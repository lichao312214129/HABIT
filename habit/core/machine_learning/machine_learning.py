
import base64
exec(base64.b64decode(b'IiIiDQpBIENvbXBsZXRlIE1vZGVsaW5nIFBpcGVsaW5lDQoNCkF1dGhvcjogTGkgQ2hhbw0KRW1haWw6IGxpY2gzNTZAbWFpbC5zeXN1LmVkdS5jbg0KIiIiDQppbXBvcnQgb3MNCmltcG9ydCBwYW5kYXMgYXMgcGQNCmltcG9ydCBudW1weSBhcyBucA0KaW1wb3J0IHdhcm5pbmdzDQpmcm9tIHNrbGVhcm4ucHJlcHJvY2Vzc2luZyBpbXBvcnQgU3RhbmRhcmRTY2FsZXIsIE1pbk1heFNjYWxlcg0KZnJvbSBza2xlYXJuLm1vZGVsX3NlbGVjdGlvbiBpbXBvcnQgdHJhaW5fdGVzdF9zcGxpdA0KaW1wb3J0IGpzb24NCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBMaXN0LCBBbnksIE9wdGlvbmFsLCBVbmlvbiwgVHVwbGUsIFNldA0KZnJvbSAubW9kZWxzLmZhY3RvcnkgaW1wb3J0IE1vZGVsRmFjdG9yeQ0KZnJvbSAuZmVhdHVyZV9zZWxlY3RvcnMgaW1wb3J0IHJ1bl9zZWxlY3RvciwgZ2V0X2F2YWlsYWJsZV9zZWxlY3RvcnMNCmZyb20gLmV2YWx1YXRpb24ubW9kZWxfZXZhbHVhdGlvbiBpbXBvcnQgTW9kZWxFdmFsdWF0b3IsIGNhbGN1bGF0ZV9tZXRyaWNzDQpmcm9tIC52aXN1YWxpemF0aW9uLnBsb3R0aW5nIGltcG9ydCBQbG90dGVyIA0KDQojIElnbm9yZSB3YXJuaW5ncw0Kd2FybmluZ3MuZmlsdGVyd2FybmluZ3MoImlnbm9yZSIpDQoNCmNsYXNzIE1vZGVsaW5nOg0KICAgICIiIg0KICAgIEEgY2xhc3MgZm9yIHJhZGlvbWljcyBtb2RlbGluZyBwaXBlbGluZQ0KICAgICIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb25maWc6IERpY3Rbc3RyLCBBbnldKSAtPiBOb25lOg0KICAgICAgICAiIiINCiAgICAgICAgSW5pdGlhbGl6ZSB0aGUgbW9kZWxpbmcgY2xhc3MNCiAgICAgICAgDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBjb25maWc6IENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeSBjb250YWluaW5nIGFsbCBtb2RlbGluZyBwYXJhbWV0ZXJzDQogICAgICAgICIiIg0KICAgICAgICBzZWxmLmNvbmZpZyA9IGNvbmZpZw0KICAgICAgICBzZWxmLmRhdGFfZmlsZSA9IGNvbmZpZ1snaW5wdXQnXQ0KICAgICAgICBzZWxmLm91dHB1dF9kaXIgPSBjb25maWdbJ291dHB1dCddDQogICAgICAgIHNlbGYudGVzdF9zaXplID0gY29uZmlnLmdldCgndGVzdF9zaXplJywgMC4zKQ0KICAgICAgICBzZWxmLlNFRUQgPSBjb25maWcuZ2V0KCdyYW5kb21fc3RhdGUnLCA0MikNCiAgICAgICAgc2VsZi5mZWF0dXJlX3NlbGVjdGlvbl9tZXRob2RzID0gY29uZmlnLmdldCgnZmVhdHVyZV9zZWxlY3Rpb25fbWV0aG9kcycpDQogICAgICAgIA0KICAgICAgICAjIERhdGEgc3BsaXQgY29uZmlndXJhdGlvbg0KICAgICAgICBzZWxmLnNwbGl0X21ldGhvZCA9IGNvbmZpZy5nZXQoJ3NwbGl0X21ldGhvZCcsICdzdHJhdGlmaWVkJykNCiAgICAgICAgc2VsZi50cmFpbl9pZHNfZmlsZSA9IGNvbmZpZy5nZXQoJ3RyYWluX2lkc19maWxlJywgTm9uZSkNCiAgICAgICAgc2VsZi50ZXN0X2lkc19maWxlID0gY29uZmlnLmdldCgndGVzdF9pZHNfZmlsZScsIE5vbmUpDQoNCiAgICAgICAgIyB2aXN1YWxpemF0aW9uIGFuZCBzYXZlIGNvbmZpZ3VyYXRpb24NCiAgICAgICAgc2VsZi5pc192aXN1YWxpemUgPSBjb25maWcuZ2V0KCdpc192aXN1YWxpemUnLCBGYWxzZSkNCiAgICAgICAgc2VsZi5pc19zYXZlX21vZGVsID0gY29uZmlnLmdldCgnaXNfc2F2ZV9tb2RlbCcsIEZhbHNlKQ0KICAgICAgICANCiAgICAgICAgIyBHZXQgYXZhaWxhYmxlIGZlYXR1cmUgc2VsZWN0b3JzDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHNlbGYuYXZhaWxhYmxlX3NlbGVjdG9ycyA9IGdldF9hdmFpbGFibGVfc2VsZWN0b3JzKCkNCiAgICAgICAgICAgIHByaW50KGYiQXZhaWxhYmxlIGZlYXR1cmUgc2VsZWN0b3JzOiB7c2VsZi5hdmFpbGFibGVfc2VsZWN0b3JzfSIpDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToNCiAgICAgICAgICAgIHNlbGYuYXZhaWxhYmxlX3NlbGVjdG9ycyA9IFtdDQogICAgICAgICAgICBwcmludChmIldhcm5pbmc6IEZhaWxlZCB0byBnZXQgYXZhaWxhYmxlIGZlYXR1cmUgc2VsZWN0b3JzOiB7ZX0iKQ0KICAgIA0KICAgICAgICBzZWxmLnBsb3R0ZXIgPSBQbG90dGVyKHNlbGYub3V0cHV0X2RpcikNCiAgICAgICAgDQogICAgZGVmIHJlYWRfZGF0YShzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgUmVhZCBkYXRhIGZyb20gZmlsZShzKQ0KICAgICAgICANCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIE1vZGVsaW5nOiBTZWxmIGluc3RhbmNlIGZvciBtZXRob2QgY2hhaW5pbmcNCiAgICAgICAgIiIiDQogICAgICAgICAgICANCiAgICAgICAgaWYgaXNpbnN0YW5jZShzZWxmLmRhdGFfZmlsZSwgbGlzdCk6DQogICAgICAgICAgICAjIE11bHRpcGxlIGZpbGVzIGNhc2UNCiAgICAgICAgICAgIHByaW50KGYiUmVhZGluZyBkYXRhIGZyb20gbXVsdGlwbGUgZmlsZXM6IHtsZW4oc2VsZi5kYXRhX2ZpbGUpfSBmaWxlcyIpDQogICAgICAgICAgICANCiAgICAgICAgICAgIG1lcmdlZF9kZiA9IE5vbmUNCiAgICAgICAgICAgIGFsbF9sYWJlbHMgPSB7fSAgIyDnlKjkuo7lrZjlgqjmiYDmnInmoLfmnKznmoTmoIfnrb7lgLwNCiAgICAgICAgICAgIGZpcnN0X3N1YmplY3RfaWRfY29sID0gTm9uZSAgIyDorrDlvZXnrKzkuIDkuKpzdWJqZWN0X2lkX2NvbA0KICAgICAgICAgICAgZmlyc3RfbGFiZWxfY29sID0gTm9uZSAgIyDorrDlvZXnrKzkuIDkuKrmoIfnrb7liJflkI0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgZm9yIGl0aGYsIGZpbGVfY29uZmlnIGluIGVudW1lcmF0ZShzZWxmLmRhdGFfZmlsZSk6DQogICAgICAgICAgICAgICAgZmlsZV9wYXRoID0gZmlsZV9jb25maWdbJ3BhdGgnXQ0KICAgICAgICAgICAgICAgIG5hbWUgPSBmaWxlX2NvbmZpZy5nZXQoJ25hbWUnLCBmIm1vZGVse2l0aGYrMX0iKQ0KICAgICAgICAgICAgICAgIHN1YmplY3RfaWRfY29sID0gZmlsZV9jb25maWcuZ2V0KCdzdWJqZWN0X2lkX2NvbCcpDQogICAgICAgICAgICAgICAgbGFiZWxfY29sID0gZmlsZV9jb25maWcuZ2V0KCdsYWJlbF9jb2wnKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgQ2hlY2sgaWYgc3ViamVjdF9pZF9jb2wgb3IgbGFiZWxfY29sIGlzIE5vbmUNCiAgICAgICAgICAgICAgICBpZiBzdWJqZWN0X2lkX2NvbCBpcyBOb25lOg0KICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiU3ViamVjdCBJRCBjb2x1bW4gbXVzdCBiZSBzcGVjaWZpZWQgZm9yIGZpbGUge2ZpbGVfcGF0aH0iKQ0KICAgICAgICAgICAgICAgIGlmIGxhYmVsX2NvbCBpcyBOb25lOg0KICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTGFiZWwgY29sdW1uIG11c3QgYmUgc3BlY2lmaWVkIGZvciBmaWxlIHtmaWxlX3BhdGh9IikNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBmZWF0dXJlcyA9IGZpbGVfY29uZmlnLmdldCgnZmVhdHVyZXMnLCBbXSkNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBwcmludChmIiAgUmVhZGluZyBmaWxlOiB7ZmlsZV9wYXRofSIpDQogICAgICAgICAgICAgICAgcHJpbnQoZiIgIERhdGFzZXQgbmFtZToge25hbWV9IikNCiAgICAgICAgICAgICAgICBwcmludChmIiAgU3ViamVjdCBJRCBjb2x1bW46IHtzdWJqZWN0X2lkX2NvbH0iKQ0KICAgICAgICAgICAgICAgIHByaW50KGYiICBMYWJlbCBjb2x1bW46IHtsYWJlbF9jb2x9IikNCiAgICAgICAgICAgICAgICBwcmludChmIiAgRmVhdHVyZXM6IHtmZWF0dXJlc30iKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgUmVhZCB0aGUgZmlsZQ0KICAgICAgICAgICAgICAgIGRmID0gcGQucmVhZF9jc3YoZmlsZV9wYXRoKQ0KDQogICAgICAgICAgICAgICAgIyBjaGVjayBpZiBzdWJqZWN0X2lkX2NvbCBhbmQgbGFiZWxfY29sIGV4aXN0IGluIGRmDQogICAgICAgICAgICAgICAgaWYgc3ViamVjdF9pZF9jb2wgbm90IGluIGRmLmNvbHVtbnM6DQogICAgICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJTdWJqZWN0IElEIGNvbHVtbiAne3N1YmplY3RfaWRfY29sfScgbm90IGZvdW5kIGluIHtmaWxlX3BhdGh9IikNCiAgICAgICAgICAgICAgICBpZiBsYWJlbF9jb2wgbm90IGluIGRmLmNvbHVtbnM6DQogICAgICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJMYWJlbCBjb2x1bW4gJ3tsYWJlbF9jb2x9JyBub3QgZm91bmQgaW4ge2ZpbGVfcGF0aH0iKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgQ29udmVydCBzdWJqZWN0IElEcyB0byBzdHJpbmcgZm9yIGNvbnNpc3RlbnQgbWVyZ2luZw0KICAgICAgICAgICAgICAgIGRmW3N1YmplY3RfaWRfY29sXSA9IGRmW3N1YmplY3RfaWRfY29sXS5hc3R5cGUoc3RyKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMg6K6w5b2V56ys5LiA5Liq5paH5Lu255qE5qCH562+5YiX5ZCN5L2c5Li65pyA57uI5qCH562+5YiX5ZCNDQogICAgICAgICAgICAgICAgaWYgZmlyc3RfbGFiZWxfY29sIGlzIE5vbmU6DQogICAgICAgICAgICAgICAgICAgIGZpcnN0X2xhYmVsX2NvbCA9IGxhYmVsX2NvbA0KICAgICAgICAgICAgICAgICAgICBzZWxmLmxhYmVsX2NvbCA9IGZpcnN0X2xhYmVsX2NvbA0KICAgICAgICAgICAgICAgICAgICBsYWJlbF92YWx1ZXMgPSBkZltsYWJlbF9jb2xdDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgIyDorrDlvZXnrKzkuIDkuKrmlofku7bnmoRzdWJqZWN0X2lkX2NvbOS9nOS4uuacgOe7iHN1YmplY3RfaWRfY29sDQogICAgICAgICAgICAgICAgaWYgZmlyc3Rfc3ViamVjdF9pZF9jb2wgaXMgTm9uZToNCiAgICAgICAgICAgICAgICAgICAgZmlyc3Rfc3ViamVjdF9pZF9jb2wgPSBzdWJqZWN0X2lkX2NvbA0KICAgICAgICAgICAgICAgICAgICBzZWxmLnN1YmplY3RfaWRfY29sID0gZmlyc3Rfc3ViamVjdF9pZF9jb2wNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIOaPkOWPluW5tuS/neWtmOagh+etvuaVsOaNrizlkIzml7bkv53nlZlzdWJqSUQNCiAgICAgICAgICAgICAgICBhbGxfbGFiZWxzW2ZpbGVfcGF0aF0gPSBkZi5sb2NbOiwgW3N1YmplY3RfaWRfY29sLCBsYWJlbF9jb2xdXQ0KICAgICAgICAgICAgICAgIGFsbF9sYWJlbHNbZmlsZV9wYXRoXS5zZXRfaW5kZXgoc3ViamVjdF9pZF9jb2wsIGlucGxhY2U9VHJ1ZSkNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIOmAieaLqeimgeS/neeVmeeahOWIl++8jOS4jeWMheaLrOagh+etvuWIlw0KICAgICAgICAgICAgICAgIGNvbHVtbnNfdG9fa2VlcCA9IFtzdWJqZWN0X2lkX2NvbF0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIOa3u+WKoOeJueW+geWIl++8jOa3u+WKoOWJjee8gOmBv+WFjeWGsueqgQ0KICAgICAgICAgICAgICAgIGZlYXR1cmVfY29sdW1ucyA9IHt9DQogICAgICAgICAgICAgICAgaWYgZmVhdHVyZXM6DQogICAgICAgICAgICAgICAgICAgIGZvciBmZWF0dXJlIGluIGZlYXR1cmVzOg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgZmVhdHVyZSBpbiBkZi5jb2x1bW5zOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnNfdG9fa2VlcC5hcHBlbmQoZmVhdHVyZSkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIOS4uueJueW+geWIl+WQjea3u+WKoOWJjee8gA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmVfY29sdW1uc1tmZWF0dXJlXSA9IGYie25hbWV9e2ZlYXR1cmV9Ig0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIiAgV2FybmluZzogRmVhdHVyZSAne2ZlYXR1cmV9JyBub3QgZm91bmQgaW4ge2ZpbGVfcGF0aH0iKQ0KICAgICAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgICAgICMg5aaC5p6c5pyq5oyH5a6a54m55b6B77yM5L2/55So6ZmkSUTlkozmoIfnrb7lpJbnmoTmiYDmnInliJcNCiAgICAgICAgICAgICAgICAgICAgZm9yIGNvbCBpbiBkZi5jb2x1bW5zOg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgY29sICE9IHN1YmplY3RfaWRfY29sIGFuZCBjb2wgIT0gbGFiZWxfY29sOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnNfdG9fa2VlcC5hcHBlbmQoY29sKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmVfY29sdW1uc1tjb2xdID0gZiJ7bmFtZX17Y29sfSINCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIOWPquS/neeVmemcgOimgeeahOWIlw0KICAgICAgICAgICAgICAgIGRmID0gZGZbY29sdW1uc190b19rZWVwXQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMg6YeN5ZG95ZCN54m55b6B5YiX77yM5re75Yqg5YmN57yADQogICAgICAgICAgICAgICAgcmVuYW1lX2RpY3QgPSB7Y29sOiBmZWF0dXJlX2NvbHVtbnNbY29sXSBmb3IgY29sIGluIGZlYXR1cmVfY29sdW1ucyBpZiBjb2wgaW4gZGYuY29sdW1uc30NCiAgICAgICAgICAgICAgICBkZiA9IGRmLnJlbmFtZShjb2x1bW5zPXJlbmFtZV9kaWN0KQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMg6aaW5qyh5aSE55CG5Yid5aeL5YyW5ZCI5bm25pWw5o2u5qGGDQogICAgICAgICAgICAgICAgaWYgbWVyZ2VkX2RmIGlzIE5vbmU6DQogICAgICAgICAgICAgICAgICAgIG1lcmdlZF9kZiA9IGRmDQogICAgICAgICAgICAgICAgICAgICMg6K6+572u57Si5byV55So5LqO5ZCO57ut5ZCI5bm2DQogICAgICAgICAgICAgICAgICAgIG1lcmdlZF9kZi5zZXRfaW5kZXgoc3ViamVjdF9pZF9jb2wsIGlucGxhY2U9VHJ1ZSkNCiAgICAgICAgICAgICAgICAgICAgIyDntKLlvJXovazkuLrlrZfnrKbkuLINCiAgICAgICAgICAgICAgICAgICAgbWVyZ2VkX2RmLmluZGV4ID0gbWVyZ2VkX2RmLmluZGV4LmFzdHlwZShzdHIpDQogICAgICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICAgICAgIyDkuLrlkIjlubborr7nva7kuLTml7bntKLlvJUNCiAgICAgICAgICAgICAgICAgICAgZGYuc2V0X2luZGV4KHN1YmplY3RfaWRfY29sLCBpbnBsYWNlPVRydWUpDQogICAgICAgICAgICAgICAgICAgICMg57Si5byV6L2s5Li65a2X56ym5LiyDQogICAgICAgICAgICAgICAgICAgIGRmLmluZGV4ID0gZGYuaW5kZXguYXN0eXBlKHN0cikNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgICMg5LiO546w5pyJ5pWw5o2u5ZCI5bm2DQogICAgICAgICAgICAgICAgICAgIG1lcmdlZF9kZiA9IG1lcmdlZF9kZi5qb2luKGRmLCBob3c9J291dGVyJykNCg0KICAgICAgICAgICAgICAgICAgICAjIOabtOaWsOe0ouW8leWQjeensA0KICAgICAgICAgICAgICAgICAgICBtZXJnZWRfZGYuaW5kZXgubmFtZSA9IHNlbGYuc3ViamVjdF9pZF9jb2wNCg0KICAgICAgICAgICAgIyDlsIbmoIfnrb7mlbDmja7mt7vliqDlm57lkIjlubblkI7nmoTmlbDmja7moYYNCiAgICAgICAgICAgIHByaW50KGYiQWRkaW5nIHVuaWZpZWQgbGFiZWwgY29sdW1uOiB7c2VsZi5sYWJlbF9jb2x9IikNCiAgICAgICAgICAgIG1lcmdlZF9kZltzZWxmLmxhYmVsX2NvbF0gPSBsYWJlbF92YWx1ZXMudmFsdWVzDQogICAgICAgICAgICAjIOaKimxhYmVs5pS+5Yiw56ys5LiA5YiXDQogICAgICAgICAgICBtZXJnZWRfZGYgPSBtZXJnZWRfZGZbW3NlbGYubGFiZWxfY29sXSArIFtjb2wgZm9yIGNvbCBpbiBtZXJnZWRfZGYuY29sdW1ucyBpZiBjb2wgIT0gc2VsZi5zdWJqZWN0X2lkX2NvbCBhbmQgY29sICE9IHNlbGYubGFiZWxfY29sXV0NCiAgICAgICAgICAgIHNlbGYuZGF0YSA9IG1lcmdlZF9kZg0KDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoZiJFeHBlY3RlZCBsaXN0IGZvciBkYXRhX2ZpbGUsIGdvdCB7dHlwZShzZWxmLmRhdGFfZmlsZSl9IikNCiAgICAgICAgDQogICAgICAgIHJldHVybiBzZWxmDQogICAgDQogICAgZGVmIHByZXByb2Nlc3NfZGF0YShzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgUHJlcHJvY2VzcyB0aGUgZGF0YQ0KICAgICAgICANCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIE1vZGVsaW5nOiBTZWxmIGluc3RhbmNlIGZvciBtZXRob2QgY2hhaW5pbmcNCiAgICAgICAgIiIiDQogICAgICAgICMgUmVtb3ZlIG1pc3NpbmcgdmFsdWVzDQogICAgICAgIHByaW50KGYiU2FtcGxlIHNpemUgYmVmb3JlIHJlbW92aW5nIG1pc3NpbmcgdmFsdWVzOiB7c2VsZi5kYXRhLnNoYXBlWzBdfSIpDQogICAgICAgICMgc2VsZi5kYXRhID0gc2VsZi5kYXRhLmRyb3BuYSgpDQogICAgICAgIHByaW50KGYiU2FtcGxlIHNpemUgYWZ0ZXIgcmVtb3ZpbmcgbWlzc2luZyB2YWx1ZXM6IHtzZWxmLmRhdGEuc2hhcGVbMF19IikNCg0KICAgICAgICAjIENoZWNrIGZvciBtaXNzaW5nIHZhbHVlcw0KICAgICAgICBwcmludChmIk1pc3NpbmcgdmFsdWVzOiB7c2VsZi5kYXRhLmlzbnVsbCgpLnN1bSgpfSIpDQoNCiAgICAgICAgIyBDb252ZXJ0IHRvIG51bWVyaWMNCiAgICAgICAgIyBzZWxmLmRhdGEgPSBzZWxmLmRhdGEuYXBwbHkocGQudG9fbnVtZXJpYykNCg0KICAgICAgICAjIFBlcmZvcm0gU2hhcGlyby1XaWxrIG5vcm1hbGl0eSB0ZXN0IG9uIGFsbCBjbGluaWNhbCBkYXRhDQoNCiAgICAgICAgIyBEYXRhIGV4cGxvcmF0aW9uDQoNCiAgICAgICAgIyBldGMuDQoNCiAgICAgICAgcmV0dXJuIHNlbGYNCg0KICAgIGRlZiBfc3BsaXRfZGF0YShzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgU3BsaXQgZGF0YSBpbnRvIHRyYWluaW5nIGFuZCB0ZXN0IHNldHMgYmFzZWQgb24gdGhlIHNwZWNpZmllZCBtZXRob2QNCiAgICAgICAgDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICBNb2RlbGluZzogU2VsZiBpbnN0YW5jZSBmb3IgbWV0aG9kIGNoYWluaW5nDQogICAgICAgICIiIg0KICAgICAgICAjIFNhdmUgb3JpZ2luYWwgZGF0YSB0byBhbGxvdyBhY2Nlc3MgdG8gc3ViamVjdCBJRHMgbGF0ZXINCiAgICAgICAgc2VsZi5vcmlnaW5hbF9kYXRhID0gc2VsZi5kYXRhLmNvcHkoKQ0KICAgICAgICANCiAgICAgICAgIyBEaWZmZXJlbnQgc3BsaXQgbWV0aG9kcw0KICAgICAgICBpZiBzZWxmLnNwbGl0X21ldGhvZCA9PSAncmFuZG9tJzoNCiAgICAgICAgICAgICMgUmFuZG9tIHNwbGl0IHdpdGhvdXQgc3RyYXRpZmljYXRpb24NCiAgICAgICAgICAgIHNlbGYuZGF0YV90cmFpbiwgc2VsZi5kYXRhX3Rlc3QgPSB0cmFpbl90ZXN0X3NwbGl0KA0KICAgICAgICAgICAgICAgIHNlbGYuZGF0YSwNCiAgICAgICAgICAgICAgICB0ZXN0X3NpemU9c2VsZi50ZXN0X3NpemUsIA0KICAgICAgICAgICAgICAgIHJhbmRvbV9zdGF0ZT1zZWxmLlNFRUQNCiAgICAgICAgICAgICkNCiAgICAgICAgICAgIHByaW50KGYiRGF0YSBzcGxpdCB1c2luZyByYW5kb20gbWV0aG9kICh0ZXN0IHNpemU6IHtzZWxmLnRlc3Rfc2l6ZX0pIikNCiAgICAgICAgICAgIA0KICAgICAgICBlbGlmIHNlbGYuc3BsaXRfbWV0aG9kID09ICdzdHJhdGlmaWVkJzoNCiAgICAgICAgICAgICMgU3RyYXRpZmllZCBzcGxpdCBiYXNlZCBvbiBsYWJlbCBjb2x1bW4gKGRlZmF1bHQgbWV0aG9kKQ0KICAgICAgICAgICAgc2VsZi5kYXRhX3RyYWluLCBzZWxmLmRhdGFfdGVzdCA9IHRyYWluX3Rlc3Rfc3BsaXQoDQogICAgICAgICAgICAgICAgc2VsZi5kYXRhLA0KICAgICAgICAgICAgICAgIHRlc3Rfc2l6ZT1zZWxmLnRlc3Rfc2l6ZSwgDQogICAgICAgICAgICAgICAgcmFuZG9tX3N0YXRlPXNlbGYuU0VFRCwgDQogICAgICAgICAgICAgICAgc3RyYXRpZnk9c2VsZi5kYXRhW3NlbGYubGFiZWxfY29sXQ0KICAgICAgICAgICAgKQ0KICAgICAgICAgICAgcHJpbnQoZiJEYXRhIHNwbGl0IHVzaW5nIHN0cmF0aWZpZWQgbWV0aG9kICh0ZXN0IHNpemU6IHtzZWxmLnRlc3Rfc2l6ZX0pIikNCiAgICAgICAgICAgIA0KICAgICAgICBlbGlmIHNlbGYuc3BsaXRfbWV0aG9kID09ICdjdXN0b20nOg0KICAgICAgICAgICAgIyBVc2UgY3VzdG9tIHN1YmplY3QgSURzIGZvciB0cmFpbiBhbmQgdGVzdCBzZXRzDQogICAgICAgICAgICBpZiBub3Qgc2VsZi50cmFpbl9pZHNfZmlsZSBvciBub3Qgc2VsZi50ZXN0X2lkc19maWxlOg0KICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkZvciBjdXN0b20gc3BsaXQgbWV0aG9kLCBib3RoIHRyYWluX2lkc19maWxlIGFuZCB0ZXN0X2lkc19maWxlIG11c3QgYmUgc3BlY2lmaWVkIikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBSZWFkIHN1YmplY3QgSURzIGZyb20gZmlsZXMNCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICB0cmFpbl9pZHMgPSBzZWxmLl9yZWFkX3N1YmplY3RfaWRzKHNlbGYudHJhaW5faWRzX2ZpbGUpDQogICAgICAgICAgICAgICAgdGVzdF9pZHMgPSBzZWxmLl9yZWFkX3N1YmplY3RfaWRzKHNlbGYudGVzdF9pZHNfZmlsZSkNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIEVuc3VyZSBEYXRhRnJhbWUgaW5kZXggaXMgY29udmVydGVkIHRvIHN0cmluZyB0eXBlDQogICAgICAgICAgICAgICAgaWYgbm90IGFsbChpc2luc3RhbmNlKGlkeCwgc3RyKSBmb3IgaWR4IGluIHNlbGYuZGF0YS5pbmRleCk6DQogICAgICAgICAgICAgICAgICAgIHByaW50KCJDb252ZXJ0aW5nIERhdGFGcmFtZSBpbmRleCB0byBzdHJpbmcgdHlwZSIpDQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGF0YS5pbmRleCA9IHNlbGYuZGF0YS5pbmRleC5hc3R5cGUoc3RyKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgVmVyaWZ5IG5vIG92ZXJsYXAgYmV0d2VlbiB0cmFpbiBhbmQgdGVzdA0KICAgICAgICAgICAgICAgIG92ZXJsYXAgPSBzZXQodHJhaW5faWRzKS5pbnRlcnNlY3Rpb24oc2V0KHRlc3RfaWRzKSkNCiAgICAgICAgICAgICAgICBpZiBvdmVybGFwOg0KICAgICAgICAgICAgICAgICAgICBwcmludChmIldhcm5pbmc6IEZvdW5kIHtsZW4ob3ZlcmxhcCl9IG92ZXJsYXBwaW5nIHN1YmplY3QgSURzIGJldHdlZW4gdHJhaW4gYW5kIHRlc3Qgc2V0cyIpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgIyBDcmVhdGUgdHJhaW4gYW5kIHRlc3QgZGF0YXNldHMNCiAgICAgICAgICAgICAgICBzZWxmLmRhdGFfdHJhaW4gPSBzZWxmLmRhdGEubG9jW3NlbGYuZGF0YS5pbmRleC5pc2luKHRyYWluX2lkcyldDQogICAgICAgICAgICAgICAgc2VsZi5kYXRhX3Rlc3QgPSBzZWxmLmRhdGEubG9jW3NlbGYuZGF0YS5pbmRleC5pc2luKHRlc3RfaWRzKV0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIFZlcmlmeSBhbGwgSURzIHdlcmUgZm91bmQNCiAgICAgICAgICAgICAgICBtaXNzaW5nX3RyYWluID0gc2V0KHRyYWluX2lkcykgLSBzZXQoc2VsZi5kYXRhX3RyYWluLmluZGV4KQ0KICAgICAgICAgICAgICAgIG1pc3NpbmdfdGVzdCA9IHNldCh0ZXN0X2lkcykgLSBzZXQoc2VsZi5kYXRhX3Rlc3QuaW5kZXgpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYgbWlzc2luZ190cmFpbjoNCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiB7bGVuKG1pc3NpbmdfdHJhaW4pfSB0cmFpbiBzdWJqZWN0IElEcyBub3QgZm91bmQgaW4gZGF0YSIpDQogICAgICAgICAgICAgICAgaWYgbWlzc2luZ190ZXN0Og0KICAgICAgICAgICAgICAgICAgICBwcmludChmIldhcm5pbmc6IHtsZW4obWlzc2luZ190ZXN0KX0gdGVzdCBzdWJqZWN0IElEcyBub3QgZm91bmQgaW4gZGF0YSIpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgcHJpbnQoZiJEYXRhIHNwbGl0IHVzaW5nIGN1c3RvbSBzdWJqZWN0IElEcyAodHJhaW46IHtsZW4oc2VsZi5kYXRhX3RyYWluKX0sIHRlc3Q6IHtsZW4oc2VsZi5kYXRhX3Rlc3QpfSkiKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOg0KICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJGYWlsZWQgdG8gc3BsaXQgZGF0YSB1c2luZyBjdXN0b20gc3ViamVjdCBJRHM6IHtlfSIpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiVW5zdXBwb3J0ZWQgc3BsaXQgbWV0aG9kOiB7c2VsZi5zcGxpdF9tZXRob2R9IikNCiAgICAgICAgDQogICAgICAgICMgRXh0cmFjdCBmZWF0dXJlcyBhbmQgbGFiZWxzDQogICAgICAgIHNlbGYueF90cmFpbiA9IHNlbGYuZGF0YV90cmFpbi5kcm9wKHNlbGYubGFiZWxfY29sLCBheGlzPTEpDQogICAgICAgIHNlbGYueV90cmFpbiA9IHNlbGYuZGF0YV90cmFpbltzZWxmLmxhYmVsX2NvbF0NCiAgICAgICAgc2VsZi54X3Rlc3QgPSBzZWxmLmRhdGFfdGVzdC5kcm9wKHNlbGYubGFiZWxfY29sLCBheGlzPTEpDQogICAgICAgIHNlbGYueV90ZXN0ID0gc2VsZi5kYXRhX3Rlc3Rbc2VsZi5sYWJlbF9jb2xdDQogICAgICAgIHNlbGYuaGVhZGVyID0gc2VsZi54X3RyYWluLmNvbHVtbnMNCiAgICAgICAgDQogICAgICAgICMgU2F2ZSB0cmFpbi90ZXN0IHNwbGl0IGluZGljZXMgZm9yIGxhdGVyIHJlZmVyZW5jZQ0KICAgICAgICBzZWxmLl9zYXZlX3NwbGl0X2luZm8oKQ0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHNlbGYNCiAgICANCiAgICBkZWYgX3JlYWRfc3ViamVjdF9pZHMoc2VsZiwgZmlsZV9wYXRoOiBzdHIpIC0+IExpc3Rbc3RyXToNCiAgICAgICAgIiIiDQogICAgICAgIFJlYWQgc3ViamVjdCBJRHMgZnJvbSBhIGZpbGUNCiAgICAgICAgDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBmaWxlX3BhdGg6IFBhdGggdG8gZmlsZSBjb250YWluaW5nIHN1YmplY3QgSURzDQogICAgICAgICAgICANCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIExpc3Qgb2Ygc3ViamVjdCBJRHMgKGFsbCBjb252ZXJ0ZWQgdG8gc3RyaW5nIHR5cGUpDQogICAgICAgICIiIg0KICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicpIGFzIGY6DQogICAgICAgICAgICAjIFN1cHBvcnQgZGlmZmVyZW50IGZvcm1hdHM6IG9uZSBJRCBwZXIgbGluZSwgQ1NWLCBvciBKU09ODQogICAgICAgICAgICBjb250ZW50ID0gZi5yZWFkKCkuc3RyaXAoKQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFRyeSB0byBwYXJzZSBhcyBKU09ODQogICAgICAgICAgICBpZiBjb250ZW50LnN0YXJ0c3dpdGgoJ1snKSBhbmQgY29udGVudC5lbmRzd2l0aCgnXScpOg0KICAgICAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICAgICAgaWRzID0ganNvbi5sb2Fkcyhjb250ZW50KQ0KICAgICAgICAgICAgICAgICAgICAjIEVuc3VyZSBhbGwgSURzIGFyZSBzdHJpbmcgdHlwZQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gW3N0cihpZCkgZm9yIGlkIGluIGlkc10NCiAgICAgICAgICAgICAgICBleGNlcHQ6DQogICAgICAgICAgICAgICAgICAgIHBhc3MNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAjIFRyeSB0byBwYXJzZSBhcyBDU1YNCiAgICAgICAgICAgIGlmICcsJyBpbiBjb250ZW50Og0KICAgICAgICAgICAgICAgIGlkcyA9IFtpZC5zdHJpcCgpIGZvciBpZCBpbiBjb250ZW50LnNwbGl0KCcsJyldDQogICAgICAgICAgICAgICAgIyBFbnN1cmUgYWxsIElEcyBhcmUgc3RyaW5nIHR5cGUNCiAgICAgICAgICAgICAgICByZXR1cm4gW3N0cihpZCkgZm9yIGlkIGluIGlkc10NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICMgRGVmYXVsdDogb25lIElEIHBlciBsaW5lDQogICAgICAgICAgICBpZHMgPSBbbGluZS5zdHJpcCgpIGZvciBsaW5lIGluIGNvbnRlbnQuc3BsaXQoJ1xuJykgaWYgbGluZS5zdHJpcCgpXQ0KICAgICAgICAgICAgIyBFbnN1cmUgYWxsIElEcyBhcmUgc3RyaW5nIHR5cGUNCiAgICAgICAgICAgIHJldHVybiBbc3RyKGlkKSBmb3IgaWQgaW4gaWRzXQ0KICAgIA0KICAgIGRlZiBfc2F2ZV9zcGxpdF9pbmZvKHNlbGYpIC0+IE5vbmU6DQogICAgICAgICIiIg0KICAgICAgICBTYXZlIHRyYWluL3Rlc3Qgc3BsaXQgaW5mb3JtYXRpb24NCiAgICAgICAgIiIiDQogICAgICAgIHNwbGl0X2luZm8gPSB7DQogICAgICAgICAgICAnc3BsaXRfbWV0aG9kJzogc2VsZi5zcGxpdF9tZXRob2QsDQogICAgICAgICAgICAndHJhaW5fc2l6ZSc6IGxlbihzZWxmLmRhdGFfdHJhaW4pLA0KICAgICAgICAgICAgJ3Rlc3Rfc2l6ZSc6IGxlbihzZWxmLmRhdGFfdGVzdCksDQogICAgICAgICAgICAndHJhaW5fc3ViamVjdHMnOiBsaXN0KHNlbGYuZGF0YV90cmFpbi5pbmRleCksDQogICAgICAgICAgICAndGVzdF9zdWJqZWN0cyc6IGxpc3Qoc2VsZi5kYXRhX3Rlc3QuaW5kZXgpDQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgICMgU2F2ZSB0byBKU09ODQogICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZGlyLCAnc3BsaXRfaW5mby5qc29uJyksICd3JykgYXMgZjoNCiAgICAgICAgICAgIGpzb24uZHVtcChzcGxpdF9pbmZvLCBmLCBpbmRlbnQ9NCkNCg0KICAgIGRlZiBub3JtYWxpemF0aW9uKHNlbGYpIC0+ICdNb2RlbGluZyc6DQogICAgICAgICIiIg0KICAgICAgICBQZXJmb3JtIHotc2NvcmUgc3RhbmRhcmRpemF0aW9uDQogICAgICAgIA0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgTW9kZWxpbmc6IFNlbGYgaW5zdGFuY2UgZm9yIG1ldGhvZCBjaGFpbmluZw0KICAgICAgICAiIiINCiAgICAgICAgc3MgPSBTdGFuZGFyZFNjYWxlcigpDQogICAgICAgIHhfdHJhaW4gPSBzcy5maXRfdHJhbnNmb3JtKHNlbGYueF90cmFpbikNCiAgICAgICAgeF90ZXN0ID0gc3MudHJhbnNmb3JtKHNlbGYueF90ZXN0KQ0KICAgICAgICBzZWxmLnhfdHJhaW4udmFsdWVzWzosOl0gPSB4X3RyYWluDQogICAgICAgIHNlbGYueF90ZXN0LnZhbHVlc1s6LDpdID0geF90ZXN0DQogICAgICAgIA0KICAgICAgICAjIFNhdmUgc2NhbGVyIGZvciBmdXR1cmUgdXNlDQogICAgICAgIHNlbGYuc2NhbGVyID0gc3MNCiAgICAgICAgIyBTYXZlIGZlYXR1cmUgbmFtZXMgdXNlZCBkdXJpbmcgZml0DQogICAgICAgIHNlbGYuc2NhbGVyX2ZlYXR1cmVfbmFtZXMgPSBsaXN0KHNlbGYueF90cmFpbi5jb2x1bW5zKQ0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHNlbGYNCg0KICAgIGRlZiBmZWF0dXJlX3NlbGVjdGlvbihzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgUGVyZm9ybSBmZWF0dXJlIHNlbGVjdGlvbg0KICAgICAgICANCiAgICAgICAgRXhlY3V0ZXMgZmVhdHVyZSBzZWxlY3Rpb24gbWV0aG9kcyBpbiBzZXF1ZW5jZSBhY2NvcmRpbmcgdG8gdGhlIGNvbmZpZ3VyYXRpb24NCiAgICAgICAgDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICBNb2RlbGluZzogU2VsZiBpbnN0YW5jZSBmb3IgbWV0aG9kIGNoYWluaW5nDQogICAgICAgICIiIg0KICAgICAgICAjIENoZWNrIGlmIGZlYXR1cmUgc2VsZWN0aW9uIG1ldGhvZHMgYXJlIHByb3ZpZGVkDQogICAgICAgIGlmIHNlbGYuZmVhdHVyZV9zZWxlY3Rpb25fbWV0aG9kcyBpcyBOb25lOg0KICAgICAgICAgICAgcHJpbnQoIldhcm5pbmc6IE5vIGZlYXR1cmUgc2VsZWN0aW9uIG1ldGhvZHMgcHJvdmlkZWQsIHVzaW5nIG9yaWdpbmFsIGZlYXR1cmUgc2V0IikNCiAgICAgICAgICAgIHNlbGYuc2VsZWN0ZWRfZmVhdHVyZXMgPSBsaXN0KHNlbGYueF90cmFpbi5jb2x1bW5zKQ0KICAgICAgICAgICAgcmV0dXJuIHNlbGYNCiAgICAgICAgDQogICAgICAgICMgU3RvcmUgY3VycmVudCBmZWF0dXJlIHNldA0KICAgICAgICBzZWxlY3RlZF9mZWF0dXJlcyA9IGxpc3Qoc2VsZi54X3RyYWluLmNvbHVtbnMpDQogICAgICAgIA0KICAgICAgICAjIEV4ZWN1dGUgZmVhdHVyZSBzZWxlY3Rpb24gbWV0aG9kcyBpbiBzZXF1ZW5jZQ0KICAgICAgICBzZWxlY3RlZF9mZWF0dXJlc19vZl9lYWNoX21ldGhvZCA9IHt9DQogICAgICAgIGZvciBzZWxlY3Rpb25fY29uZmlnIGluIHNlbGYuZmVhdHVyZV9zZWxlY3Rpb25fbWV0aG9kczoNCiAgICAgICAgICAgIG1ldGhvZF9uYW1lID0gc2VsZWN0aW9uX2NvbmZpZ1snbWV0aG9kJ10NCiAgICAgICAgICAgIHBhcmFtcyA9IHNlbGVjdGlvbl9jb25maWcuZ2V0KCdwYXJhbXMnLCB7fSkNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcHJpbnQoZiJcbkV4ZWN1dGluZyB7bWV0aG9kX25hbWV9IGZlYXR1cmUgc2VsZWN0aW9uLi4uIikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgICMgQWRkIGNvbW1vbiBwYXJhbWV0ZXJzDQogICAgICAgICAgICAgICAgcGFyYW1zWydvdXRkaXInXSA9IHBhcmFtcy5nZXQoJ291dGRpcicsIHNlbGYub3V0cHV0X2RpcikNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIFJ1biBmZWF0dXJlIHNlbGVjdG9yDQogICAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBydW5fc2VsZWN0b3IoDQogICAgICAgICAgICAgICAgICAgIG1ldGhvZF9uYW1lLA0KICAgICAgICAgICAgICAgICAgICBzZWxmLnhfdHJhaW4sDQogICAgICAgICAgICAgICAgICAgIHNlbGYueV90cmFpbiwNCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRfZmVhdHVyZXMsDQogICAgICAgICAgICAgICAgICAgICoqcGFyYW1zDQogICAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgVXBkYXRlIGZlYXR1cmUgc2V0DQogICAgICAgICAgICAgICAgc2VsZWN0ZWRfZmVhdHVyZXMgPSBzZWxlY3RlZA0KICAgICAgICAgICAgICAgIHNlbGVjdGVkX2ZlYXR1cmVzX29mX2VhY2hfbWV0aG9kW21ldGhvZF9uYW1lXSA9IHNlbGVjdGVkX2ZlYXR1cmVzDQoNCiAgICAgICAgICAgICAgICAjIHByaW50IHNlbGVjdGVkIGZlYXR1cmVzIGFuZCByZW1vdmVkIGZlYXR1cmVzDQogICAgICAgICAgICAgICAgcHJpbnQoZiJTZWxlY3RlZCBmZWF0dXJlczoge3NlbGVjdGVkX2ZlYXR1cmVzfSIpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgIyBXYXJuIGlmIG5vIGZlYXR1cmVzIHNlbGVjdGVkDQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGVjdGVkX2ZlYXR1cmVzOg0KICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTm8gZmVhdHVyZXMgcmVtYWluaW5nIGFmdGVyIHttZXRob2RfbmFtZX0gc2VsZWN0aW9uLCBwbGVhc2UgY2hlY2sgc2V0dGluZ3MiKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOg0KICAgICAgICAgICAgICAgIHByaW50KGYiV2FybmluZzoge21ldGhvZF9uYW1lfSBzZWxlY3Rpb24gZmFpbGVkOiB7ZX0iKQ0KICAgICAgICAgICAgICAgIHByaW50KGYiU2tpcHBpbmcgdGhpcyBtZXRob2QsIGNvbnRpbnVpbmcgd2l0aCBjdXJyZW50IGZlYXR1cmUgc2V0OiB7bGVuKHNlbGVjdGVkX2ZlYXR1cmVzKX0gZmVhdHVyZXMiKQ0KICAgICAgICANCiAgICAgICAgIyBGaW5hbCBzZWxlY3RlZCBmZWF0dXJlcw0KICAgICAgICBzZWxmLnNlbGVjdGVkX2ZlYXR1cmVzID0gc2VsZWN0ZWRfZmVhdHVyZXMNCiAgICAgICAgcHJpbnQoZiJcbkZpbmFsIG51bWJlciBvZiBzZWxlY3RlZCBmZWF0dXJlczoge2xlbihzZWxmLnNlbGVjdGVkX2ZlYXR1cmVzKX0iKQ0KICAgICAgICBwcmludChmIlNlbGVjdGVkIGZlYXR1cmVzOiB7c2VsZi5zZWxlY3RlZF9mZWF0dXJlc30iKQ0KICAgICAgICANCiAgICAgICAgIyBTYXZlIGZlYXR1cmUgc2VsZWN0aW9uIHJlc3VsdHMNCiAgICAgICAgcmVzdWx0c19kaWN0ID0gew0KICAgICAgICAgICAgJ3NlbGVjdGVkX2ZlYXR1cmVzJzogc2VsZi5zZWxlY3RlZF9mZWF0dXJlcywNCiAgICAgICAgICAgICdmZWF0dXJlX3NlbGVjdGlvbl9tZXRob2RzJzogc2VsZi5mZWF0dXJlX3NlbGVjdGlvbl9tZXRob2RzLA0KICAgICAgICAgICAgJ3NlbGVjdGVkX2ZlYXR1cmVzX29mX2VhY2hfbWV0aG9kJzogc2VsZWN0ZWRfZmVhdHVyZXNfb2ZfZWFjaF9tZXRob2QNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9kaXIsICdmZWF0dXJlX3NlbGVjdGlvbl9yZXN1bHRzLmpzb24nKSwgJ3cnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOg0KICAgICAgICAgICAganNvbi5kdW1wKHJlc3VsdHNfZGljdCwgZiwgZW5zdXJlX2FzY2lpPUZhbHNlLCBpbmRlbnQ9NCkNCiAgICAgICAgDQogICAgICAgIHJldHVybiBzZWxmDQoNCiAgICBkZWYgbW9kZWxpbmcoc2VsZikgLT4gJ01vZGVsaW5nJzoNCiAgICAgICAgIiIiDQogICAgICAgIFRyYWluIG1hY2hpbmUgbGVhcm5pbmcgbW9kZWxzDQogICAgICAgIA0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgTW9kZWxpbmc6IFNlbGYgaW5zdGFuY2UgZm9yIG1ldGhvZCBjaGFpbmluZw0KICAgICAgICAiIiINCiAgICAgICAgIyBVc2UgZGlyZWN0IG1vZGVsIGltcG9ydCBpbnN0ZWFkIG9mIGZhY3RvcnkgcGF0dGVybg0KICAgICAgICByZXN1bHRzID0gew0KICAgICAgICAgICAgJ3RyYWluJzoge30sDQogICAgICAgICAgICAndGVzdCc6IHt9DQogICAgICAgIH0NCiAgICAgICAgbW9kZWxzID0ge30NCiAgICAgICAgDQogICAgICAgICMgSXRlcmF0ZSB0aHJvdWdoIG1vZGVscyBpbiBjb25maWd1cmF0aW9uDQogICAgICAgIGZvciBtb2RlbF9uYW1lLCBtb2RlbF9jb25maWcgaW4gc2VsZi5jb25maWcuZ2V0KCdtb2RlbHMnLCB7fSkuaXRlbXMoKToNCiAgICAgICAgICAgIHByaW50KGYiXG5UcmFpbmluZyBtb2RlbDoge21vZGVsX25hbWV9IikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBDcmVhdGUgbW9kZWwNCiAgICAgICAgICAgIG1vZGVsID0gTW9kZWxGYWN0b3J5LmNyZWF0ZV9tb2RlbChtb2RlbF9uYW1lLCBtb2RlbF9jb25maWcpDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgR2V0IGZlYXR1cmUgZGF0YQ0KICAgICAgICAgICAgWF90cmFpbiA9IHNlbGYueF90cmFpbltzZWxmLnNlbGVjdGVkX2ZlYXR1cmVzXQ0KICAgICAgICAgICAgWF90ZXN0ID0gc2VsZi54X3Rlc3Rbc2VsZi5zZWxlY3RlZF9mZWF0dXJlc10NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBUcmFpbiBtb2RlbA0KICAgICAgICAgICAgbW9kZWwuZml0KFhfdHJhaW4sIHNlbGYueV90cmFpbikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBTYXZlIG1vZGVsIG9iamVjdA0KICAgICAgICAgICAgbW9kZWxzW21vZGVsX25hbWVdID0gbW9kZWwNCiAgICAgICAgDQogICAgICAgICMgU2F2ZSByZXN1bHRzIGFuZCBtb2RlbHMNCiAgICAgICAgc2VsZi5yZXN1bHRzID0gcmVzdWx0cw0KICAgICAgICBzZWxmLm1vZGVscyA9IG1vZGVscw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHNlbGYNCiAgICAgICAgDQogICAgZGVmIGV2YWx1YXRlX21vZGVscyhzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgRXZhbHVhdGUgbW9kZWxzLCB2aXN1YWxpemUgcmVzdWx0cywgYW5kIHNhdmUgZXZhbHVhdGlvbiByZXN1bHRzDQogICAgICAgIA0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgTW9kZWxpbmc6IFNlbGYgaW5zdGFuY2UgZm9yIG1ldGhvZCBjaGFpbmluZw0KICAgICAgICAiIiINCiAgICAgICAgIyBDcmVhdGUgZXZhbHVhdG9yDQogICAgICAgIGV2YWx1YXRvciA9IE1vZGVsRXZhbHVhdG9yKHNlbGYub3V0cHV0X2RpcikNCiAgICAgICAgDQogICAgICAgICMgR2V0IGZlYXR1cmUgZGF0YQ0KICAgICAgICBYX3RyYWluID0gc2VsZi54X3RyYWluW3NlbGYuc2VsZWN0ZWRfZmVhdHVyZXNdDQogICAgICAgIFhfdGVzdCA9IHNlbGYueF90ZXN0W3NlbGYuc2VsZWN0ZWRfZmVhdHVyZXNdDQogICAgICAgIA0KICAgICAgICAjIEV2YWx1YXRlIGVhY2ggbW9kZWwNCiAgICAgICAgZm9yIG1vZGVsX25hbWUsIG1vZGVsIGluIHNlbGYubW9kZWxzLml0ZW1zKCk6DQogICAgICAgICAgICBwcmludChmIlxuRXZhbHVhdGluZyBtb2RlbDoge21vZGVsX25hbWV9IikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBFdmFsdWF0ZSBtb2RlbCAtIHRyYWluaW5nIHNldA0KICAgICAgICAgICAgdHJhaW5fcmVzdWx0cyA9IGV2YWx1YXRvci5ldmFsdWF0ZShtb2RlbCwgWF90cmFpbiwgc2VsZi55X3RyYWluLCAidHJhaW4iKQ0KICAgICAgICAgICAgc2VsZi5yZXN1bHRzWyd0cmFpbiddW21vZGVsX25hbWVdID0gdHJhaW5fcmVzdWx0cw0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIEV2YWx1YXRlIG1vZGVsIC0gdGVzdCBzZXQNCiAgICAgICAgICAgIHRlc3RfcmVzdWx0cyA9IGV2YWx1YXRvci5ldmFsdWF0ZShtb2RlbCwgWF90ZXN0LCBzZWxmLnlfdGVzdCwgInRlc3QiKQ0KICAgICAgICAgICAgc2VsZi5yZXN1bHRzWyd0ZXN0J11bbW9kZWxfbmFtZV0gPSB0ZXN0X3Jlc3VsdHMNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBQcmludCBmZWF0dXJlIGltcG9ydGFuY2UgKGlmIGF2YWlsYWJsZSkNCiAgICAgICAgICAgIGlmIGhhc2F0dHIobW9kZWwsICdnZXRfZmVhdHVyZV9pbXBvcnRhbmNlJyk6DQogICAgICAgICAgICAgICAgZmVhdHVyZV9pbXBvcnRhbmNlID0gbW9kZWwuZ2V0X2ZlYXR1cmVfaW1wb3J0YW5jZSgpDQogICAgICAgICAgICAgICAgcHJpbnQoZiJGZWF0dXJlIGltcG9ydGFuY2U6IHtmZWF0dXJlX2ltcG9ydGFuY2V9IikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBQbG90IFNIQVAgdmFsdWVzIGZvciBlYWNoIG1vZGVsDQogICAgICAgICAgICBzZWxmLnBsb3R0ZXIucGxvdF9zaGFwKG1vZGVsLCBYX3Rlc3QsIHNlbGYuc2VsZWN0ZWRfZmVhdHVyZXMsIHNhdmVfbmFtZT1vcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZGlyLCBmJ3ttb2RlbF9uYW1lfV9TSEFQLnBkZicpKQ0KICAgICAgICANCiAgICAgICAgIyBQcmludCBwZXJmb3JtYW5jZSB0YWJsZQ0KICAgICAgICBldmFsdWF0b3IuX3ByaW50X3BlcmZvcm1hbmNlX3RhYmxlKHNlbGYucmVzdWx0cykNCiAgICAgICAgDQogICAgICAgICMgUGxvdCBldmFsdWF0aW9uIHJlc3VsdHMNCiAgICAgICAgaWYgc2VsZi5pc192aXN1YWxpemU6DQogICAgICAgICAgICBldmFsdWF0b3IucGxvdF9jdXJ2ZXMoc2VsZi5yZXN1bHRzKQ0KICAgICAgICANCiAgICAgICAgIyBTYXZlIGRldGFpbGVkIHByZWRpY3Rpb24gcmVzdWx0cw0KICAgICAgICBzZWxmLl9zYXZlX3ByZWRpY3Rpb25fcmVzdWx0cygpDQogICAgICAgIA0KICAgICAgICAjIFNhdmUgdHJhaW5lZCBtb2RlbHMgYW5kIGFsbCBuZWNlc3NhcnkgcHJlcHJvY2Vzc2luZyBpbmZvcm1hdGlvbg0KICAgICAgICBpZiBzZWxmLmlzX3NhdmVfbW9kZWw6DQogICAgICAgICAgICBzZWxmLl9zYXZlX2NvbXBsZXRlX21vZGVscygpDQogICAgICAgIA0KICAgICAgICByZXR1cm4gc2VsZg0KDQogICAgZGVmIF9zYXZlX3ByZWRpY3Rpb25fcmVzdWx0cyhzZWxmKSAtPiBOb25lOg0KICAgICAgICAiIiINCiAgICAgICAgU2F2ZSBkZXRhaWxlZCBwcmVkaWN0aW9uIHJlc3VsdHMgdG8gQ1NWIGZpbGVzDQogICAgICAgICIiIg0KICAgICAgICAjIENyZWF0ZSBjbGVhbiBkYXRhZnJhbWVzIGZvciByZXN1bHRzIHdpdGggb25seSBlc3NlbnRpYWwgY29sdW1ucw0KICAgICAgICB0cmFpbl9kZiA9IHBkLkRhdGFGcmFtZSh7c2VsZi5zdWJqZWN0X2lkX2NvbDogc2VsZi5kYXRhX3RyYWluLmluZGV4fSkNCiAgICAgICAgdGVzdF9kZiA9IHBkLkRhdGFGcmFtZSh7c2VsZi5zdWJqZWN0X2lkX2NvbDogc2VsZi5kYXRhX3Rlc3QuaW5kZXh9KQ0KICAgICAgICANCiAgICAgICAgIyBBZGQgdHJ1ZSBsYWJlbHMNCiAgICAgICAgdHJhaW5fZGZbJ3RydWVfbGFiZWwnXSA9IHNlbGYueV90cmFpbi52YWx1ZXMNCiAgICAgICAgdGVzdF9kZlsndHJ1ZV9sYWJlbCddID0gc2VsZi55X3Rlc3QudmFsdWVzDQogICAgICAgIA0KICAgICAgICAjIEFkZCBwcmVkaWN0aW9ucyBhbmQgcHJvYmFiaWxpdGllcyBmb3IgZWFjaCBtb2RlbA0KICAgICAgICBmb3IgbW9kZWxfbmFtZSBpbiBzZWxmLnJlc3VsdHNbJ3RyYWluJ10ua2V5cygpOg0KICAgICAgICAgICAgIyBUcmFpbmluZyBzZXQgcmVzdWx0cw0KICAgICAgICAgICAgdHJhaW5fZGZbZid7bW9kZWxfbmFtZX1fcHJlZCddID0gc2VsZi5yZXN1bHRzWyd0cmFpbiddW21vZGVsX25hbWVdWyd5X3ByZWQnXQ0KICAgICAgICAgICAgdHJhaW5fZGZbZid7bW9kZWxfbmFtZX1fcHJvYiddID0gc2VsZi5yZXN1bHRzWyd0cmFpbiddW21vZGVsX25hbWVdWyd5X3ByZWRfcHJvYmEnXQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFRlc3Rpbmcgc2V0IHJlc3VsdHMNCiAgICAgICAgICAgIHRlc3RfZGZbZid7bW9kZWxfbmFtZX1fcHJlZCddID0gc2VsZi5yZXN1bHRzWyd0ZXN0J11bbW9kZWxfbmFtZV1bJ3lfcHJlZCddDQogICAgICAgICAgICB0ZXN0X2RmW2Yne21vZGVsX25hbWV9X3Byb2InXSA9IHNlbGYucmVzdWx0c1sndGVzdCddW21vZGVsX25hbWVdWyd5X3ByZWRfcHJvYmEnXQ0KICAgICAgICANCiAgICAgICAgIyBTYXZlIGFsbC1pbi1vbmUgcmVzdWx0cyB3aXRoIGJvdGggdHJhaW5pbmcgYW5kIHRlc3RpbmcgZGF0YQ0KICAgICAgICBhbGxfZGYgPSBwZC5jb25jYXQoW3RyYWluX2RmLCB0ZXN0X2RmXSkNCiAgICAgICAgIyBBZGQgYSBjb2x1bW4gdG8gZGlzdGluZ3Vpc2ggdHJhaW4gYW5kIHRlc3Qgc2FtcGxlcw0KICAgICAgICBhbGxfZGZbJ3NwbGl0J10gPSBbJ3RyYWluJ10gKiBsZW4odHJhaW5fZGYpICsgWyd0ZXN0J10gKiBsZW4odGVzdF9kZikNCiAgICAgICAgDQogICAgICAgIGFsbF9yZXN1bHRzX3BhdGggPSBvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZGlyLCAnYWxsX3ByZWRpY3Rpb25fcmVzdWx0cy5jc3YnKQ0KICAgICAgICBhbGxfZGYudG9fY3N2KGFsbF9yZXN1bHRzX3BhdGgsIGluZGV4PUZhbHNlKQ0KICAgICAgICBwcmludChmIlNhdmVkIGNvbXBsZXRlIHByZWRpY3Rpb24gcmVzdWx0cyB0bzoge2FsbF9yZXN1bHRzX3BhdGh9IikNCiAgICANCiAgICBkZWYgX3NhdmVfY29tcGxldGVfbW9kZWxzKHNlbGYpIC0+IE5vbmU6DQogICAgICAgICIiIg0KICAgICAgICBTYXZlIHRyYWluZWQgbW9kZWxzIGFuZCBhbGwgbmVjZXNzYXJ5IHByZXByb2Nlc3NpbmcgaW5mb3JtYXRpb24NCiAgICAgICAgIiIiDQogICAgICAgIGltcG9ydCBwaWNrbGUNCiAgICAgICAgDQogICAgICAgICMgQ3JlYXRlIGEgZGljdGlvbmFyeSB3aXRoIGFsbCBpbmZvcm1hdGlvbiBuZWVkZWQgZm9yIGZ1dHVyZSBwcmVkaWN0aW9ucw0KICAgICAgICBtb2RlbF9wYWNrYWdlID0gew0KICAgICAgICAgICAgJ21vZGVscyc6IHNlbGYubW9kZWxzLA0KICAgICAgICAgICAgJ3NjYWxlcic6IHNlbGYuc2NhbGVyLA0KICAgICAgICAgICAgJ3NjYWxlcl9mZWF0dXJlX25hbWVzJzogc2VsZi5zY2FsZXJfZmVhdHVyZV9uYW1lcywgICMgU2F2ZSBmZWF0dXJlIG5hbWVzIHVzZWQgZHVyaW5nIHNjYWxpbmcNCiAgICAgICAgICAgICdzZWxlY3RlZF9mZWF0dXJlcyc6IHNlbGYuc2VsZWN0ZWRfZmVhdHVyZXMsDQogICAgICAgICAgICAnY29uZmlnJzogc2VsZi5jb25maWcsDQogICAgICAgICAgICAncHJlcHJvY2Vzc2luZ19pbmZvJzogew0KICAgICAgICAgICAgICAgICdzdWJqZWN0X2lkX2NvbCc6IHNlbGYuc3ViamVjdF9pZF9jb2wsDQogICAgICAgICAgICAgICAgJ2xhYmVsX2NvbCc6IHNlbGYubGFiZWxfY29sLA0KICAgICAgICAgICAgICAgICdmZWF0dXJlX3NlbGVjdGlvbnMnOiBzZWxmLmZlYXR1cmVfc2VsZWN0aW9uX21ldGhvZHMsDQogICAgICAgICAgICAgICAgJ25vcm1hbGl6YXRpb24nOiBzZWxmLnNjYWxlcg0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICAjIFNhdmUgdGhlIGNvbXBsZXRlIG1vZGVsIHBhY2thZ2UNCiAgICAgICAgbW9kZWxfcGFja2FnZV9wYXRoID0gb3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2RpciwgJ21vZGVsX3BhY2thZ2UucGtsJykNCiAgICAgICAgd2l0aCBvcGVuKG1vZGVsX3BhY2thZ2VfcGF0aCwgJ3diJykgYXMgZjoNCiAgICAgICAgICAgIHBpY2tsZS5kdW1wKG1vZGVsX3BhY2thZ2UsIGYpDQogICAgICAgIA0KICAgICAgICBwcmludChmIlNhdmVkIGNvbXBsZXRlIG1vZGVsIHBhY2thZ2UgdG86IHttb2RlbF9wYWNrYWdlX3BhdGh9IikNCiAgICAgICAgDQogICAgICAgICMgUHJlcGFyZSBtb2RlbCBuYW1lcyBsaXN0IGZvciB1c2FnZSBpbnN0cnVjdGlvbnMNCiAgICAgICAgbW9kZWxfbmFtZXNfbGlzdCA9ICdcbicuam9pbihbZiItIHtuYW1lfSIgZm9yIG5hbWUgaW4gc2VsZi5tb2RlbHMua2V5cygpXSkNCiAgICAgICAgDQogICAgICAgICMgU2F2ZSB1c2FnZSBpbnN0cnVjdGlvbnMgYXMgYSB0ZXh0IGZpbGUNCiAgICAgICAgdXNhZ2VfaW5zdHJ1Y3Rpb25zID0gZiIiIg0KICAgICAgICBNb2RlbCBVc2FnZSBJbnN0cnVjdGlvbnMNCiAgICAgICAgPT09PT09PT09PT09PT09PT09PT09PT0NCg0KICAgICAgICBUaGlzIGRpcmVjdG9yeSBjb250YWlucyB0cmFpbmVkIG1vZGVscyBhbmQgYWxsIG5lY2Vzc2FyeSBpbmZvcm1hdGlvbiBmb3IgbWFraW5nIG5ldyBwcmVkaWN0aW9ucy4NCiAgICAgICAgSGVyZSdzIGhvdyB0byB1c2UgdGhlIHNhdmVkIG1vZGVsczoNCg0KICAgICAgICAxLiBMb2FkIHRoZSBtb2RlbCBwYWNrYWdlOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgaW1wb3J0IHBpY2tsZQ0KICAgICAgICB3aXRoIG9wZW4oJ21vZGVsX3BhY2thZ2UucGtsJywgJ3JiJykgYXMgZjoNCiAgICAgICAgICAgIG1vZGVsX3BhY2thZ2UgPSBwaWNrbGUubG9hZChmKQ0KICAgICAgICBgYGANCg0KICAgICAgICAyLiBFeHRyYWN0IGNvbXBvbmVudHM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBtb2RlbHMgPSBtb2RlbF9wYWNrYWdlWydtb2RlbHMnXQ0KICAgICAgICBzY2FsZXIgPSBtb2RlbF9wYWNrYWdlWydzY2FsZXInXQ0KICAgICAgICBzY2FsZXJfZmVhdHVyZV9uYW1lcyA9IG1vZGVsX3BhY2thZ2VbJ3NjYWxlcl9mZWF0dXJlX25hbWVzJ10NCiAgICAgICAgc2VsZWN0ZWRfZmVhdHVyZXMgPSBtb2RlbF9wYWNrYWdlWydzZWxlY3RlZF9mZWF0dXJlcyddDQogICAgICAgIHByZXByb2Nlc3NpbmdfaW5mbyA9IG1vZGVsX3BhY2thZ2VbJ3ByZXByb2Nlc3NpbmdfaW5mbyddDQogICAgICAgIGBgYA0KDQogICAgICAgIDMuIFByZXByb2Nlc3MgbmV3IGRhdGE6DQogICAgICAgIC0gRW5zdXJlIHlvdXIgZGF0YSBpbmNsdWRlcyBhbGwgZmVhdHVyZXMgdXNlZCBkdXJpbmcgdHJhaW5pbmcNCiAgICAgICAgLSBBcHBseSB0aGUgc2FtZSBwcmVwcm9jZXNzaW5nIChzY2FsaW5nKSB1c2luZyB0aGUgc2FmZV90cmFuc2Zvcm0gZnVuY3Rpb246DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICBkZWYgc2FmZV90cmFuc2Zvcm0oc2NhbGVyLCBkYXRhLCBzY2FsZXJfZmVhdHVyZV9uYW1lcyk6DQogICAgICAgICAgICAnJycNCiAgICAgICAgICAgIEFwcGx5IHNjYWxpbmcgb25seSB0byBjb2x1bW5zIHRoYXQgd2VyZSBwcmVzZW50IGR1cmluZyBmaXQNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgQXJnczoNCiAgICAgICAgICAgICAgICBzY2FsZXI6IFRyYWluZWQgc2NhbGVyIG9iamVjdA0KICAgICAgICAgICAgICAgIGRhdGE6IERhdGFGcmFtZSB0byB0cmFuc2Zvcm0NCiAgICAgICAgICAgICAgICBzY2FsZXJfZmVhdHVyZV9uYW1lczogRmVhdHVyZSBuYW1lcyB1c2VkIGR1cmluZyBzY2FsZXIgZml0DQogICAgICAgICAgICAnJycNCiAgICAgICAgICAgICMgR2V0IGNvbW1vbiBjb2x1bW5zIGJldHdlZW4gZGF0YSBhbmQgc2NhbGVyIGZlYXR1cmVzDQogICAgICAgICAgICBjb21tb25fY29scyA9IFtjb2wgZm9yIGNvbCBpbiBzY2FsZXJfZmVhdHVyZV9uYW1lcyBpZiBjb2wgaW4gZGF0YS5jb2x1bW5zXQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIEdldCBtaXNzaW5nIGNvbHVtbnMNCiAgICAgICAgICAgIG1pc3NpbmdfY29scyA9IFtjb2wgZm9yIGNvbCBpbiBzY2FsZXJfZmVhdHVyZV9uYW1lcyBpZiBjb2wgbm90IGluIGRhdGEuY29sdW1uc10NCiAgICAgICAgICAgIGlmIG1pc3NpbmdfY29sczoNCiAgICAgICAgICAgICAgICBwcmludChmIldhcm5pbmc6IE1pc3NpbmcgY29sdW1ucyBpbiBuZXcgZGF0YToge3ttaXNzaW5nX2NvbHN9fSIpDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgVHJhbnNmb3JtIG9ubHkgdGhlIGNvbHVtbnMgdGhhdCB3ZXJlIHByZXNlbnQgZHVyaW5nIGZpdA0KICAgICAgICAgICAgaWYgY29tbW9uX2NvbHM6DQogICAgICAgICAgICAgICAgZGF0YV90b190cmFuc2Zvcm0gPSBkYXRhW2NvbW1vbl9jb2xzXS5jb3B5KCkNCiAgICAgICAgICAgICAgICBkYXRhX3RyYW5zZm9ybWVkID0gc2NhbGVyLnRyYW5zZm9ybShkYXRhX3RvX3RyYW5zZm9ybSkNCiAgICAgICAgICAgICAgICByZXN1bHQgPSBkYXRhLmNvcHkoKQ0KICAgICAgICAgICAgICAgIHJlc3VsdFtjb21tb25fY29sc10gPSBkYXRhX3RyYW5zZm9ybWVkDQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdA0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBwcmludCgiTm8gY29tbW9uIGNvbHVtbnMgZm91bmQgZm9yIHRyYW5zZm9ybWF0aW9uIikNCiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YQ0KDQogICAgICAgICMgVHJhbnNmb3JtIHRoZSBuZXcgZGF0YSBzYWZlbHkNCiAgICAgICAgWF9uZXdfc2NhbGVkID0gc2FmZV90cmFuc2Zvcm0oc2NhbGVyLCB5b3VyX2RhdGEsIHNjYWxlcl9mZWF0dXJlX25hbWVzKQ0KDQogICAgICAgICMgRmlsdGVyIHRvIG9ubHkgaW5jbHVkZSBzZWxlY3RlZCBmZWF0dXJlcyBmb3IgcHJlZGljdGlvbg0KICAgICAgICBYX25ld19zZWxlY3RlZCA9IFhfbmV3X3NjYWxlZFtzZWxlY3RlZF9mZWF0dXJlc10NCiAgICAgICAgYGBgDQoNCiAgICAgICAgNC4gTWFrZSBwcmVkaWN0aW9ucyB3aXRoIG9uZSBvciBtb3JlIG1vZGVsczoNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgICMgQ2hvb3NlIGEgbW9kZWwgKGUuZy4sIExvZ2lzdGljUmVncmVzc2lvbikNCiAgICAgICAgbW9kZWwgPSBtb2RlbHNbJ0xvZ2lzdGljUmVncmVzc2lvbiddDQoNCiAgICAgICAgIyBNYWtlIHByZWRpY3Rpb25zDQogICAgICAgIHByZWRpY3Rpb25zID0gbW9kZWwucHJlZGljdChYX25ld19zZWxlY3RlZCkNCiAgICAgICAgcHJvYmFiaWxpdGllcyA9IG1vZGVsLnByZWRpY3RfcHJvYmEoWF9uZXdfc2VsZWN0ZWQpWzosIDFdICAjIFByb2JhYmlsaXR5IG9mIHBvc2l0aXZlIGNsYXNzDQogICAgICAgIGBgYA0KDQogICAgICAgIDUuIEF2YWlsYWJsZSBtb2RlbHM6DQogICAgICAgIHttb2RlbF9uYW1lc19saXN0fQ0KDQogICAgICAgIDYuIENvbW1hbmQtbGluZSBwcmVkaWN0aW9uOg0KICAgICAgICBZb3UgY2FuIGFsc28gdXNlIHRoZSBjb21tYW5kLWxpbmUgaW50ZXJmYWNlIGZvciBwcmVkaWN0aW9uczoNCiAgICAgICAgYGBgDQogICAgICAgIHB5dGhvbiBkYXlfMTBfd2hvbGVfY29kZS5weSAtLW1vZGUgcHJlZGljdCAtLW1vZGVsIHttb2RlbF9wYWNrYWdlX3BhdGh9IC0tZGF0YSB5b3VyX2RhdGEuY3N2DQogICAgICAgIGBgYA0KICAgICAgICAiIiINCg0KICAgICAgICAjIFNhdmUgdXNhZ2UgaW5zdHJ1Y3Rpb25zDQogICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZGlyLCAnbW9kZWxfdXNhZ2VfaW5zdHJ1Y3Rpb25zLnR4dCcpLCAndycpIGFzIGY6DQogICAgICAgICAgICBmLndyaXRlKHVzYWdlX2luc3RydWN0aW9ucykNCiAgICAgICAgICAgIA0KICAgIGRlZiBwcmVkaWN0X25ld19kYXRhKHNlbGYsIG5ld19kYXRhOiBwZC5EYXRhRnJhbWUsIG1vZGVsX25hbWU6IHN0ciA9IE5vbmUpIC0+IHBkLkRhdGFGcmFtZToNCiAgICAgICAgIiIiDQogICAgICAgIEFwcGx5IHRyYWluZWQgbW9kZWwgdG8gbmV3IGRhdGENCiAgICAgICAgDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBuZXdfZGF0YSAocGQuRGF0YUZyYW1lKTogTmV3IGRhdGEgZm9yIHByZWRpY3Rpb24NCiAgICAgICAgICAgIG1vZGVsX25hbWUgKHN0ciwgb3B0aW9uYWwpOiBOYW1lIG9mIG1vZGVsIHRvIHVzZS4gSWYgTm9uZSwgdXNlIGFsbCBtb2RlbHMuDQogICAgICAgICAgICANCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIHBkLkRhdGFGcmFtZTogRGF0YWZyYW1lIHdpdGggcHJlZGljdGlvbnMgKG9ubHkgZXNzZW50aWFsIGNvbHVtbnMpDQogICAgICAgICIiIg0KICAgICAgICAjIENoZWNrIGlmIHRoZSBtb2RlbHMgYXJlIGF2YWlsYWJsZQ0KICAgICAgICBpZiBub3QgaGFzYXR0cihzZWxmLCAnbW9kZWxzJyk6DQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJObyB0cmFpbmVkIG1vZGVscyBhdmFpbGFibGUuIFJ1biB0aGUgbW9kZWxpbmcgcGlwZWxpbmUgZmlyc3QuIikNCiAgICAgICAgDQogICAgICAgICMgQ3JlYXRlIGEgbmV3IERhdGFGcmFtZSB3aXRoIG9ubHkgbmVjZXNzYXJ5IGNvbHVtbnMNCiAgICAgICAgaWYgc2VsZi5zdWJqZWN0X2lkX2NvbCBpbiBuZXdfZGF0YS5jb2x1bW5zOg0KICAgICAgICAgICAgIyBJRCBpcyBhIGNvbHVtbg0KICAgICAgICAgICAgcmVzdWx0X2RmID0gcGQuRGF0YUZyYW1lKHtzZWxmLnN1YmplY3RfaWRfY29sOiBuZXdfZGF0YVtzZWxmLnN1YmplY3RfaWRfY29sXX0pDQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShuZXdfZGF0YS5pbmRleCwgcGQuSW5kZXgpIGFuZCBuZXdfZGF0YS5pbmRleC5uYW1lID09IHNlbGYuc3ViamVjdF9pZF9jb2w6DQogICAgICAgICAgICAjIElEIGlzIHRoZSBpbmRleA0KICAgICAgICAgICAgcmVzdWx0X2RmID0gcGQuRGF0YUZyYW1lKHtzZWxmLnN1YmplY3RfaWRfY29sOiBuZXdfZGF0YS5pbmRleH0pDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICAjIENyZWF0ZSBudW1lcmljYWwgSURzDQogICAgICAgICAgICBwcmludChmIldhcm5pbmc6IFN1YmplY3QgSUQgY29sdW1uICd7c2VsZi5zdWJqZWN0X2lkX2NvbH0nIG5vdCBmb3VuZC4gVXNpbmcgcm93IG51bWJlcnMuIikNCiAgICAgICAgICAgIHJlc3VsdF9kZiA9IHBkLkRhdGFGcmFtZSh7c2VsZi5zdWJqZWN0X2lkX2NvbDogcmFuZ2UobGVuKG5ld19kYXRhKSl9KQ0KICAgICAgICANCiAgICAgICAgIyBBZGQgdHJ1ZSBsYWJlbCBpZiBhdmFpbGFibGUNCiAgICAgICAgaWYgc2VsZi5sYWJlbF9jb2wgaW4gbmV3X2RhdGEuY29sdW1uczoNCiAgICAgICAgICAgIHJlc3VsdF9kZltzZWxmLmxhYmVsX2NvbF0gPSBuZXdfZGF0YVtzZWxmLmxhYmVsX2NvbF0NCiAgICAgICAgDQogICAgICAgICMgUmVtb3ZlIGxhYmVsIGNvbHVtbiBmb3IgcHJvY2Vzc2luZw0KICAgICAgICBYX25ldyA9IG5ld19kYXRhLmRyb3AoW3NlbGYubGFiZWxfY29sXSwgYXhpcz0xKSBpZiBzZWxmLmxhYmVsX2NvbCBpbiBuZXdfZGF0YS5jb2x1bW5zIGVsc2UgbmV3X2RhdGEuY29weSgpDQogICAgICAgIA0KICAgICAgICAjIEFwcGx5IHNjYWxpbmcgc2FmZWx5IC0gb25seSB0byBjb2x1bW5zIHRoYXQgd2VyZSBwcmVzZW50IGR1cmluZyBmaXQNCiAgICAgICAgZGVmIHNhZmVfdHJhbnNmb3JtKGRhdGEpOg0KICAgICAgICAgICAgIyBHZXQgY29tbW9uIGNvbHVtbnMgYmV0d2VlbiBkYXRhIGFuZCBzY2FsZXIgZmVhdHVyZXMNCiAgICAgICAgICAgIGNvbW1vbl9jb2xzID0gW2NvbCBmb3IgY29sIGluIHNlbGYuc2NhbGVyX2ZlYXR1cmVfbmFtZXMgaWYgY29sIGluIGRhdGEuY29sdW1uc10NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBHZXQgbWlzc2luZyBjb2x1bW5zDQogICAgICAgICAgICBtaXNzaW5nX2NvbHMgPSBbY29sIGZvciBjb2wgaW4gc2VsZi5zY2FsZXJfZmVhdHVyZV9uYW1lcyBpZiBjb2wgbm90IGluIGRhdGEuY29sdW1uc10NCiAgICAgICAgICAgIGlmIG1pc3NpbmdfY29sczoNCiAgICAgICAgICAgICAgICBwcmludChmIldhcm5pbmc6IE1pc3NpbmcgY29sdW1ucyBpbiBuZXcgZGF0YToge21pc3NpbmdfY29sc30iKQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFRyYW5zZm9ybSBvbmx5IHRoZSBjb2x1bW5zIHRoYXQgd2VyZSBwcmVzZW50IGR1cmluZyBmaXQNCiAgICAgICAgICAgIGlmIGNvbW1vbl9jb2xzOg0KICAgICAgICAgICAgICAgIGRhdGFfdG9fdHJhbnNmb3JtID0gZGF0YVtjb21tb25fY29sc10uY29weSgpDQogICAgICAgICAgICAgICAgZGF0YV90cmFuc2Zvcm1lZCA9IHNlbGYuc2NhbGVyLnRyYW5zZm9ybShkYXRhX3RvX3RyYW5zZm9ybSkNCiAgICAgICAgICAgICAgICByZXN1bHQgPSBkYXRhLmNvcHkoKQ0KICAgICAgICAgICAgICAgIHJlc3VsdFtjb21tb25fY29sc10gPSBkYXRhX3RyYW5zZm9ybWVkDQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdA0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBwcmludCgiTm8gY29tbW9uIGNvbHVtbnMgZm91bmQgZm9yIHRyYW5zZm9ybWF0aW9uIikNCiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YQ0KICAgICAgICANCiAgICAgICAgIyBTY2FsZSB0aGUgZGF0YQ0KICAgICAgICBYX25ld19zY2FsZWQgPSBzYWZlX3RyYW5zZm9ybShYX25ldykNCiAgICAgICAgDQogICAgICAgICMgQ2hlY2sgZm9yIG1pc3Npbmcgc2VsZWN0ZWQgZmVhdHVyZXMNCiAgICAgICAgbWlzc2luZ19mZWF0dXJlcyA9IFtmIGZvciBmIGluIHNlbGYuc2VsZWN0ZWRfZmVhdHVyZXMgaWYgZiBub3QgaW4gWF9uZXdfc2NhbGVkLmNvbHVtbnNdDQogICAgICAgIGlmIG1pc3NpbmdfZmVhdHVyZXM6DQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTWlzc2luZyBmZWF0dXJlcyBpbiBuZXcgZGF0YToge21pc3NpbmdfZmVhdHVyZXN9IikNCiAgICAgICAgDQogICAgICAgICMgRmlsdGVyIHRvIHNlbGVjdGVkIGZlYXR1cmVzIG9ubHkNCiAgICAgICAgWF9uZXdfc2VsZWN0ZWQgPSBYX25ld19zY2FsZWRbc2VsZi5zZWxlY3RlZF9mZWF0dXJlc10NCiAgICAgICAgDQogICAgICAgICMgR2V0IG1vZGVscyB0byB1c2UNCiAgICAgICAgbW9kZWxzX3RvX3VzZSA9IHttb2RlbF9uYW1lOiBzZWxmLm1vZGVsc1ttb2RlbF9uYW1lXX0gaWYgbW9kZWxfbmFtZSBlbHNlIHNlbGYubW9kZWxzDQogICAgICAgIA0KICAgICAgICAjIE1ha2UgcHJlZGljdGlvbnMgd2l0aCBlYWNoIG1vZGVsDQogICAgICAgIGZvciBuYW1lLCBtb2RlbCBpbiBtb2RlbHNfdG9fdXNlLml0ZW1zKCk6DQogICAgICAgICAgICAjIFByZWRpY3QgY2xhc3MNCiAgICAgICAgICAgIHlfcHJlZCA9IG1vZGVsLnByZWRpY3QoWF9uZXdfc2VsZWN0ZWQpDQogICAgICAgICAgICByZXN1bHRfZGZbZid7bmFtZX1fcHJlZCddID0geV9wcmVkDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgUHJlZGljdCBwcm9iYWJpbGl0eQ0KICAgICAgICAgICAgaWYgaGFzYXR0cihtb2RlbCwgJ3ByZWRpY3RfcHJvYmEnKToNCiAgICAgICAgICAgICAgICB5X3ByZWRfcHJvYmEgPSBtb2RlbC5wcmVkaWN0X3Byb2JhKFhfbmV3X3NlbGVjdGVkKVs6LCAxXQ0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICB5X3ByZWRfcHJvYmEgPSBtb2RlbC5kZWNpc2lvbl9mdW5jdGlvbihYX25ld19zZWxlY3RlZCkNCiAgICAgICAgICAgICAgICAjIENvbnZlcnQgZGVjaXNpb24gZnVuY3Rpb24gdmFsdWVzIHRvIHByb2JhYmlsaXRpZXMNCiAgICAgICAgICAgICAgICB5X3ByZWRfcHJvYmEgPSAxIC8gKDEgKyBucC5leHAoLXlfcHJlZF9wcm9iYSkpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICByZXN1bHRfZGZbZid7bmFtZX1fcHJvYiddID0geV9wcmVkX3Byb2JhDQogICAgICAgIA0KICAgICAgICByZXR1cm4gcmVzdWx0X2RmDQoNCiAgICBAc3RhdGljbWV0aG9kDQogICAgZGVmIGxvYWRfYW5kX3ByZWRpY3QobW9kZWxfZmlsZV9wYXRoOiBzdHIsIG5ld19kYXRhOiBwZC5EYXRhRnJhbWUsIG1vZGVsX25hbWU6IHN0ciA9IE5vbmUsIA0KICAgICAgICAgICAgICAgICAgICAgICAgb3V0cHV0X2Rpcjogc3RyID0gTm9uZSwgZXZhbHVhdGU6IGJvb2wgPSBGYWxzZSkgLT4gcGQuRGF0YUZyYW1lOg0KICAgICAgICAiIiINCiAgICAgICAgTG9hZCBhIHNhdmVkIG1vZGVsIHBhY2thZ2UgYW5kIG1ha2UgcHJlZGljdGlvbnMgb24gbmV3IGRhdGENCiAgICAgICAgDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBtb2RlbF9maWxlX3BhdGggKHN0cik6IFBhdGggdG8gdGhlIHNhdmVkIG1vZGVsIHBhY2thZ2UgKC5wa2wgZmlsZSkNCiAgICAgICAgICAgIG5ld19kYXRhIChwZC5EYXRhRnJhbWUpOiBOZXcgZGF0YSBmb3IgcHJlZGljdGlvbg0KICAgICAgICAgICAgbW9kZWxfbmFtZSAoc3RyLCBvcHRpb25hbCk6IE5hbWUgb2YgbW9kZWwgdG8gdXNlLiBJZiBOb25lLCB1c2UgYWxsIG1vZGVscy4NCiAgICAgICAgICAgIG91dHB1dF9kaXIgKHN0ciwgb3B0aW9uYWwpOiBEaXJlY3RvcnkgdG8gc2F2ZSBldmFsdWF0aW9uIHJlc3VsdHMgYW5kIHBsb3RzDQogICAgICAgICAgICBldmFsdWF0ZSAoYm9vbCwgb3B0aW9uYWwpOiBXaGV0aGVyIHRvIGV2YWx1YXRlIG1vZGVsIHBlcmZvcm1hbmNlIGFuZCBnZW5lcmF0ZSBwbG90cw0KICAgICAgICAgICAgDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICBwZC5EYXRhRnJhbWU6IERhdGFGcmFtZSB3aXRoIHByZWRpY3Rpb25zIChvbmx5IGVzc2VudGlhbCBjb2x1bW5zKQ0KICAgICAgICAiIiINCiAgICAgICAgIyBMb2FkIHRoZSBtb2RlbCBwYWNrYWdlDQogICAgICAgIGltcG9ydCBwaWNrbGUNCiAgICAgICAgdHJ5Og0KICAgICAgICAgICAgd2l0aCBvcGVuKG1vZGVsX2ZpbGVfcGF0aCwgJ3JiJykgYXMgZjoNCiAgICAgICAgICAgICAgICBtb2RlbF9wYWNrYWdlID0gcGlja2xlLmxvYWQoZikNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIHByaW50KGYiU3VjY2Vzc2Z1bGx5IGxvYWRlZCBtb2RlbCBwYWNrYWdlIGZyb20ge21vZGVsX2ZpbGVfcGF0aH0iKQ0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6DQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiRmFpbGVkIHRvIGxvYWQgbW9kZWwgcGFja2FnZToge2V9IikNCiAgICAgICAgDQogICAgICAgICMgRXh0cmFjdCBjb21wb25lbnRzDQogICAgICAgIG1vZGVscyA9IG1vZGVsX3BhY2thZ2UuZ2V0KCdtb2RlbHMnLCB7fSkNCiAgICAgICAgc2NhbGVyID0gbW9kZWxfcGFja2FnZS5nZXQoJ3NjYWxlcicpDQogICAgICAgIHNjYWxlcl9mZWF0dXJlX25hbWVzID0gbW9kZWxfcGFja2FnZS5nZXQoJ3NjYWxlcl9mZWF0dXJlX25hbWVzJywgW10pDQogICAgICAgIHNlbGVjdGVkX2ZlYXR1cmVzID0gbW9kZWxfcGFja2FnZS5nZXQoJ3NlbGVjdGVkX2ZlYXR1cmVzJywgW10pDQogICAgICAgIHByZXByb2Nlc3NpbmdfaW5mbyA9IG1vZGVsX3BhY2thZ2UuZ2V0KCdwcmVwcm9jZXNzaW5nX2luZm8nLCB7fSkNCiAgICAgICAgDQogICAgICAgICMgQ2hlY2sgaWYgcmVxdWlyZWQgY29tcG9uZW50cyBhcmUgYXZhaWxhYmxlDQogICAgICAgIGlmIG5vdCBtb2RlbHM6DQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJObyBtb2RlbHMgZm91bmQgaW4gdGhlIG1vZGVsIHBhY2thZ2UiKQ0KICAgICAgICBpZiBtb2RlbF9uYW1lIGFuZCBtb2RlbF9uYW1lIG5vdCBpbiBtb2RlbHM6DQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTW9kZWwgJ3ttb2RlbF9uYW1lfScgbm90IGZvdW5kIGluIHRoZSBtb2RlbCBwYWNrYWdlLiBBdmFpbGFibGUgbW9kZWxzOiB7bGlzdChtb2RlbHMua2V5cygpKX0iKQ0KICAgICAgICANCiAgICAgICAgIyBHZXQgbW9kZWxzIHRvIHVzZQ0KICAgICAgICBtb2RlbHNfdG9fdXNlID0ge21vZGVsX25hbWU6IG1vZGVsc1ttb2RlbF9uYW1lXX0gaWYgbW9kZWxfbmFtZSBlbHNlIG1vZGVscw0KICAgICAgICANCiAgICAgICAgIyBHZXQgc3ViamVjdCBJRCBhbmQgbGFiZWwgY29sdW1uIG5hbWVzDQogICAgICAgIHN1YmplY3RfaWRfY29sID0gcHJlcHJvY2Vzc2luZ19pbmZvLmdldCgnc3ViamVjdF9pZF9jb2wnLCAnc3ViaklEJykNCiAgICAgICAgbGFiZWxfY29sID0gcHJlcHJvY2Vzc2luZ19pbmZvLmdldCgnbGFiZWxfY29sJywgJ2xhYmVsJykNCiAgICAgICAgDQogICAgICAgICMgQ3JlYXRlIGEgbmV3IERhdGFGcmFtZSB3aXRoIG9ubHkgbmVjZXNzYXJ5IGNvbHVtbnMNCiAgICAgICAgaWYgc3ViamVjdF9pZF9jb2wgaW4gbmV3X2RhdGEuY29sdW1uczoNCiAgICAgICAgICAgICMgSUQgaXMgYSBjb2x1bW4NCiAgICAgICAgICAgIHJlc3VsdF9kZiA9IHBkLkRhdGFGcmFtZSh7c3ViamVjdF9pZF9jb2w6IG5ld19kYXRhW3N1YmplY3RfaWRfY29sXX0pDQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShuZXdfZGF0YS5pbmRleCwgcGQuSW5kZXgpIGFuZCBuZXdfZGF0YS5pbmRleC5uYW1lID09IHN1YmplY3RfaWRfY29sOg0KICAgICAgICAgICAgIyBJRCBpcyB0aGUgaW5kZXgNCiAgICAgICAgICAgIHJlc3VsdF9kZiA9IHBkLkRhdGFGcmFtZSh7c3ViamVjdF9pZF9jb2w6IG5ld19kYXRhLmluZGV4fSkNCiAgICAgICAgZWxzZToNCiAgICAgICAgICAgICMgQ3JlYXRlIG51bWVyaWNhbCBJRHMNCiAgICAgICAgICAgIHByaW50KGYiV2FybmluZzogU3ViamVjdCBJRCBjb2x1bW4gJ3tzdWJqZWN0X2lkX2NvbH0nIG5vdCBmb3VuZC4gVXNpbmcgcm93IG51bWJlcnMuIikNCiAgICAgICAgICAgIHJlc3VsdF9kZiA9IHBkLkRhdGFGcmFtZSh7c3ViamVjdF9pZF9jb2w6IHJhbmdlKGxlbihuZXdfZGF0YSkpfSkNCiAgICAgICAgDQogICAgICAgICMgQWRkIHRydWUgbGFiZWwgaWYgYXZhaWxhYmxlDQogICAgICAgIGlmIGxhYmVsX2NvbCBpbiBuZXdfZGF0YS5jb2x1bW5zOg0KICAgICAgICAgICAgcmVzdWx0X2RmW2xhYmVsX2NvbF0gPSBuZXdfZGF0YVtsYWJlbF9jb2xdDQogICAgICAgIA0KICAgICAgICAjIFJlbW92ZSBsYWJlbCBjb2x1bW4gaWYgcHJlc2VudCBmb3IgcHJvY2Vzc2luZw0KICAgICAgICBYX25ldyA9IG5ld19kYXRhLmRyb3AoW2xhYmVsX2NvbF0sIGF4aXM9MSkgaWYgbGFiZWxfY29sIGluIG5ld19kYXRhLmNvbHVtbnMgZWxzZSBuZXdfZGF0YS5jb3B5KCkNCiAgICAgICAgDQogICAgICAgICMgQXBwbHkgc2NhbGluZyBzYWZlbHkgLSBvbmx5IHRvIGNvbHVtbnMgdGhhdCB3ZXJlIHByZXNlbnQgZHVyaW5nIGZpdA0KICAgICAgICBkZWYgc2FmZV90cmFuc2Zvcm0oZGF0YSwgc2NhbGVyLCBmZWF0dXJlX25hbWVzKToNCiAgICAgICAgICAgIGlmIHNjYWxlciBpcyBOb25lOg0KICAgICAgICAgICAgICAgIHByaW50KCJXYXJuaW5nOiBObyBzY2FsZXIgZm91bmQgaW4gbW9kZWwgcGFja2FnZS4gU2tpcHBpbmcgc2NhbGluZyBzdGVwLiIpDQogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGENCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICMgR2V0IGNvbW1vbiBjb2x1bW5zIGJldHdlZW4gZGF0YSBhbmQgc2NhbGVyIGZlYXR1cmVzDQogICAgICAgICAgICBjb21tb25fY29scyA9IFtjb2wgZm9yIGNvbCBpbiBmZWF0dXJlX25hbWVzIGlmIGNvbCBpbiBkYXRhLmNvbHVtbnNdDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgR2V0IG1pc3NpbmcgY29sdW1ucw0KICAgICAgICAgICAgbWlzc2luZ19jb2xzID0gW2NvbCBmb3IgY29sIGluIGZlYXR1cmVfbmFtZXMgaWYgY29sIG5vdCBpbiBkYXRhLmNvbHVtbnNdDQogICAgICAgICAgICBpZiBtaXNzaW5nX2NvbHM6DQogICAgICAgICAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiBNaXNzaW5nIGNvbHVtbnMgaW4gbmV3IGRhdGE6IHttaXNzaW5nX2NvbHN9IikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBUcmFuc2Zvcm0gb25seSB0aGUgY29sdW1ucyB0aGF0IHdlcmUgcHJlc2VudCBkdXJpbmcgZml0DQogICAgICAgICAgICBpZiBjb21tb25fY29sczoNCiAgICAgICAgICAgICAgICBkYXRhX3RvX3RyYW5zZm9ybSA9IGRhdGFbY29tbW9uX2NvbHNdLmNvcHkoKQ0KICAgICAgICAgICAgICAgIGRhdGFfdHJhbnNmb3JtZWQgPSBzY2FsZXIudHJhbnNmb3JtKGRhdGFfdG9fdHJhbnNmb3JtKQ0KICAgICAgICAgICAgICAgIHJlc3VsdCA9IGRhdGEuY29weSgpDQogICAgICAgICAgICAgICAgcmVzdWx0W2NvbW1vbl9jb2xzXSA9IGRhdGFfdHJhbnNmb3JtZWQNCiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0DQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIHByaW50KCJObyBjb21tb24gY29sdW1ucyBmb3VuZCBmb3IgdHJhbnNmb3JtYXRpb24iKQ0KICAgICAgICAgICAgICAgIHJldHVybiBkYXRhDQogICAgICAgIA0KICAgICAgICAjIFNjYWxlIHRoZSBkYXRhDQogICAgICAgIFhfbmV3X3NjYWxlZCA9IHNhZmVfdHJhbnNmb3JtKFhfbmV3LCBzY2FsZXIsIHNjYWxlcl9mZWF0dXJlX25hbWVzKQ0KICAgICAgICANCiAgICAgICAgIyBDaGVjayBmb3IgbWlzc2luZyBzZWxlY3RlZCBmZWF0dXJlcw0KICAgICAgICBtaXNzaW5nX2ZlYXR1cmVzID0gW2YgZm9yIGYgaW4gc2VsZWN0ZWRfZmVhdHVyZXMgaWYgZiBub3QgaW4gWF9uZXdfc2NhbGVkLmNvbHVtbnNdDQogICAgICAgIGlmIG1pc3NpbmdfZmVhdHVyZXM6DQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTWlzc2luZyByZXF1aXJlZCBmZWF0dXJlcyBpbiBuZXcgZGF0YToge21pc3NpbmdfZmVhdHVyZXN9LiBUaGVzZSBmZWF0dXJlcyBhcmUgbmVlZGVkIGZvciBwcmVkaWN0aW9uLiIpDQogICAgICAgIA0KICAgICAgICAjIEZpbHRlciB0byBzZWxlY3RlZCBmZWF0dXJlcyBvbmx5DQogICAgICAgIFhfbmV3X3NlbGVjdGVkID0gWF9uZXdfc2NhbGVkW3NlbGVjdGVkX2ZlYXR1cmVzXQ0KICAgICAgICANCiAgICAgICAgIyBNYWtlIHByZWRpY3Rpb25zIHdpdGggZWFjaCBtb2RlbA0KICAgICAgICBmb3IgbmFtZSwgbW9kZWwgaW4gbW9kZWxzX3RvX3VzZS5pdGVtcygpOg0KICAgICAgICAgICAgIyBQcmVkaWN0IGNsYXNzDQogICAgICAgICAgICB5X3ByZWQgPSBtb2RlbC5wcmVkaWN0KFhfbmV3X3NlbGVjdGVkKQ0KICAgICAgICAgICAgcmVzdWx0X2RmW2Yne25hbWV9X3ByZWQnXSA9IHlfcHJlZA0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFByZWRpY3QgcHJvYmFiaWxpdHkNCiAgICAgICAgICAgIGlmIGhhc2F0dHIobW9kZWwsICdwcmVkaWN0X3Byb2JhJyk6DQogICAgICAgICAgICAgICAgeV9wcmVkX3Byb2JhID0gbW9kZWwucHJlZGljdF9wcm9iYShYX25ld19zZWxlY3RlZClbOiwgMV0NCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgeV9wcmVkX3Byb2JhID0gbW9kZWwuZGVjaXNpb25fZnVuY3Rpb24oWF9uZXdfc2VsZWN0ZWQpDQogICAgICAgICAgICAgICAgIyBDb252ZXJ0IGRlY2lzaW9uIGZ1bmN0aW9uIHZhbHVlcyB0byBwcm9iYWJpbGl0aWVzDQogICAgICAgICAgICAgICAgeV9wcmVkX3Byb2JhID0gMSAvICgxICsgbnAuZXhwKC15X3ByZWRfcHJvYmEpKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgcmVzdWx0X2RmW2Yne25hbWV9X3Byb2InXSA9IHlfcHJlZF9wcm9iYQ0KICAgICAgICANCiAgICAgICAgIyBJZiB0cnVlIGxhYmVscyBhcmUgYXZhaWxhYmxlIGFuZCBldmFsdWF0aW9uIGlzIHJlcXVlc3RlZA0KICAgICAgICBpZiBsYWJlbF9jb2wgaW4gbmV3X2RhdGEuY29sdW1ucyBhbmQgZXZhbHVhdGU6DQogICAgICAgICAgICAjIENyZWF0ZSBvdXRwdXQgZGlyZWN0b3J5IGlmIG5vdCBleGlzdHMNCiAgICAgICAgICAgIGlmIG91dHB1dF9kaXI6DQogICAgICAgICAgICAgICAgb3MubWFrZWRpcnMob3V0cHV0X2RpciwgZXhpc3Rfb2s9VHJ1ZSkNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgb3V0cHV0X2RpciA9IG9zLnBhdGguZGlybmFtZShtb2RlbF9maWxlX3BhdGgpDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgQ3JlYXRlIE1vZGVsRXZhbHVhdG9yIGluc3RhbmNlDQogICAgICAgICAgICBldmFsdWF0b3IgPSBNb2RlbEV2YWx1YXRvcihvdXRwdXRfZGlyKQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFByZXBhcmUgZGF0YSBmb3IgZXZhbHVhdGlvbg0KICAgICAgICAgICAgeV90cnVlID0gbmV3X2RhdGFbbGFiZWxfY29sXQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIENyZWF0ZSByZXN1bHRzIGRpY3Rpb25hcnkgaW4gdGhlIGZvcm1hdCBleHBlY3RlZCBieSBNb2RlbEV2YWx1YXRvcg0KICAgICAgICAgICAgcmVzdWx0cyA9IHsNCiAgICAgICAgICAgICAgICAndGVzdCc6IHt9LA0KICAgICAgICAgICAgICAgICd0cmFpbic6IHt9ICAjIEVtcHR5IGZvciBwcmVkaWN0aW9uIG1vZGUNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgZm9yIG5hbWUgaW4gbW9kZWxzX3RvX3VzZToNCiAgICAgICAgICAgICAgICByZXN1bHRzWyd0ZXN0J11bbmFtZV0gPSB7DQogICAgICAgICAgICAgICAgICAgICdtZXRyaWNzJzogY2FsY3VsYXRlX21ldHJpY3MoeV90cnVlLCByZXN1bHRfZGZbZid7bmFtZX1fcHJlZCddLCByZXN1bHRfZGZbZid7bmFtZX1fcHJvYiddKSwNCiAgICAgICAgICAgICAgICAgICAgJ3lfdHJ1ZSc6IHlfdHJ1ZS50b2xpc3QoKSwNCiAgICAgICAgICAgICAgICAgICAgJ3lfcHJlZCc6IHJlc3VsdF9kZltmJ3tuYW1lfV9wcmVkJ10udG9saXN0KCksDQogICAgICAgICAgICAgICAgICAgICd5X3ByZWRfcHJvYmEnOiByZXN1bHRfZGZbZid7bmFtZX1fcHJvYiddLnRvbGlzdCgpDQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFByaW50IHBlcmZvcm1hbmNlIHRhYmxlDQogICAgICAgICAgICBldmFsdWF0b3IuX3ByaW50X3BlcmZvcm1hbmNlX3RhYmxlKHJlc3VsdHMpDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgUGxvdCBldmFsdWF0aW9uIHJlc3VsdHMNCiAgICAgICAgICAgIGV2YWx1YXRvci5wbG90X2N1cnZlcyhyZXN1bHRzKQ0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJlc3VsdF9kZg0K').decode())
