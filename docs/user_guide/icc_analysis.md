# ICC分析

组内相关系数（Intraclass Correlation Coefficient, ICC）是评估放射组学特征可重复性和稳定性的重要指标。本节介绍如何使用HABIT执行ICC分析，筛选稳定的生境特征。

## 工作原理

ICC分析计算在测试-重测场景中特征的一致性。高ICC值（通常大于0.75）表示特征在不同扫描间稳定，适合于后续建模；低ICC值表示特征不稳定，容易受到噪声和扫描条件的影响。

HABIT的ICC分析支持多种数据组织方式，使用Pingouin库计算ICC值（采用双向混合效应模型，单一测量，一致性检验，对应于ICC(3,1)）。

## 使用场景

ICC分析适用于以下场景：

1. **特征筛选**：在建模前筛选稳定的特征
2. **方法评估**：评估特征提取方法的可重复性
3. **质量控制**：验证不同设备或参数设置的一致性

## 数据准备

ICC分析需要以下数据：

1. **测试-重测数据**：同一患者组在相同条件下的重复扫描
2. **特征文件**：CSV格式的特征表，每列是一个特征，每行是一个样本

数据可以通过两种方式组织：

1. **文件组方式**：将相关的特征文件分组，每组表示一个测试-重测对
2. **目录方式**：在不同目录中存放相关的特征文件，每个目录代表一组数据

## 命令行使用

### 文件组方式

```bash
python scripts/icc_analysis.py \
  --files "test1.csv,test2.csv;retest1.csv,retest2.csv" \
  --output results/icc_results.json \
  --processes 4
```

### 目录方式

```bash
python scripts/icc_analysis.py \
  --dirs "test_dir,retest_dir" \
  --output results/icc_results.json \
  --processes 4
```

### 参数说明

- **--files**：文件列表，格式为"file1.csv,file2.csv;file3.csv,file4.csv"
- **--dirs**：目录列表，格式为"dir1,dir2,dir3"
- **--processes**：并行处理的进程数（默认：4）
- **--output**：输出JSON文件路径（默认：icc_results.json）
- **--debug**：启用调试模式（可选）

## 输出结果

ICC分析完成后，您将获得以下输出：

1. **JSON文件**：包含所有特征的ICC值
2. **日志文件**：记录分析过程和统计信息

JSON文件格式示例：

```json
{
  "test_vs_retest": {
    "feature1": 0.85,
    "feature2": 0.65,
    "feature3": 0.92
  }
}
```

## 结果解读

ICC值通常按以下标准解读：

- **< 0.50**：较差的可重复性
- **0.50 - 0.75**：中等的可重复性
- **0.75 - 0.90**：良好的可重复性
- **> 0.90**：优秀的可重复性

分析完成后，程序会自动打印统计信息，包括：

- 平均ICC值
- 达到良好可重复性标准的特征百分比
- 各特征组的ICC分布

## 特征筛选建议

根据ICC分析结果，建议：

1. 优先选择ICC ≥ 0.75的特征进行后续分析
2. 对于ICC值中等的特征，可结合其他信息（如临床意义）决定是否保留
3. 避免使用ICC < 0.50的特征，因为这些特征可能主要反映噪声

## 与其他模块的结合

ICC分析通常与以下HABIT模块结合使用：

1. **测试-重测映射**：确保生境标签一致后再计算ICC
2. **特征提取**：分析不同类型特征的稳定性
3. **机器学习**：将ICC作为特征选择的一个标准

## 注意事项

1. 理想情况下，测试-重测数据应在短时间内获取，以减少生理变化的影响
2. 确保测试和重测数据使用一致的参数和处理流程
3. ICC分析要求数据格式规范，特别是行列的对应关系
4. 对于大量特征，可能需要多重比较校正来控制假阳性 