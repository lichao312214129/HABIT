# 测试-重测分析

测试-重测分析是评估生境分析可重复性的重要步骤。本节介绍如何使用HABIT的测试-重测映射器，确保在不同扫描之间保持生境标签的一致性。

## 工作原理

在测试-重测场景中，同一患者在不同时间点获得的多次扫描会产生不同的生境标签分配。这是因为聚类算法在不同数据集上训练时，会给相似的生境分配不同的标签序号。测试-重测映射器通过比较不同扫描中生境特征的相似性，将重测扫描的生境标签重新映射为与测试扫描一致的标签。

## 使用场景

测试-重测映射器适用于以下场景：

1. **重复性研究**：评估生境分析方法的稳定性
2. **纵向研究**：分析患者随时间的变化
3. **多中心研究**：协调不同中心或设备生成的生境标签

## 数据准备

使用测试-重测映射器需要准备以下数据：

1. **测试组生境特征表**：通常是从第一次扫描中提取的特征表（CSV格式）
2. **重测组生境特征表**：从第二次扫描中提取的特征表（CSV格式）
3. **重测组生境地图**：需要重新映射的生境地图文件（NRRD格式）

## 命令行使用

```bash
python scripts/habitat_test_retest_mapper.py \
  --test-habitat-table /path/to/test_features.csv \
  --retest-habitat-table /path/to/retest_features.csv \
  --input-dir /path/to/retest_habitat_maps \
  --out-dir /path/to/remapped_maps \
  --similarity-method pearson \
  --processes 4
```

### 参数说明

- **--test-habitat-table**：测试组生境特征表路径（必需）
- **--retest-habitat-table**：重测组生境特征表路径（必需）
- **--input-dir**：包含重测组生境地图的目录（必需）
- **--out-dir**：重映射后的输出目录（必需）
- **--features**：用于计算相似性的特征列表（可选）
- **--similarity-method**：相似性计算方法（默认：pearson）
  - 可选值：pearson, spearman, kendall, euclidean, cosine, manhattan, chebyshev
- **--processes**：并行处理的进程数（默认：4）
- **--debug**：启用调试模式（可选）

## 工作流程

测试-重测映射器的工作流程如下：

1. **特征比较**：计算测试组和重测组生境特征之间的相似度
2. **标签映射**：为每个重测生境找到最相似的测试生境
3. **地图重映射**：根据映射关系更新重测生境地图
4. **结果保存**：将重映射的生境地图保存到输出目录

## 输出结果

映射过程完成后，您将获得以下输出：

1. **重映射的生境地图**：文件名格式为 `{original_name}_remapped.nrrd`
2. **日志文件**：记录映射过程和映射关系

## 使用建议

### 选择相似性指标

不同的相似性指标适用于不同类型的特征：

- **pearson/spearman**：适合大多数连续特征
- **kendall**：适合有序数据
- **euclidean/manhattan**：适合需要考虑绝对距离的特征
- **cosine**：适合需要考虑角度而非幅度的特征

### 特征选择

为获得更准确的映射，建议：

1. 使用稳定性高的特征进行映射
2. 避免使用高度相关的特征
3. 可以通过ICC分析选择重复性好的特征

## 注意事项

1. 确保测试组和重测组具有相同数量的生境
2. 特征表中必须包含`Habitats`列来标识生境标签
3. 生境地图文件名格式应符合`*_habitats.nrrd`模式
4. 映射仅更改标签编号，不改变生境的空间分布 