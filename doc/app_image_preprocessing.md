# å›¾åƒé¢„å¤„ç†æ¨¡å—ä½¿ç”¨æ–‡æ¡£

## åŠŸèƒ½æ¦‚è¿°

å›¾åƒé¢„å¤„ç†æ¨¡å—å®ç°äº†ä¸€ç³»åˆ—åŒ»å­¦å›¾åƒé¢„å¤„ç†æ­¥éª¤ï¼ŒåŒ…æ‹¬é‡é‡‡æ ·ã€é…å‡†å’ŒN4åç½®åœºæ ¡æ­£ç­‰ï¼Œä¸ºåç»­çš„ç”Ÿå¢ƒåˆ†ææä¾›æ ‡å‡†åŒ–å’Œä¼˜åŒ–çš„å›¾åƒæ•°æ®ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ä½¿ç”¨CLIï¼ˆæ¨èï¼‰âœ¨

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®
habit preprocess

# ä½¿ç”¨æŒ‡å®šé…ç½®æ–‡ä»¶
habit preprocess --config config/config_image_preprocessing.yaml

# ç®€å†™å½¢å¼
habit preprocess -c config/config_image_preprocessing.yaml
```

### ä½¿ç”¨ä¼ ç»Ÿè„šæœ¬ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰

```bash
# ä½¿ç”¨æŒ‡å®šé…ç½®æ–‡ä»¶
python scripts/app_image_preprocessing.py --config ./config/config_image_preprocessing.yaml 

# ç®€å†™å½¢å¼
python scripts/app_image_preprocessing.py -c ./config/config_image_preprocessing.yaml 

# å¦‚æœä¸æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè„šæœ¬å°†ä½¿ç”¨é»˜è®¤é…ç½®æ–‡ä»¶
python scripts/app_image_preprocessing.py
```

## é…ç½®æ–‡ä»¶æ ¼å¼

`app_image_preprocessing.py` ä½¿ç”¨YAMLæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«ä»¥ä¸‹ä¸»è¦éƒ¨åˆ†ï¼š

### åŸºæœ¬é…ç½®

```yaml
# æ•°æ®è·¯å¾„
data_dir: <åŸå§‹æ•°æ®ç›®å½•è·¯å¾„>
out_dir: <è¾“å‡ºç›®å½•è·¯å¾„>

# é¢„å¤„ç†è®¾ç½®
Preprocessing:
  # é¢„å¤„ç†æ­¥éª¤é…ç½®
```

### é¢„å¤„ç†æ­¥éª¤é…ç½®

```yaml
Preprocessing:
  # é‡é‡‡æ ·é…ç½®
  resample:
    images: [<å›¾åƒ1>, <å›¾åƒ2>, ...]  # è¦é‡é‡‡æ ·çš„å›¾åƒåˆ—è¡¨
    target_spacing: [x, y, z]  # ç›®æ ‡ä½“ç´ é—´è·
    img_mode: <æ’å€¼æ¨¡å¼>  # å¯é€‰ï¼Œé»˜è®¤ä¸ºlinear
    padding_mode: <å¡«å……æ¨¡å¼>  # å¯é€‰ï¼Œé»˜è®¤ä¸ºborder
    align_corners: <æ˜¯å¦å¯¹é½è§’ç‚¹>  # å¯é€‰ï¼Œé»˜è®¤ä¸ºfalse

  # é…å‡†é…ç½®
  registration:
    images: [<å›¾åƒ1>, <å›¾åƒ2>, ...]  # è¦é…å‡†çš„å›¾åƒåˆ—è¡¨
    fixed_image: <å‚è€ƒå›¾åƒ>  # é™æ€å‚è€ƒå›¾åƒ
    moving_images: [<å›¾åƒ1>, <å›¾åƒ2>, ...]  # è¦ç§»åŠ¨çš„å›¾åƒåˆ—è¡¨
    type_of_transform: <å˜æ¢ç±»å‹>  # ä¾‹å¦‚Rigid, Affine, SyNRAç­‰
    use_mask: <æ˜¯å¦ä½¿ç”¨æ©ç >  # å¯é€‰ï¼Œé»˜è®¤ä¸ºfalse

  # N4åç½®åœºæ ¡æ­£é…ç½®
  n4_correction:
    images: [<å›¾åƒ1>, <å›¾åƒ2>, ...]  # è¦æ ¡æ­£çš„å›¾åƒåˆ—è¡¨
    num_fitting_levels: <æ‹Ÿåˆå±‚çº§æ•°>  # å¯é€‰ï¼Œé»˜è®¤ä¸º4
    num_iterations: [<è¿­ä»£æ¬¡æ•°1>, <è¿­ä»£æ¬¡æ•°2>, ...]  # å¯é€‰ï¼Œé»˜è®¤ä¸ºæ¯å±‚50æ¬¡
    convergence_threshold: <æ”¶æ•›é˜ˆå€¼>  # å¯é€‰ï¼Œé»˜è®¤ä¸º0.001
```

## æ”¯æŒçš„é¢„å¤„ç†æ­¥éª¤

### 1. é‡é‡‡æ ·ï¼ˆResamplingï¼‰

è°ƒæ•´å›¾åƒçš„ä½“ç´ é—´è·åˆ°æŒ‡å®šçš„ç›®æ ‡åˆ†è¾¨ç‡ã€‚

#### å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|-----|-----|-----|
| images | List[str] | è¦é‡é‡‡æ ·çš„å›¾åƒåˆ—è¡¨ | å¿…éœ€ |
| target_spacing | List[float] | ç›®æ ‡ä½“ç´ é—´è·ï¼ˆæ¯«ç±³ï¼‰ | å¿…éœ€ |
| img_mode | str | å›¾åƒæ’å€¼æ¨¡å¼ | "linear" |
| padding_mode | str | è¾¹ç•Œå¤–å€¼å¡«å……æ¨¡å¼ | "border" |
| align_corners | bool | æ˜¯å¦å¯¹é½è§’ç‚¹ | False |

#### æ”¯æŒçš„æ’å€¼æ¨¡å¼

- `nearest`: æœ€è¿‘é‚»æ’å€¼
- `linear`: çº¿æ€§æ’å€¼
- `bilinear`: åŒçº¿æ€§æ’å€¼ï¼ˆç­‰åŒäºlinearï¼‰
- `bspline`: Bæ ·æ¡æ’å€¼
- `bicubic`: åŒä¸‰æ¬¡æ’å€¼ï¼ˆç­‰åŒäºbsplineï¼‰
- `gaussian`: é«˜æ–¯æ’å€¼
- `lanczos`: Lanczosçª—ä¿®æ­£çš„sincæ’å€¼
- `hamming`: Hammingçª—ä¿®æ­£çš„sincæ’å€¼
- `cosine`: ä½™å¼¦çª—ä¿®æ­£çš„sincæ’å€¼
- `welch`: Welchçª—ä¿®æ­£çš„sincæ’å€¼
- `blackman`: Blackmançª—ä¿®æ­£çš„sincæ’å€¼

### 2. é…å‡†ï¼ˆRegistrationï¼‰

å°†å›¾åƒå¯¹é½åˆ°å‚è€ƒå›¾åƒï¼Œä½¿ç”¨ANTsï¼ˆé«˜çº§æ ‡å‡†åŒ–å·¥å…·ï¼‰å®ç°ã€‚

#### å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|-----|-----|-----|
| images | List[str] | è¦å¤„ç†çš„å›¾åƒåˆ—è¡¨ | å¿…éœ€ |
| fixed_image | str | å‚è€ƒå›¾åƒçš„å…³é”®å­— | å¿…éœ€ |
| moving_images | List[str] | è¦ç§»åŠ¨çš„å›¾åƒåˆ—è¡¨ | å¿…éœ€ |
| type_of_transform | str | å˜æ¢ç±»å‹ | "Rigid" |
| metric | str | ç›¸ä¼¼åº¦åº¦é‡ | "MI" |
| optimizer | str | ä¼˜åŒ–æ–¹æ³• | "gradient_descent" |
| use_mask | bool | æ˜¯å¦ä½¿ç”¨æ©ç  | False |

#### æ”¯æŒçš„å˜æ¢ç±»å‹

1. **Rigid**: ä»…å¹³ç§»å’Œæ—‹è½¬
2. **Affine**: å¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾å’Œå‰ªåˆ‡
3. **SyN**: å¯¹ç§°å½’ä¸€åŒ–ï¼ˆå¯å˜å½¢é…å‡†ï¼‰
4. **SyNRA**: SyN + Rigid + Affineï¼ˆæœ€å¸¸ç”¨ï¼‰
5. **SyNOnly**: ä¸å¸¦åˆå§‹åˆšæ€§/ä»¿å°„çš„SyN
6. **TRSAA**: å¹³ç§» + æ—‹è½¬ + ç¼©æ”¾ + ä»¿å°„
7. **Elastic**: å¼¹æ€§å˜æ¢
8. **SyNCC**: å¸¦äº¤å‰ç›¸å…³åº¦é‡çš„SyN
9. **SyNabp**: å¸¦äº’ä¿¡æ¯åº¦é‡çš„SyN
10. **SyNBold**: é’ˆå¯¹BOLDå›¾åƒä¼˜åŒ–çš„SyN
11. **SyNBoldAff**: SyN + Affine for BOLDå›¾åƒ
12. **SyNAggro**: ä½¿ç”¨æ¿€è¿›ä¼˜åŒ–çš„SyN
13. **TVMSQ**: æ—¶å˜å¾®åˆ†åŒèƒšä¸å‡æ–¹åº¦é‡

### 3. N4åç½®åœºæ ¡æ­£

æ ¡æ­£åŒ»å­¦å›¾åƒä¸­çš„å¼ºåº¦ä¸å‡åŒ€æ€§ï¼Œé€šå¸¸ç”±MRIæ‰«æä»ªä¸­çš„ç£åœºä¸å‡åŒ€æ€§å¼•èµ·ã€‚

#### å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|-----|-----|-----|
| images | List[str] | è¦æ ¡æ­£çš„å›¾åƒåˆ—è¡¨ | å¿…éœ€ |
| num_fitting_levels | int | æ‹Ÿåˆå±‚çº§æ•° | 4 |
| num_iterations | List[int] | æ¯å±‚è¿­ä»£æ¬¡æ•° | [50] * num_fitting_levels |
| convergence_threshold | float | æ”¶æ•›é˜ˆå€¼ | 0.001 |

### 4. ç›´æ–¹å›¾æ ‡å‡†åŒ–

å°†å›¾åƒçš„ç›´æ–¹å›¾ä¸å‚è€ƒå›¾åƒçš„ç›´æ–¹å›¾åŒ¹é…ï¼Œä½¿å¾—ä¸åŒå›¾åƒä¹‹é—´çš„å¼ºåº¦åˆ†å¸ƒæ›´åŠ ä¸€è‡´ã€‚è¿™å¯¹äºè·¨æ‰«æä»ªæˆ–è·¨é‡‡é›†åºåˆ—çš„å›¾åƒæ ‡å‡†åŒ–éå¸¸æœ‰ç”¨ã€‚

#### å‚æ•°

| å‚æ•° | ç±»å‹ | æè¿° | é»˜è®¤å€¼ |
|-----|-----|-----|-----|
| images | List[str] | è¦æ ‡å‡†åŒ–çš„å›¾åƒåˆ—è¡¨ | å¿…éœ€ |
| reference_key | str | å‚è€ƒå›¾åƒçš„é”®å | å¿…éœ€ |

#### é…ç½®ç¤ºä¾‹

```yaml
histogram_standardization:
  images: [pre_contrast, LAP, delay_3min]  # è¦å¤„ç†çš„å›¾åƒåºåˆ—
  reference_key: PVP  # å‚è€ƒå›¾åƒçš„é”®å
```

## å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# æ•°æ®è·¯å¾„
data_dir: F:\work\research\radiomics_TLSs\data\raw_data
out_dir: F:\work\research\radiomics_TLSs\data\results

# é¢„å¤„ç†è®¾ç½®
Preprocessing:
  # é‡é‡‡æ ·ï¼ˆå¯é€‰ï¼‰
  resample:
    images: [T2WI, ADC]
    target_spacing: [1.0, 1.0, 1.0]

  # é…å‡†ï¼ˆå¯é€‰ï¼‰
  registration:
    images: [T2WI, ADC]
    fixed_image: T2WI
    moving_images: [ADC]
    type_of_transform: SyNRA  # æ”¯æŒæ‰€æœ‰ANTsé…å‡†æ–¹æ³•
    use_mask: false

  # N4åç½®åœºæ ¡æ­£ï¼ˆå¯é€‰ï¼‰
  # n4_correction:
  #   images: [T2WI, ADC]
  #   num_fitting_levels: 2
    
  # Z-Scoreæ ‡å‡†åŒ–ï¼ˆå¯é€‰ï¼‰
  # zscore_normalization:
  #   images: [T2WI, ADC]
  #   only_inmask: false
    
  # ç›´æ–¹å›¾æ ‡å‡†åŒ–ï¼ˆå¯é€‰ï¼‰
  # histogram_standardization:
  #   images: [T2WI]
  #   reference_key: ADC

# ä¸€èˆ¬è®¾ç½®
processes: 1  # å¹¶è¡Œè¿›ç¨‹æ•°
random_state: 42  # éšæœºç§å­
```

## æ‰§è¡Œæµç¨‹

1. åŠ è½½é…ç½®æ–‡ä»¶
2. åˆå§‹åŒ–BatchProcessorå¤„ç†å™¨
3. æ‰§è¡Œæ‰¹å¤„ç†æ“ä½œï¼Œå¤„ç†æ‰€æœ‰æŒ‡å®šçš„å›¾åƒ
4. ç”Ÿæˆè¯¦ç»†çš„å¤„ç†æ—¥å¿—

## è¾“å‡ºç»“æ„

```
out_dir/
â”œâ”€â”€ processed_images/
â”‚   â”œâ”€â”€ images/
â”‚   â”‚   â””â”€â”€ subject_id/
â”‚   â”‚       â”œâ”€â”€ modality1/
â”‚   â”‚       â”‚   â””â”€â”€ modality1.nii.gz
â”‚   â”‚       â””â”€â”€ modality2/
â”‚   â”‚           â””â”€â”€ modality2.nii.gz
â”‚   â””â”€â”€ masks/
â”‚       â””â”€â”€ subject_id/
â”‚           â”œâ”€â”€ modality1/
â”‚           â”‚   â””â”€â”€ mask_modality1.nii.gz
â”‚           â””â”€â”€ modality2/
â”‚               â””â”€â”€ mask_modality2.nii.gz
â””â”€â”€ logs/
    â””â”€â”€ processing.log
```

## æ—¥å¿—è®°å½•

è¯¥è„šæœ¬ç»´æŠ¤è¯¦ç»†çš„æ—¥å¿—æ–‡ä»¶ `preprocessing_debug.log`ï¼ŒåŒ…å«ï¼š
- å¤„ç†è¿›åº¦
- é”™è¯¯æ¶ˆæ¯
- å‚æ•°è®¾ç½®
- æ€§èƒ½æŒ‡æ ‡

## æœ€ä½³å®è·µå»ºè®®

1. **é‡é‡‡æ ·**:
   - æ ¹æ®åˆ†æéœ€æ±‚é€‰æ‹©åˆé€‚çš„ç›®æ ‡é—´è·
   - å¯¹å›¾åƒä½¿ç”¨çº¿æ€§æ’å€¼
   - å¯¹æ©ç ä½¿ç”¨æœ€è¿‘é‚»æ’å€¼

2. **é…å‡†**:
   - å¯¹äºå¯å˜å½¢é…å‡†ä½¿ç”¨SyN
   - å¯¹äºå¤šæ¨¡æ€é…å‡†ä½¿ç”¨MIåº¦é‡
   - åœ¨æœ‰æ©ç çš„æƒ…å†µä¸‹å§‹ç»ˆä½¿ç”¨æ©ç 
   - è€ƒè™‘ä½¿ç”¨SyNRAè·å¾—æ›´å¥½çš„åˆå§‹å¯¹é½

3. **N4æ ¡æ­£**:
   - å¤§å¤šæ•°æƒ…å†µä¸‹ä½¿ç”¨4ä¸ªæ‹Ÿåˆå±‚çº§
   - æ ¹æ®å›¾åƒå¤æ‚åº¦è°ƒæ•´è¿­ä»£æ¬¡æ•°
   - å¦‚æœ‰æ©ç å¯ç”¨ï¼Œä½¿ç”¨æ©ç è·å¾—æ›´å¥½çš„æ ¡æ­£

## å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **é…å‡†å¤±è´¥**:
   - å°è¯•ä¸åŒçš„å˜æ¢ç±»å‹
   - è°ƒæ•´ç›¸ä¼¼åº¦åº¦é‡
   - å¦‚æœ‰å¯ç”¨æ©ç ï¼Œå¯ç”¨use_mask
   - æ£€æŸ¥å›¾åƒæ–¹å‘

2. **N4æ ¡æ­£é—®é¢˜**:
   - å¢åŠ è¿­ä»£æ¬¡æ•°
   - è°ƒæ•´æ”¶æ•›é˜ˆå€¼
   - ä½¿ç”¨æ©ç è·å¾—æ›´å¥½çš„æ ¡æ­£

3. **å†…å­˜é—®é¢˜**:
   - å‡å°‘å¹¶è¡Œè¿›ç¨‹æ•°
   - åˆ†æ‰¹å¤„ç†å›¾åƒ
   - å¯¹åˆå§‹é…å‡†ä½¿ç”¨è¾ƒä½åˆ†è¾¨ç‡

## æ€§èƒ½è€ƒè™‘

1. **å¹¶è¡Œå¤„ç†**:
   - ä½¿ç”¨å¤šè¿›ç¨‹åŠ å¿«å¤„ç†é€Ÿåº¦
   - æ ¹æ®å¯ç”¨å†…å­˜è°ƒæ•´è¿›ç¨‹æ•°
   - å¯¹å†…å­˜å¯†é›†å‹æ“ä½œè€ƒè™‘ä½¿ç”¨è¾ƒå°‘è¿›ç¨‹

2. **å†…å­˜ä½¿ç”¨**:
   - ç›‘æ§å¤„ç†è¿‡ç¨‹ä¸­çš„å†…å­˜ä½¿ç”¨æƒ…å†µ
   - å¿…è¦æ—¶è°ƒæ•´æ‰¹é‡å¤§å°
   - ä½¿ç”¨é€‚å½“çš„å›¾åƒæ ¼å¼

3. **ç£ç›˜ç©ºé—´**:
   - å¤„ç†åçš„å›¾åƒä»¥NIfTIæ ¼å¼ä¿å­˜
   - è€ƒè™‘å‹ç¼©ä»¥ä¾¿é•¿æœŸå­˜å‚¨
   - å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶ 