
import base64
exec(base64.b64decode(b'IiIiDQpBIENvbXBsZXRlIE1vZGVsaW5nIFBpcGVsaW5lDQoNCkF1dGhvcjogTGkgQ2hhbw0KRW1haWw6IGxpY2gzNTZAbWFpbC5zeXN1LmVkdS5jbg0KIiIiDQppbXBvcnQgb3MNCmltcG9ydCBwYW5kYXMgYXMgcGQNCmltcG9ydCBudW1weSBhcyBucA0KaW1wb3J0IHdhcm5pbmdzDQpmcm9tIHNrbGVhcm4ucHJlcHJvY2Vzc2luZyBpbXBvcnQgU3RhbmRhcmRTY2FsZXIsIE1pbk1heFNjYWxlcg0KZnJvbSBza2xlYXJuLm1vZGVsX3NlbGVjdGlvbiBpbXBvcnQgdHJhaW5fdGVzdF9zcGxpdA0KaW1wb3J0IGpzb24NCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBMaXN0LCBBbnksIE9wdGlvbmFsLCBVbmlvbiwgVHVwbGUsIFNldA0KZnJvbSAubW9kZWxzLmZhY3RvcnkgaW1wb3J0IE1vZGVsRmFjdG9yeQ0KZnJvbSAuZmVhdHVyZV9zZWxlY3RvcnMgaW1wb3J0IHJ1bl9zZWxlY3RvciwgZ2V0X2F2YWlsYWJsZV9zZWxlY3RvcnMNCmZyb20gLmV2YWx1YXRpb24ubW9kZWxfZXZhbHVhdGlvbiBpbXBvcnQgTW9kZWxFdmFsdWF0b3IsIGNhbGN1bGF0ZV9tZXRyaWNzDQpmcm9tIC52aXN1YWxpemF0aW9uLnBsb3R0aW5nIGltcG9ydCBQbG90dGVyIA0KDQojIElnbm9yZSB3YXJuaW5ncw0Kd2FybmluZ3MuZmlsdGVyd2FybmluZ3MoImlnbm9yZSIpDQoNCmNsYXNzIE1vZGVsaW5nOg0KICAgICIiIg0KICAgIEEgY2xhc3MgZm9yIHJhZGlvbWljcyBtb2RlbGluZyBwaXBlbGluZQ0KICAgICIiIg0KICAgIGRlZiBfX2luaXRfXyhzZWxmLCBjb25maWc6IERpY3Rbc3RyLCBBbnldKSAtPiBOb25lOg0KICAgICAgICAiIiINCiAgICAgICAgSW5pdGlhbGl6ZSB0aGUgbW9kZWxpbmcgY2xhc3MNCiAgICAgICAgDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBjb25maWc6IENvbmZpZ3VyYXRpb24gZGljdGlvbmFyeSBjb250YWluaW5nIGFsbCBtb2RlbGluZyBwYXJhbWV0ZXJzDQogICAgICAgICIiIg0KICAgICAgICBzZWxmLmNvbmZpZyA9IGNvbmZpZw0KICAgICAgICBzZWxmLmRhdGFfZmlsZSA9IGNvbmZpZ1snaW5wdXQnXQ0KICAgICAgICBzZWxmLm91dHB1dF9kaXIgPSBjb25maWdbJ291dHB1dCddDQogICAgICAgIHNlbGYudGVzdF9zaXplID0gY29uZmlnLmdldCgndGVzdF9zaXplJywgMC4zKQ0KICAgICAgICBzZWxmLlNFRUQgPSBjb25maWcuZ2V0KCdyYW5kb21fc3RhdGUnLCA0MikNCiAgICAgICAgc2VsZi5mZWF0dXJlX3NlbGVjdGlvbl9tZXRob2RzID0gY29uZmlnLmdldCgnZmVhdHVyZV9zZWxlY3Rpb25fbWV0aG9kcycpDQogICAgICAgIA0KICAgICAgICAjIERhdGEgc3BsaXQgY29uZmlndXJhdGlvbg0KICAgICAgICBzZWxmLnNwbGl0X21ldGhvZCA9IGNvbmZpZy5nZXQoJ3NwbGl0X21ldGhvZCcsICdzdHJhdGlmaWVkJykNCiAgICAgICAgc2VsZi50cmFpbl9pZHNfZmlsZSA9IGNvbmZpZy5nZXQoJ3RyYWluX2lkc19maWxlJywgTm9uZSkNCiAgICAgICAgc2VsZi50ZXN0X2lkc19maWxlID0gY29uZmlnLmdldCgndGVzdF9pZHNfZmlsZScsIE5vbmUpDQoNCiAgICAgICAgIyB2aXN1YWxpemF0aW9uIGFuZCBzYXZlIGNvbmZpZ3VyYXRpb24NCiAgICAgICAgc2VsZi5pc192aXN1YWxpemUgPSBjb25maWcuZ2V0KCdpc192aXN1YWxpemUnLCBGYWxzZSkNCiAgICAgICAgc2VsZi5pc19zYXZlX21vZGVsID0gY29uZmlnLmdldCgnaXNfc2F2ZV9tb2RlbCcsIEZhbHNlKQ0KICAgICAgICANCiAgICAgICAgIyBHZXQgYXZhaWxhYmxlIGZlYXR1cmUgc2VsZWN0b3JzDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHNlbGYuYXZhaWxhYmxlX3NlbGVjdG9ycyA9IGdldF9hdmFpbGFibGVfc2VsZWN0b3JzKCkNCiAgICAgICAgICAgIHByaW50KGYiQXZhaWxhYmxlIGZlYXR1cmUgc2VsZWN0b3JzOiB7c2VsZi5hdmFpbGFibGVfc2VsZWN0b3JzfSIpDQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToNCiAgICAgICAgICAgIHNlbGYuYXZhaWxhYmxlX3NlbGVjdG9ycyA9IFtdDQogICAgICAgICAgICBwcmludChmIldhcm5pbmc6IEZhaWxlZCB0byBnZXQgYXZhaWxhYmxlIGZlYXR1cmUgc2VsZWN0b3JzOiB7ZX0iKQ0KICAgIA0KICAgICAgICBzZWxmLnBsb3R0ZXIgPSBQbG90dGVyKHNlbGYub3V0cHV0X2RpcikNCiAgICAgICAgDQogICAgZGVmIHJlYWRfZGF0YShzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgUmVhZCBkYXRhIGZyb20gZmlsZShzKQ0KICAgICAgICANCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIE1vZGVsaW5nOiBTZWxmIGluc3RhbmNlIGZvciBtZXRob2QgY2hhaW5pbmcNCiAgICAgICAgIiIiDQogICAgICAgICAgICANCiAgICAgICAgaWYgaXNpbnN0YW5jZShzZWxmLmRhdGFfZmlsZSwgbGlzdCk6DQogICAgICAgICAgICAjIE11bHRpcGxlIGZpbGVzIGNhc2UNCiAgICAgICAgICAgIHByaW50KGYiUmVhZGluZyBkYXRhIGZyb20gbXVsdGlwbGUgZmlsZXM6IHtsZW4oc2VsZi5kYXRhX2ZpbGUpfSBmaWxlcyIpDQogICAgICAgICAgICANCiAgICAgICAgICAgIG1lcmdlZF9kZiA9IE5vbmUNCiAgICAgICAgICAgIGFsbF9sYWJlbHMgPSB7fSAgIyDnlKjkuo7lrZjlgqjmiYDmnInmoLfmnKznmoTmoIfnrb7lgLwNCiAgICAgICAgICAgIGZpcnN0X3N1YmplY3RfaWRfY29sID0gTm9uZSAgIyDorrDlvZXnrKzkuIDkuKpzdWJqZWN0X2lkX2NvbA0KICAgICAgICAgICAgZmlyc3RfbGFiZWxfY29sID0gTm9uZSAgIyDorrDlvZXnrKzkuIDkuKrmoIfnrb7liJflkI0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgZm9yIGl0aGYsIGZpbGVfY29uZmlnIGluIGVudW1lcmF0ZShzZWxmLmRhdGFfZmlsZSk6DQogICAgICAgICAgICAgICAgZmlsZV9wYXRoID0gZmlsZV9jb25maWdbJ3BhdGgnXQ0KICAgICAgICAgICAgICAgIG5hbWUgPSBmaWxlX2NvbmZpZy5nZXQoJ25hbWUnLCBmIm1vZGVse2l0aGYrMX0iKQ0KICAgICAgICAgICAgICAgIHN1YmplY3RfaWRfY29sID0gZmlsZV9jb25maWcuZ2V0KCdzdWJqZWN0X2lkX2NvbCcpDQogICAgICAgICAgICAgICAgbGFiZWxfY29sID0gZmlsZV9jb25maWcuZ2V0KCdsYWJlbF9jb2wnKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgQ2hlY2sgaWYgc3ViamVjdF9pZF9jb2wgb3IgbGFiZWxfY29sIGlzIE5vbmUNCiAgICAgICAgICAgICAgICBpZiBzdWJqZWN0X2lkX2NvbCBpcyBOb25lOg0KICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiU3ViamVjdCBJRCBjb2x1bW4gbXVzdCBiZSBzcGVjaWZpZWQgZm9yIGZpbGUge2ZpbGVfcGF0aH0iKQ0KICAgICAgICAgICAgICAgIGlmIGxhYmVsX2NvbCBpcyBOb25lOg0KICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTGFiZWwgY29sdW1uIG11c3QgYmUgc3BlY2lmaWVkIGZvciBmaWxlIHtmaWxlX3BhdGh9IikNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBmZWF0dXJlcyA9IGZpbGVfY29uZmlnLmdldCgnZmVhdHVyZXMnLCBbXSkNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICBwcmludChmIiAgUmVhZGluZyBmaWxlOiB7ZmlsZV9wYXRofSIpDQogICAgICAgICAgICAgICAgcHJpbnQoZiIgIERhdGFzZXQgbmFtZToge25hbWV9IikNCiAgICAgICAgICAgICAgICBwcmludChmIiAgU3ViamVjdCBJRCBjb2x1bW46IHtzdWJqZWN0X2lkX2NvbH0iKQ0KICAgICAgICAgICAgICAgIHByaW50KGYiICBMYWJlbCBjb2x1bW46IHtsYWJlbF9jb2x9IikNCiAgICAgICAgICAgICAgICBwcmludChmIiAgRmVhdHVyZXM6IHtmZWF0dXJlc30iKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgUmVhZCB0aGUgZmlsZQ0KICAgICAgICAgICAgICAgIGRmID0gcGQucmVhZF9jc3YoZmlsZV9wYXRoKQ0KDQogICAgICAgICAgICAgICAgIyBjaGVjayBpZiBzdWJqZWN0X2lkX2NvbCBhbmQgbGFiZWxfY29sIGV4aXN0IGluIGRmDQogICAgICAgICAgICAgICAgaWYgc3ViamVjdF9pZF9jb2wgbm90IGluIGRmLmNvbHVtbnM6DQogICAgICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJTdWJqZWN0IElEIGNvbHVtbiAne3N1YmplY3RfaWRfY29sfScgbm90IGZvdW5kIGluIHtmaWxlX3BhdGh9IikNCiAgICAgICAgICAgICAgICBpZiBsYWJlbF9jb2wgbm90IGluIGRmLmNvbHVtbnM6DQogICAgICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJMYWJlbCBjb2x1bW4gJ3tsYWJlbF9jb2x9JyBub3QgZm91bmQgaW4ge2ZpbGVfcGF0aH0iKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgQ29udmVydCBzdWJqZWN0IElEcyB0byBzdHJpbmcgZm9yIGNvbnNpc3RlbnQgbWVyZ2luZw0KICAgICAgICAgICAgICAgIGRmW3N1YmplY3RfaWRfY29sXSA9IGRmW3N1YmplY3RfaWRfY29sXS5hc3R5cGUoc3RyKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMg6K6w5b2V56ys5LiA5Liq5paH5Lu255qE5qCH562+5YiX5ZCN5L2c5Li65pyA57uI5qCH562+5YiX5ZCNDQogICAgICAgICAgICAgICAgaWYgZmlyc3RfbGFiZWxfY29sIGlzIE5vbmU6DQogICAgICAgICAgICAgICAgICAgIGZpcnN0X2xhYmVsX2NvbCA9IGxhYmVsX2NvbA0KICAgICAgICAgICAgICAgICAgICBzZWxmLmxhYmVsX2NvbCA9IGZpcnN0X2xhYmVsX2NvbA0KICAgICAgICAgICAgICAgICAgICBsYWJlbF92YWx1ZXMgPSBkZltsYWJlbF9jb2xdDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgIyDorrDlvZXnrKzkuIDkuKrmlofku7bnmoRzdWJqZWN0X2lkX2NvbOS9nOS4uuacgOe7iHN1YmplY3RfaWRfY29sDQogICAgICAgICAgICAgICAgaWYgZmlyc3Rfc3ViamVjdF9pZF9jb2wgaXMgTm9uZToNCiAgICAgICAgICAgICAgICAgICAgZmlyc3Rfc3ViamVjdF9pZF9jb2wgPSBzdWJqZWN0X2lkX2NvbA0KICAgICAgICAgICAgICAgICAgICBzZWxmLnN1YmplY3RfaWRfY29sID0gZmlyc3Rfc3ViamVjdF9pZF9jb2wNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIOaPkOWPluW5tuS/neWtmOagh+etvuaVsOaNrizlkIzml7bkv53nlZlzdWJqSUQNCiAgICAgICAgICAgICAgICBhbGxfbGFiZWxzW2ZpbGVfcGF0aF0gPSBkZi5sb2NbOiwgW3N1YmplY3RfaWRfY29sLCBsYWJlbF9jb2xdXQ0KICAgICAgICAgICAgICAgIGFsbF9sYWJlbHNbZmlsZV9wYXRoXS5zZXRfaW5kZXgoc3ViamVjdF9pZF9jb2wsIGlucGxhY2U9VHJ1ZSkNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIOmAieaLqeimgeS/neeVmeeahOWIl++8jOS4jeWMheaLrOagh+etvuWIlw0KICAgICAgICAgICAgICAgIGNvbHVtbnNfdG9fa2VlcCA9IFtzdWJqZWN0X2lkX2NvbF0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIOa3u+WKoOeJueW+geWIl++8jOa3u+WKoOWJjee8gOmBv+WFjeWGsueqgQ0KICAgICAgICAgICAgICAgIGZlYXR1cmVfY29sdW1ucyA9IHt9DQogICAgICAgICAgICAgICAgaWYgZmVhdHVyZXM6DQogICAgICAgICAgICAgICAgICAgIGZvciBmZWF0dXJlIGluIGZlYXR1cmVzOg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgZmVhdHVyZSBpbiBkZi5jb2x1bW5zOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnNfdG9fa2VlcC5hcHBlbmQoZmVhdHVyZSkNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIOS4uueJueW+geWIl+WQjea3u+WKoOWJjee8gA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmVfY29sdW1uc1tmZWF0dXJlXSA9IGYie25hbWV9e2ZlYXR1cmV9Ig0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcmludChmIiAgV2FybmluZzogRmVhdHVyZSAne2ZlYXR1cmV9JyBub3QgZm91bmQgaW4ge2ZpbGVfcGF0aH0iKQ0KICAgICAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgICAgICMg5aaC5p6c5pyq5oyH5a6a54m55b6B77yM5L2/55So6ZmkSUTlkozmoIfnrb7lpJbnmoTmiYDmnInliJcNCiAgICAgICAgICAgICAgICAgICAgZm9yIGNvbCBpbiBkZi5jb2x1bW5zOg0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgY29sICE9IHN1YmplY3RfaWRfY29sIGFuZCBjb2wgIT0gbGFiZWxfY29sOg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnNfdG9fa2VlcC5hcHBlbmQoY29sKQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmVfY29sdW1uc1tjb2xdID0gZiJ7bmFtZX17Y29sfSINCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIOWPquS/neeVmemcgOimgeeahOWIlw0KICAgICAgICAgICAgICAgIGRmID0gZGZbY29sdW1uc190b19rZWVwXQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMg6YeN5ZG95ZCN54m55b6B5YiX77yM5re75Yqg5YmN57yADQogICAgICAgICAgICAgICAgcmVuYW1lX2RpY3QgPSB7Y29sOiBmZWF0dXJlX2NvbHVtbnNbY29sXSBmb3IgY29sIGluIGZlYXR1cmVfY29sdW1ucyBpZiBjb2wgaW4gZGYuY29sdW1uc30NCiAgICAgICAgICAgICAgICBkZiA9IGRmLnJlbmFtZShjb2x1bW5zPXJlbmFtZV9kaWN0KQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMg6aaW5qyh5aSE55CG5Yid5aeL5YyW5ZCI5bm25pWw5o2u5qGGDQogICAgICAgICAgICAgICAgaWYgbWVyZ2VkX2RmIGlzIE5vbmU6DQogICAgICAgICAgICAgICAgICAgIG1lcmdlZF9kZiA9IGRmDQogICAgICAgICAgICAgICAgICAgICMg6K6+572u57Si5byV55So5LqO5ZCO57ut5ZCI5bm2DQogICAgICAgICAgICAgICAgICAgIG1lcmdlZF9kZi5zZXRfaW5kZXgoc3ViamVjdF9pZF9jb2wsIGlucGxhY2U9VHJ1ZSkNCiAgICAgICAgICAgICAgICAgICAgIyDntKLlvJXovazkuLrlrZfnrKbkuLINCiAgICAgICAgICAgICAgICAgICAgbWVyZ2VkX2RmLmluZGV4ID0gbWVyZ2VkX2RmLmluZGV4LmFzdHlwZShzdHIpDQogICAgICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICAgICAgIyDkuLrlkIjlubborr7nva7kuLTml7bntKLlvJUNCiAgICAgICAgICAgICAgICAgICAgZGYuc2V0X2luZGV4KHN1YmplY3RfaWRfY29sLCBpbnBsYWNlPVRydWUpDQogICAgICAgICAgICAgICAgICAgICMg57Si5byV6L2s5Li65a2X56ym5LiyDQogICAgICAgICAgICAgICAgICAgIGRmLmluZGV4ID0gZGYuaW5kZXguYXN0eXBlKHN0cikNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgICAgICMg5LiO546w5pyJ5pWw5o2u5ZCI5bm2DQogICAgICAgICAgICAgICAgICAgIG1lcmdlZF9kZiA9IG1lcmdlZF9kZi5qb2luKGRmLCBob3c9J291dGVyJykNCg0KICAgICAgICAgICAgICAgICAgICAjIOabtOaWsOe0ouW8leWQjeensA0KICAgICAgICAgICAgICAgICAgICBtZXJnZWRfZGYuaW5kZXgubmFtZSA9IHNlbGYuc3ViamVjdF9pZF9jb2wNCg0KICAgICAgICAgICAgIyDlsIbmoIfnrb7mlbDmja7mt7vliqDlm57lkIjlubblkI7nmoTmlbDmja7moYYNCiAgICAgICAgICAgIHByaW50KGYiQWRkaW5nIHVuaWZpZWQgbGFiZWwgY29sdW1uOiB7c2VsZi5sYWJlbF9jb2x9IikNCiAgICAgICAgICAgIG1lcmdlZF9kZltzZWxmLmxhYmVsX2NvbF0gPSBsYWJlbF92YWx1ZXMudmFsdWVzDQogICAgICAgICAgICAjIOaKimxhYmVs5pS+5Yiw56ys5LiA5YiXDQogICAgICAgICAgICBtZXJnZWRfZGYgPSBtZXJnZWRfZGZbW3NlbGYubGFiZWxfY29sXSArIFtjb2wgZm9yIGNvbCBpbiBtZXJnZWRfZGYuY29sdW1ucyBpZiBjb2wgIT0gc2VsZi5zdWJqZWN0X2lkX2NvbCBhbmQgY29sICE9IHNlbGYubGFiZWxfY29sXV0NCiAgICAgICAgICAgIHNlbGYuZGF0YSA9IG1lcmdlZF9kZg0KDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByYWlzZSBUeXBlRXJyb3IoZiJFeHBlY3RlZCBsaXN0IGZvciBkYXRhX2ZpbGUsIGdvdCB7dHlwZShzZWxmLmRhdGFfZmlsZSl9IikNCiAgICAgICAgDQogICAgICAgIHJldHVybiBzZWxmDQogICAgDQogICAgZGVmIHByZXByb2Nlc3NfZGF0YShzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgUHJlcHJvY2VzcyB0aGUgZGF0YQ0KICAgICAgICANCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIE1vZGVsaW5nOiBTZWxmIGluc3RhbmNlIGZvciBtZXRob2QgY2hhaW5pbmcNCiAgICAgICAgIiIiDQogICAgICAgICMgUmVtb3ZlIG1pc3NpbmcgdmFsdWVzDQogICAgICAgIHByaW50KGYiU2FtcGxlIHNpemUgYmVmb3JlIHJlbW92aW5nIG1pc3NpbmcgdmFsdWVzOiB7c2VsZi5kYXRhLnNoYXBlWzBdfSIpDQogICAgICAgICMgc2VsZi5kYXRhID0gc2VsZi5kYXRhLmRyb3BuYSgpDQogICAgICAgIHByaW50KGYiU2FtcGxlIHNpemUgYWZ0ZXIgcmVtb3ZpbmcgbWlzc2luZyB2YWx1ZXM6IHtzZWxmLmRhdGEuc2hhcGVbMF19IikNCg0KICAgICAgICAjIENoZWNrIGZvciBtaXNzaW5nIHZhbHVlcw0KICAgICAgICBwcmludChmIk1pc3NpbmcgdmFsdWVzOiB7c2VsZi5kYXRhLmlzbnVsbCgpLnN1bSgpfSIpDQoNCiAgICAgICAgIyBDb252ZXJ0IHRvIG51bWVyaWMNCiAgICAgICAgIyBzZWxmLmRhdGEgPSBzZWxmLmRhdGEuYXBwbHkocGQudG9fbnVtZXJpYykNCg0KICAgICAgICAjIFBlcmZvcm0gU2hhcGlyby1XaWxrIG5vcm1hbGl0eSB0ZXN0IG9uIGFsbCBjbGluaWNhbCBkYXRhDQoNCiAgICAgICAgIyBEYXRhIGV4cGxvcmF0aW9uDQoNCiAgICAgICAgIyBldGMuDQoNCiAgICAgICAgcmV0dXJuIHNlbGYNCg0KICAgIGRlZiBfc3BsaXRfZGF0YShzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgU3BsaXQgZGF0YSBpbnRvIHRyYWluaW5nIGFuZCB0ZXN0IHNldHMgYmFzZWQgb24gdGhlIHNwZWNpZmllZCBtZXRob2QNCiAgICAgICAgDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICBNb2RlbGluZzogU2VsZiBpbnN0YW5jZSBmb3IgbWV0aG9kIGNoYWluaW5nDQogICAgICAgICIiIg0KICAgICAgICAjIFNhdmUgb3JpZ2luYWwgZGF0YSB0byBhbGxvdyBhY2Nlc3MgdG8gc3ViamVjdCBJRHMgbGF0ZXINCiAgICAgICAgc2VsZi5vcmlnaW5hbF9kYXRhID0gc2VsZi5kYXRhLmNvcHkoKQ0KICAgICAgICANCiAgICAgICAgIyBEaWZmZXJlbnQgc3BsaXQgbWV0aG9kcw0KICAgICAgICBpZiBzZWxmLnNwbGl0X21ldGhvZCA9PSAncmFuZG9tJzoNCiAgICAgICAgICAgICMgUmFuZG9tIHNwbGl0IHdpdGhvdXQgc3RyYXRpZmljYXRpb24NCiAgICAgICAgICAgIHNlbGYuZGF0YV90cmFpbiwgc2VsZi5kYXRhX3Rlc3QgPSB0cmFpbl90ZXN0X3NwbGl0KA0KICAgICAgICAgICAgICAgIHNlbGYuZGF0YSwNCiAgICAgICAgICAgICAgICB0ZXN0X3NpemU9c2VsZi50ZXN0X3NpemUsIA0KICAgICAgICAgICAgICAgIHJhbmRvbV9zdGF0ZT1zZWxmLlNFRUQNCiAgICAgICAgICAgICkNCiAgICAgICAgICAgIHByaW50KGYiRGF0YSBzcGxpdCB1c2luZyByYW5kb20gbWV0aG9kICh0ZXN0IHNpemU6IHtzZWxmLnRlc3Rfc2l6ZX0pIikNCiAgICAgICAgICAgIA0KICAgICAgICBlbGlmIHNlbGYuc3BsaXRfbWV0aG9kID09ICdzdHJhdGlmaWVkJzoNCiAgICAgICAgICAgICMgU3RyYXRpZmllZCBzcGxpdCBiYXNlZCBvbiBsYWJlbCBjb2x1bW4gKGRlZmF1bHQgbWV0aG9kKQ0KICAgICAgICAgICAgc2VsZi5kYXRhX3RyYWluLCBzZWxmLmRhdGFfdGVzdCA9IHRyYWluX3Rlc3Rfc3BsaXQoDQogICAgICAgICAgICAgICAgc2VsZi5kYXRhLA0KICAgICAgICAgICAgICAgIHRlc3Rfc2l6ZT1zZWxmLnRlc3Rfc2l6ZSwgDQogICAgICAgICAgICAgICAgcmFuZG9tX3N0YXRlPXNlbGYuU0VFRCwgDQogICAgICAgICAgICAgICAgc3RyYXRpZnk9c2VsZi5kYXRhW3NlbGYubGFiZWxfY29sXQ0KICAgICAgICAgICAgKQ0KICAgICAgICAgICAgcHJpbnQoZiJEYXRhIHNwbGl0IHVzaW5nIHN0cmF0aWZpZWQgbWV0aG9kICh0ZXN0IHNpemU6IHtzZWxmLnRlc3Rfc2l6ZX0pIikNCiAgICAgICAgICAgIA0KICAgICAgICBlbGlmIHNlbGYuc3BsaXRfbWV0aG9kID09ICdjdXN0b20nOg0KICAgICAgICAgICAgIyBVc2UgY3VzdG9tIHN1YmplY3QgSURzIGZvciB0cmFpbiBhbmQgdGVzdCBzZXRzDQogICAgICAgICAgICBpZiBub3Qgc2VsZi50cmFpbl9pZHNfZmlsZSBvciBub3Qgc2VsZi50ZXN0X2lkc19maWxlOg0KICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIkZvciBjdXN0b20gc3BsaXQgbWV0aG9kLCBib3RoIHRyYWluX2lkc19maWxlIGFuZCB0ZXN0X2lkc19maWxlIG11c3QgYmUgc3BlY2lmaWVkIikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBSZWFkIHN1YmplY3QgSURzIGZyb20gZmlsZXMNCiAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICB0cmFpbl9pZHMgPSBzZWxmLl9yZWFkX3N1YmplY3RfaWRzKHNlbGYudHJhaW5faWRzX2ZpbGUpDQogICAgICAgICAgICAgICAgdGVzdF9pZHMgPSBzZWxmLl9yZWFkX3N1YmplY3RfaWRzKHNlbGYudGVzdF9pZHNfZmlsZSkNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIEVuc3VyZSBEYXRhRnJhbWUgaW5kZXggaXMgY29udmVydGVkIHRvIHN0cmluZyB0eXBlDQogICAgICAgICAgICAgICAgaWYgbm90IGFsbChpc2luc3RhbmNlKGlkeCwgc3RyKSBmb3IgaWR4IGluIHNlbGYuZGF0YS5pbmRleCk6DQogICAgICAgICAgICAgICAgICAgIHByaW50KCJDb252ZXJ0aW5nIERhdGFGcmFtZSBpbmRleCB0byBzdHJpbmcgdHlwZSIpDQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGF0YS5pbmRleCA9IHNlbGYuZGF0YS5pbmRleC5hc3R5cGUoc3RyKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgVmVyaWZ5IG5vIG92ZXJsYXAgYmV0d2VlbiB0cmFpbiBhbmQgdGVzdA0KICAgICAgICAgICAgICAgIG92ZXJsYXAgPSBzZXQodHJhaW5faWRzKS5pbnRlcnNlY3Rpb24oc2V0KHRlc3RfaWRzKSkNCiAgICAgICAgICAgICAgICBpZiBvdmVybGFwOg0KICAgICAgICAgICAgICAgICAgICBwcmludChmIldhcm5pbmc6IEZvdW5kIHtsZW4ob3ZlcmxhcCl9IG92ZXJsYXBwaW5nIHN1YmplY3QgSURzIGJldHdlZW4gdHJhaW4gYW5kIHRlc3Qgc2V0cyIpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgIyBDcmVhdGUgdHJhaW4gYW5kIHRlc3QgZGF0YXNldHMNCiAgICAgICAgICAgICAgICBzZWxmLmRhdGFfdHJhaW4gPSBzZWxmLmRhdGEubG9jW3NlbGYuZGF0YS5pbmRleC5pc2luKHRyYWluX2lkcyldDQogICAgICAgICAgICAgICAgc2VsZi5kYXRhX3Rlc3QgPSBzZWxmLmRhdGEubG9jW3NlbGYuZGF0YS5pbmRleC5pc2luKHRlc3RfaWRzKV0NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIFZlcmlmeSBhbGwgSURzIHdlcmUgZm91bmQNCiAgICAgICAgICAgICAgICBtaXNzaW5nX3RyYWluID0gc2V0KHRyYWluX2lkcykgLSBzZXQoc2VsZi5kYXRhX3RyYWluLmluZGV4KQ0KICAgICAgICAgICAgICAgIG1pc3NpbmdfdGVzdCA9IHNldCh0ZXN0X2lkcykgLSBzZXQoc2VsZi5kYXRhX3Rlc3QuaW5kZXgpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgaWYgbWlzc2luZ190cmFpbjoNCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiB7bGVuKG1pc3NpbmdfdHJhaW4pfSB0cmFpbiBzdWJqZWN0IElEcyBub3QgZm91bmQgaW4gZGF0YSIpDQogICAgICAgICAgICAgICAgaWYgbWlzc2luZ190ZXN0Og0KICAgICAgICAgICAgICAgICAgICBwcmludChmIldhcm5pbmc6IHtsZW4obWlzc2luZ190ZXN0KX0gdGVzdCBzdWJqZWN0IElEcyBub3QgZm91bmQgaW4gZGF0YSIpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgcHJpbnQoZiJEYXRhIHNwbGl0IHVzaW5nIGN1c3RvbSBzdWJqZWN0IElEcyAodHJhaW46IHtsZW4oc2VsZi5kYXRhX3RyYWluKX0sIHRlc3Q6IHtsZW4oc2VsZi5kYXRhX3Rlc3QpfSkiKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOg0KICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJGYWlsZWQgdG8gc3BsaXQgZGF0YSB1c2luZyBjdXN0b20gc3ViamVjdCBJRHM6IHtlfSIpDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiVW5zdXBwb3J0ZWQgc3BsaXQgbWV0aG9kOiB7c2VsZi5zcGxpdF9tZXRob2R9IikNCiAgICAgICAgDQogICAgICAgICMgRXh0cmFjdCBmZWF0dXJlcyBhbmQgbGFiZWxzDQogICAgICAgIHNlbGYueF90cmFpbiA9IHNlbGYuZGF0YV90cmFpbi5kcm9wKHNlbGYubGFiZWxfY29sLCBheGlzPTEpDQogICAgICAgIHNlbGYueV90cmFpbiA9IHNlbGYuZGF0YV90cmFpbltzZWxmLmxhYmVsX2NvbF0NCiAgICAgICAgc2VsZi54X3Rlc3QgPSBzZWxmLmRhdGFfdGVzdC5kcm9wKHNlbGYubGFiZWxfY29sLCBheGlzPTEpDQogICAgICAgIHNlbGYueV90ZXN0ID0gc2VsZi5kYXRhX3Rlc3Rbc2VsZi5sYWJlbF9jb2xdDQogICAgICAgIHNlbGYuaGVhZGVyID0gc2VsZi54X3RyYWluLmNvbHVtbnMNCiAgICAgICAgDQogICAgICAgICMgU2F2ZSB0cmFpbi90ZXN0IHNwbGl0IGluZGljZXMgZm9yIGxhdGVyIHJlZmVyZW5jZQ0KICAgICAgICBzZWxmLl9zYXZlX3NwbGl0X2luZm8oKQ0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHNlbGYNCiAgICANCiAgICBkZWYgX3JlYWRfc3ViamVjdF9pZHMoc2VsZiwgZmlsZV9wYXRoOiBzdHIpIC0+IExpc3Rbc3RyXToNCiAgICAgICAgIiIiDQogICAgICAgIFJlYWQgc3ViamVjdCBJRHMgZnJvbSBhIGZpbGUNCiAgICAgICAgDQogICAgICAgIEFyZ3M6DQogICAgICAgICAgICBmaWxlX3BhdGg6IFBhdGggdG8gZmlsZSBjb250YWluaW5nIHN1YmplY3QgSURzDQogICAgICAgICAgICANCiAgICAgICAgUmV0dXJuczoNCiAgICAgICAgICAgIExpc3Qgb2Ygc3ViamVjdCBJRHMgKGFsbCBjb252ZXJ0ZWQgdG8gc3RyaW5nIHR5cGUpDQogICAgICAgICIiIg0KICAgICAgICB3aXRoIG9wZW4oZmlsZV9wYXRoLCAncicpIGFzIGY6DQogICAgICAgICAgICAjIFN1cHBvcnQgZGlmZmVyZW50IGZvcm1hdHM6IG9uZSBJRCBwZXIgbGluZSwgQ1NWLCBvciBKU09ODQogICAgICAgICAgICBjb250ZW50ID0gZi5yZWFkKCkuc3RyaXAoKQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFRyeSB0byBwYXJzZSBhcyBKU09ODQogICAgICAgICAgICBpZiBjb250ZW50LnN0YXJ0c3dpdGgoJ1snKSBhbmQgY29udGVudC5lbmRzd2l0aCgnXScpOg0KICAgICAgICAgICAgICAgIHRyeToNCiAgICAgICAgICAgICAgICAgICAgaWRzID0ganNvbi5sb2Fkcyhjb250ZW50KQ0KICAgICAgICAgICAgICAgICAgICAjIEVuc3VyZSBhbGwgSURzIGFyZSBzdHJpbmcgdHlwZQ0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gW3N0cihpZCkgZm9yIGlkIGluIGlkc10NCiAgICAgICAgICAgICAgICBleGNlcHQ6DQogICAgICAgICAgICAgICAgICAgIHBhc3MNCiAgICAgICAgICAgICAgICAgICAgDQogICAgICAgICAgICAjIFRyeSB0byBwYXJzZSBhcyBDU1YNCiAgICAgICAgICAgIGlmICcsJyBpbiBjb250ZW50Og0KICAgICAgICAgICAgICAgIGlkcyA9IFtpZC5zdHJpcCgpIGZvciBpZCBpbiBjb250ZW50LnNwbGl0KCcsJyldDQogICAgICAgICAgICAgICAgIyBFbnN1cmUgYWxsIElEcyBhcmUgc3RyaW5nIHR5cGUNCiAgICAgICAgICAgICAgICByZXR1cm4gW3N0cihpZCkgZm9yIGlkIGluIGlkc10NCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICMgRGVmYXVsdDogb25lIElEIHBlciBsaW5lDQogICAgICAgICAgICBpZHMgPSBbbGluZS5zdHJpcCgpIGZvciBsaW5lIGluIGNvbnRlbnQuc3BsaXQoJ1xuJykgaWYgbGluZS5zdHJpcCgpXQ0KICAgICAgICAgICAgIyBFbnN1cmUgYWxsIElEcyBhcmUgc3RyaW5nIHR5cGUNCiAgICAgICAgICAgIHJldHVybiBbc3RyKGlkKSBmb3IgaWQgaW4gaWRzXQ0KICAgIA0KICAgIGRlZiBfc2F2ZV9zcGxpdF9pbmZvKHNlbGYpIC0+IE5vbmU6DQogICAgICAgICIiIg0KICAgICAgICBTYXZlIHRyYWluL3Rlc3Qgc3BsaXQgaW5mb3JtYXRpb24NCiAgICAgICAgIiIiDQogICAgICAgIHNwbGl0X2luZm8gPSB7DQogICAgICAgICAgICAnc3BsaXRfbWV0aG9kJzogc2VsZi5zcGxpdF9tZXRob2QsDQogICAgICAgICAgICAndHJhaW5fc2l6ZSc6IGxlbihzZWxmLmRhdGFfdHJhaW4pLA0KICAgICAgICAgICAgJ3Rlc3Rfc2l6ZSc6IGxlbihzZWxmLmRhdGFfdGVzdCksDQogICAgICAgICAgICAndHJhaW5fc3ViamVjdHMnOiBsaXN0KHNlbGYuZGF0YV90cmFpbi5pbmRleCksDQogICAgICAgICAgICAndGVzdF9zdWJqZWN0cyc6IGxpc3Qoc2VsZi5kYXRhX3Rlc3QuaW5kZXgpDQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgICMgU2F2ZSB0byBKU09ODQogICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRwdXRfZGlyLCAnc3BsaXRfaW5mby5qc29uJyksICd3JykgYXMgZjoNCiAgICAgICAgICAgIGpzb24uZHVtcChzcGxpdF9pbmZvLCBmLCBpbmRlbnQ9NCkNCg0KICAgIGRlZiBub3JtYWxpemF0aW9uKHNlbGYpIC0+ICdNb2RlbGluZyc6DQogICAgICAgICIiIg0KICAgICAgICBQZXJmb3JtIHotc2NvcmUgc3RhbmRhcmRpemF0aW9uDQogICAgICAgIA0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgTW9kZWxpbmc6IFNlbGYgaW5zdGFuY2UgZm9yIG1ldGhvZCBjaGFpbmluZw0KICAgICAgICAiIiINCiAgICAgICAgc3MgPSBTdGFuZGFyZFNjYWxlcigpDQogICAgICAgIHhfdHJhaW4gPSBzcy5maXRfdHJhbnNmb3JtKHNlbGYueF90cmFpbikNCiAgICAgICAgeF90ZXN0ID0gc3MudHJhbnNmb3JtKHNlbGYueF90ZXN0KQ0KICAgICAgICBzZWxmLnhfdHJhaW4udmFsdWVzWzosOl0gPSB4X3RyYWluDQogICAgICAgIHNlbGYueF90ZXN0LnZhbHVlc1s6LDpdID0geF90ZXN0DQogICAgICAgIA0KICAgICAgICAjIFNhdmUgc2NhbGVyIGZvciBmdXR1cmUgdXNlDQogICAgICAgIHNlbGYuc2NhbGVyID0gc3MNCiAgICAgICAgIyBTYXZlIGZlYXR1cmUgbmFtZXMgdXNlZCBkdXJpbmcgZml0DQogICAgICAgIHNlbGYuc2NhbGVyX2ZlYXR1cmVfbmFtZXMgPSBsaXN0KHNlbGYueF90cmFpbi5jb2x1bW5zKQ0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHNlbGYNCg0KICAgIGRlZiBmZWF0dXJlX3NlbGVjdGlvbihzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgUGVyZm9ybSBmZWF0dXJlIHNlbGVjdGlvbg0KICAgICAgICANCiAgICAgICAgRXhlY3V0ZXMgZmVhdHVyZSBzZWxlY3Rpb24gbWV0aG9kcyBpbiBzZXF1ZW5jZSBhY2NvcmRpbmcgdG8gdGhlIGNvbmZpZ3VyYXRpb24NCiAgICAgICAgDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICBNb2RlbGluZzogU2VsZiBpbnN0YW5jZSBmb3IgbWV0aG9kIGNoYWluaW5nDQogICAgICAgICIiIg0KICAgICAgICAjIENoZWNrIGlmIGZlYXR1cmUgc2VsZWN0aW9uIG1ldGhvZHMgYXJlIHByb3ZpZGVkDQogICAgICAgIGlmIHNlbGYuZmVhdHVyZV9zZWxlY3Rpb25fbWV0aG9kcyBpcyBOb25lOg0KICAgICAgICAgICAgcHJpbnQoIldhcm5pbmc6IE5vIGZlYXR1cmUgc2VsZWN0aW9uIG1ldGhvZHMgcHJvdmlkZWQsIHVzaW5nIG9yaWdpbmFsIGZlYXR1cmUgc2V0IikNCiAgICAgICAgICAgIHNlbGYuc2VsZWN0ZWRfZmVhdHVyZXMgPSBsaXN0KHNlbGYueF90cmFpbi5jb2x1bW5zKQ0KICAgICAgICAgICAgcmV0dXJuIHNlbGYNCiAgICAgICAgDQogICAgICAgICMgU3RvcmUgY3VycmVudCBmZWF0dXJlIHNldA0KICAgICAgICBzZWxlY3RlZF9mZWF0dXJlcyA9IGxpc3Qoc2VsZi54X3RyYWluLmNvbHVtbnMpDQogICAgICAgIA0KICAgICAgICAjIEV4ZWN1dGUgZmVhdHVyZSBzZWxlY3Rpb24gbWV0aG9kcyBpbiBzZXF1ZW5jZQ0KICAgICAgICBzZWxlY3RlZF9mZWF0dXJlc19vZl9lYWNoX21ldGhvZCA9IHt9DQogICAgICAgIGZvciBzZWxlY3Rpb25fY29uZmlnIGluIHNlbGYuZmVhdHVyZV9zZWxlY3Rpb25fbWV0aG9kczoNCiAgICAgICAgICAgIG1ldGhvZF9uYW1lID0gc2VsZWN0aW9uX2NvbmZpZ1snbWV0aG9kJ10NCiAgICAgICAgICAgIHBhcmFtcyA9IHNlbGVjdGlvbl9jb25maWcuZ2V0KCdwYXJhbXMnLCB7fSkNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgcHJpbnQoZiJcbkV4ZWN1dGluZyB7bWV0aG9kX25hbWV9IGZlYXR1cmUgc2VsZWN0aW9uLi4uIikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgdHJ5Og0KICAgICAgICAgICAgICAgICMgQWRkIGNvbW1vbiBwYXJhbWV0ZXJzDQogICAgICAgICAgICAgICAgcGFyYW1zWydvdXRkaXInXSA9IHBhcmFtcy5nZXQoJ291dGRpcicsIHNlbGYub3V0cHV0X2RpcikNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgICAgICAjIFJ1biBmZWF0dXJlIHNlbGVjdG9yDQogICAgICAgICAgICAgICAgc2VsZWN0ZWQgPSBydW5fc2VsZWN0b3IoDQogICAgICAgICAgICAgICAgICAgIG1ldGhvZF9uYW1lLA0KICAgICAgICAgICAgICAgICAgICBzZWxmLnhfdHJhaW4sDQogICAgICAgICAgICAgICAgICAgIHNlbGYueV90cmFpbiwNCiAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRfZmVhdHVyZXMsDQogICAgICAgICAgICAgICAgICAgICoqcGFyYW1zDQogICAgICAgICAgICAgICAgKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgICAgICMgVXBkYXRlIGZlYXR1cmUgc2V0DQogICAgICAgICAgICAgICAgc2VsZWN0ZWRfZmVhdHVyZXMgPSBzZWxlY3RlZA0KICAgICAgICAgICAgICAgIHNlbGVjdGVkX2ZlYXR1cmVzX29mX2VhY2hfbWV0aG9kW21ldGhvZF9uYW1lXSA9IHNlbGVjdGVkX2ZlYXR1cmVzDQoNCiAgICAgICAgICAgICAgICAjIHByaW50IHNlbGVjdGVkIGZlYXR1cmVzIGFuZCByZW1vdmVkIGZlYXR1cmVzDQogICAgICAgICAgICAgICAgcHJpbnQoZiJTZWxlY3RlZCBmZWF0dXJlczoge3NlbGVjdGVkX2ZlYXR1cmVzfSIpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAgICAgIyBXYXJuIGlmIG5vIGZlYXR1cmVzIHNlbGVjdGVkDQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGVjdGVkX2ZlYXR1cmVzOg0KICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiTm8gZmVhdHVyZXMgcmVtYWluaW5nIGFmdGVyIHttZXRob2RfbmFtZX0gc2VsZWN0aW9uLCBwbGVhc2UgY2hlY2sgc2V0dGluZ3MiKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOg0KICAgICAgICAgICAgICAgIHByaW50KGYiV2FybmluZzoge21ldGhvZF9uYW1lfSBzZWxlY3Rpb24gZmFpbGVkOiB7ZX0iKQ0KICAgICAgICAgICAgICAgIHByaW50KGYiU2tpcHBpbmcgdGhpcyBtZXRob2QsIGNvbnRpbnVpbmcgd2l0aCBjdXJyZW50IGZlYXR1cmUgc2V0OiB7bGVuKHNlbGVjdGVkX2ZlYXR1cmVzKX0gZmVhdHVyZXMiKQ0KICAgICAgICANCiAgICAgICAgIyBGaW5hbCBzZWxlY3RlZCBmZWF0dXJlcw0KICAgICAgICBzZWxmLnNlbGVjdGVkX2ZlYXR1cmVzID0gc2VsZWN0ZWRfZmVhdHVyZXMNCiAgICAgICAgcHJpbnQoZiJcbkZpbmFsIG51bWJlciBvZiBzZWxlY3RlZCBmZWF0dXJlczoge2xlbihzZWxmLnNlbGVjdGVkX2ZlYXR1cmVzKX0iKQ0KICAgICAgICBwcmludChmIlNlbGVjdGVkIGZlYXR1cmVzOiB7c2VsZi5zZWxlY3RlZF9mZWF0dXJlc30iKQ0KICAgICAgICANCiAgICAgICAgIyBTYXZlIGZlYXR1cmUgc2VsZWN0aW9uIHJlc3VsdHMNCiAgICAgICAgcmVzdWx0c19kaWN0ID0gew0KICAgICAgICAgICAgJ3NlbGVjdGVkX2ZlYXR1cmVzJzogc2VsZi5zZWxlY3RlZF9mZWF0dXJlcywNCiAgICAgICAgICAgICdmZWF0dXJlX3NlbGVjdGlvbl9tZXRob2RzJzogc2VsZi5mZWF0dXJlX3NlbGVjdGlvbl9tZXRob2RzLA0KICAgICAgICAgICAgJ3NlbGVjdGVkX2ZlYXR1cmVzX29mX2VhY2hfbWV0aG9kJzogc2VsZWN0ZWRfZmVhdHVyZXNfb2ZfZWFjaF9tZXRob2QNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9kaXIsICdmZWF0dXJlX3NlbGVjdGlvbl9yZXN1bHRzLmpzb24nKSwgJ3cnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOg0KICAgICAgICAgICAganNvbi5kdW1wKHJlc3VsdHNfZGljdCwgZiwgZW5zdXJlX2FzY2lpPUZhbHNlLCBpbmRlbnQ9NCkNCiAgICAgICAgDQogICAgICAgIHJldHVybiBzZWxmDQoNCiAgICBkZWYgbW9kZWxpbmcoc2VsZikgLT4gJ01vZGVsaW5nJzoNCiAgICAgICAgIiIiDQogICAgICAgIFRyYWluIG1hY2hpbmUgbGVhcm5pbmcgbW9kZWxzDQogICAgICAgIA0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgTW9kZWxpbmc6IFNlbGYgaW5zdGFuY2UgZm9yIG1ldGhvZCBjaGFpbmluZw0KICAgICAgICAiIiINCiAgICAgICAgIyBVc2UgZGlyZWN0IG1vZGVsIGltcG9ydCBpbnN0ZWFkIG9mIGZhY3RvcnkgcGF0dGVybg0KICAgICAgICByZXN1bHRzID0gew0KICAgICAgICAgICAgJ3RyYWluJzoge30sDQogICAgICAgICAgICAndGVzdCc6IHt9DQogICAgICAgIH0NCiAgICAgICAgbW9kZWxzID0ge30NCiAgICAgICAgDQogICAgICAgICMgSXRlcmF0ZSB0aHJvdWdoIG1vZGVscyBpbiBjb25maWd1cmF0aW9uDQogICAgICAgIGZvciBtb2RlbF9uYW1lLCBtb2RlbF9jb25maWcgaW4gc2VsZi5jb25maWcuZ2V0KCdtb2RlbHMnLCB7fSkuaXRlbXMoKToNCiAgICAgICAgICAgIHByaW50KGYiXG5UcmFpbmluZyBtb2RlbDoge21vZGVsX25hbWV9IikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBDcmVhdGUgbW9kZWwNCiAgICAgICAgICAgIG1vZGVsID0gTW9kZWxGYWN0b3J5LmNyZWF0ZV9tb2RlbChtb2RlbF9uYW1lLCBtb2RlbF9jb25maWcpDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgR2V0IGZlYXR1cmUgZGF0YQ0KICAgICAgICAgICAgWF90cmFpbiA9IHNlbGYueF90cmFpbltzZWxmLnNlbGVjdGVkX2ZlYXR1cmVzXQ0KICAgICAgICAgICAgWF90ZXN0ID0gc2VsZi54X3Rlc3Rbc2VsZi5zZWxlY3RlZF9mZWF0dXJlc10NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBUcmFpbiBtb2RlbA0KICAgICAgICAgICAgbW9kZWwuZml0KFhfdHJhaW4sIHNlbGYueV90cmFpbikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBTYXZlIG1vZGVsIG9iamVjdA0KICAgICAgICAgICAgbW9kZWxzW21vZGVsX25hbWVdID0gbW9kZWwNCiAgICAgICAgDQogICAgICAgICMgU2F2ZSByZXN1bHRzIGFuZCBtb2RlbHMNCiAgICAgICAgc2VsZi5yZXN1bHRzID0gcmVzdWx0cw0KICAgICAgICBzZWxmLm1vZGVscyA9IG1vZGVscw0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHNlbGYNCiAgICAgICAgDQogICAgZGVmIGV2YWx1YXRlX21vZGVscyhzZWxmKSAtPiAnTW9kZWxpbmcnOg0KICAgICAgICAiIiINCiAgICAgICAgRXZhbHVhdGUgbW9kZWxzLCB2aXN1YWxpemUgcmVzdWx0cywgYW5kIHNhdmUgZXZhbHVhdGlvbiByZXN1bHRzDQogICAgICAgIA0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgTW9kZWxpbmc6IFNlbGYgaW5zdGFuY2UgZm9yIG1ldGhvZCBjaGFpbmluZw0KICAgICAgICAiIiINCiAgICAgICAgIyBDcmVhdGUgZXZhbHVhdG9yDQogICAgICAgIGV2YWx1YXRvciA9IE1vZGVsRXZhbHVhdG9yKHNlbGYub3V0cHV0X2RpcikNCiAgICAgICAgDQogICAgICAgICMgR2V0IGZlYXR1cmUgZGF0YQ0KICAgICAgICBYX3RyYWluID0gc2VsZi54X3RyYWluW3NlbGYuc2VsZWN0ZWRfZmVhdHVyZXNdDQogICAgICAgIFhfdGVzdCA9IHNlbGYueF90ZXN0W3NlbGYuc2VsZWN0ZWRfZmVhdHVyZXNdDQogICAgICAgIA0KICAgICAgICAjIEV2YWx1YXRlIGVhY2ggbW9kZWwNCiAgICAgICAgZm9yIG1vZGVsX25hbWUsIG1vZGVsIGluIHNlbGYubW9kZWxzLml0ZW1zKCk6DQogICAgICAgICAgICBwcmludChmIlxuRXZhbHVhdGluZyBtb2RlbDoge21vZGVsX25hbWV9IikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBFdmFsdWF0ZSBtb2RlbCAtIHRyYWluaW5nIHNldA0KICAgICAgICAgICAgdHJhaW5fcmVzdWx0cyA9IGV2YWx1YXRvci5ldmFsdWF0ZShtb2RlbCwgWF90cmFpbiwgc2VsZi55X3RyYWluLCAidHJhaW4iKQ0KICAgICAgICAgICAgc2VsZi5yZXN1bHRzWyd0cmFpbiddW21vZGVsX25hbWVdID0gdHJhaW5fcmVzdWx0cw0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIEV2YWx1YXRlIG1vZGVsIC0gdGVzdCBzZXQNCiAgICAgICAgICAgIHRlc3RfcmVzdWx0cyA9IGV2YWx1YXRvci5ldmFsdWF0ZShtb2RlbCwgWF90ZXN0LCBzZWxmLnlfdGVzdCwgInRlc3QiKQ0KICAgICAgICAgICAgc2VsZi5yZXN1bHRzWyd0ZXN0J11bbW9kZWxfbmFtZV0gPSB0ZXN0X3Jlc3VsdHMNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBQcmludCBmZWF0dXJlIGltcG9ydGFuY2UgKGlmIGF2YWlsYWJsZSkNCiAgICAgICAgICAgIGlmIGhhc2F0dHIobW9kZWwsICdnZXRfZmVhdHVyZV9pbXBvcnRhbmNlJyk6DQogICAgICAgICAgICAgICAgZmVhdHVyZV9pbXBvcnRhbmNlID0gbW9kZWwuZ2V0X2ZlYXR1cmVfaW1wb3J0YW5jZSgpDQogICAgICAgICAgICAgICAgcHJpbnQoZiJGZWF0dXJlIGltcG9ydGFuY2U6IHtmZWF0dXJlX2ltcG9ydGFuY2V9IikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBQbG90IFNIQVAgdmFsdWVzIGZvciBlYWNoIG1vZGVsDQogICAgICAgICAgICBzZWxmLnBsb3R0ZXIucGxvdF9zaGFwKG1vZGVsLCBYX3Rlc3QsIHNlbGYuc2VsZWN0ZWRfZmVhdHVyZXMsIHNhdmVfbmFtZT1mJ3ttb2RlbF9uYW1lfV9TSEFQLnBkZicpICAjIHNhdmVfbmFtZSBub3QgdXNlZCwgb25seSB1c2UgLnBkZiBzdWZmaXgNCiAgICAgICAgDQogICAgICAgICMgUHJpbnQgcGVyZm9ybWFuY2UgdGFibGUNCiAgICAgICAgZXZhbHVhdG9yLl9wcmludF9wZXJmb3JtYW5jZV90YWJsZShzZWxmLnJlc3VsdHMpDQogICAgICAgIA0KICAgICAgICAjIFBsb3QgZXZhbHVhdGlvbiByZXN1bHRzDQogICAgICAgIGlmIHNlbGYuaXNfdmlzdWFsaXplOg0KICAgICAgICAgICAgZXZhbHVhdG9yLnBsb3RfY3VydmVzKHNlbGYucmVzdWx0cykNCiAgICAgICAgDQogICAgICAgICMgU2F2ZSBkZXRhaWxlZCBwcmVkaWN0aW9uIHJlc3VsdHMNCiAgICAgICAgc2VsZi5fc2F2ZV9wcmVkaWN0aW9uX3Jlc3VsdHMoKQ0KICAgICAgICANCiAgICAgICAgIyBTYXZlIHRyYWluZWQgbW9kZWxzIGFuZCBhbGwgbmVjZXNzYXJ5IHByZXByb2Nlc3NpbmcgaW5mb3JtYXRpb24NCiAgICAgICAgaWYgc2VsZi5pc19zYXZlX21vZGVsOg0KICAgICAgICAgICAgc2VsZi5fc2F2ZV9jb21wbGV0ZV9tb2RlbHMoKQ0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHNlbGYNCg0KICAgIGRlZiBfc2F2ZV9wcmVkaWN0aW9uX3Jlc3VsdHMoc2VsZikgLT4gTm9uZToNCiAgICAgICAgIiIiDQogICAgICAgIFNhdmUgZGV0YWlsZWQgcHJlZGljdGlvbiByZXN1bHRzIHRvIENTViBmaWxlcw0KICAgICAgICAiIiINCiAgICAgICAgIyBDcmVhdGUgY2xlYW4gZGF0YWZyYW1lcyBmb3IgcmVzdWx0cyB3aXRoIG9ubHkgZXNzZW50aWFsIGNvbHVtbnMNCiAgICAgICAgdHJhaW5fZGYgPSBwZC5EYXRhRnJhbWUoe3NlbGYuc3ViamVjdF9pZF9jb2w6IHNlbGYuZGF0YV90cmFpbi5pbmRleH0pDQogICAgICAgIHRlc3RfZGYgPSBwZC5EYXRhRnJhbWUoe3NlbGYuc3ViamVjdF9pZF9jb2w6IHNlbGYuZGF0YV90ZXN0LmluZGV4fSkNCiAgICAgICAgDQogICAgICAgICMgQWRkIHRydWUgbGFiZWxzDQogICAgICAgIHRyYWluX2RmWyd0cnVlX2xhYmVsJ10gPSBzZWxmLnlfdHJhaW4udmFsdWVzDQogICAgICAgIHRlc3RfZGZbJ3RydWVfbGFiZWwnXSA9IHNlbGYueV90ZXN0LnZhbHVlcw0KICAgICAgICANCiAgICAgICAgIyBBZGQgcHJlZGljdGlvbnMgYW5kIHByb2JhYmlsaXRpZXMgZm9yIGVhY2ggbW9kZWwNCiAgICAgICAgZm9yIG1vZGVsX25hbWUgaW4gc2VsZi5yZXN1bHRzWyd0cmFpbiddLmtleXMoKToNCiAgICAgICAgICAgICMgVHJhaW5pbmcgc2V0IHJlc3VsdHMNCiAgICAgICAgICAgIHRyYWluX2RmW2Yne21vZGVsX25hbWV9X3ByZWQnXSA9IHNlbGYucmVzdWx0c1sndHJhaW4nXVttb2RlbF9uYW1lXVsneV9wcmVkJ10NCiAgICAgICAgICAgIHRyYWluX2RmW2Yne21vZGVsX25hbWV9X3Byb2InXSA9IHNlbGYucmVzdWx0c1sndHJhaW4nXVttb2RlbF9uYW1lXVsneV9wcmVkX3Byb2JhJ10NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBUZXN0aW5nIHNldCByZXN1bHRzDQogICAgICAgICAgICB0ZXN0X2RmW2Yne21vZGVsX25hbWV9X3ByZWQnXSA9IHNlbGYucmVzdWx0c1sndGVzdCddW21vZGVsX25hbWVdWyd5X3ByZWQnXQ0KICAgICAgICAgICAgdGVzdF9kZltmJ3ttb2RlbF9uYW1lfV9wcm9iJ10gPSBzZWxmLnJlc3VsdHNbJ3Rlc3QnXVttb2RlbF9uYW1lXVsneV9wcmVkX3Byb2JhJ10NCiAgICAgICAgDQogICAgICAgICMgU2F2ZSBhbGwtaW4tb25lIHJlc3VsdHMgd2l0aCBib3RoIHRyYWluaW5nIGFuZCB0ZXN0aW5nIGRhdGENCiAgICAgICAgYWxsX2RmID0gcGQuY29uY2F0KFt0cmFpbl9kZiwgdGVzdF9kZl0pDQogICAgICAgICMgQWRkIGEgY29sdW1uIHRvIGRpc3Rpbmd1aXNoIHRyYWluIGFuZCB0ZXN0IHNhbXBsZXMNCiAgICAgICAgYWxsX2RmWydzcGxpdCddID0gWyd0cmFpbiddICogbGVuKHRyYWluX2RmKSArIFsndGVzdCddICogbGVuKHRlc3RfZGYpDQogICAgICAgIA0KICAgICAgICBhbGxfcmVzdWx0c19wYXRoID0gb3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2RpciwgJ2FsbF9wcmVkaWN0aW9uX3Jlc3VsdHMuY3N2JykNCiAgICAgICAgYWxsX2RmLnRvX2NzdihhbGxfcmVzdWx0c19wYXRoLCBpbmRleD1GYWxzZSkNCiAgICAgICAgcHJpbnQoZiJTYXZlZCBjb21wbGV0ZSBwcmVkaWN0aW9uIHJlc3VsdHMgdG86IHthbGxfcmVzdWx0c19wYXRofSIpDQogICAgDQogICAgZGVmIF9zYXZlX2NvbXBsZXRlX21vZGVscyhzZWxmKSAtPiBOb25lOg0KICAgICAgICAiIiINCiAgICAgICAgU2F2ZSB0cmFpbmVkIG1vZGVscyBhbmQgYWxsIG5lY2Vzc2FyeSBwcmVwcm9jZXNzaW5nIGluZm9ybWF0aW9uDQogICAgICAgICIiIg0KICAgICAgICBpbXBvcnQgcGlja2xlDQogICAgICAgIA0KICAgICAgICAjIENyZWF0ZSBhIGRpY3Rpb25hcnkgd2l0aCBhbGwgaW5mb3JtYXRpb24gbmVlZGVkIGZvciBmdXR1cmUgcHJlZGljdGlvbnMNCiAgICAgICAgbW9kZWxfcGFja2FnZSA9IHsNCiAgICAgICAgICAgICdtb2RlbHMnOiBzZWxmLm1vZGVscywNCiAgICAgICAgICAgICdzY2FsZXInOiBzZWxmLnNjYWxlciwNCiAgICAgICAgICAgICdzY2FsZXJfZmVhdHVyZV9uYW1lcyc6IHNlbGYuc2NhbGVyX2ZlYXR1cmVfbmFtZXMsICAjIFNhdmUgZmVhdHVyZSBuYW1lcyB1c2VkIGR1cmluZyBzY2FsaW5nDQogICAgICAgICAgICAnc2VsZWN0ZWRfZmVhdHVyZXMnOiBzZWxmLnNlbGVjdGVkX2ZlYXR1cmVzLA0KICAgICAgICAgICAgJ2NvbmZpZyc6IHNlbGYuY29uZmlnLA0KICAgICAgICAgICAgJ3ByZXByb2Nlc3NpbmdfaW5mbyc6IHsNCiAgICAgICAgICAgICAgICAnc3ViamVjdF9pZF9jb2wnOiBzZWxmLnN1YmplY3RfaWRfY29sLA0KICAgICAgICAgICAgICAgICdsYWJlbF9jb2wnOiBzZWxmLmxhYmVsX2NvbCwNCiAgICAgICAgICAgICAgICAnZmVhdHVyZV9zZWxlY3Rpb25zJzogc2VsZi5mZWF0dXJlX3NlbGVjdGlvbl9tZXRob2RzLA0KICAgICAgICAgICAgICAgICdub3JtYWxpemF0aW9uJzogc2VsZi5zY2FsZXINCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgIyBTYXZlIHRoZSBjb21wbGV0ZSBtb2RlbCBwYWNrYWdlDQogICAgICAgIG1vZGVsX3BhY2thZ2VfcGF0aCA9IG9zLnBhdGguam9pbihzZWxmLm91dHB1dF9kaXIsICdtb2RlbF9wYWNrYWdlLnBrbCcpDQogICAgICAgIHdpdGggb3Blbihtb2RlbF9wYWNrYWdlX3BhdGgsICd3YicpIGFzIGY6DQogICAgICAgICAgICBwaWNrbGUuZHVtcChtb2RlbF9wYWNrYWdlLCBmKQ0KICAgICAgICANCiAgICAgICAgcHJpbnQoZiJTYXZlZCBjb21wbGV0ZSBtb2RlbCBwYWNrYWdlIHRvOiB7bW9kZWxfcGFja2FnZV9wYXRofSIpDQogICAgICAgIA0KICAgICAgICAjIFByZXBhcmUgbW9kZWwgbmFtZXMgbGlzdCBmb3IgdXNhZ2UgaW5zdHJ1Y3Rpb25zDQogICAgICAgIG1vZGVsX25hbWVzX2xpc3QgPSAnXG4nLmpvaW4oW2YiLSB7bmFtZX0iIGZvciBuYW1lIGluIHNlbGYubW9kZWxzLmtleXMoKV0pDQogICAgICAgIA0KICAgICAgICAjIFNhdmUgdXNhZ2UgaW5zdHJ1Y3Rpb25zIGFzIGEgdGV4dCBmaWxlDQogICAgICAgIHVzYWdlX2luc3RydWN0aW9ucyA9IGYiIiINCiAgICAgICAgTW9kZWwgVXNhZ2UgSW5zdHJ1Y3Rpb25zDQogICAgICAgID09PT09PT09PT09PT09PT09PT09PT09DQoNCiAgICAgICAgVGhpcyBkaXJlY3RvcnkgY29udGFpbnMgdHJhaW5lZCBtb2RlbHMgYW5kIGFsbCBuZWNlc3NhcnkgaW5mb3JtYXRpb24gZm9yIG1ha2luZyBuZXcgcHJlZGljdGlvbnMuDQogICAgICAgIEhlcmUncyBob3cgdG8gdXNlIHRoZSBzYXZlZCBtb2RlbHM6DQoNCiAgICAgICAgMS4gTG9hZCB0aGUgbW9kZWwgcGFja2FnZToNCiAgICAgICAgYGBgcHl0aG9uDQogICAgICAgIGltcG9ydCBwaWNrbGUNCiAgICAgICAgd2l0aCBvcGVuKCdtb2RlbF9wYWNrYWdlLnBrbCcsICdyYicpIGFzIGY6DQogICAgICAgICAgICBtb2RlbF9wYWNrYWdlID0gcGlja2xlLmxvYWQoZikNCiAgICAgICAgYGBgDQoNCiAgICAgICAgMi4gRXh0cmFjdCBjb21wb25lbnRzOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgbW9kZWxzID0gbW9kZWxfcGFja2FnZVsnbW9kZWxzJ10NCiAgICAgICAgc2NhbGVyID0gbW9kZWxfcGFja2FnZVsnc2NhbGVyJ10NCiAgICAgICAgc2NhbGVyX2ZlYXR1cmVfbmFtZXMgPSBtb2RlbF9wYWNrYWdlWydzY2FsZXJfZmVhdHVyZV9uYW1lcyddDQogICAgICAgIHNlbGVjdGVkX2ZlYXR1cmVzID0gbW9kZWxfcGFja2FnZVsnc2VsZWN0ZWRfZmVhdHVyZXMnXQ0KICAgICAgICBwcmVwcm9jZXNzaW5nX2luZm8gPSBtb2RlbF9wYWNrYWdlWydwcmVwcm9jZXNzaW5nX2luZm8nXQ0KICAgICAgICBgYGANCg0KICAgICAgICAzLiBQcmVwcm9jZXNzIG5ldyBkYXRhOg0KICAgICAgICAtIEVuc3VyZSB5b3VyIGRhdGEgaW5jbHVkZXMgYWxsIGZlYXR1cmVzIHVzZWQgZHVyaW5nIHRyYWluaW5nDQogICAgICAgIC0gQXBwbHkgdGhlIHNhbWUgcHJlcHJvY2Vzc2luZyAoc2NhbGluZykgdXNpbmcgdGhlIHNhZmVfdHJhbnNmb3JtIGZ1bmN0aW9uOg0KICAgICAgICBgYGBweXRob24NCiAgICAgICAgZGVmIHNhZmVfdHJhbnNmb3JtKHNjYWxlciwgZGF0YSwgc2NhbGVyX2ZlYXR1cmVfbmFtZXMpOg0KICAgICAgICAgICAgJycnDQogICAgICAgICAgICBBcHBseSBzY2FsaW5nIG9ubHkgdG8gY29sdW1ucyB0aGF0IHdlcmUgcHJlc2VudCBkdXJpbmcgZml0DQogICAgICAgICAgICANCiAgICAgICAgICAgIEFyZ3M6DQogICAgICAgICAgICAgICAgc2NhbGVyOiBUcmFpbmVkIHNjYWxlciBvYmplY3QNCiAgICAgICAgICAgICAgICBkYXRhOiBEYXRhRnJhbWUgdG8gdHJhbnNmb3JtDQogICAgICAgICAgICAgICAgc2NhbGVyX2ZlYXR1cmVfbmFtZXM6IEZlYXR1cmUgbmFtZXMgdXNlZCBkdXJpbmcgc2NhbGVyIGZpdA0KICAgICAgICAgICAgJycnDQogICAgICAgICAgICAjIEdldCBjb21tb24gY29sdW1ucyBiZXR3ZWVuIGRhdGEgYW5kIHNjYWxlciBmZWF0dXJlcw0KICAgICAgICAgICAgY29tbW9uX2NvbHMgPSBbY29sIGZvciBjb2wgaW4gc2NhbGVyX2ZlYXR1cmVfbmFtZXMgaWYgY29sIGluIGRhdGEuY29sdW1uc10NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBHZXQgbWlzc2luZyBjb2x1bW5zDQogICAgICAgICAgICBtaXNzaW5nX2NvbHMgPSBbY29sIGZvciBjb2wgaW4gc2NhbGVyX2ZlYXR1cmVfbmFtZXMgaWYgY29sIG5vdCBpbiBkYXRhLmNvbHVtbnNdDQogICAgICAgICAgICBpZiBtaXNzaW5nX2NvbHM6DQogICAgICAgICAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiBNaXNzaW5nIGNvbHVtbnMgaW4gbmV3IGRhdGE6IHt7bWlzc2luZ19jb2xzfX0iKQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFRyYW5zZm9ybSBvbmx5IHRoZSBjb2x1bW5zIHRoYXQgd2VyZSBwcmVzZW50IGR1cmluZyBmaXQNCiAgICAgICAgICAgIGlmIGNvbW1vbl9jb2xzOg0KICAgICAgICAgICAgICAgIGRhdGFfdG9fdHJhbnNmb3JtID0gZGF0YVtjb21tb25fY29sc10uY29weSgpDQogICAgICAgICAgICAgICAgZGF0YV90cmFuc2Zvcm1lZCA9IHNjYWxlci50cmFuc2Zvcm0oZGF0YV90b190cmFuc2Zvcm0pDQogICAgICAgICAgICAgICAgcmVzdWx0ID0gZGF0YS5jb3B5KCkNCiAgICAgICAgICAgICAgICByZXN1bHRbY29tbW9uX2NvbHNdID0gZGF0YV90cmFuc2Zvcm1lZA0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgcHJpbnQoIk5vIGNvbW1vbiBjb2x1bW5zIGZvdW5kIGZvciB0cmFuc2Zvcm1hdGlvbiIpDQogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGENCg0KICAgICAgICAjIFRyYW5zZm9ybSB0aGUgbmV3IGRhdGEgc2FmZWx5DQogICAgICAgIFhfbmV3X3NjYWxlZCA9IHNhZmVfdHJhbnNmb3JtKHNjYWxlciwgeW91cl9kYXRhLCBzY2FsZXJfZmVhdHVyZV9uYW1lcykNCg0KICAgICAgICAjIEZpbHRlciB0byBvbmx5IGluY2x1ZGUgc2VsZWN0ZWQgZmVhdHVyZXMgZm9yIHByZWRpY3Rpb24NCiAgICAgICAgWF9uZXdfc2VsZWN0ZWQgPSBYX25ld19zY2FsZWRbc2VsZWN0ZWRfZmVhdHVyZXNdDQogICAgICAgIGBgYA0KDQogICAgICAgIDQuIE1ha2UgcHJlZGljdGlvbnMgd2l0aCBvbmUgb3IgbW9yZSBtb2RlbHM6DQogICAgICAgIGBgYHB5dGhvbg0KICAgICAgICAjIENob29zZSBhIG1vZGVsIChlLmcuLCBMb2dpc3RpY1JlZ3Jlc3Npb24pDQogICAgICAgIG1vZGVsID0gbW9kZWxzWydMb2dpc3RpY1JlZ3Jlc3Npb24nXQ0KDQogICAgICAgICMgTWFrZSBwcmVkaWN0aW9ucw0KICAgICAgICBwcmVkaWN0aW9ucyA9IG1vZGVsLnByZWRpY3QoWF9uZXdfc2VsZWN0ZWQpDQogICAgICAgIHByb2JhYmlsaXRpZXMgPSBtb2RlbC5wcmVkaWN0X3Byb2JhKFhfbmV3X3NlbGVjdGVkKVs6LCAxXSAgIyBQcm9iYWJpbGl0eSBvZiBwb3NpdGl2ZSBjbGFzcw0KICAgICAgICBgYGANCg0KICAgICAgICA1LiBBdmFpbGFibGUgbW9kZWxzOg0KICAgICAgICB7bW9kZWxfbmFtZXNfbGlzdH0NCg0KICAgICAgICA2LiBDb21tYW5kLWxpbmUgcHJlZGljdGlvbjoNCiAgICAgICAgWW91IGNhbiBhbHNvIHVzZSB0aGUgY29tbWFuZC1saW5lIGludGVyZmFjZSBmb3IgcHJlZGljdGlvbnM6DQogICAgICAgIGBgYA0KICAgICAgICBweXRob24gZGF5XzEwX3dob2xlX2NvZGUucHkgLS1tb2RlIHByZWRpY3QgLS1tb2RlbCB7bW9kZWxfcGFja2FnZV9wYXRofSAtLWRhdGEgeW91cl9kYXRhLmNzdg0KICAgICAgICBgYGANCiAgICAgICAgIiIiDQoNCiAgICAgICAgIyBTYXZlIHVzYWdlIGluc3RydWN0aW9ucw0KICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKHNlbGYub3V0cHV0X2RpciwgJ21vZGVsX3VzYWdlX2luc3RydWN0aW9ucy50eHQnKSwgJ3cnKSBhcyBmOg0KICAgICAgICAgICAgZi53cml0ZSh1c2FnZV9pbnN0cnVjdGlvbnMpDQogICAgICAgICAgICANCiAgICBkZWYgcHJlZGljdF9uZXdfZGF0YShzZWxmLCBuZXdfZGF0YTogcGQuRGF0YUZyYW1lLCBtb2RlbF9uYW1lOiBzdHIgPSBOb25lKSAtPiBwZC5EYXRhRnJhbWU6DQogICAgICAgICIiIg0KICAgICAgICBBcHBseSB0cmFpbmVkIG1vZGVsIHRvIG5ldyBkYXRhDQogICAgICAgIA0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgbmV3X2RhdGEgKHBkLkRhdGFGcmFtZSk6IE5ldyBkYXRhIGZvciBwcmVkaWN0aW9uDQogICAgICAgICAgICBtb2RlbF9uYW1lIChzdHIsIG9wdGlvbmFsKTogTmFtZSBvZiBtb2RlbCB0byB1c2UuIElmIE5vbmUsIHVzZSBhbGwgbW9kZWxzLg0KICAgICAgICAgICAgDQogICAgICAgIFJldHVybnM6DQogICAgICAgICAgICBwZC5EYXRhRnJhbWU6IERhdGFmcmFtZSB3aXRoIHByZWRpY3Rpb25zIChvbmx5IGVzc2VudGlhbCBjb2x1bW5zKQ0KICAgICAgICAiIiINCiAgICAgICAgIyBDaGVjayBpZiB0aGUgbW9kZWxzIGFyZSBhdmFpbGFibGUNCiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgJ21vZGVscycpOg0KICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiTm8gdHJhaW5lZCBtb2RlbHMgYXZhaWxhYmxlLiBSdW4gdGhlIG1vZGVsaW5nIHBpcGVsaW5lIGZpcnN0LiIpDQogICAgICAgIA0KICAgICAgICAjIENyZWF0ZSBhIG5ldyBEYXRhRnJhbWUgd2l0aCBvbmx5IG5lY2Vzc2FyeSBjb2x1bW5zDQogICAgICAgIGlmIHNlbGYuc3ViamVjdF9pZF9jb2wgaW4gbmV3X2RhdGEuY29sdW1uczoNCiAgICAgICAgICAgICMgSUQgaXMgYSBjb2x1bW4NCiAgICAgICAgICAgIHJlc3VsdF9kZiA9IHBkLkRhdGFGcmFtZSh7c2VsZi5zdWJqZWN0X2lkX2NvbDogbmV3X2RhdGFbc2VsZi5zdWJqZWN0X2lkX2NvbF19KQ0KICAgICAgICBlbGlmIGlzaW5zdGFuY2UobmV3X2RhdGEuaW5kZXgsIHBkLkluZGV4KSBhbmQgbmV3X2RhdGEuaW5kZXgubmFtZSA9PSBzZWxmLnN1YmplY3RfaWRfY29sOg0KICAgICAgICAgICAgIyBJRCBpcyB0aGUgaW5kZXgNCiAgICAgICAgICAgIHJlc3VsdF9kZiA9IHBkLkRhdGFGcmFtZSh7c2VsZi5zdWJqZWN0X2lkX2NvbDogbmV3X2RhdGEuaW5kZXh9KQ0KICAgICAgICBlbHNlOg0KICAgICAgICAgICAgIyBDcmVhdGUgbnVtZXJpY2FsIElEcw0KICAgICAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiBTdWJqZWN0IElEIGNvbHVtbiAne3NlbGYuc3ViamVjdF9pZF9jb2x9JyBub3QgZm91bmQuIFVzaW5nIHJvdyBudW1iZXJzLiIpDQogICAgICAgICAgICByZXN1bHRfZGYgPSBwZC5EYXRhRnJhbWUoe3NlbGYuc3ViamVjdF9pZF9jb2w6IHJhbmdlKGxlbihuZXdfZGF0YSkpfSkNCiAgICAgICAgDQogICAgICAgICMgQWRkIHRydWUgbGFiZWwgaWYgYXZhaWxhYmxlDQogICAgICAgIGlmIHNlbGYubGFiZWxfY29sIGluIG5ld19kYXRhLmNvbHVtbnM6DQogICAgICAgICAgICByZXN1bHRfZGZbc2VsZi5sYWJlbF9jb2xdID0gbmV3X2RhdGFbc2VsZi5sYWJlbF9jb2xdDQogICAgICAgIA0KICAgICAgICAjIFJlbW92ZSBsYWJlbCBjb2x1bW4gZm9yIHByb2Nlc3NpbmcNCiAgICAgICAgWF9uZXcgPSBuZXdfZGF0YS5kcm9wKFtzZWxmLmxhYmVsX2NvbF0sIGF4aXM9MSkgaWYgc2VsZi5sYWJlbF9jb2wgaW4gbmV3X2RhdGEuY29sdW1ucyBlbHNlIG5ld19kYXRhLmNvcHkoKQ0KICAgICAgICANCiAgICAgICAgIyBBcHBseSBzY2FsaW5nIHNhZmVseSAtIG9ubHkgdG8gY29sdW1ucyB0aGF0IHdlcmUgcHJlc2VudCBkdXJpbmcgZml0DQogICAgICAgIGRlZiBzYWZlX3RyYW5zZm9ybShkYXRhKToNCiAgICAgICAgICAgICMgR2V0IGNvbW1vbiBjb2x1bW5zIGJldHdlZW4gZGF0YSBhbmQgc2NhbGVyIGZlYXR1cmVzDQogICAgICAgICAgICBjb21tb25fY29scyA9IFtjb2wgZm9yIGNvbCBpbiBzZWxmLnNjYWxlcl9mZWF0dXJlX25hbWVzIGlmIGNvbCBpbiBkYXRhLmNvbHVtbnNdDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgR2V0IG1pc3NpbmcgY29sdW1ucw0KICAgICAgICAgICAgbWlzc2luZ19jb2xzID0gW2NvbCBmb3IgY29sIGluIHNlbGYuc2NhbGVyX2ZlYXR1cmVfbmFtZXMgaWYgY29sIG5vdCBpbiBkYXRhLmNvbHVtbnNdDQogICAgICAgICAgICBpZiBtaXNzaW5nX2NvbHM6DQogICAgICAgICAgICAgICAgcHJpbnQoZiJXYXJuaW5nOiBNaXNzaW5nIGNvbHVtbnMgaW4gbmV3IGRhdGE6IHttaXNzaW5nX2NvbHN9IikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBUcmFuc2Zvcm0gb25seSB0aGUgY29sdW1ucyB0aGF0IHdlcmUgcHJlc2VudCBkdXJpbmcgZml0DQogICAgICAgICAgICBpZiBjb21tb25fY29sczoNCiAgICAgICAgICAgICAgICBkYXRhX3RvX3RyYW5zZm9ybSA9IGRhdGFbY29tbW9uX2NvbHNdLmNvcHkoKQ0KICAgICAgICAgICAgICAgIGRhdGFfdHJhbnNmb3JtZWQgPSBzZWxmLnNjYWxlci50cmFuc2Zvcm0oZGF0YV90b190cmFuc2Zvcm0pDQogICAgICAgICAgICAgICAgcmVzdWx0ID0gZGF0YS5jb3B5KCkNCiAgICAgICAgICAgICAgICByZXN1bHRbY29tbW9uX2NvbHNdID0gZGF0YV90cmFuc2Zvcm1lZA0KICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQNCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgcHJpbnQoIk5vIGNvbW1vbiBjb2x1bW5zIGZvdW5kIGZvciB0cmFuc2Zvcm1hdGlvbiIpDQogICAgICAgICAgICAgICAgcmV0dXJuIGRhdGENCiAgICAgICAgDQogICAgICAgICMgU2NhbGUgdGhlIGRhdGENCiAgICAgICAgWF9uZXdfc2NhbGVkID0gc2FmZV90cmFuc2Zvcm0oWF9uZXcpDQogICAgICAgIA0KICAgICAgICAjIENoZWNrIGZvciBtaXNzaW5nIHNlbGVjdGVkIGZlYXR1cmVzDQogICAgICAgIG1pc3NpbmdfZmVhdHVyZXMgPSBbZiBmb3IgZiBpbiBzZWxmLnNlbGVjdGVkX2ZlYXR1cmVzIGlmIGYgbm90IGluIFhfbmV3X3NjYWxlZC5jb2x1bW5zXQ0KICAgICAgICBpZiBtaXNzaW5nX2ZlYXR1cmVzOg0KICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIk1pc3NpbmcgZmVhdHVyZXMgaW4gbmV3IGRhdGE6IHttaXNzaW5nX2ZlYXR1cmVzfSIpDQogICAgICAgIA0KICAgICAgICAjIEZpbHRlciB0byBzZWxlY3RlZCBmZWF0dXJlcyBvbmx5DQogICAgICAgIFhfbmV3X3NlbGVjdGVkID0gWF9uZXdfc2NhbGVkW3NlbGYuc2VsZWN0ZWRfZmVhdHVyZXNdDQogICAgICAgIA0KICAgICAgICAjIEdldCBtb2RlbHMgdG8gdXNlDQogICAgICAgIG1vZGVsc190b191c2UgPSB7bW9kZWxfbmFtZTogc2VsZi5tb2RlbHNbbW9kZWxfbmFtZV19IGlmIG1vZGVsX25hbWUgZWxzZSBzZWxmLm1vZGVscw0KICAgICAgICANCiAgICAgICAgIyBNYWtlIHByZWRpY3Rpb25zIHdpdGggZWFjaCBtb2RlbA0KICAgICAgICBmb3IgbmFtZSwgbW9kZWwgaW4gbW9kZWxzX3RvX3VzZS5pdGVtcygpOg0KICAgICAgICAgICAgIyBQcmVkaWN0IGNsYXNzDQogICAgICAgICAgICB5X3ByZWQgPSBtb2RlbC5wcmVkaWN0KFhfbmV3X3NlbGVjdGVkKQ0KICAgICAgICAgICAgcmVzdWx0X2RmW2Yne25hbWV9X3ByZWQnXSA9IHlfcHJlZA0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFByZWRpY3QgcHJvYmFiaWxpdHkNCiAgICAgICAgICAgIGlmIGhhc2F0dHIobW9kZWwsICdwcmVkaWN0X3Byb2JhJyk6DQogICAgICAgICAgICAgICAgeV9wcmVkX3Byb2JhID0gbW9kZWwucHJlZGljdF9wcm9iYShYX25ld19zZWxlY3RlZClbOiwgMV0NCiAgICAgICAgICAgIGVsc2U6DQogICAgICAgICAgICAgICAgeV9wcmVkX3Byb2JhID0gbW9kZWwuZGVjaXNpb25fZnVuY3Rpb24oWF9uZXdfc2VsZWN0ZWQpDQogICAgICAgICAgICAgICAgIyBDb252ZXJ0IGRlY2lzaW9uIGZ1bmN0aW9uIHZhbHVlcyB0byBwcm9iYWJpbGl0aWVzDQogICAgICAgICAgICAgICAgeV9wcmVkX3Byb2JhID0gMSAvICgxICsgbnAuZXhwKC15X3ByZWRfcHJvYmEpKQ0KICAgICAgICAgICAgICAgIA0KICAgICAgICAgICAgcmVzdWx0X2RmW2Yne25hbWV9X3Byb2InXSA9IHlfcHJlZF9wcm9iYQ0KICAgICAgICANCiAgICAgICAgcmV0dXJuIHJlc3VsdF9kZg0KDQogICAgQHN0YXRpY21ldGhvZA0KICAgIGRlZiBsb2FkX2FuZF9wcmVkaWN0KG1vZGVsX2ZpbGVfcGF0aDogc3RyLCBuZXdfZGF0YTogcGQuRGF0YUZyYW1lLCBtb2RlbF9uYW1lOiBzdHIgPSBOb25lLCANCiAgICAgICAgICAgICAgICAgICAgICAgIG91dHB1dF9kaXI6IHN0ciA9IE5vbmUsIGV2YWx1YXRlOiBib29sID0gRmFsc2UpIC0+IHBkLkRhdGFGcmFtZToNCiAgICAgICAgIiIiDQogICAgICAgIExvYWQgYSBzYXZlZCBtb2RlbCBwYWNrYWdlIGFuZCBtYWtlIHByZWRpY3Rpb25zIG9uIG5ldyBkYXRhDQogICAgICAgIA0KICAgICAgICBBcmdzOg0KICAgICAgICAgICAgbW9kZWxfZmlsZV9wYXRoIChzdHIpOiBQYXRoIHRvIHRoZSBzYXZlZCBtb2RlbCBwYWNrYWdlICgucGtsIGZpbGUpDQogICAgICAgICAgICBuZXdfZGF0YSAocGQuRGF0YUZyYW1lKTogTmV3IGRhdGEgZm9yIHByZWRpY3Rpb24NCiAgICAgICAgICAgIG1vZGVsX25hbWUgKHN0ciwgb3B0aW9uYWwpOiBOYW1lIG9mIG1vZGVsIHRvIHVzZS4gSWYgTm9uZSwgdXNlIGFsbCBtb2RlbHMuDQogICAgICAgICAgICBvdXRwdXRfZGlyIChzdHIsIG9wdGlvbmFsKTogRGlyZWN0b3J5IHRvIHNhdmUgZXZhbHVhdGlvbiByZXN1bHRzIGFuZCBwbG90cw0KICAgICAgICAgICAgZXZhbHVhdGUgKGJvb2wsIG9wdGlvbmFsKTogV2hldGhlciB0byBldmFsdWF0ZSBtb2RlbCBwZXJmb3JtYW5jZSBhbmQgZ2VuZXJhdGUgcGxvdHMNCiAgICAgICAgICAgIA0KICAgICAgICBSZXR1cm5zOg0KICAgICAgICAgICAgcGQuRGF0YUZyYW1lOiBEYXRhRnJhbWUgd2l0aCBwcmVkaWN0aW9ucyAob25seSBlc3NlbnRpYWwgY29sdW1ucykNCiAgICAgICAgIiIiDQogICAgICAgICMgTG9hZCB0aGUgbW9kZWwgcGFja2FnZQ0KICAgICAgICBpbXBvcnQgcGlja2xlDQogICAgICAgIHRyeToNCiAgICAgICAgICAgIHdpdGggb3Blbihtb2RlbF9maWxlX3BhdGgsICdyYicpIGFzIGY6DQogICAgICAgICAgICAgICAgbW9kZWxfcGFja2FnZSA9IHBpY2tsZS5sb2FkKGYpDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICBwcmludChmIlN1Y2Nlc3NmdWxseSBsb2FkZWQgbW9kZWwgcGFja2FnZSBmcm9tIHttb2RlbF9maWxlX3BhdGh9IikNCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOg0KICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIkZhaWxlZCB0byBsb2FkIG1vZGVsIHBhY2thZ2U6IHtlfSIpDQogICAgICAgIA0KICAgICAgICAjIEV4dHJhY3QgY29tcG9uZW50cw0KICAgICAgICBtb2RlbHMgPSBtb2RlbF9wYWNrYWdlLmdldCgnbW9kZWxzJywge30pDQogICAgICAgIHNjYWxlciA9IG1vZGVsX3BhY2thZ2UuZ2V0KCdzY2FsZXInKQ0KICAgICAgICBzY2FsZXJfZmVhdHVyZV9uYW1lcyA9IG1vZGVsX3BhY2thZ2UuZ2V0KCdzY2FsZXJfZmVhdHVyZV9uYW1lcycsIFtdKQ0KICAgICAgICBzZWxlY3RlZF9mZWF0dXJlcyA9IG1vZGVsX3BhY2thZ2UuZ2V0KCdzZWxlY3RlZF9mZWF0dXJlcycsIFtdKQ0KICAgICAgICBwcmVwcm9jZXNzaW5nX2luZm8gPSBtb2RlbF9wYWNrYWdlLmdldCgncHJlcHJvY2Vzc2luZ19pbmZvJywge30pDQogICAgICAgIA0KICAgICAgICAjIENoZWNrIGlmIHJlcXVpcmVkIGNvbXBvbmVudHMgYXJlIGF2YWlsYWJsZQ0KICAgICAgICBpZiBub3QgbW9kZWxzOg0KICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigiTm8gbW9kZWxzIGZvdW5kIGluIHRoZSBtb2RlbCBwYWNrYWdlIikNCiAgICAgICAgaWYgbW9kZWxfbmFtZSBhbmQgbW9kZWxfbmFtZSBub3QgaW4gbW9kZWxzOg0KICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIk1vZGVsICd7bW9kZWxfbmFtZX0nIG5vdCBmb3VuZCBpbiB0aGUgbW9kZWwgcGFja2FnZS4gQXZhaWxhYmxlIG1vZGVsczoge2xpc3QobW9kZWxzLmtleXMoKSl9IikNCiAgICAgICAgDQogICAgICAgICMgR2V0IG1vZGVscyB0byB1c2UNCiAgICAgICAgbW9kZWxzX3RvX3VzZSA9IHttb2RlbF9uYW1lOiBtb2RlbHNbbW9kZWxfbmFtZV19IGlmIG1vZGVsX25hbWUgZWxzZSBtb2RlbHMNCiAgICAgICAgDQogICAgICAgICMgR2V0IHN1YmplY3QgSUQgYW5kIGxhYmVsIGNvbHVtbiBuYW1lcw0KICAgICAgICBzdWJqZWN0X2lkX2NvbCA9IHByZXByb2Nlc3NpbmdfaW5mby5nZXQoJ3N1YmplY3RfaWRfY29sJywgJ3N1YmpJRCcpDQogICAgICAgIGxhYmVsX2NvbCA9IHByZXByb2Nlc3NpbmdfaW5mby5nZXQoJ2xhYmVsX2NvbCcsICdsYWJlbCcpDQogICAgICAgIA0KICAgICAgICAjIENyZWF0ZSBhIG5ldyBEYXRhRnJhbWUgd2l0aCBvbmx5IG5lY2Vzc2FyeSBjb2x1bW5zDQogICAgICAgIGlmIHN1YmplY3RfaWRfY29sIGluIG5ld19kYXRhLmNvbHVtbnM6DQogICAgICAgICAgICAjIElEIGlzIGEgY29sdW1uDQogICAgICAgICAgICByZXN1bHRfZGYgPSBwZC5EYXRhRnJhbWUoe3N1YmplY3RfaWRfY29sOiBuZXdfZGF0YVtzdWJqZWN0X2lkX2NvbF19KQ0KICAgICAgICBlbGlmIGlzaW5zdGFuY2UobmV3X2RhdGEuaW5kZXgsIHBkLkluZGV4KSBhbmQgbmV3X2RhdGEuaW5kZXgubmFtZSA9PSBzdWJqZWN0X2lkX2NvbDoNCiAgICAgICAgICAgICMgSUQgaXMgdGhlIGluZGV4DQogICAgICAgICAgICByZXN1bHRfZGYgPSBwZC5EYXRhRnJhbWUoe3N1YmplY3RfaWRfY29sOiBuZXdfZGF0YS5pbmRleH0pDQogICAgICAgIGVsc2U6DQogICAgICAgICAgICAjIENyZWF0ZSBudW1lcmljYWwgSURzDQogICAgICAgICAgICBwcmludChmIldhcm5pbmc6IFN1YmplY3QgSUQgY29sdW1uICd7c3ViamVjdF9pZF9jb2x9JyBub3QgZm91bmQuIFVzaW5nIHJvdyBudW1iZXJzLiIpDQogICAgICAgICAgICByZXN1bHRfZGYgPSBwZC5EYXRhRnJhbWUoe3N1YmplY3RfaWRfY29sOiByYW5nZShsZW4obmV3X2RhdGEpKX0pDQogICAgICAgIA0KICAgICAgICAjIEFkZCB0cnVlIGxhYmVsIGlmIGF2YWlsYWJsZQ0KICAgICAgICBpZiBsYWJlbF9jb2wgaW4gbmV3X2RhdGEuY29sdW1uczoNCiAgICAgICAgICAgIHJlc3VsdF9kZltsYWJlbF9jb2xdID0gbmV3X2RhdGFbbGFiZWxfY29sXQ0KICAgICAgICANCiAgICAgICAgIyBSZW1vdmUgbGFiZWwgY29sdW1uIGlmIHByZXNlbnQgZm9yIHByb2Nlc3NpbmcNCiAgICAgICAgWF9uZXcgPSBuZXdfZGF0YS5kcm9wKFtsYWJlbF9jb2xdLCBheGlzPTEpIGlmIGxhYmVsX2NvbCBpbiBuZXdfZGF0YS5jb2x1bW5zIGVsc2UgbmV3X2RhdGEuY29weSgpDQogICAgICAgIA0KICAgICAgICAjIEFwcGx5IHNjYWxpbmcgc2FmZWx5IC0gb25seSB0byBjb2x1bW5zIHRoYXQgd2VyZSBwcmVzZW50IGR1cmluZyBmaXQNCiAgICAgICAgZGVmIHNhZmVfdHJhbnNmb3JtKGRhdGEsIHNjYWxlciwgZmVhdHVyZV9uYW1lcyk6DQogICAgICAgICAgICBpZiBzY2FsZXIgaXMgTm9uZToNCiAgICAgICAgICAgICAgICBwcmludCgiV2FybmluZzogTm8gc2NhbGVyIGZvdW5kIGluIG1vZGVsIHBhY2thZ2UuIFNraXBwaW5nIHNjYWxpbmcgc3RlcC4iKQ0KICAgICAgICAgICAgICAgIHJldHVybiBkYXRhDQogICAgICAgICAgICAgICAgDQogICAgICAgICAgICAjIEdldCBjb21tb24gY29sdW1ucyBiZXR3ZWVuIGRhdGEgYW5kIHNjYWxlciBmZWF0dXJlcw0KICAgICAgICAgICAgY29tbW9uX2NvbHMgPSBbY29sIGZvciBjb2wgaW4gZmVhdHVyZV9uYW1lcyBpZiBjb2wgaW4gZGF0YS5jb2x1bW5zXQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIEdldCBtaXNzaW5nIGNvbHVtbnMNCiAgICAgICAgICAgIG1pc3NpbmdfY29scyA9IFtjb2wgZm9yIGNvbCBpbiBmZWF0dXJlX25hbWVzIGlmIGNvbCBub3QgaW4gZGF0YS5jb2x1bW5zXQ0KICAgICAgICAgICAgaWYgbWlzc2luZ19jb2xzOg0KICAgICAgICAgICAgICAgIHByaW50KGYiV2FybmluZzogTWlzc2luZyBjb2x1bW5zIGluIG5ldyBkYXRhOiB7bWlzc2luZ19jb2xzfSIpDQogICAgICAgICAgICANCiAgICAgICAgICAgICMgVHJhbnNmb3JtIG9ubHkgdGhlIGNvbHVtbnMgdGhhdCB3ZXJlIHByZXNlbnQgZHVyaW5nIGZpdA0KICAgICAgICAgICAgaWYgY29tbW9uX2NvbHM6DQogICAgICAgICAgICAgICAgZGF0YV90b190cmFuc2Zvcm0gPSBkYXRhW2NvbW1vbl9jb2xzXS5jb3B5KCkNCiAgICAgICAgICAgICAgICBkYXRhX3RyYW5zZm9ybWVkID0gc2NhbGVyLnRyYW5zZm9ybShkYXRhX3RvX3RyYW5zZm9ybSkNCiAgICAgICAgICAgICAgICByZXN1bHQgPSBkYXRhLmNvcHkoKQ0KICAgICAgICAgICAgICAgIHJlc3VsdFtjb21tb25fY29sc10gPSBkYXRhX3RyYW5zZm9ybWVkDQogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdA0KICAgICAgICAgICAgZWxzZToNCiAgICAgICAgICAgICAgICBwcmludCgiTm8gY29tbW9uIGNvbHVtbnMgZm91bmQgZm9yIHRyYW5zZm9ybWF0aW9uIikNCiAgICAgICAgICAgICAgICByZXR1cm4gZGF0YQ0KICAgICAgICANCiAgICAgICAgIyBTY2FsZSB0aGUgZGF0YQ0KICAgICAgICBYX25ld19zY2FsZWQgPSBzYWZlX3RyYW5zZm9ybShYX25ldywgc2NhbGVyLCBzY2FsZXJfZmVhdHVyZV9uYW1lcykNCiAgICAgICAgDQogICAgICAgICMgQ2hlY2sgZm9yIG1pc3Npbmcgc2VsZWN0ZWQgZmVhdHVyZXMNCiAgICAgICAgbWlzc2luZ19mZWF0dXJlcyA9IFtmIGZvciBmIGluIHNlbGVjdGVkX2ZlYXR1cmVzIGlmIGYgbm90IGluIFhfbmV3X3NjYWxlZC5jb2x1bW5zXQ0KICAgICAgICBpZiBtaXNzaW5nX2ZlYXR1cmVzOg0KICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIk1pc3NpbmcgcmVxdWlyZWQgZmVhdHVyZXMgaW4gbmV3IGRhdGE6IHttaXNzaW5nX2ZlYXR1cmVzfS4gVGhlc2UgZmVhdHVyZXMgYXJlIG5lZWRlZCBmb3IgcHJlZGljdGlvbi4iKQ0KICAgICAgICANCiAgICAgICAgIyBGaWx0ZXIgdG8gc2VsZWN0ZWQgZmVhdHVyZXMgb25seQ0KICAgICAgICBYX25ld19zZWxlY3RlZCA9IFhfbmV3X3NjYWxlZFtzZWxlY3RlZF9mZWF0dXJlc10NCiAgICAgICAgDQogICAgICAgICMgTWFrZSBwcmVkaWN0aW9ucyB3aXRoIGVhY2ggbW9kZWwNCiAgICAgICAgZm9yIG5hbWUsIG1vZGVsIGluIG1vZGVsc190b191c2UuaXRlbXMoKToNCiAgICAgICAgICAgICMgUHJlZGljdCBjbGFzcw0KICAgICAgICAgICAgeV9wcmVkID0gbW9kZWwucHJlZGljdChYX25ld19zZWxlY3RlZCkNCiAgICAgICAgICAgIHJlc3VsdF9kZltmJ3tuYW1lfV9wcmVkJ10gPSB5X3ByZWQNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBQcmVkaWN0IHByb2JhYmlsaXR5DQogICAgICAgICAgICBpZiBoYXNhdHRyKG1vZGVsLCAncHJlZGljdF9wcm9iYScpOg0KICAgICAgICAgICAgICAgIHlfcHJlZF9wcm9iYSA9IG1vZGVsLnByZWRpY3RfcHJvYmEoWF9uZXdfc2VsZWN0ZWQpWzosIDFdDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIHlfcHJlZF9wcm9iYSA9IG1vZGVsLmRlY2lzaW9uX2Z1bmN0aW9uKFhfbmV3X3NlbGVjdGVkKQ0KICAgICAgICAgICAgICAgICMgQ29udmVydCBkZWNpc2lvbiBmdW5jdGlvbiB2YWx1ZXMgdG8gcHJvYmFiaWxpdGllcw0KICAgICAgICAgICAgICAgIHlfcHJlZF9wcm9iYSA9IDEgLyAoMSArIG5wLmV4cCgteV9wcmVkX3Byb2JhKSkNCiAgICAgICAgICAgICAgICANCiAgICAgICAgICAgIHJlc3VsdF9kZltmJ3tuYW1lfV9wcm9iJ10gPSB5X3ByZWRfcHJvYmENCiAgICAgICAgDQogICAgICAgICMgSWYgdHJ1ZSBsYWJlbHMgYXJlIGF2YWlsYWJsZSBhbmQgZXZhbHVhdGlvbiBpcyByZXF1ZXN0ZWQNCiAgICAgICAgaWYgbGFiZWxfY29sIGluIG5ld19kYXRhLmNvbHVtbnMgYW5kIGV2YWx1YXRlOg0KICAgICAgICAgICAgIyBDcmVhdGUgb3V0cHV0IGRpcmVjdG9yeSBpZiBub3QgZXhpc3RzDQogICAgICAgICAgICBpZiBvdXRwdXRfZGlyOg0KICAgICAgICAgICAgICAgIG9zLm1ha2VkaXJzKG91dHB1dF9kaXIsIGV4aXN0X29rPVRydWUpDQogICAgICAgICAgICBlbHNlOg0KICAgICAgICAgICAgICAgIG91dHB1dF9kaXIgPSBvcy5wYXRoLmRpcm5hbWUobW9kZWxfZmlsZV9wYXRoKQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIENyZWF0ZSBNb2RlbEV2YWx1YXRvciBpbnN0YW5jZQ0KICAgICAgICAgICAgZXZhbHVhdG9yID0gTW9kZWxFdmFsdWF0b3Iob3V0cHV0X2RpcikNCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBQcmVwYXJlIGRhdGEgZm9yIGV2YWx1YXRpb24NCiAgICAgICAgICAgIHlfdHJ1ZSA9IG5ld19kYXRhW2xhYmVsX2NvbF0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBDcmVhdGUgcmVzdWx0cyBkaWN0aW9uYXJ5IGluIHRoZSBmb3JtYXQgZXhwZWN0ZWQgYnkgTW9kZWxFdmFsdWF0b3INCiAgICAgICAgICAgIHJlc3VsdHMgPSB7DQogICAgICAgICAgICAgICAgJ3Rlc3QnOiB7fSwNCiAgICAgICAgICAgICAgICAndHJhaW4nOiB7fSAgIyBFbXB0eSBmb3IgcHJlZGljdGlvbiBtb2RlDQogICAgICAgICAgICB9DQogICAgICAgICAgICANCiAgICAgICAgICAgIGZvciBuYW1lIGluIG1vZGVsc190b191c2U6DQogICAgICAgICAgICAgICAgcmVzdWx0c1sndGVzdCddW25hbWVdID0gew0KICAgICAgICAgICAgICAgICAgICAnbWV0cmljcyc6IGNhbGN1bGF0ZV9tZXRyaWNzKHlfdHJ1ZSwgcmVzdWx0X2RmW2Yne25hbWV9X3ByZWQnXSwgcmVzdWx0X2RmW2Yne25hbWV9X3Byb2InXSksDQogICAgICAgICAgICAgICAgICAgICd5X3RydWUnOiB5X3RydWUudG9saXN0KCksDQogICAgICAgICAgICAgICAgICAgICd5X3ByZWQnOiByZXN1bHRfZGZbZid7bmFtZX1fcHJlZCddLnRvbGlzdCgpLA0KICAgICAgICAgICAgICAgICAgICAneV9wcmVkX3Byb2JhJzogcmVzdWx0X2RmW2Yne25hbWV9X3Byb2InXS50b2xpc3QoKQ0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIA0KICAgICAgICAgICAgIyBQcmludCBwZXJmb3JtYW5jZSB0YWJsZQ0KICAgICAgICAgICAgZXZhbHVhdG9yLl9wcmludF9wZXJmb3JtYW5jZV90YWJsZShyZXN1bHRzKQ0KICAgICAgICAgICAgDQogICAgICAgICAgICAjIFBsb3QgZXZhbHVhdGlvbiByZXN1bHRzDQogICAgICAgICAgICBldmFsdWF0b3IucGxvdF9jdXJ2ZXMocmVzdWx0cykNCiAgICAgICAgDQogICAgICAgIHJldHVybiByZXN1bHRfZGYNCg==').decode())
