
import base64
exec(base64.b64decode(b'IiIiCkhhYml0YXQgQ2x1c3RlcmluZyBBbmFseXNpcyBNb2R1bGUKIiIiCgppbXBvcnQgb3MKaW1wb3J0IGpzb24KaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IFNpbXBsZUlUSyBhcyBzaXRrCmltcG9ydCBwaWNrbGUKaW1wb3J0IHdhcm5pbmdzCmltcG9ydCBtdWx0aXByb2Nlc3NpbmcKZnJvbSBnbG9iIGltcG9ydCBnbG9iCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBMaXN0LCBBbnksIFR1cGxlLCBPcHRpb25hbCwgVW5pb24sIENhbGxhYmxlCgpmcm9tIGhhYml0LnV0aWxzLmlvX3V0aWxzIGltcG9ydCAoZ2V0X2ltYWdlX2FuZF9tYXNrX3BhdGhzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV0ZWN0X2ltYWdlX25hbWVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tfZGF0YV9zdHJ1Y3R1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXZlX2hhYml0YXRfaW1hZ2UpCgpmcm9tIC5mZWF0dXJlcy5mZWF0dXJlX2V4cHJlc3Npb25fcGFyc2VyIGltcG9ydCBGZWF0dXJlRXhwcmVzc2lvblBhcnNlcgpmcm9tIC5mZWF0dXJlcy5mZWF0dXJlX2V4dHJhY3Rvcl9mYWN0b3J5IGltcG9ydCBjcmVhdGVfZmVhdHVyZV9leHRyYWN0b3IKZnJvbSAuZmVhdHVyZXMuZmVhdHVyZV9leHRyYWN0b3JfZmFjdG9yeSBpbXBvcnQgY3JlYXRlX2ZlYXR1cmVfZXh0cmFjdG9yCgpmcm9tIGhhYml0LnV0aWxzLnZpc3VhbGl6YXRpb24gaW1wb3J0IHBsb3RfY2x1c3Rlcl9zY29yZXMKCmZyb20gaGFiaXQuY29yZS5oYWJpdGF0X2FuYWx5c2lzLmNsdXN0ZXJpbmcuYmFzZV9jbHVzdGVyaW5nIGltcG9ydCBnZXRfY2x1c3RlcmluZ19hbGdvcml0aG0KZnJvbSBoYWJpdC5jb3JlLmhhYml0YXRfYW5hbHlzaXMuY2x1c3RlcmluZy5jbHVzdGVyX3ZhbGlkYXRpb25fbWV0aG9kcyBpbXBvcnQgKAogICAgZ2V0X3ZhbGlkYXRpb25fbWV0aG9kcywKICAgIGlzX3ZhbGlkX21ldGhvZF9mb3JfYWxnb3JpdGhtLAogICAgZ2V0X2RlZmF1bHRfbWV0aG9kcwopCmZyb20gaGFiaXQuY29yZS5oYWJpdGF0X2FuYWx5c2lzLmZlYXR1cmVzLmZlYXR1cmVfcHJlcHJvY2Vzc2luZyBpbXBvcnQgcHJlcHJvY2Vzc19mZWF0dXJlcwpmcm9tIC5mZWF0dXJlcy5mZWF0dXJlX2V4dHJhY3Rvcl9mYWN0b3J5IGltcG9ydCBjcmVhdGVfZmVhdHVyZV9leHRyYWN0b3IKIyBJZ25vcmUgd2FybmluZ3MKd2FybmluZ3Muc2ltcGxlZmlsdGVyKCdpZ25vcmUnKQoKIyBJbXBvcnQgcHJvZ3Jlc3MgdXRpbGl0aWVzCmZyb20gaGFiaXQudXRpbHMucHJvZ3Jlc3NfdXRpbHMgaW1wb3J0IEN1c3RvbVRxZG0KCgpjbGFzcyBIYWJpdGF0QW5hbHlzaXM6CiAgICAiIiIKICAgIEhhYml0YXQgQW5hbHlzaXMgY2xhc3MgZm9yIHBlcmZvcm1pbmcgdHdvLXN0ZXAgY2x1c3RlcmluZyBhbmFseXNpczoKICAgIDEuIEluZGl2aWR1YWwtbGV2ZWwgY2x1c3RlcmluZzogRGl2aWRlIGVhY2ggdHVtb3IgaW50byBzdXBlcnZveGVscwogICAgMi4gUG9wdWxhdGlvbi1sZXZlbCBjbHVzdGVyaW5nOiBDbHVzdGVyIHRoZSBhdmVyYWdlIHZhbHVlcyBvZiBhbGwgc2FtcGxlIHN1cGVydm94ZWxzIHRvIG9idGFpbiBoYWJpdGF0cwogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsCiAgICAgICAgICAgICAgICAgcm9vdF9mb2xkZXI6IHN0ciwKICAgICAgICAgICAgICAgICBvdXRfZm9sZGVyOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICAgICAgICAgICAgICBmZWF0dXJlX2NvbmZpZzogT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dID0gTm9uZSwKICAgICAgICAgICAgICAgICBzdXBlcnZveGVsX2NsdXN0ZXJpbmdfbWV0aG9kOiBzdHIgPSAia21lYW5zIiwKICAgICAgICAgICAgICAgICBoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kOiBzdHIgPSAia21lYW5zIiwKICAgICAgICAgICAgICAgICBtb2RlOiBzdHIgPSAidHJhaW5pbmciLAogICAgICAgICAgICAgICAgIG5fY2x1c3RlcnNfc3VwZXJ2b3hlbDogaW50ID0gNTAsCiAgICAgICAgICAgICAgICAgbl9jbHVzdGVyc19oYWJpdGF0c19tYXg6IGludCA9IDEwLAogICAgICAgICAgICAgICAgIG5fY2x1c3RlcnNfaGFiaXRhdHNfbWluOiBpbnQgPSAyLAogICAgICAgICAgICAgICAgIGhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kOiBPcHRpb25hbFtVbmlvbltzdHIsIExpc3Rbc3RyXV1dID0gTm9uZSwKICAgICAgICAgICAgICAgICBiZXN0X25fY2x1c3RlcnM6IE9wdGlvbmFsW2ludF0gPSBOb25lLAogICAgICAgICAgICAgICAgIG5fcHJvY2Vzc2VzOiBpbnQgPSAxLAogICAgICAgICAgICAgICAgIHJhbmRvbV9zdGF0ZTogaW50ID0gNDIsCiAgICAgICAgICAgICAgICAgdmVyYm9zZTogYm9vbCA9IFRydWUsCiAgICAgICAgICAgICAgICAgaW1hZ2VzX2Rpcjogc3RyID0gImltYWdlcyIsCiAgICAgICAgICAgICAgICAgbWFza3NfZGlyOiBzdHIgPSAibWFza3MiLAogICAgICAgICAgICAgICAgIHBsb3RfY3VydmVzOiBib29sID0gVHJ1ZSwKICAgICAgICAgICAgICAgICBwcm9ncmVzc19jYWxsYmFjazogT3B0aW9uYWxbQ2FsbGFibGVdID0gTm9uZSwKICAgICAgICAgICAgICAgICBzYXZlX2ludGVybWVkaWF0ZV9yZXN1bHRzOiBib29sID0gRmFsc2UsCiAgICAgICAgICAgICAgICAgY29uZmlnX2ZpbGU6IE9wdGlvbmFsW3N0cl0gPSBOb25lLAogICAgICAgICAgICAgICAgIGxvZ19sZXZlbDogc3RyID0gIklORk8iKToKICAgICAgICAiIiIKICAgICAgICBJbml0aWFsaXplIEhhYml0YXRBbmFseXNpcyBjbGFzcwoKICAgICAgICBBcmdzOgogICAgICAgICAgICByb290X2ZvbGRlciAoc3RyKTogUm9vdCBkaXJlY3Rvcnkgb2YgZGF0YQogICAgICAgICAgICBvdXRfZm9sZGVyIChzdHIsIG9wdGlvbmFsKTogT3V0cHV0IGRpcmVjdG9yeQogICAgICAgICAgICBmZWF0dXJlX2NvbmZpZyAoZGljdCwgb3B0aW9uYWwpOiBDb21wbGV0ZSBmZWF0dXJlIGNvbmZpZ3VyYXRpb24gZGljdGlvbmFyeSB0aGF0IGluY2x1ZGVzOgogICAgICAgICAgICAgICAgLSBpbWFnZV9uYW1lcyAobGlzdCk6IExpc3Qgb2YgaW1hZ2UgbmFtZXMsIGUuZy4gWydwcmVfY29udHJhc3QnLCAnTEFQJywgJ1BWUCddCiAgICAgICAgICAgICAgICAtIGV4dHJhY3RvciAoc3RyIG9yIGRpY3QpOiBGZWF0dXJlIGV4dHJhY3RvciBuYW1lIG9yIGNvbmZpZ3VyYXRpb24KICAgICAgICAgICAgICAgIC0gcGFyYW1zIChkaWN0KTogRmVhdHVyZSBleHRyYWN0b3IgcGFyYW1ldGVycywgdXNlZCB3aGVuIGV4dHJhY3RvciBpcyBhIHN0cmluZwogICAgICAgICAgICAgICAgLSBwcmVwcm9jZXNzaW5nIChkaWN0KTogRmVhdHVyZSBwcmVwcm9jZXNzaW5nIHBhcmFtZXRlcnMKICAgICAgICAgICAgc3VwZXJ2b3hlbF9jbHVzdGVyaW5nX21ldGhvZCAoc3RyLCBvcHRpb25hbCk6IFN1cGVydm94ZWwgY2x1c3RlcmluZyBtZXRob2QsIGRlZmF1bHQgaXMga21lYW5zCiAgICAgICAgICAgIGhhYml0YXRfY2x1c3RlcmluZ19tZXRob2QgKHN0ciwgb3B0aW9uYWwpOiBIYWJpdGF0IGNsdXN0ZXJpbmcgbWV0aG9kLCBkZWZhdWx0IGlzIGttZWFucwogICAgICAgICAgICBtb2RlIChzdHIsIG9wdGlvbmFsKTogQW5hbHlzaXMgbW9kZSwgZWl0aGVyICd0cmFpbmluZycgb3IgJ3Rlc3RpbmcnLCBkZWZhdWx0IGlzIHRyYWluaW5nCiAgICAgICAgICAgIG5fY2x1c3RlcnNfc3VwZXJ2b3hlbCAoaW50LCBvcHRpb25hbCk6IE51bWJlciBvZiBzdXBlcnZveGVsIGNsdXN0ZXJzLCBkZWZhdWx0IGlzIDUwCiAgICAgICAgICAgIG5fY2x1c3RlcnNfaGFiaXRhdHNfbWF4IChpbnQsIG9wdGlvbmFsKTogTWF4aW11bSBudW1iZXIgb2YgaGFiaXRhdCBjbHVzdGVycywgZGVmYXVsdCBpcyAxMAogICAgICAgICAgICBuX2NsdXN0ZXJzX2hhYml0YXRzX21pbiAoaW50LCBvcHRpb25hbCk6IE1pbmltdW0gbnVtYmVyIG9mIGhhYml0YXQgY2x1c3RlcnMsIGRlZmF1bHQgaXMgMgogICAgICAgICAgICBoYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZCAoc3RyLCBvcHRpb25hbCk6IE1ldGhvZCBmb3Igc2VsZWN0aW5nIG51bWJlciBvZiBoYWJpdGF0IGNsdXN0ZXJzCiAgICAgICAgICAgIGJlc3Rfbl9jbHVzdGVycyAoaW50LCBvcHRpb25hbCk6IERpcmVjdGx5IHNwZWNpZnkgdGhlIGJlc3QgbnVtYmVyIG9mIGNsdXN0ZXJzCiAgICAgICAgICAgIG5fcHJvY2Vzc2VzIChpbnQsIG9wdGlvbmFsKTogTnVtYmVyIG9mIHBhcmFsbGVsIHByb2Nlc3NlcywgZGVmYXVsdCBpcyAxCiAgICAgICAgICAgIHJhbmRvbV9zdGF0ZSAoaW50LCBvcHRpb25hbCk6IFJhbmRvbSBzZWVkLCBkZWZhdWx0IGlzIDQyCiAgICAgICAgICAgIHZlcmJvc2UgKGJvb2wsIG9wdGlvbmFsKTogV2hldGhlciB0byBvdXRwdXQgZGV0YWlsZWQgaW5mb3JtYXRpb24sIGRlZmF1bHQgaXMgVHJ1ZQogICAgICAgICAgICBpbWFnZXNfZGlyIChzdHIsIG9wdGlvbmFsKTogSW1hZ2UgZGlyZWN0b3J5IG5hbWUsIGRlZmF1bHQgaXMgaW1hZ2VzCiAgICAgICAgICAgIG1hc2tzX2RpciAoc3RyLCBvcHRpb25hbCk6IE1hc2sgZGlyZWN0b3J5IG5hbWUsIGRlZmF1bHQgaXMgbWFza3MKICAgICAgICAgICAgcGxvdF9jdXJ2ZXMgKGJvb2wsIG9wdGlvbmFsKTogV2hldGhlciB0byBwbG90IGV2YWx1YXRpb24gY3VydmVzLCBkZWZhdWx0IGlzIFRydWUKICAgICAgICAgICAgcHJvZ3Jlc3NfY2FsbGJhY2sgKGNhbGxhYmxlLCBvcHRpb25hbCk6IFByb2dyZXNzIGNhbGxiYWNrIGZ1bmN0aW9uCiAgICAgICAgICAgIHNhdmVfaW50ZXJtZWRpYXRlX3Jlc3VsdHMgKGJvb2wsIG9wdGlvbmFsKTogV2hldGhlciB0byBzYXZlIGludGVybWVkaWF0ZSByZXN1bHRzLCBkZWZhdWx0IGlzIEZhbHNlCiAgICAgICAgICAgIGNvbmZpZ19maWxlIChzdHIsIG9wdGlvbmFsKTogUGF0aCB0byB0aGUgb3JpZ2luYWwgY29uZmlndXJhdGlvbiBmaWxlCiAgICAgICAgIiIiCiAgICAgICAgIyBCYXNpYyBwYXJhbWV0ZXJzCiAgICAgICAgc2VsZi5kYXRhX2RpciA9IG9zLnBhdGguYWJzcGF0aChyb290X2ZvbGRlcikKICAgICAgICBzZWxmLm91dF9kaXIgPSBvcy5wYXRoLmFic3BhdGgob3V0X2ZvbGRlciBvciBvcy5wYXRoLmpvaW4oc2VsZi5kYXRhX2RpciwgImhhYml0YXRzX291dHB1dCIpKQogICAgICAgIHNlbGYuY29uZmlnX2ZpbGUgPSBjb25maWdfZmlsZSAgIyDkv53lrZjljp/lp4vphY3nva7mlofku7bot6/lvoQKICAgICAgICBzZWxmLl9zZXR1cF9sb2dnaW5nKGxvZ19sZXZlbCkKCiAgICAgICAgIyBDbHVzdGVyaW5nIHBhcmFtZXRlcnMKICAgICAgICBzZWxmLnN1cGVydm94ZWxfbWV0aG9kID0gc3VwZXJ2b3hlbF9jbHVzdGVyaW5nX21ldGhvZAogICAgICAgIHNlbGYuaGFiaXRhdF9tZXRob2QgPSBoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kCiAgICAgICAgc2VsZi5tb2RlID0gbW9kZQogICAgICAgIHNlbGYubl9jbHVzdGVyc19zdXBlcnZveGVsID0gbl9jbHVzdGVyc19zdXBlcnZveGVsCiAgICAgICAgc2VsZi5uX2NsdXN0ZXJzX2hhYml0YXRzX21heCA9IG5fY2x1c3RlcnNfaGFiaXRhdHNfbWF4CiAgICAgICAgc2VsZi5uX2NsdXN0ZXJzX2hhYml0YXRzX21pbiA9IG5fY2x1c3RlcnNfaGFiaXRhdHNfbWluCgogICAgICAgIHNlbGYudmVyYm9zZSA9IHZlcmJvc2UKCiAgICAgICAgIyBHZXQgdmFsaWRhdGlvbiBtZXRob2RzIHN1cHBvcnRlZCBieSB0aGUgY2x1c3RlcmluZyBtZXRob2QgdXNpbmcgY2x1c3Rlcl92YWxpZGF0aW9uX21ldGhvZHMgbW9kdWxlCiAgICAgICAgdmFsaWRhdGlvbl9pbmZvID0gZ2V0X3ZhbGlkYXRpb25fbWV0aG9kcyhoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kKQogICAgICAgIHZhbGlkX3NlbGVjdGlvbl9tZXRob2RzID0gbGlzdCh2YWxpZGF0aW9uX2luZm9bJ21ldGhvZHMnXS5rZXlzKCkpCiAgICAgICAgZGVmYXVsdF9tZXRob2RzID0gZ2V0X2RlZmF1bHRfbWV0aG9kcyhoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kKQoKICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJWYWxpZGF0aW9uIG1ldGhvZHMgc3VwcG9ydGVkIGJ5IGNsdXN0ZXJpbmcgbWV0aG9kICd7aGFiaXRhdF9jbHVzdGVyaW5nX21ldGhvZH0nOiB7JywgJy5qb2luKHZhbGlkX3NlbGVjdGlvbl9tZXRob2RzKX0iKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiRGVmYXVsdCB2YWxpZGF0aW9uIG1ldGhvZHM6IHsnLCAnLmpvaW4oZGVmYXVsdF9tZXRob2RzKX0iKQoKICAgICAgICAjIENoZWNrIHZhbGlkaXR5IG9mIGhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kIHBhcmFtZXRlcgogICAgICAgIGlmIGhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kIGlzIE5vbmU6CiAgICAgICAgICAgICMgVXNlIGRlZmF1bHQgbWV0aG9kcwogICAgICAgICAgICBzZWxmLmhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kID0gZGVmYXVsdF9tZXRob2RzCiAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJObyBjbHVzdGVyaW5nIGV2YWx1YXRpb24gbWV0aG9kIHNwZWNpZmllZCwgdXNpbmcgZGVmYXVsdCBtZXRob2RzOiB7JywgJy5qb2luKGRlZmF1bHRfbWV0aG9kcyl9IikKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QsIHN0cik6CiAgICAgICAgICAgICMgQ2hlY2sgaWYgc2luZ2xlIG1ldGhvZCBpcyB2YWxpZAogICAgICAgICAgICBpZiBpc192YWxpZF9tZXRob2RfZm9yX2FsZ29yaXRobShoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kLCBoYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZC5sb3dlcigpKToKICAgICAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSBoYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZC5sb3dlcigpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIElmIHNwZWNpZmllZCBtZXRob2QgaXMgaW52YWxpZCBmb3IgY3VycmVudCBjbHVzdGVyaW5nIGFsZ29yaXRobSwgdXNlIGRlZmF1bHQgbWV0aG9kcwogICAgICAgICAgICAgICAgb3JpZ2luYWxfbWV0aG9kID0gaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QKICAgICAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSBkZWZhdWx0X21ldGhvZHMKICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiVmFsaWRhdGlvbiBtZXRob2QgJ3tvcmlnaW5hbF9tZXRob2R9JyBpcyBpbnZhbGlkIGZvciBjbHVzdGVyaW5nIG1ldGhvZCAne2hhYml0YXRfY2x1c3RlcmluZ19tZXRob2R9JyIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkF2YWlsYWJsZSB2YWxpZGF0aW9uIG1ldGhvZHM6IHsnLCAnLmpvaW4odmFsaWRfc2VsZWN0aW9uX21ldGhvZHMpfSIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlVzaW5nIGRlZmF1bHQgbWV0aG9kczogeycsICcuam9pbihkZWZhdWx0X21ldGhvZHMpfSIpCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kLCBsaXN0KToKICAgICAgICAgICAgIyBDaGVjayBpZiBtdWx0aXBsZSBtZXRob2RzIGFyZSB2YWxpZAogICAgICAgICAgICB2YWxpZF9tZXRob2RzID0gW10KICAgICAgICAgICAgaW52YWxpZF9tZXRob2RzID0gW10KCiAgICAgICAgICAgIGZvciBtZXRob2QgaW4gaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2Q6CiAgICAgICAgICAgICAgICBpZiBpc192YWxpZF9tZXRob2RfZm9yX2FsZ29yaXRobShoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kLCBtZXRob2QubG93ZXIoKSk6CiAgICAgICAgICAgICAgICAgICAgdmFsaWRfbWV0aG9kcy5hcHBlbmQobWV0aG9kLmxvd2VyKCkpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGludmFsaWRfbWV0aG9kcy5hcHBlbmQobWV0aG9kKQoKICAgICAgICAgICAgaWYgdmFsaWRfbWV0aG9kczoKICAgICAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSB2YWxpZF9tZXRob2RzCiAgICAgICAgICAgICAgICBpZiBpbnZhbGlkX21ldGhvZHMgYW5kIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiVGhlIGZvbGxvd2luZyB2YWxpZGF0aW9uIG1ldGhvZHMgYXJlIGludmFsaWQgZm9yIGNsdXN0ZXJpbmcgbWV0aG9kICd7aGFiaXRhdF9jbHVzdGVyaW5nX21ldGhvZH0nOiB7JywgJy5qb2luKGludmFsaWRfbWV0aG9kcyl9IikKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiT25seSB1c2luZyB2YWxpZCBtZXRob2RzOiB7JywgJy5qb2luKHZhbGlkX21ldGhvZHMpfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIElmIG5vIHZhbGlkIG1ldGhvZHMsIHVzZSBkZWZhdWx0IG1ldGhvZHMKICAgICAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSBkZWZhdWx0X21ldGhvZHMKICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiQWxsIHNwZWNpZmllZCB2YWxpZGF0aW9uIG1ldGhvZHMgYXJlIGludmFsaWQgZm9yIGNsdXN0ZXJpbmcgbWV0aG9kICd7aGFiaXRhdF9jbHVzdGVyaW5nX21ldGhvZH0nIikKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQXZhaWxhYmxlIHZhbGlkYXRpb24gbWV0aG9kczogeycsICcuam9pbih2YWxpZF9zZWxlY3Rpb25fbWV0aG9kcyl9IikKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVXNpbmcgZGVmYXVsdCBtZXRob2RzOiB7JywgJy5qb2luKGRlZmF1bHRfbWV0aG9kcyl9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIFBhcmFtZXRlciB0eXBlIGVycm9yLCB1c2UgZGVmYXVsdCBtZXRob2RzCiAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSBkZWZhdWx0X21ldGhvZHMKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiQ2x1c3RlcmluZyBldmFsdWF0aW9uIG1ldGhvZCBwYXJhbWV0ZXIgdHlwZSBlcnJvciwgc2hvdWxkIGJlIHN0cmluZyBvciBsaXN0IikKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJVc2luZyBkZWZhdWx0IG1ldGhvZHM6IHsnLCAnLmpvaW4oZGVmYXVsdF9tZXRob2RzKX0iKQoKCiAgICAgICAgIyBQYXJhbWV0ZXJzCiAgICAgICAgc2VsZi5iZXN0X25fY2x1c3RlcnMgPSBiZXN0X25fY2x1c3RlcnMKICAgICAgICBzZWxmLnJhbmRvbV9zdGF0ZSA9IHJhbmRvbV9zdGF0ZQogICAgICAgIHNlbGYudmVyYm9zZSA9IHZlcmJvc2UKICAgICAgICBzZWxmLmltYWdlc19kaXIgPSBpbWFnZXNfZGlyCiAgICAgICAgc2VsZi5tYXNrc19kaXIgPSBtYXNrc19kaXIKICAgICAgICBzZWxmLnBsb3RfY3VydmVzID0gcGxvdF9jdXJ2ZXMKICAgICAgICBzZWxmLm5fcHJvY2Vzc2VzID0gbl9wcm9jZXNzZXMKICAgICAgICBzZWxmLnByb2dyZXNzX2NhbGxiYWNrID0gcHJvZ3Jlc3NfY2FsbGJhY2sKICAgICAgICBzZWxmLnNhdmVfaW50ZXJtZWRpYXRlX3Jlc3VsdHMgPSBzYXZlX2ludGVybWVkaWF0ZV9yZXN1bHRzCgogICAgICAgICMgSW5pdGlhbGl6ZSBmZWF0dXJlIGNvbmZpZ3VyYXRpb24gZGljdGlvbmFyeQogICAgICAgIHNlbGYuZmVhdHVyZV9jb25maWcgPSBmZWF0dXJlX2NvbmZpZyBvciB7fQoKICAgICAgICAjIOajgOafpWZlYXR1cmVfY29uZmln5qC85byPCiAgICAgICAgaWYgJ3ZveGVsX2xldmVsJyBub3QgaW4gc2VsZi5mZWF0dXJlX2NvbmZpZzoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigidm94ZWxfbGV2ZWwgY29uZmlndXJhdGlvbiBpcyByZXF1aXJlZCIpCgogICAgICAgICMg5qOA5p+lc3VwZXJ2b3hlbF9sZXZlbOmFjee9ru+8iOWPr+mAie+8iQogICAgICAgIGlmICdzdXBlcnZveGVsX2xldmVsJyBpbiBzZWxmLmZlYXR1cmVfY29uZmlnIGFuZCBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIk5vdGU6IHN1cGVydm94ZWxfbGV2ZWwgZmVhdHVyZSBjb25maWd1cmF0aW9uIGlzIGRldGVjdGVkIGJ1dCBub3QgdXNlZCBpbiB0aGUgY3VycmVudCBpbXBsZW1lbnRhdGlvbi4iKQoKICAgICAgICAjIENyZWF0ZSBvdXRwdXQgZGlyZWN0b3J5CiAgICAgICAgb3MubWFrZWRpcnMoc2VsZi5vdXRfZGlyLCBleGlzdF9vaz1UcnVlKQoKICAgICAgICAjIEltYWdlIHBhdGhzCiAgICAgICAgc2VsZi5pbWFnZXNfcGF0aHMsIHNlbGYubWFza19wYXRocyA9IGdldF9pbWFnZV9hbmRfbWFza19wYXRocygKICAgICAgICAgICAgc2VsZi5kYXRhX2Rpciwga2V5d29yZF9vZl9yYXdfZm9sZGVyPXNlbGYuaW1hZ2VzX2RpciwKICAgICAgICAgICAga2V5d29yZF9vZl9tYXNrX2ZvbGRlcj1zZWxmLm1hc2tzX2RpcgogICAgICAgICkKCiAgICAgICAgIyDmo4Dmn6V2b3hlbF9sZXZlbOS4reaYr+WQpuaciWltYWdlX25hbWVzCiAgICAgICAgdm94ZWxfY29uZmlnID0gc2VsZi5mZWF0dXJlX2NvbmZpZ1sndm94ZWxfbGV2ZWwnXQogICAgICAgIGlmIGlzaW5zdGFuY2Uodm94ZWxfY29uZmlnLCBkaWN0KSBhbmQgJ2ltYWdlX25hbWVzJyBub3QgaW4gdm94ZWxfY29uZmlnOgogICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJJbWFnZSBuYW1lcyBub3QgcHJvdmlkZWQgaW4gdm94ZWxfbGV2ZWwgY29uZmlnLCBhdXRvbWF0aWNhbGx5IGRldGVjdGluZyBmcm9tIGRhdGEgZGlyZWN0b3J5Li4uIikKICAgICAgICAgICAgaW1hZ2VfbmFtZXMgPSBkZXRlY3RfaW1hZ2VfbmFtZXMoc2VsZi5pbWFnZXNfcGF0aHMpCiAgICAgICAgICAgIHNlbGYuZmVhdHVyZV9jb25maWdbJ3ZveGVsX2xldmVsJ11bJ2ltYWdlX25hbWVzJ10gPSBpbWFnZV9uYW1lcwogICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiRGV0ZWN0ZWQgaW1hZ2UgbmFtZXM6IHtpbWFnZV9uYW1lc30iKQoKICAgICAgICAjIEluaXRpYWxpemUgZmVhdHVyZSBleHRyYWN0b3IKICAgICAgICBzZWxmLl9pbml0X2ZlYXR1cmVfZXh0cmFjdG9yKCkKCiAgICAgICAgIyBJbml0aWFsaXplIGNsdXN0ZXJpbmcgYWxnb3JpdGhtcwogICAgICAgIHNlbGYudm94ZWwyc3VwZXJ2b3hlbF9jbHVzdGVyaW5nID0gZ2V0X2NsdXN0ZXJpbmdfYWxnb3JpdGhtKAogICAgICAgICAgICBzZWxmLnN1cGVydm94ZWxfbWV0aG9kLAogICAgICAgICAgICBuX2NsdXN0ZXJzPXNlbGYubl9jbHVzdGVyc19zdXBlcnZveGVsLAogICAgICAgICAgICByYW5kb21fc3RhdGU9c2VsZi5yYW5kb21fc3RhdGUKICAgICAgICApCgogICAgICAgIHNlbGYuc3VwZXJ2b3hlbDJoYWJpdGF0X2NsdXN0ZXJpbmcgPSBnZXRfY2x1c3RlcmluZ19hbGdvcml0aG0oCiAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9tZXRob2QsCiAgICAgICAgICAgIG5fY2x1c3RlcnM9c2VsZi5uX2NsdXN0ZXJzX2hhYml0YXRzX21heCwKICAgICAgICAgICAgcmFuZG9tX3N0YXRlPXNlbGYucmFuZG9tX3N0YXRlCiAgICAgICAgKQoKICAgICAgICAjIFJlc3VsdHMgc3RvcmFnZQogICAgICAgIHNlbGYuWCA9IE5vbmUgICMgRmVhdHVyZSBtYXRyaXgKICAgICAgICBzZWxmLnN1cGVydm94ZWxfbGFiZWxzID0ge30gICMgU3VwZXJ2b3hlbCBsYWJlbHMKICAgICAgICBzZWxmLmhhYml0YXRfbGFiZWxzID0gTm9uZSAgIyBIYWJpdGF0IGxhYmVscwogICAgICAgIHNlbGYucmVzdWx0c19kZiA9IE5vbmUgICMgUmVzdWx0cyBEYXRhRnJhbWUKCiAgICAgICAgIyBWYWxpZGF0ZSBkYXRhIHN0cnVjdHVyZQogICAgICAgIHZveGVsX2NvbmZpZyA9IHNlbGYuZmVhdHVyZV9jb25maWdbJ3ZveGVsX2xldmVsJ10KICAgICAgICBpZiBpc2luc3RhbmNlKHZveGVsX2NvbmZpZywgZGljdCkgYW5kICdpbWFnZV9uYW1lcycgaW4gdm94ZWxfY29uZmlnOgogICAgICAgICAgICBjaGVja19kYXRhX3N0cnVjdHVyZShzZWxmLmltYWdlc19wYXRocywgc2VsZi5tYXNrX3BhdGhzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdm94ZWxfY29uZmlnWydpbWFnZV9uYW1lcyddLCBOb25lKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoInZveGVsX2xldmVsIGNvbmZpZ3VyYXRpb24gbXVzdCBjb250YWluICdpbWFnZV9uYW1lcycgZmllbGQiKQogICAgCiAgICBkZWYgX3NldHVwX2xvZ2dpbmcoc2VsZiwgbG9nX2xldmVsOiBzdHIpIC0+IE5vbmU6CiAgICAgICAgIiIiU2V0dXAgbG9nZ2luZyBjb25maWd1cmF0aW9uLgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGxvZ19sZXZlbCAoc3RyKTogTG9nZ2luZyBsZXZlbC4KICAgICAgICAiIiIKICAgICAgICAjIENyZWF0ZSBmb3JtYXR0ZXIKICAgICAgICBmb3JtYXR0ZXIgPSBsb2dnaW5nLkZvcm1hdHRlcignJShhc2N0aW1lKXMgLSAlKG5hbWUpcyAtICUobGV2ZWxuYW1lKXMgLSAlKG1lc3NhZ2UpcycpCiAgICAgICAgCiAgICAgICAgIyBTZXR1cCBsb2dnZXIKICAgICAgICBzZWxmLmxvZ2dlciA9IGxvZ2dpbmcuZ2V0TG9nZ2VyKF9fbmFtZV9fKQogICAgICAgIHNlbGYubG9nZ2VyLnNldExldmVsKGdldGF0dHIobG9nZ2luZywgbG9nX2xldmVsLnVwcGVyKCkpKQogICAgICAgIAogICAgICAgICMgQ2xlYXIgYW55IGV4aXN0aW5nIGhhbmRsZXJzCiAgICAgICAgc2VsZi5sb2dnZXIuaGFuZGxlcnMgPSBbXQogICAgICAgIAogICAgICAgICMgQWRkIGNvbnNvbGUgaGFuZGxlcgogICAgICAgIGNvbnNvbGVfaGFuZGxlciA9IGxvZ2dpbmcuU3RyZWFtSGFuZGxlcigpCiAgICAgICAgY29uc29sZV9oYW5kbGVyLnNldEZvcm1hdHRlcihmb3JtYXR0ZXIpCiAgICAgICAgc2VsZi5sb2dnZXIuYWRkSGFuZGxlcihjb25zb2xlX2hhbmRsZXIpCiAgICAgICAgCiAgICAgICAgIyBBZGQgZmlsZSBoYW5kbGVyCiAgICAgICAgbG9nX2RpciA9IG9zLnBhdGguam9pbihzZWxmLm91dF9kaXIsICJsb2dzIikKICAgICAgICBvcy5tYWtlZGlycyhsb2dfZGlyLCBleGlzdF9vaz1UcnVlKQogICAgICAgIGxvZ19maWxlID0gb3MucGF0aC5qb2luKGxvZ19kaXIsICJoYWJpdGF0X2FuYWx5c2lzLmxvZyIpCiAgICAgICAgZmlsZV9oYW5kbGVyID0gbG9nZ2luZy5GaWxlSGFuZGxlcihsb2dfZmlsZSwgZW5jb2Rpbmc9J3V0Zi04JykKICAgICAgICBmaWxlX2hhbmRsZXIuc2V0Rm9ybWF0dGVyKGZvcm1hdHRlcikKICAgICAgICBzZWxmLmxvZ2dlci5hZGRIYW5kbGVyKGZpbGVfaGFuZGxlcikKICAgICAgICAKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTG9nZ2luZyBpbml0aWFsaXplZC4gTG9nIGZpbGU6IHtsb2dfZmlsZX0iKQoKICAgIGRlZiBfaW5pdF9mZWF0dXJlX2V4dHJhY3RvcihzZWxmKToKICAgICAgICAiIiJJbml0aWFsaXplIGZlYXR1cmUgZXh0cmFjdG9yIGJhc2VkIG9uIGNvbmZpZ3VyYXRpb24iIiIKCgogICAgICAgICMg5Yib5bu66KGo6L6+5byP6Kej5p6Q5Zmo5a6e5L6LCiAgICAgICAgc2VsZi5leHByZXNzaW9uX3BhcnNlciA9IEZlYXR1cmVFeHByZXNzaW9uUGFyc2VyKCkKCiAgICAgICAgIyDmj5Dlj5Z2b3hlbF9sZXZlbOmFjee9rgogICAgICAgIHZveGVsX2NvbmZpZyA9IHNlbGYuZmVhdHVyZV9jb25maWdbJ3ZveGVsX2xldmVsJ10KCiAgICAgICAgIyDnoa7kv512b3hlbF9jb25maWfmmK/lrZflhbjkuJTljIXlkKttZXRob2TlrZfmrrUKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZSh2b3hlbF9jb25maWcsIGRpY3QpIG9yICdtZXRob2QnIG5vdCBpbiB2b3hlbF9jb25maWc6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoInZveGVsX2xldmVsIG11c3QgYmUgYSBkaWN0aW9uYXJ5IHdpdGggJ21ldGhvZCcgZmllbGQiKQoKICAgICAgICAjIOino+aekHZveGVsX2xldmVs6KGo6L6+5byPCiAgICAgICAgc2VsZi52b3hlbF9tZXRob2QsIHNlbGYudm94ZWxfcGFyYW1zLCBzZWxmLnZveGVsX3Byb2Nlc3Npbmdfc3RlcHMgPSBzZWxmLmV4cHJlc3Npb25fcGFyc2VyLnBhcnNlKHZveGVsX2NvbmZpZykKCiAgICAgICAgIyDmo4Dmn6XmmK/lkKbmj5DkvpvkuoZzdXBlcnZveGVsX2xldmVs6YWN572uCiAgICAgICAgc2VsZi5oYXNfc3VwZXJ2b3hlbF9jb25maWcgPSAnc3VwZXJ2b3hlbF9sZXZlbCcgaW4gc2VsZi5mZWF0dXJlX2NvbmZpZwogICAgICAgIGlmIHNlbGYuaGFzX3N1cGVydm94ZWxfY29uZmlnOgogICAgICAgICAgICAjIOaPkOWPlnN1cGVydm94ZWxfbGV2ZWzphY3nva4KICAgICAgICAgICAgc3VwZXJ2b3hlbF9jb25maWcgPSBzZWxmLmZlYXR1cmVfY29uZmlnWydzdXBlcnZveGVsX2xldmVsJ10KCiAgICAgICAgICAgICMg56Gu5L+dc3VwZXJ2b3hlbF9jb25maWfmmK/lrZflhbjkuJTljIXlkKttZXRob2TlrZfmrrUKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uoc3VwZXJ2b3hlbF9jb25maWcsIGRpY3QpIG9yICdtZXRob2QnIG5vdCBpbiBzdXBlcnZveGVsX2NvbmZpZzoKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoInN1cGVydm94ZWxfbGV2ZWwgbXVzdCBiZSBhIGRpY3Rpb25hcnkgd2l0aCAnbWV0aG9kJyBmaWVsZCIpCgogICAgICAgICAgICAjIOino+aekHN1cGVydm94ZWxfbGV2ZWzooajovr7lvI8KICAgICAgICAgICAgc2VsZi5zdXBlcnZveGVsX21ldGhvZF9uYW1lLCBzZWxmLnN1cGVydm94ZWxfcGFyYW1zLCBzZWxmLnN1cGVydm94ZWxfcHJvY2Vzc2luZ19zdGVwcyA9IHNlbGYuZXhwcmVzc2lvbl9wYXJzZXIucGFyc2Uoc3VwZXJ2b3hlbF9jb25maWcpCgogICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJzdXBlcnZveGVsX2xldmVsIGZlYXR1cmUgY29uZmlndXJhdGlvbiBkZXRlY3RlZCBidXQgbm90IHVzZWQgaW4gY3VycmVudCBpbXBsZW1lbnRhdGlvbiIpCgogICAgICAgICMg5Yib5bu66Leo5Zu+5YOP54m55b6B5o+Q5Y+W5Zmo5Y+C5pWwCiAgICAgICAgIyDlh4blpIfot6jlm77lg4/lj4LmlbAKICAgICAgICBjcm9zc19pbWFnZV9rd2FyZ3MgPSB7fQoKICAgICAgICAjIOajgOafpXZveGVsX3BhcmFtc+aYr+WQpuS4uuepugogICAgICAgIGlmIHNlbGYudm94ZWxfcGFyYW1zOgogICAgICAgICAgICAjIOWkhOeQhui3qOWbvuWDj+WPguaVsAogICAgICAgICAgICBmb3IgcGFyYW1fbmFtZSwgcGFyYW1fdmFsdWUgaW4gc2VsZi52b3hlbF9wYXJhbXMuaXRlbXMoKToKICAgICAgICAgICAgICAgICMg5LuOdm94ZWxfbGV2ZWwucGFyYW1z5Lit6I635Y+W5Y+C5pWw5YC8CiAgICAgICAgICAgICAgICB2b3hlbF9wYXJhbXMgPSBzZWxmLmZlYXR1cmVfY29uZmlnWyd2b3hlbF9sZXZlbCddLmdldCgncGFyYW1zJywge30pCiAgICAgICAgICAgICAgICBpZiBwYXJhbV92YWx1ZSA9PSBwYXJhbV9uYW1lIGFuZCBwYXJhbV9uYW1lIGluIHZveGVsX3BhcmFtczoKICAgICAgICAgICAgICAgICAgICBjcm9zc19pbWFnZV9rd2FyZ3NbcGFyYW1fbmFtZV0gPSB2b3hlbF9wYXJhbXNbcGFyYW1fbmFtZV0KICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShwYXJhbV92YWx1ZSwgc3RyKSBhbmQgcGFyYW1fdmFsdWUgaW4gdm94ZWxfcGFyYW1zOgogICAgICAgICAgICAgICAgICAgIGNyb3NzX2ltYWdlX2t3YXJnc1twYXJhbV9uYW1lXSA9IHZveGVsX3BhcmFtc1twYXJhbV92YWx1ZV0KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyDlkKbliJnnm7TmjqXkvb/nlKjlj4LmlbDlgLwKICAgICAgICAgICAgICAgICAgICBjcm9zc19pbWFnZV9rd2FyZ3NbcGFyYW1fbmFtZV0gPSBwYXJhbV92YWx1ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgIHNlbGYuY3Jvc3NfaW1hZ2Vfa3dhcmdzID0gY3Jvc3NfaW1hZ2Vfa3dhcmdzCgogICAgZGVmIF92b3hlbDJzdXBlcnZveGVsX2NsdXN0ZXJpbmcoc2VsZiwgc3ViamVjdDogc3RyKSAtPiBUdXBsZVtzdHIsIFVuaW9uW1R1cGxlW3N0ciwgcGQuRGF0YUZyYW1lXSwgRXhjZXB0aW9uXV06CiAgICAgICAgIiIiCiAgICAgICAgUHJvY2VzcyBhIHNpbmdsZSBzdWJqZWN0CgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHN1YmplY3QgKHN0cik6IFN1YmplY3QgSUQgdG8gcHJvY2VzcwoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBUdXBsZVtzdHIsIFVuaW9uW1R1cGxlW3N0ciwgcGQuRGF0YUZyYW1lXSwgRXhjZXB0aW9uXV06IFR1cGxlIGNvbnRhaW5pbmc6CiAgICAgICAgICAgICAgICAtIHN1YmplY3QgSUQKICAgICAgICAgICAgICAgIC0gRWl0aGVyIGEgdHVwbGUgb2YgKHN1YmplY3QgSUQsIG1lYW5fZmVhdHVyZXNfZGYpIG9yIGFuIEV4Y2VwdGlvbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBsb2cgYWRkIHN1YmplY3QKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIl92b3hlbDJzdXBlcnZveGVsX2NsdXN0ZXJpbmcgc3ViamVjdDoge3N1YmplY3R9IikKICAgICAgICAgICAgcHJpbnQoZiJfdm94ZWwyc3VwZXJ2b3hlbF9jbHVzdGVyaW5nIHN1YmplY3Q6IHtzdWJqZWN0fSIpCiAgICAgICAgICAgICMgRXh0cmFjdCBmZWF0dXJlcwogICAgICAgICAgICBfLCBmZWF0dXJlX2RmLCByYXdfZGYsIG1hc2tfaW5mbyA9IHNlbGYuZXh0cmFjdF92b3hlbF9mZWF0dXJlcyhzdWJqZWN0KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBBcHBseSBwcmVwcm9jZXNzaW5nIGlmIGVuYWJsZWQKICAgICAgICAgICAgaWYgc2VsZi5mZWF0dXJlX2NvbmZpZy5nZXQoJ3ByZXByb2Nlc3NpbmcnLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAjIOajgOafpeaYr+WQpuS9v+eUqOaWsOeahOWkmuaWueazleS4suiBlOacuuWItgogICAgICAgICAgICAgICAgaWYgJ21ldGhvZHMnIGluIHNlbGYuZmVhdHVyZV9jb25maWdbJ3ByZXByb2Nlc3NpbmcnXToKICAgICAgICAgICAgICAgICAgICAjIOS9v+eUqOWkmuaWueazleS4suiBlAogICAgICAgICAgICAgICAgICAgIFhfc3Vial8gPSBwcmVwcm9jZXNzX2ZlYXR1cmVzKAogICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlX2RmLnZhbHVlcywKICAgICAgICAgICAgICAgICAgICAgICAgbWV0aG9kcz1zZWxmLmZlYXR1cmVfY29uZmlnWydwcmVwcm9jZXNzaW5nJ11bJ21ldGhvZHMnXQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlX2RmID0gcGQuRGF0YUZyYW1lKFhfc3Vial8sIGNvbHVtbnM9ZmVhdHVyZV9kZi5jb2x1bW5zKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIOS9v+eUqOWNleS4gOaWueazle+8iOWQkeWQjuWFvOWuue+8iQogICAgICAgICAgICAgICAgICAgIFhfc3Vial8gPSBwcmVwcm9jZXNzX2ZlYXR1cmVzKGZlYXR1cmVfZGYudmFsdWVzLCAqKnNlbGYuZmVhdHVyZV9jb25maWdbJ3ByZXByb2Nlc3NpbmcnXSkKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlX2RmID0gcGQuRGF0YUZyYW1lKFhfc3Vial8sIGNvbHVtbnM9ZmVhdHVyZV9kZi5jb2x1bW5zKQoKICAgICAgICAgICAgIyBQZXJmb3JtIGNsdXN0ZXJpbmcgZm9yIHZveGVsIHRvIHN1cGVydm94ZWwKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi52b3hlbDJzdXBlcnZveGVsX2NsdXN0ZXJpbmcuZml0KGZlYXR1cmVfZGYudmFsdWVzKQogICAgICAgICAgICAgICAgc3VwZXJ2b3hlbF9sYWJlbHMgPSBzZWxmLnZveGVsMnN1cGVydm94ZWxfY2x1c3RlcmluZy5wcmVkaWN0KGZlYXR1cmVfZGYudmFsdWVzKQogICAgICAgICAgICAgICAgc3VwZXJ2b3hlbF9sYWJlbHMgKz0gMSAgIyBTdGFydCBudW1iZXJpbmcgZnJvbSAxCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiRXJyb3IgcGVyZm9ybWluZyBzdXBlcnZveGVsIGNsdXN0ZXJpbmcgZm9yIHN1YmplY3Qge3N1YmplY3R9OiB7c3RyKGUpfSIpCiAgICAgICAgICAgICAgICByYWlzZQoKICAgICAgICAgICAgIyBHZXQgZmVhdHVyZSBuYW1lcwogICAgICAgICAgICBmZWF0dXJlX25hbWVzID0gZmVhdHVyZV9kZi5jb2x1bW5zLnRvbGlzdCgpCgogICAgICAgICAgICAjIEdldCBvcmlnaW5hbCBmZWF0dXJlIG5hbWVzIChpbWFnZSBuYW1lcykKICAgICAgICAgICAgb3JpZ2luYWxfZmVhdHVyZV9uYW1lcyA9IHJhd19kZi5jb2x1bW5zLnRvbGlzdCgpCgogICAgICAgICAgICAjIENhbGN1bGF0ZSBhdmVyYWdlIGZlYXR1cmVzIGZvciBlYWNoIHN1cGVydm94ZWwKICAgICAgICAgICAgdW5pcXVlX2xhYmVscyA9IG5wLmFyYW5nZSgxLCBzZWxmLm5fY2x1c3RlcnNfc3VwZXJ2b3hlbCArIDEpCiAgICAgICAgICAgIGRhdGFfcm93cyA9IFtdCiAgICAgICAgICAgIGZvciBpIGluIHVuaXF1ZV9sYWJlbHM6CiAgICAgICAgICAgICAgICBpbmRpY2VzID0gc3VwZXJ2b3hlbF9sYWJlbHMgPT0gaQogICAgICAgICAgICAgICAgaWYgbnAuYW55KGluZGljZXMpOgogICAgICAgICAgICAgICAgICAgICMgQ2FsY3VsYXRlIGF2ZXJhZ2UgZmVhdHVyZXMgZm9yIGN1cnJlbnQgc3VwZXJ2b3hlbAogICAgICAgICAgICAgICAgICAgIG1lYW5fZmVhdHVyZXMgPSBucC5tZWFuKGZlYXR1cmVfZGZbaW5kaWNlc10sIGF4aXM9MCkKICAgICAgICAgICAgICAgICAgICBtZWFuX29yaWdpbmFsX2ZlYXR1cmVzID0gbnAubWVhbihyYXdfZGYudmFsdWVzW2luZGljZXNdLCBheGlzPTApCiAgICAgICAgICAgICAgICAgICAgY291bnQgPSBucC5zdW0oaW5kaWNlcykKICAgICAgICAgICAgICAgICAgICAjIENyZWF0ZSBkYXRhIHJvdwogICAgICAgICAgICAgICAgICAgIGRhdGFfcm93ID0gewogICAgICAgICAgICAgICAgICAgICAgICAiU3ViamVjdCI6IHN1YmplY3QsCiAgICAgICAgICAgICAgICAgICAgICAgICJTdXBlcnZveGVsIjogaSwKICAgICAgICAgICAgICAgICAgICAgICAgIkNvdW50IjogY291bnQsCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICMgQWRkIGZlYXR1cmUgbWVhbnMKICAgICAgICAgICAgICAgICAgICBmb3IgaiwgbmFtZSBpbiBlbnVtZXJhdGUoZmVhdHVyZV9uYW1lcyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFfcm93W25hbWVdID0gbWVhbl9mZWF0dXJlc1tqXQoKICAgICAgICAgICAgICAgICAgICAjIEFkZCBvcmlnaW5hbCBmZWF0dXJlIG1lYW5zCiAgICAgICAgICAgICAgICAgICAgZm9yIGosIG5hbWUgaW4gZW51bWVyYXRlKG9yaWdpbmFsX2ZlYXR1cmVfbmFtZXMpOgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhX3Jvd1tmIntuYW1lfS1vcmlnaW5hbCJdID0gbWVhbl9vcmlnaW5hbF9mZWF0dXJlc1tqXQoKICAgICAgICAgICAgICAgICAgICBkYXRhX3Jvd3MuYXBwZW5kKGRhdGFfcm93KQogICAgICAgICAgICBtZWFuX2ZlYXR1cmVzX2RmID0gcGQuRGF0YUZyYW1lKGRhdGFfcm93cykKCiAgICAgICAgICAgICMgU2F2ZSBzdXBlcnZveGVsIGltYWdlCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UobWFza19pbmZvLCBkaWN0KSBhbmQgJ21hc2tfYXJyYXknIGluIG1hc2tfaW5mbyBhbmQgJ21hc2snIGluIG1hc2tfaW5mbzoKICAgICAgICAgICAgICAgICMgQ3JlYXRlIHN1cGVydm94ZWwgbWFwCiAgICAgICAgICAgICAgICBzdXBlcnZveGVsX21hcCA9IG5wLnplcm9zX2xpa2UobWFza19pbmZvWydtYXNrX2FycmF5J10pCiAgICAgICAgICAgICAgICBtYXNrX2luZGljZXMgPSBtYXNrX2luZm9bJ21hc2tfYXJyYXknXSA+IDAKICAgICAgICAgICAgICAgIHN1cGVydm94ZWxfbWFwW21hc2tfaW5kaWNlc10gPSBzdXBlcnZveGVsX2xhYmVscwoKICAgICAgICAgICAgICAgICMgQ29udmVydCB0byBTaW1wbGVJVEsgaW1hZ2UgYW5kIHNhdmUKICAgICAgICAgICAgICAgIHN1cGVydm94ZWxfaW1nID0gc2l0ay5HZXRJbWFnZUZyb21BcnJheShzdXBlcnZveGVsX21hcCkKICAgICAgICAgICAgICAgIHN1cGVydm94ZWxfaW1nLkNvcHlJbmZvcm1hdGlvbihtYXNrX2luZm9bJ21hc2snXSkKCiAgICAgICAgICAgICAgICAjIFNhdmUgYXMgbnJyZCBmaWxlCiAgICAgICAgICAgICAgICBzaXRrLldyaXRlSW1hZ2Uoc3VwZXJ2b3hlbF9pbWcsIG9zLnBhdGguam9pbihzZWxmLm91dF9kaXIsIGYie3N1YmplY3R9X3N1cGVydm94ZWwubnJyZCIpKQoKICAgICAgICAgICAgICAgICMgQ2xlYW4gdXAgbWVtb3J5CiAgICAgICAgICAgICAgICBkZWwgc3VwZXJ2b3hlbF9tYXAsIG1hc2tfaW5kaWNlcwoKICAgICAgICAgICAgIyBDbGVhbiB1cCBtZW1vcnkKICAgICAgICAgICAgZGVsIGZlYXR1cmVfZGYsIHJhd19kZiwgc3VwZXJ2b3hlbF9sYWJlbHMKCiAgICAgICAgICAgIHJldHVybiBzdWJqZWN0LCBtZWFuX2ZlYXR1cmVzX2RmCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAjIOiusOW9lemUmeivr+W5tui/lOWbnuW8guW4uOWvueixoQogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkVycm9yIGluIF92b3hlbDJzdXBlcnZveGVsX2NsdXN0ZXJpbmcgZm9yIHN1YmplY3Qge3N1YmplY3R9OiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybiBzdWJqZWN0LCBFeGNlcHRpb24oc3RyKGUpKQoKICAgIGRlZiBydW4oc2VsZiwgc3ViamVjdHM6IE9wdGlvbmFsW0xpc3Rbc3RyXV0gPSBOb25lLCBzYXZlX3Jlc3VsdHNfY3N2OiBib29sID0gVHJ1ZSkgLT4gcGQuRGF0YUZyYW1lOgogICAgICAgICIiIgogICAgICAgIFJ1biB0aGUgaGFiaXRhdCBjbHVzdGVyaW5nIHBpcGVsaW5lCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHN1YmplY3RzIChPcHRpb25hbFtMaXN0W3N0cl1dLCBvcHRpb25hbCk6IExpc3Qgb2Ygc3ViamVjdHMgdG8gcHJvY2Vzcy4gSWYgTm9uZSwgYWxsIHN1YmplY3RzIHdpbGwgYmUgcHJvY2Vzc2VkLgogICAgICAgICAgICBzYXZlX3Jlc3VsdHNfY3N2IChib29sLCBvcHRpb25hbCk6IFdoZXRoZXIgdG8gc2F2ZSByZXN1bHRzIGFzIENTViBmaWxlcy4gRGVmYXVsdHMgdG8gVHJ1ZS4KCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgcGQuRGF0YUZyYW1lOiBIYWJpdGF0IGNsdXN0ZXJpbmcgcmVzdWx0cwogICAgICAgICIiIgogICAgICAgIGlmIHN1YmplY3RzIGlzIE5vbmU6CiAgICAgICAgICAgIHN1YmplY3RzID0gbGlzdChzZWxmLmltYWdlc19wYXRocy5rZXlzKCkpCgogICAgICAgICMgRXh0cmFjdCBmZWF0dXJlcyBhbmQgcGVyZm9ybSBzdXBlcnZveGVsIGNsdXN0ZXJpbmcgZm9yIGVhY2ggc3ViamVjdAogICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiRXh0cmFjdGluZyBmZWF0dXJlcyBhbmQgcGVyZm9ybWluZyBzdXBlcnZveGVsIGNsdXN0ZXJpbmcuLi4iKQoKICAgICAgICAjIFJlc3VsdHMgc3RvcmFnZQogICAgICAgIG1lYW5fZmVhdHVyZXNfYWxsID0gcGQuRGF0YUZyYW1lKCkKICAgICAgICBmYWlsZWRfc3ViamVjdHMgPSBbXSAgIyBUcmFjayBmYWlsZWQgc3ViamVjdHMKCiAgICAgICAgIyBVc2UgbXVsdGlwcm9jZXNzaW5nIHRvIHByb2Nlc3Mgc3ViamVjdHMKICAgICAgICBpZiBzZWxmLm5fcHJvY2Vzc2VzID4gMSBhbmQgbGVuKHN1YmplY3RzKSA+IDE6CiAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJVc2luZyB7c2VsZi5uX3Byb2Nlc3Nlc30gcHJvY2Vzc2VzIGZvciBwYXJhbGxlbCBwcm9jZXNzaW5nLi4uIikKCiAgICAgICAgICAgIHdpdGggbXVsdGlwcm9jZXNzaW5nLlBvb2wocHJvY2Vzc2VzPXNlbGYubl9wcm9jZXNzZXMpIGFzIHBvb2w6CiAgICAgICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiU3RhcnRpbmcgcGFyYWxsZWwgcHJvY2Vzc2luZyBvZiBhbGwgc3ViamVjdHMuLi4iKQogICAgICAgICAgICAgICAgcmVzdWx0c19pdGVyID0gcG9vbC5pbWFwX3Vub3JkZXJlZChzZWxmLl92b3hlbDJzdXBlcnZveGVsX2NsdXN0ZXJpbmcsIHN1YmplY3RzKQoKICAgICAgICAgICAgICAgICMg5L2/55So6Ieq5a6a5LmJ6L+b5bqm5p2h5pi+56S66L+b5bqmCiAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIgPSBDdXN0b21UcWRtKHRvdGFsPWxlbihzdWJqZWN0cyksIGRlc2M9IlByb2Nlc3Npbmcgc3ViamVjdHMiKQogICAgICAgICAgICAgICAgZm9yIHJlc3VsdCBpbiByZXN1bHRzX2l0ZXI6CiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXN1bHRbMV0sIEV4Y2VwdGlvbik6CiAgICAgICAgICAgICAgICAgICAgICAgICMg5aaC5p6c57uT5p6c5piv5byC5bi477yM6K6w5b2V6ZSZ6K+v5bm257un57utCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZF9zdWJqZWN0cy5hcHBlbmQocmVzdWx0WzBdKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkVycm9yIHByb2Nlc3Npbmcgc3ViamVjdCB7cmVzdWx0WzBdfToge3N0cihyZXN1bHRbMV0pfSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdCwgbWVhbl9mZWF0dXJlc19kZiA9IHJlc3VsdAogICAgICAgICAgICAgICAgICAgICAgICBtZWFuX2ZlYXR1cmVzX2FsbCA9IHBkLmNvbmNhdChbbWVhbl9mZWF0dXJlc19hbGwsIG1lYW5fZmVhdHVyZXNfZGZdLCBpZ25vcmVfaW5kZXg9VHJ1ZSkKCiAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyLnVwZGF0ZSgxKQoKICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBpZiBmYWlsZWRfc3ViamVjdHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJGYWlsZWQgdG8gcHJvY2VzcyB7bGVuKGZhaWxlZF9zdWJqZWN0cyl9IikKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiXG5BbGwge2xlbihzdWJqZWN0cyl9IHN1YmplY3RzIGhhdmUgYmVlbiBwcm9jZXNzZWQuIFByb2NlZWRpbmcgdG8gY2x1c3RlcmluZy4uLiIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBTaW5nbGUgcHJvY2VzcyBwcm9jZXNzaW5nLCB1c2UgY3VzdG9tIHByb2dyZXNzIGJhcgogICAgICAgICAgICBwcm9ncmVzc19iYXIgPSBDdXN0b21UcWRtKHRvdGFsPWxlbihzdWJqZWN0cyksIGRlc2M9IlByb2Nlc3Npbmcgc3ViamVjdHMiKQogICAgICAgICAgICBmb3Igc3ViamVjdCBpbiBzdWJqZWN0czoKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmVzdWx0WzFdLCBFeGNlcHRpb24pOgogICAgICAgICAgICAgICAgICAgIGZhaWxlZF9zdWJqZWN0cy5hcHBlbmQoc3ViamVjdCkKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiRXJyb3IgcHJvY2Vzc2luZyBzdWJqZWN0IHtzdWJqZWN0fToge3N0cihyZXN1bHRbMV0pfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHN1YmplY3QsIG1lYW5fZmVhdHVyZXNfZGYgPSByZXN1bHQKICAgICAgICAgICAgICAgICAgICBtZWFuX2ZlYXR1cmVzX2FsbCA9IHBkLmNvbmNhdChbbWVhbl9mZWF0dXJlc19hbGwsIG1lYW5fZmVhdHVyZXNfZGZdLCBpZ25vcmVfaW5kZXg9VHJ1ZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyLnVwZGF0ZSgxKQoKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlIGFuZCBmYWlsZWRfc3ViamVjdHM6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiRmFpbGVkIHRvIHByb2Nlc3Mge2xlbihmYWlsZWRfc3ViamVjdHMpfSIpCgogICAgICAgICMgQ2hlY2sgaWYgdGhlcmUgaXMgZW5vdWdoIGRhdGEgZm9yIGNsdXN0ZXJpbmcKICAgICAgICBpZiBsZW4obWVhbl9mZWF0dXJlc19hbGwpID09IDA6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIk5vIHZhbGlkIGZlYXR1cmVzIGZvciBhbmFseXNpcyIpCgogICAgICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgICAjIFByZXBhcmUgZmVhdHVyZXMgZm9yIHBvcHVsYXRpb24tbGV2ZWwgY2x1c3RlcmluZwogICAgICAgICMgZmVhdHVyZV9uYW1lcyA9IG1lYW5fZmVhdHVyZXNfYWxs5Lit5LiN5LulLW9yaWdpbmFs57uT5bC+55qE5YiXCiAgICAgICAgZmVhdHVyZV9uYW1lcyA9IFtjb2wgZm9yIGNvbCBpbiBtZWFuX2ZlYXR1cmVzX2FsbC5jb2x1bW5zIGlmIG5vdCBjb2wuZW5kc3dpdGgoJy1vcmlnaW5hbCcpXQogICAgICAgIGZlYXR1cmVfbmFtZXMgPSBmZWF0dXJlX25hbWVzWzM6XSAgIyDljrvmjolTdWJqZWN0LCBTdXBlcnZveGVsLCBDb3VudCBGSVhNRTog6ZyA6KaB5qC55o2u5a6e6ZmF5oOF5Ya16LCD5pW0CiAgICAgICAgZmVhdHVyZXNfb2ZfYWxsX3N1YmplY3RzID0gbWVhbl9mZWF0dXJlc19hbGxbZmVhdHVyZV9uYW1lc10KICAgICAgICBzdXBlcnZveGVsX2ZpbGVfa2V5d29yZCA9IHNlbGYuZmVhdHVyZV9jb25maWdbJ3N1cGVydm94ZWxfbGV2ZWwnXS5nZXQoJ3N1cGVydm94ZWxfZmlsZV9rZXl3b3JkJywgJypfc3VwZXJ2b3hlbC5ucnJkJykKICAgICAgICBzdXBlcnZveGVsX2ZpbGVzID0gZ2xvYihvcy5wYXRoLmpvaW4oc2VsZi5vdXRfZGlyLCBzdXBlcnZveGVsX2ZpbGVfa2V5d29yZCkpCiAgICAgICAgIyBpZiBzdWJqZWN0IGluIHN1YmplY3RzLCB0aGVuIGFkZCB0byBzdXBlcnZveGVsX2ZpbGVfa2V5d29yZF9kaWN0CiAgICAgICAgc2VsZi5zdXBlcnZveGVsX2ZpbGVfZGljdCA9IHt9CiAgICAgICAgZm9yIHN1YmplY3QgaW4gc3ViamVjdHM6CiAgICAgICAgICAgIGZvciBzdXBlcnZveGVsX2ZpbGUgaW4gc3VwZXJ2b3hlbF9maWxlczoKICAgICAgICAgICAgICAgIGlmIHN1YmplY3QgaW4gc3VwZXJ2b3hlbF9maWxlOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc3VwZXJ2b3hlbF9maWxlX2RpY3Rbc3ViamVjdF0gPSBzdXBlcnZveGVsX2ZpbGUKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaWYgc3ViamVjdCBub3QgaW4gZmFpbGVkX3N1YmplY3RzOiAgIyBPbmx5IHdhcm4gZm9yIG5vbi1mYWlsZWQgc3ViamVjdHMKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJObyBzdXBlcnZveGVsIGZpbGUgZm91bmQgZm9yIHN1YmplY3Qge3N1YmplY3R9IikKCiAgICAgICAgaWYgbm90IHNlbGYuc3VwZXJ2b3hlbF9maWxlX2RpY3Q6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJObyBzdXBlcnZveGVsIGZpbGVzIGZvdW5kIGluIHtzZWxmLm91dF9kaXJ9IikKCiAgICAgICAgIyDmo4Dmn6XmmK/lkKbkvb/nlKhtZWFuX3ZveGVsX2ZlYXR1cmVzCiAgICAgICAgaXNfbWVhbl92b3hlbF9mZWF0dXJlcyA9ICdtZWFuX3ZveGVsX2ZlYXR1cmVzJyBpbiBzZWxmLmZlYXR1cmVfY29uZmlnWydzdXBlcnZveGVsX2xldmVsJ11bJ21ldGhvZCddCiAgICAgICAgaWYgbm90IGlzX21lYW5fdm94ZWxfZmVhdHVyZXM6CiAgICAgICAgICAgICMgVXNlIG11bHRpcHJvY2Vzc2luZyB0byBleHRyYWN0IHN1cGVydm94ZWwgZmVhdHVyZXMgZm9yIGFsbCBzdWJqZWN0cwogICAgICAgICAgICBpZiBzZWxmLm5fcHJvY2Vzc2VzID4gMSBhbmQgbGVuKHN1YmplY3RzKSA+IDE6CiAgICAgICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlVzaW5nIHtzZWxmLm5fcHJvY2Vzc2VzfSBwcm9jZXNzZXMgZm9yIHN1cGVydm94ZWwgZmVhdHVyZSBleHRyYWN0aW9uLi4uIikKCiAgICAgICAgICAgICAgICB3aXRoIG11bHRpcHJvY2Vzc2luZy5Qb29sKHByb2Nlc3Nlcz1zZWxmLm5fcHJvY2Vzc2VzKSBhcyBwb29sOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiU3RhcnRpbmcgcGFyYWxsZWwgc3VwZXJ2b3hlbCBmZWF0dXJlIGV4dHJhY3Rpb24uLi4iKQoKICAgICAgICAgICAgICAgICAgICAjIFVzZSBpbWFwX3Vub3JkZXJlZCB0byBwcm9jZXNzIHN1YmplY3RzIGluIHBhcmFsbGVsCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0c19pdGVyID0gcG9vbC5pbWFwX3Vub3JkZXJlZChzZWxmLmV4dHJhY3Rfc3VwZXJ2b3hlbF9mZWF0dXJlcywgc3ViamVjdHMpCgogICAgICAgICAgICAgICAgICAgICMgQ29sbGVjdCBmZWF0dXJlcyBmcm9tIGFsbCBzdWJqZWN0cwogICAgICAgICAgICAgICAgICAgIGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cyA9IFtdCiAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyID0gQ3VzdG9tVHFkbSh0b3RhbD1sZW4oc3ViamVjdHMpLCBkZXNjPSJFeHRyYWN0aW5nIHN1cGVydm94ZWwgZmVhdHVyZXMiKQogICAgICAgICAgICAgICAgICAgIGZvciByZXN1bHQgaW4gcmVzdWx0c19pdGVyOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJlc3VsdFsxXSwgRXhjZXB0aW9uKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZF9zdWJqZWN0cy5hcHBlbmQocmVzdWx0WzBdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiRXJyb3IgZXh0cmFjdGluZyBzdXBlcnZveGVsIGZlYXR1cmVzIGZvciBzdWJqZWN0IHtyZXN1bHRbMF19OiB7c3RyKHJlc3VsdFsxXSl9IikKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cy5hcHBlbmQocmVzdWx0WzFdKQogICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIudXBkYXRlKDEpCgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZSBhbmQgZmFpbGVkX3N1YmplY3RzOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiRmFpbGVkIHRvIGV4dHJhY3Qgc3VwZXJ2b3hlbCBmZWF0dXJlcyBmb3Ige2xlbihmYWlsZWRfc3ViamVjdHMpfSIpCgogICAgICAgICAgICAgICAgICAgICMgY29uY2F0CiAgICAgICAgICAgICAgICAgICAgaWYgZmVhdHVyZXNfb2ZfYWxsX3N1YmplY3RzOgogICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlc19vZl9hbGxfc3ViamVjdHMgPSBwZC5jb25jYXQoZmVhdHVyZXNfb2ZfYWxsX3N1YmplY3RzLCBpZ25vcmVfaW5kZXg9VHJ1ZSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJObyB2YWxpZCBzdXBlcnZveGVsIGZlYXR1cmVzIGV4dHJhY3RlZCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFNpbmdsZSBwcm9jZXNzIHByb2Nlc3NpbmcKICAgICAgICAgICAgICAgIGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cyA9IFtdCiAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIgPSBDdXN0b21UcWRtKHRvdGFsPWxlbihzdWJqZWN0cyksIGRlc2M9IkV4dHJhY3Rpbmcgc3VwZXJ2b3hlbCBmZWF0dXJlcyIpCiAgICAgICAgICAgICAgICBmb3Igc3ViamVjdCBpbiBzdWJqZWN0czoKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJlc3VsdFsxXSwgRXhjZXB0aW9uKToKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkX3N1YmplY3RzLmFwcGVuZChyZXN1bHRbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiRXJyb3IgZXh0cmFjdGluZyBzdXBlcnZveGVsIGZlYXR1cmVzIGZvciBzdWJqZWN0IHtyZXN1bHRbMF19OiB7c3RyKHJlc3VsdFsxXSl9IikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlc19vZl9hbGxfc3ViamVjdHMuYXBwZW5kKHJlc3VsdFsxXSkKICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIudXBkYXRlKDEpCgogICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlIGFuZCBmYWlsZWRfc3ViamVjdHM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkZhaWxlZCB0byBleHRyYWN0IHN1cGVydm94ZWwgZmVhdHVyZXMgZm9yIHtsZW4oZmFpbGVkX3N1YmplY3RzKX0iKQoKICAgICAgICAgICAgICAgICMgY29uY2F0CiAgICAgICAgICAgICAgICBpZiBmZWF0dXJlc19vZl9hbGxfc3ViamVjdHM6CiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXNfb2ZfYWxsX3N1YmplY3RzID0gcGQuY29uY2F0KGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cywgaWdub3JlX2luZGV4PVRydWUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoIk5vIHZhbGlkIHN1cGVydm94ZWwgZmVhdHVyZXMgZXh0cmFjdGVkIikKCiAgICAgICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICAgICMgIFRPRE86IHBlcmZvcm0gZ3JvdXAgbGV2ZWwgZmVhdHVyZSBwcmVwcm9jZXNzaW5nLCBwZXJmb3JtIGhlcmUKICAgICAgICAjIEN1cnJlbnQgb25seSBzdXBwb3J0IG1lYW4gZmlsbGluZwogICAgICAgIGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cyA9IGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cy5hcHBseShsYW1iZGEgeDogcGQudG9fbnVtZXJpYyh4LCBlcnJvcnM9J2NvZXJjZScpKQogICAgICAgIGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cyA9IGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cy5hcHBseW1hcChsYW1iZGEgeDogeC5pdGVtKCkgaWYgaGFzYXR0cih4LCAnaXRlbScpIGVsc2UgeCkKICAgICAgICBmZWF0dXJlc19vZl9hbGxfc3ViamVjdHMgPSBmZWF0dXJlc19vZl9hbGxfc3ViamVjdHMucmVwbGFjZShbbnAuaW5mLCAtbnAuaW5mXSwgbnAubmFuKQogICAgICAgIGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cyA9IGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cy5maWxsbmEoZmVhdHVyZXNfb2ZfYWxsX3N1YmplY3RzLm1lYW4oKSkKICAgICAgICAKICAgICAgICAjICBTYXZlIG1lYW4gdmFsdWVzIGZvciB1bnNlZW4gdGVzdCBzdWJqZWN0cyBpZiBpcyB0cmFpbmluZyBtb2RlbCAgRklYTUU6IOmcgOimgeagueaNruWunumZheaDheWGteiwg+aVtAogICAgICAgIGlmIHNlbGYubW9kZSA9PSAndHJhaW5pbmcnOgogICAgICAgICAgICBtZWFuX3ZhbHVlcyA9IGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cy5tZWFuKCkKICAgICAgICAgICAgbWVhbl92YWx1ZXMubmFtZSA9ICdtZWFuX3ZhbHVlcycKICAgICAgICAgICAgbWVhbl92YWx1ZXMudG9fY3N2KG9zLnBhdGguam9pbihzZWxmLm91dF9kaXIsICdtZWFuX3ZhbHVlc19vZl9hbGxfc3VwZXJ2b3hlbHNfZmVhdHVyZXMuY3N2JyksIGluZGV4PVRydWUsIGhlYWRlcj1UcnVlKQogICAgICAgIGVsaWYgc2VsZi5tb2RlID09ICd0ZXN0aW5nJzoKICAgICAgICAgICAgIyAgTG9hZCBtZWFuIHZhbHVlcyBmb3IgdW5zZWVuIHRlc3Qgc3ViamVjdHMKICAgICAgICAgICAgbWVhbl92YWx1ZXMgPSBwZC5yZWFkX2Nzdihvcy5wYXRoLmpvaW4oc2VsZi5vdXRfZGlyLCAnbWVhbl92YWx1ZXNfb2ZfYWxsX3N1cGVydm94ZWxzX2ZlYXR1cmVzLmNzdicpKQogICAgICAgICAgICBmZWF0dXJlc19vZl9hbGxfc3ViamVjdHMgPSBmZWF0dXJlc19vZl9hbGxfc3ViamVjdHMuZmlsbG5hKG1lYW5fdmFsdWVzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJJbnZhbGlkIG1vZGU6IHtzZWxmLm1vZGV9IikKICAgICAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgICAgCiAgICAgICAgaWYgc2VsZi5tb2RlID09ICd0cmFpbmluZyc6CiAgICAgICAgICAgICMgRGV0ZXJtaW5lIG9wdGltYWwgbnVtYmVyIG9mIGNsdXN0ZXJzCiAgICAgICAgICAgIGlmIHNlbGYuYmVzdF9uX2NsdXN0ZXJzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgIyBJZiBiZXN0IG51bWJlciBvZiBjbHVzdGVycyBpcyBhbHJlYWR5IHNwZWNpZmllZCwgdXNlIGl0IGRpcmVjdGx5CiAgICAgICAgICAgICAgICBvcHRpbWFsX25fY2x1c3RlcnMgPSBzZWxmLmJlc3Rfbl9jbHVzdGVycwogICAgICAgICAgICAgICAgc2NvcmVzID0gTm9uZQogICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJVc2luZyBzcGVjaWZpZWQgYmVzdCBudW1iZXIgb2YgY2x1c3RlcnM6IHtvcHRpbWFsX25fY2x1c3RlcnN9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgT3RoZXJ3aXNlIGZpbmQgb3B0aW1hbCBudW1iZXIgb2YgY2x1c3RlcnMKICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJGaW5kaW5nIG9wdGltYWwgbnVtYmVyIG9mIGNsdXN0ZXJzLi4uIikKCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyBFbnN1cmUgY2x1c3RlciBudW1iZXIgcmFuZ2UgaXMgcmVhc29uYWJsZQogICAgICAgICAgICAgICAgICAgIG1pbl9jbHVzdGVycyA9IG1heCgyLCBzZWxmLm5fY2x1c3RlcnNfaGFiaXRhdHNfbWluKQogICAgICAgICAgICAgICAgICAgIG1heF9jbHVzdGVycyA9IG1pbihzZWxmLm5fY2x1c3RlcnNfaGFiaXRhdHNfbWF4LCBsZW4oZmVhdHVyZXNfb2ZfYWxsX3N1YmplY3RzKSAtIDEpCgogICAgICAgICAgICAgICAgICAgIGlmIG1heF9jbHVzdGVycyA8PSBtaW5fY2x1c3RlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgICMgSWYgcmFuZ2UgaXMgaW52YWxpZCwgdXNlIGRlZmF1bHQgbWluaW11bSB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiSW52YWxpZCBjbHVzdGVyIG51bWJlciByYW5nZSBbe21pbl9jbHVzdGVyc30sIHttYXhfY2x1c3RlcnN9XSwgdXNpbmcgZGVmYXVsdCB2YWx1ZSIpCiAgICAgICAgICAgICAgICAgICAgICAgIG9wdGltYWxfbl9jbHVzdGVycyA9IG1pbl9jbHVzdGVycwogICAgICAgICAgICAgICAgICAgICAgICBzY29yZXMgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBUcnkgdG8gZmluZCBvcHRpbWFsIG51bWJlciBvZiBjbHVzdGVycwogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbHVzdGVyX2Zvcl9iZXN0X24gPSBnZXRfY2x1c3RlcmluZ19hbGdvcml0aG0oc2VsZi5oYWJpdGF0X21ldGhvZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGltYWxfbl9jbHVzdGVycywgc2NvcmVzID0gY2x1c3Rlcl9mb3JfYmVzdF9uLmZpbmRfb3B0aW1hbF9jbHVzdGVycygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZWF0dXJlc19vZl9hbGxfc3ViamVjdHMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluX2NsdXN0ZXJzPW1pbl9jbHVzdGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXhfY2x1c3RlcnM9bWF4X2NsdXN0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZHM9c2VsZi5oYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG93X3Byb2dyZXNzPVRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIElmIHBsb3R0aW5nIGlzIG5lZWRlZCwgcGxvdCBzY29yZSBncmFwaHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYucGxvdF9jdXJ2ZXMgYW5kIHNjb3JlcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMg56Gu5L+d6L6T5Ye655uu5b2V5a2Y5ZyoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLm1ha2VkaXJzKHNlbGYub3V0X2RpciwgZXhpc3Rfb2s9VHJ1ZSkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMg5p6E6YCg5L+d5a2Y6Lev5b6ECiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVfcGF0aCA9IG9zLnBhdGguam9pbihzZWxmLm91dF9kaXIsICdoYWJpdGF0X2NsdXN0ZXJpbmdfc2NvcmVzLnBuZycpCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIOS9v+eUqOaWsOeahOWPr+inhuWMluWHveaVsOe7mOWbvgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwbG90X2NsdXN0ZXJfc2NvcmVzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcmVzX2RpY3Q9c2NvcmVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2x1c3Rlcl9yYW5nZT1jbHVzdGVyX2Zvcl9iZXN0X24uY2x1c3Rlcl9yYW5nZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZHM9c2VsZi5oYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsdXN0ZXJpbmdfYWxnb3JpdGhtPXNlbGYuaGFiaXRhdF9tZXRob2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWdzaXplPSgxMiwgOCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXZlX3BhdGg9c2F2ZV9wYXRoLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdz1GYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYi6IGa57G76K+E5YiG5Zu+5bey5L+d5a2Y6IezIHtzYXZlX3BhdGh9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMg5o2V6I6357uY5Zu+6L+H56iL5Lit55qE6ZSZ6K+vCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYi57uY5Yi26IGa57G76K+E5YiG5Zu+5pe25Ye66ZSZOiB7c3RyKGUpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLnu6fnu63miafooYzlhbbku5bmtYHnqIsuLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIElmIG9wdGltYWwgbnVtYmVyIG9mIGNsdXN0ZXJzIGNhbm5vdCBiZSBmb3VuZCwgdXNlIGRlZmF1bHQgdmFsdWUgYW5kIHdhcm4gdXNlcgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJGYWlsZWQgdG8gZmluZCBvcHRpbWFsIG51bWJlciBvZiBjbHVzdGVyczoge3N0cihlKX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlVzaW5nIGRlZmF1bHQgbnVtYmVyIG9mIGNsdXN0ZXJzIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGltYWxfbl9jbHVzdGVycyA9IG1pbigzLCBtYXhfY2x1c3RlcnMpICAjIFVzZSBhIHJlYXNvbmFibGUgZGVmYXVsdCB2YWx1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcmVzID0gTm9uZQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICMgQ2F0Y2ggYWxsIGV4Y2VwdGlvbnMsIHVzZSBkZWZhdWx0IHZhbHVlCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkV4Y2VwdGlvbiBvY2N1cnJlZCB3aGVuIGRldGVybWluaW5nIG9wdGltYWwgbnVtYmVyIG9mIGNsdXN0ZXJzOiB7c3RyKGUpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlVzaW5nIGRlZmF1bHQgbnVtYmVyIG9mIGNsdXN0ZXJzIikKICAgICAgICAgICAgICAgICAgICBvcHRpbWFsX25fY2x1c3RlcnMgPSAzICAjIERlZmF1bHQgdG8gMyBjbHVzdGVycwogICAgICAgICAgICAgICAgICAgIHNjb3JlcyA9IE5vbmUKCiAgICAgICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIk9wdGltYWwgbnVtYmVyIG9mIGNsdXN0ZXJzOiB7b3B0aW1hbF9uX2NsdXN0ZXJzfSIpCgogICAgICAgICAgICAgICAgIyBQZXJmb3JtIHBvcHVsYXRpb24tbGV2ZWwgY2x1c3RlcmluZyB1c2luZyBvcHRpbWFsIG51bWJlciBvZiBjbHVzdGVycwogICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBlcmZvcm1pbmcgcG9wdWxhdGlvbi1sZXZlbCBjbHVzdGVyaW5nLi4uIikKCiAgICAgICAgICAgICMgUmVpbml0aWFsaXplIGNsdXN0ZXJpbmcgYWxnb3JpdGhtIHdpdGggb3B0aW1hbCBudW1iZXIgb2YgY2x1c3RlcnMKICAgICAgICAgICAgc2VsZi5zdXBlcnZveGVsMmhhYml0YXRfY2x1c3RlcmluZy5uX2NsdXN0ZXJzID0gb3B0aW1hbF9uX2NsdXN0ZXJzCiAgICAgICAgICAgIHNlbGYuc3VwZXJ2b3hlbDJoYWJpdGF0X2NsdXN0ZXJpbmcuZml0KGZlYXR1cmVzX29mX2FsbF9zdWJqZWN0cykKICAgICAgICAgICAgaGFiaXRhdF9sYWJlbHMgPSBzZWxmLnN1cGVydm94ZWwyaGFiaXRhdF9jbHVzdGVyaW5nLnByZWRpY3QoZmVhdHVyZXNfb2ZfYWxsX3N1YmplY3RzKSArIDEgICMgU3RhcnQgbnVtYmVyaW5nIGZyb20gMQoKICAgICAgICAgICAgIyBTYXZlIGNsdXN0ZXJpbmcgbW9kZWwgb2Ygc3VwZXJ2b3hlbCB0byBoYWJpdGF0CiAgICAgICAgICAgIG1vZGVsX3BhdGggPSBvcy5wYXRoLmpvaW4oc2VsZi5vdXRfZGlyLCAnc3VwZXJ2b3hlbDJoYWJpdGF0X2NsdXN0ZXJpbmdfbW9kZWwucGtsJykKICAgICAgICAgICAgd2l0aCBvcGVuKG1vZGVsX3BhdGgsICd3YicpIGFzIGY6CiAgICAgICAgICAgICAgICBwaWNrbGUuZHVtcChzZWxmLnN1cGVydm94ZWwyaGFiaXRhdF9jbHVzdGVyaW5nLCBmKQoKICAgICAgICBlbGlmIHNlbGYubW9kZSA9PSAndGVzdGluZyc6CiAgICAgICAgICAgICMgTG9hZCBjbHVzdGVyaW5nIG1vZGVsIGZyb20gY29uZmlnIGZpbGUKICAgICAgICAgICAgbW9kZWxfcGF0aCA9IG9zLnBhdGguam9pbihzZWxmLm91dF9kaXIsICdzdXBlcnZveGVsMmhhYml0YXRfY2x1c3RlcmluZ19tb2RlbC5wa2wnKQogICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhtb2RlbF9wYXRoKToKICAgICAgICAgICAgICAgIHdpdGggb3Blbihtb2RlbF9wYXRoLCAncmInKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc3VwZXJ2b3hlbDJoYWJpdGF0X2NsdXN0ZXJpbmcgPSBwaWNrbGUubG9hZChmKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIk5vIGNsdXN0ZXJpbmcgbW9kZWwgZm91bmQgYXQge21vZGVsX3BhdGh9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJQZXJmb3JtaW5nIHBvcHVsYXRpb24tbGV2ZWwgY2x1c3RlcmluZyB1c2luZyBhbHJlYWR5IHRyYWluZWQgbW9kZWx7bW9kZWxfcGF0aH0uLi4iKQoKICAgICAgICAgICAgIyBQZXJmb3JtIHBvcHVsYXRpb24tbGV2ZWwgY2x1c3RlcmluZyB1c2luZyBhbHJlYWR5IHRyYWluZWQgbW9kZWwKICAgICAgICAgICAgaGFiaXRhdF9sYWJlbHMgPSBzZWxmLnN1cGVydm94ZWwyaGFiaXRhdF9jbHVzdGVyaW5nLnByZWRpY3QoZmVhdHVyZXNfb2ZfYWxsX3N1YmplY3RzKSArIDEgICMgU3RhcnQgbnVtYmVyaW5nIGZyb20gMQoKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYiSW52YWxpZCBtb2RlOiB7c2VsZi5tb2RlfSIpCgogICAgICAgICMgQWRkIGhhYml0YXQgbGFiZWxzIHRvIHJlc3VsdHMKICAgICAgICBtZWFuX2ZlYXR1cmVzX2FsbFsnSGFiaXRhdHMnXSA9IGhhYml0YXRfbGFiZWxzCgogICAgICAgICMgQ3JlYXRlIHJlc3VsdHMgRGF0YUZyYW1lCiAgICAgICAgc2VsZi5yZXN1bHRzX2RmID0gbWVhbl9mZWF0dXJlc19hbGwuY29weSgpCgogICAgICAgICMgU2F2ZSByZXN1bHRzCiAgICAgICAgaWYgc2F2ZV9yZXN1bHRzX2NzdjoKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiU2F2aW5nIHJlc3VsdHMuLi4iKQoKICAgICAgICAgICAgIyDnoa7kv53nm67lvZXlrZjlnKgKICAgICAgICAgICAgb3MubWFrZWRpcnMoc2VsZi5vdXRfZGlyLCBleGlzdF9vaz1UcnVlKQoKICAgICAgICAgICAgIyDlpoLmnpzmnInljp/lp4vphY3nva7mlofku7bvvIzliJnnm7TmjqXlpI3liLbliLDovpPlh7rnm67lvZUKICAgICAgICAgICAgaWYgc2VsZi5jb25maWdfZmlsZSBhbmQgb3MucGF0aC5leGlzdHMoc2VsZi5jb25maWdfZmlsZSk6CiAgICAgICAgICAgICAgICBpbXBvcnQgc2h1dGlsCiAgICAgICAgICAgICAgICBjb25maWdfb3V0X3BhdGggPSBvcy5wYXRoLmpvaW4oc2VsZi5vdXRfZGlyLCAnY29uZmlnLnlhbWwnKQogICAgICAgICAgICAgICAgc2h1dGlsLmNvcHkyKHNlbGYuY29uZmlnX2ZpbGUsIGNvbmZpZ19vdXRfcGF0aCkKICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYi5Y6f5aeL6YWN572u5paH5Lu25bey5aSN5Yi25YiwOiB7Y29uZmlnX291dF9wYXRofSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIOayoeacieWOn+Wni+mFjee9ruaWh+S7tuaXtu+8jOS7jeeEtuS/neWtmOW9k+WJjemFjee9ruS4ukpTT04KICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLmnKrmj5Dkvpvljp/lp4vphY3nva7mlofku7bot6/lvoTvvIzlsIbku6VKU09O5qC85byP5L+d5a2Y5b2T5YmN6YWN572uIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDliJvlu7rljIXlkKvlvZPliY3liIbmnpDlj4LmlbDnmoTphY3nva7lrZflhbgKICAgICAgICAgICAgICAgIGNvbmZpZyA9IHsKICAgICAgICAgICAgICAgICAgICAnZGF0YV9kaXInOiBzZWxmLmRhdGFfZGlyLAogICAgICAgICAgICAgICAgICAgICdvdXRfZm9sZGVyJzogc2VsZi5vdXRfZGlyLAogICAgICAgICAgICAgICAgICAgICdmZWF0dXJlX2NvbmZpZyc6IHNlbGYuZmVhdHVyZV9jb25maWcsCiAgICAgICAgICAgICAgICAgICAgJ3N1cGVydm94ZWxfY2x1c3RlcmluZ19tZXRob2QnOiBzZWxmLnN1cGVydm94ZWxfbWV0aG9kLAogICAgICAgICAgICAgICAgICAgICdoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kJzogc2VsZi5oYWJpdGF0X21ldGhvZCwKICAgICAgICAgICAgICAgICAgICAnbW9kZSc6IHNlbGYubW9kZSwKICAgICAgICAgICAgICAgICAgICAnbl9jbHVzdGVyc19zdXBlcnZveGVsJzogc2VsZi5uX2NsdXN0ZXJzX3N1cGVydm94ZWwsCiAgICAgICAgICAgICAgICAgICAgJ25fY2x1c3RlcnNfaGFiaXRhdHNfbWF4Jzogc2VsZi5uX2NsdXN0ZXJzX2hhYml0YXRzX21heCwKICAgICAgICAgICAgICAgICAgICAnbl9jbHVzdGVyc19oYWJpdGF0c19taW4nOiBzZWxmLm5fY2x1c3RlcnNfaGFiaXRhdHNfbWluLAogICAgICAgICAgICAgICAgICAgICdoYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZCc6IHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QsCiAgICAgICAgICAgICAgICAgICAgJ2Jlc3Rfbl9jbHVzdGVycyc6IHNlbGYuYmVzdF9uX2NsdXN0ZXJzLAogICAgICAgICAgICAgICAgICAgICduX3Byb2Nlc3Nlcyc6IHNlbGYubl9wcm9jZXNzZXMsCiAgICAgICAgICAgICAgICAgICAgJ3JhbmRvbV9zdGF0ZSc6IHNlbGYucmFuZG9tX3N0YXRlLAogICAgICAgICAgICAgICAgICAgICd2ZXJib3NlJzogc2VsZi52ZXJib3NlLAogICAgICAgICAgICAgICAgICAgICdpbWFnZXNfZGlyJzogc2VsZi5pbWFnZXNfZGlyLAogICAgICAgICAgICAgICAgICAgICdtYXNrc19kaXInOiBzZWxmLm1hc2tzX2RpciwKICAgICAgICAgICAgICAgICAgICAncGxvdF9jdXJ2ZXMnOiBzZWxmLnBsb3RfY3VydmVzLAogICAgICAgICAgICAgICAgICAgICdzYXZlX2ludGVybWVkaWF0ZV9yZXN1bHRzJzogc2VsZi5zYXZlX2ludGVybWVkaWF0ZV9yZXN1bHRzLAogICAgICAgICAgICAgICAgICAgICdvcHRpbWFsX25fY2x1c3RlcnNfaGFiaXRhdCc6IGludChvcHRpbWFsX25fY2x1c3RlcnMpCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgIyDkv53lrZjphY3nva4KICAgICAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc2VsZi5vdXRfZGlyLCAnY29uZmlnLmpzb24nKSwgJ3cnKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGpzb24uZHVtcChjb25maWcsIGYsIGluZGVudD00KQoKICAgICAgICAgICAgIyBTYXZlIENTVgogICAgICAgICAgICBzZWxmLnJlc3VsdHNfZGYudG9fY3N2KG9zLnBhdGguam9pbihzZWxmLm91dF9kaXIsICdoYWJpdGF0cy5jc3YnKSwgaW5kZXg9RmFsc2UpCgogICAgICAgICAgICAjIFNhdmUgaGFiaXRhdCBpbWFnZXMgZm9yIGVhY2ggc3ViamVjdAogICAgICAgICAgICAjIFNldCBTdWJqZWN0IGFzIGluZGV4CiAgICAgICAgICAgIHNlbGYucmVzdWx0c19kZi5zZXRfaW5kZXgoJ1N1YmplY3QnLCBpbnBsYWNlPVRydWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIOWIm+W7uuWPguaVsOWIl+ihqAogICAgICAgICAgICBhcmdzX2xpc3QgPSBsaXN0KHNldChzZWxmLnJlc3VsdHNfZGYuaW5kZXgpKQoKICAgICAgICAgICAgIyDkvb/nlKjlpJrov5vnqIvkv53lrZjmiYDmnInkuLvkvZPnmoTmoJbmga/lnLDlm77lg48KICAgICAgICAgICAgd2l0aCBtdWx0aXByb2Nlc3NpbmcuUG9vbChwcm9jZXNzZXM9c2VsZi5uX3Byb2Nlc3NlcykgYXMgcG9vbDoKICAgICAgICAgICAgICAgICMg5L2/55SoaW1hcF91bm9yZGVyZWTlubbphY3lkIjoh6rlrprkuYnov5vluqbmnaHvvIzmt7vliqDlrrnplJnmnLrliLYKICAgICAgICAgICAgICAgIHByb2dyZXNzX2JhciA9IEN1c3RvbVRxZG0odG90YWw9bGVuKGFyZ3NfbGlzdCksIGRlc2M9IlNhdmUgaGFiaXRhdCBpbWFnZXMiKQogICAgICAgICAgICAgICAgZmFpbGVkX3N1YmplY3RzID0gW10KICAgICAgICAgICAgICAgIHJlc3VsdHNfaXRlciA9IHBvb2wuaW1hcF91bm9yZGVyZWQoc2VsZi5fc2F2ZV9oYWJpdGF0X2Zvcl9zdWJqZWN0LCBhcmdzX2xpc3QpCiAgICAgICAgICAgICAgICBmb3IgcmVzdWx0IGluIHJlc3VsdHNfaXRlcjoKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJlc3VsdFsxXSwgRXhjZXB0aW9uKToKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkX3N1YmplY3RzLmFwcGVuZChyZXN1bHRbMF0pCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiRXJyb3Igc2F2aW5nIGhhYml0YXQgaW1hZ2UgZm9yIHN1YmplY3Qge3Jlc3VsdFswXX06IHtzdHIocmVzdWx0WzFdKX0iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHByb2dyZXNzX2Jhci51cGRhdGUoMSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgZmFpbGVkX3N1YmplY3RzIGFuZCBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkZhaWxlZCB0byBzYXZlIGhhYml0YXQgaW1hZ2VzIGZvciB7bGVuKGZhaWxlZF9zdWJqZWN0cyl9IikKCiAgICAgICAgcmV0dXJuIHNlbGYucmVzdWx0c19kZgoKICAgIGRlZiBleHRyYWN0X3ZveGVsX2ZlYXR1cmVzKHNlbGYsIHN1YmplY3Q6IHN0cikgLT4gVHVwbGVbc3RyLCBwZC5EYXRhRnJhbWUsIHBkLkRhdGFGcmFtZSwgbnAubmRhcnJheSwgZGljdF06CiAgICAgICAgIiIiCiAgICAgICAgRXh0cmFjdCBmZWF0dXJlcyBmb3IgYSBzaW5nbGUgc3ViamVjdAoKICAgICAgICBBcmdzOgogICAgICAgICAgICBzdWJqZWN0IChzdHIpOiBTdWJqZWN0IElECgogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIFR1cGxlW3N0ciwgcGQuRGF0YUZyYW1lLCBwZC5EYXRhRnJhbWUsIG5wLm5kYXJyYXksIGRpY3RdOiBUdXBsZSBjb250YWluaW5nOgogICAgICAgICAgICAgICAgLSBzdWJqZWN0IElECiAgICAgICAgICAgICAgICAtIGZlYXR1cmUgZGF0YWZyYW1lCiAgICAgICAgICAgICAgICAtIG9yaWdpbmFsIGltYWdlIGRhdGFmcmFtZQogICAgICAgICAgICAgICAgLSBtYXNrIGFycmF5CiAgICAgICAgICAgICAgICAtIGRpY3Rpb25hcnkgd2l0aCBpbWFnZSBpbmZvcm1hdGlvbgogICAgICAgICIiIgogICAgICAgIAogICAgICAgICMgR2V0IGltYWdlIGFuZCBtYXNrIHBhdGhzCiAgICAgICAgaW1nX3BhdGhzID0gc2VsZi5pbWFnZXNfcGF0aHNbc3ViamVjdF0KICAgICAgICBtYXNrX3BhdGhzID0gc2VsZi5tYXNrX3BhdGhzW3N1YmplY3RdCgogICAgICAgICMg5YWI5aSE55CG5Y2V5Zu+5YOPCiAgICAgICAgcHJvY2Vzc2VkX2ltYWdlcyA9IFtdCiAgICAgICAgIyDpgY3ljoblpITnkIbmraXpqqTvvIzlpITnkIbmr4/kuKrljZXlm77lg48KICAgICAgICBmb3Igc3RlcCBpbiBzZWxmLnZveGVsX3Byb2Nlc3Npbmdfc3RlcHM6CiAgICAgICAgICAgIG1ldGhvZCA9IHN0ZXBbJ21ldGhvZCddCiAgICAgICAgICAgIGltZ19uYW1lID0gc3RlcFsnaW1hZ2UnXQogICAgICAgICAgICBzdGVwX3BhcmFtcyA9IHN0ZXBbJ3BhcmFtcyddLmNvcHkoKSAgIyDlpI3liLblj4LmlbDvvIzpgb/lhY3kv67mlLnljp/lp4vlj4LmlbAKCiAgICAgICAgICAgICMg5qOA5p+lc3RlcF9wYXJhbXPmmK/lkKbkuLrnqboKICAgICAgICAgICAgaWYgc3RlcF9wYXJhbXM6CiAgICAgICAgICAgICAgICAjIOWkhOeQhuWPguaVsO+8jOWwhuWPguaVsOWQjeabv+aNouS4uuWunumZheWAvAogICAgICAgICAgICAgICAgZm9yIHBhcmFtX25hbWUsIHBhcmFtX3ZhbHVlIGluIGxpc3Qoc3RlcF9wYXJhbXMuaXRlbXMoKSk6CiAgICAgICAgICAgICAgICAgICAgIyDmo4Dmn6V2b3hlbF9sZXZlbC5wYXJhbXPkuK3nmoTlj4LmlbAKICAgICAgICAgICAgICAgICAgICB2b3hlbF9wYXJhbXMgPSBzZWxmLmZlYXR1cmVfY29uZmlnWyd2b3hlbF9sZXZlbCddLmdldCgncGFyYW1zJywge30pCiAgICAgICAgICAgICAgICAgICAgaWYgcGFyYW1fdmFsdWUgPT0gcGFyYW1fbmFtZSBhbmQgcGFyYW1fbmFtZSBpbiB2b3hlbF9wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXBfcGFyYW1zW3BhcmFtX25hbWVdID0gdm94ZWxfcGFyYW1zW3BhcmFtX25hbWVdCiAgICAgICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKHBhcmFtX3ZhbHVlLCBzdHIpIGFuZCBwYXJhbV92YWx1ZSBpbiB2b3hlbF9wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ZXBfcGFyYW1zW3BhcmFtX25hbWVdID0gdm94ZWxfcGFyYW1zW3BhcmFtX3ZhbHVlXQoKICAgICAgICAgICAgIyDmjInpnIDliJvlu7rljZXlm77lg4/nibnlvoHmj5Dlj5blmajlubblpITnkIblm77lg48KICAgICAgICAgICAgc3RlcF9wYXJhbXMudXBkYXRlKHsnc3ViamVjdCc6IHN1YmplY3QsICdpbWFnZSc6IGltZ19uYW1lfSkKICAgICAgICAgICAgZXh0cmFjdG9yID0gY3JlYXRlX2ZlYXR1cmVfZXh0cmFjdG9yKG1ldGhvZCwgKipzdGVwX3BhcmFtcykKICAgICAgICAgICAgcHJvY2Vzc2VkX2RmID0gZXh0cmFjdG9yLmV4dHJhY3RfZmVhdHVyZXMoaW1nX3BhdGhzLmdldChpbWdfbmFtZSksIG1hc2tfcGF0aHMuZ2V0KGltZ19uYW1lKSwgKipzdGVwX3BhcmFtcykKICAgICAgICAgICAgcHJvY2Vzc2VkX2ltYWdlcy5hcHBlbmQocHJvY2Vzc2VkX2RmKQoKICAgICAgICAjIOaMiemcgOWIm+W7uui3qOWbvuWDj+eJueW+geaPkOWPluWZqAogICAgICAgIGNyb3NzX2ltYWdlX2t3YXJncyA9IHNlbGYuY3Jvc3NfaW1hZ2Vfa3dhcmdzLmNvcHkoKQogICAgICAgIGNyb3NzX2ltYWdlX2t3YXJncy51cGRhdGUoeydzdWJqZWN0Jzogc3ViamVjdH0pCiAgICAgICAgY3Jvc3NfaW1hZ2VfZXh0cmFjdG9yID0gY3JlYXRlX2ZlYXR1cmVfZXh0cmFjdG9yKHNlbGYudm94ZWxfbWV0aG9kLCAqKmNyb3NzX2ltYWdlX2t3YXJncykKICAgICAgICBmZWF0dXJlcyA9IGNyb3NzX2ltYWdlX2V4dHJhY3Rvci5leHRyYWN0X2ZlYXR1cmVzKHByb2Nlc3NlZF9pbWFnZXMsICoqY3Jvc3NfaW1hZ2Vfa3dhcmdzKQoKICAgICAgICAjIGdldCByYXcgZGF0YSAtIOWcqOi/nuaOpeWJjemHjeWRveWQjeWIlwogICAgICAgIHJhd19kZiA9IHBkLmNvbmNhdChwcm9jZXNzZWRfaW1hZ2VzLCBheGlzPTEpCgogICAgICAgICMgU2F2ZSBtYXNrIGluZm9ybWF0aW9uIGZvciBsYXRlciBpbWFnZSByZWNvbnN0cnVjdGlvbgogICAgICAgIG1hc2sgPSBzZWxmLm1hc2tfcGF0aHNbc3ViamVjdF0KICAgICAgICBtYXNrID0gbGlzdChtYXNrLnZhbHVlcygpKVswXQogICAgICAgIG1hc2tfaW1nID0gc2l0ay5SZWFkSW1hZ2UobWFzaykKICAgICAgICBtYXNrX2FycmF5ID0gc2l0ay5HZXRBcnJheUZyb21JbWFnZShtYXNrX2ltZykKICAgICAgICBtYXNrX2luZm8gPSB7CiAgICAgICAgICAgICdtYXNrJzogbWFza19pbWcsCiAgICAgICAgICAgICdtYXNrX2FycmF5JzogbWFza19hcnJheQogICAgICAgIH0KCiAgICAgICAgIyBDbGVhbiB1cCBtZW1vcnkKICAgICAgICBkZWwgcHJvY2Vzc2VkX2ltYWdlcywgbWFza19pbWcsIG1hc2tfYXJyYXkKCiAgICAgICAgcmV0dXJuIHN1YmplY3QsIGZlYXR1cmVzLCByYXdfZGYsIG1hc2tfaW5mbwoKICAgIGRlZiBleHRyYWN0X3N1cGVydm94ZWxfZmVhdHVyZXMoc2VsZiwgc3ViamVjdDogc3RyKSAtPiBUdXBsZVtzdHIsIG5wLm5kYXJyYXldOgogICAgICAgICIiIgogICAgICAgIEV4dHJhY3Qgc3VwZXJ2b3hlbC1sZXZlbCBmZWF0dXJlcyBmcm9tIHN1cGVydm94ZWwgbWFwcyBhbmQgb3JpZ2luYWwgaW1hZ2VzCgogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIG5wLm5kYXJyYXk6IFN1cGVydm94ZWwgZmVhdHVyZXMgZm9yIGNsdXN0ZXJpbmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgbG9nIGFuZCBwcmludAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiRXh0cmFjdGluZyBzdXBlcnZveGVsLWxldmVsIGZlYXR1cmVzIGZvciBzdWJqZWN0IHtzdWJqZWN0fS4uLiIpCiAgICAgICAgICAgIHByaW50KGYiRXh0cmFjdGluZyBzdXBlcnZveGVsLWxldmVsIGZlYXR1cmVzIGZvciBzdWJqZWN0IHtzdWJqZWN0fS4uLiIpCgogICAgICAgICAgICAjIEdldCBpbWFnZSBhbmQgbWFzayBwYXRocwogICAgICAgICAgICBpbWdfcGF0aHMgPSBzZWxmLmltYWdlc19wYXRoc1tzdWJqZWN0XQogICAgICAgICAgICBtYXNrX3BhdGggPSBzZWxmLnN1cGVydm94ZWxfZmlsZV9kaWN0W3N1YmplY3RdCgogICAgICAgICAgICAjIOiOt+WPlm91dGRpcuS4reeahOaJgOaciXN1cGVydm94ZWzmlofku7YKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiRXh0cmFjdGluZyBzdXBlcnZveGVsLWxldmVsIGZlYXR1cmVzLi4uIikKCiAgICAgICAgICAgICMg5YWI5aSE55CG5Y2V5Zu+5YOPCiAgICAgICAgICAgIHByb2Nlc3NlZF9pbWFnZXMgPSBbXQogICAgICAgICAgICAjIOmBjeWOhuWkhOeQhuatpemqpO+8jOWkhOeQhuavj+S4quWNleWbvuWDjwogICAgICAgICAgICBmb3Igc3RlcCBpbiBzZWxmLnN1cGVydm94ZWxfcHJvY2Vzc2luZ19zdGVwczoKICAgICAgICAgICAgICAgIG1ldGhvZCA9IHN0ZXBbJ21ldGhvZCddCiAgICAgICAgICAgICAgICBpbWdfbmFtZSA9IHN0ZXBbJ2ltYWdlJ10KICAgICAgICAgICAgICAgIHN0ZXBfcGFyYW1zID0gc3RlcFsncGFyYW1zJ10uY29weSgpICAjIOWkjeWItuWPguaVsO+8jOmBv+WFjeS/ruaUueWOn+Wni+WPguaVsAoKICAgICAgICAgICAgICAgICMg5L2/55So5Y2V5Zu+5YOP54m55b6B5o+Q5Y+W5Zmo5aSE55CG5Zu+5YOPCiAgICAgICAgICAgICAgICBzdGVwX3BhcmFtcy51cGRhdGUoeydzdWJqZWN0Jzogc3ViamVjdCwgJ2ltYWdlJzogaW1nX25hbWV9KQogICAgICAgICAgICAgICAgIyDmjInpnIDliJvlu7rljZXlm77lg4/nibnlvoHmj5Dlj5blmagKICAgICAgICAgICAgICAgIHNpbmdsZV9pbWFnZV9leHRyYWN0b3IgPSBjcmVhdGVfZmVhdHVyZV9leHRyYWN0b3IobWV0aG9kLCAqKnN0ZXBfcGFyYW1zKQogICAgICAgICAgICAgICAgcHJvY2Vzc2VkX2RmID0gc2luZ2xlX2ltYWdlX2V4dHJhY3Rvci5leHRyYWN0X2ZlYXR1cmVzKGltZ19wYXRocy5nZXQoaW1nX25hbWUpLCBtYXNrX3BhdGgsICoqc3RlcF9wYXJhbXMpCiAgICAgICAgICAgICAgICBwcm9jZXNzZWRfaW1hZ2VzLmFwcGVuZChwcm9jZXNzZWRfZGYpCgogICAgICAgICAgICAjIOaMiemcgOWIm+W7uui3qOWbvuWDj+eJueW+geaPkOWPluWZqAogICAgICAgICAgICBzdXBlcnZveGVsX3BhcmFtcyA9IHNlbGYuc3VwZXJ2b3hlbF9wYXJhbXMuY29weSgpCiAgICAgICAgICAgIGNyb3NzX2ltYWdlX2V4dHJhY3RvciA9IGNyZWF0ZV9mZWF0dXJlX2V4dHJhY3RvcihzZWxmLnN1cGVydm94ZWxfbWV0aG9kX25hbWUsICoqc3VwZXJ2b3hlbF9wYXJhbXMpCiAgICAgICAgICAgIGZlYXR1cmVzID0gY3Jvc3NfaW1hZ2VfZXh0cmFjdG9yLmV4dHJhY3RfZmVhdHVyZXMocHJvY2Vzc2VkX2ltYWdlcywgKipzdXBlcnZveGVsX3BhcmFtcykKCiAgICAgICAgICAgIHJldHVybiBzdWJqZWN0LCBmZWF0dXJlcwogICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuIHN1YmplY3QsIEV4Y2VwdGlvbihzdHIoZSkpCgogICAgZGVmIF9zYXZlX2hhYml0YXRfZm9yX3N1YmplY3Qoc2VsZiwgc3ViamVjdCk6CiAgICAgICAgIiIiCiAgICAgICAg5L+d5a2Y5Y2V5Liq5Li75L2T55qE5qCW5oGv5Zyw5Zu+5YOPCgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFyZ3MgKHR1cGxlKTog5YyF5ZCr5Li75L2T57Si5byV5ZKM5ZCN56ew55qE5YWD57uEIChpLCBzdWJqZWN0KQoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IOS4u+S9k+e0ouW8lQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc3VwZXJ2b3hlbF9wYXRoID0gb3MucGF0aC5qb2luKHNlbGYub3V0X2RpciwgZiJ7c3ViamVjdH1fc3VwZXJ2b3hlbC5ucnJkIikKICAgICAgICAgICAgc2F2ZV9oYWJpdGF0X2ltYWdlKHN1YmplY3QsIHNlbGYucmVzdWx0c19kZiwgc3VwZXJ2b3hlbF9wYXRoLCBzZWxmLm91dF9kaXIpCiAgICAgICAgICAgIHJldHVybiBzdWJqZWN0LCBOb25lCiAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4gc3ViamVjdCwgRXhjZXB0aW9uKHN0cihlKSkKCgoK').decode())
