
import base64
exec(base64.b64decode(b'IiIiCkhhYml0YXQgQ2x1c3RlcmluZyBBbmFseXNpcyBNb2R1bGUKIiIiCgppbXBvcnQgb3MKaW1wb3J0IGpzb24KaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IFNpbXBsZUlUSyBhcyBzaXRrCmltcG9ydCB3YXJuaW5ncwppbXBvcnQgbXVsdGlwcm9jZXNzaW5nCmltcG9ydCBtYXRwbG90bGliLnB5cGxvdCBhcyBwbHQKZnJvbSBnbG9iIGltcG9ydCBnbG9iCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBMaXN0LCBBbnksIFR1cGxlLCBPcHRpb25hbCwgVW5pb24sIENhbGxhYmxlCgpmcm9tIGhhYml0LnV0aWxzLmlvX3V0aWxzIGltcG9ydCAoZ2V0X2ltYWdlX2FuZF9tYXNrX3BhdGhzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV0ZWN0X2ltYWdlX25hbWVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tfZGF0YV9zdHJ1Y3R1cmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzYXZlX2hhYml0YXRfaW1hZ2UpCgpmcm9tIGhhYml0LnV0aWxzLnZpc3VhbGl6YXRpb24gaW1wb3J0IHBsb3RfY2x1c3Rlcl9zY29yZXMKZnJvbSBoYWJpdC51dGlscy5sb2dfdXRpbHMgaW1wb3J0IGdldF9sb2dnZXIKCmZyb20gaGFiaXQuY29yZS5oYWJpdGF0X2FuYWx5c2lzLmNsdXN0ZXJpbmcuYmFzZV9jbHVzdGVyaW5nIGltcG9ydCBnZXRfY2x1c3RlcmluZ19hbGdvcml0aG0KZnJvbSBoYWJpdC5jb3JlLmhhYml0YXRfYW5hbHlzaXMuY2x1c3RlcmluZy5jbHVzdGVyX3ZhbGlkYXRpb25fbWV0aG9kcyBpbXBvcnQgKAogICAgZ2V0X3ZhbGlkYXRpb25fbWV0aG9kcywKICAgIGlzX3ZhbGlkX21ldGhvZF9mb3JfYWxnb3JpdGhtLAogICAgZ2V0X2RlZmF1bHRfbWV0aG9kcwopCmZyb20gaGFiaXQuY29yZS5oYWJpdGF0X2FuYWx5c2lzLmZlYXR1cmVzLmZlYXR1cmVfcHJlcHJvY2Vzc2luZyBpbXBvcnQgcHJlcHJvY2Vzc19mZWF0dXJlcwpmcm9tIC5mZWF0dXJlcy5mZWF0dXJlX2V4dHJhY3Rvcl9mYWN0b3J5IGltcG9ydCBjcmVhdGVfZmVhdHVyZV9leHRyYWN0b3IKIyBJZ25vcmUgd2FybmluZ3MKd2FybmluZ3Muc2ltcGxlZmlsdGVyKCdpZ25vcmUnKQoKIyBJbXBvcnQgcHJvZ3Jlc3MgdXRpbGl0aWVzCmZyb20gaGFiaXQudXRpbHMucHJvZ3Jlc3NfdXRpbHMgaW1wb3J0IEN1c3RvbVRxZG0KCgpjbGFzcyBIYWJpdGF0QW5hbHlzaXM6CiAgICAiIiIKICAgIEhhYml0YXQgQW5hbHlzaXMgY2xhc3MgZm9yIHBlcmZvcm1pbmcgdHdvLXN0ZXAgY2x1c3RlcmluZyBhbmFseXNpczoKICAgIDEuIEluZGl2aWR1YWwtbGV2ZWwgY2x1c3RlcmluZzogRGl2aWRlIGVhY2ggdHVtb3IgaW50byBzdXBlcnZveGVscwogICAgMi4gUG9wdWxhdGlvbi1sZXZlbCBjbHVzdGVyaW5nOiBDbHVzdGVyIHRoZSBhdmVyYWdlIHZhbHVlcyBvZiBhbGwgc2FtcGxlIHN1cGVydm94ZWxzIHRvIG9idGFpbiBoYWJpdGF0cwogICAgIiIiCgogICAgZGVmIF9faW5pdF9fKHNlbGYsCiAgICAgICAgICAgICAgICAgcm9vdF9mb2xkZXI6IHN0ciwKICAgICAgICAgICAgICAgICBvdXRfZm9sZGVyOiBPcHRpb25hbFtzdHJdID0gTm9uZSwKICAgICAgICAgICAgICAgICBmZWF0dXJlX2NvbmZpZzogT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dID0gTm9uZSwKICAgICAgICAgICAgICAgICBzdXBlcnZveGVsX2NsdXN0ZXJpbmdfbWV0aG9kOiBzdHIgPSAia21lYW5zIiwKICAgICAgICAgICAgICAgICBoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kOiBzdHIgPSAia21lYW5zIiwKICAgICAgICAgICAgICAgICBuX2NsdXN0ZXJzX3N1cGVydm94ZWw6IGludCA9IDUwLAogICAgICAgICAgICAgICAgIG5fY2x1c3RlcnNfaGFiaXRhdHNfbWF4OiBpbnQgPSAxMCwKICAgICAgICAgICAgICAgICBuX2NsdXN0ZXJzX2hhYml0YXRzX21pbjogaW50ID0gMiwKICAgICAgICAgICAgICAgICBoYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZDogT3B0aW9uYWxbVW5pb25bc3RyLCBMaXN0W3N0cl1dXSA9IE5vbmUsCiAgICAgICAgICAgICAgICAgYmVzdF9uX2NsdXN0ZXJzOiBPcHRpb25hbFtpbnRdID0gTm9uZSwKICAgICAgICAgICAgICAgICBuX3Byb2Nlc3NlczogaW50ID0gMSwKICAgICAgICAgICAgICAgICByYW5kb21fc3RhdGU6IGludCA9IDQyLAogICAgICAgICAgICAgICAgIHZlcmJvc2U6IGJvb2wgPSBUcnVlLAogICAgICAgICAgICAgICAgIGltYWdlc19kaXI6IHN0ciA9ICJpbWFnZXMiLAogICAgICAgICAgICAgICAgIG1hc2tzX2Rpcjogc3RyID0gIm1hc2tzIiwKICAgICAgICAgICAgICAgICBwbG90X2N1cnZlczogYm9vbCA9IFRydWUsCiAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NfY2FsbGJhY2s6IE9wdGlvbmFsW0NhbGxhYmxlXSA9IE5vbmUsCiAgICAgICAgICAgICAgICAgc2F2ZV9pbnRlcm1lZGlhdGVfcmVzdWx0czogYm9vbCA9IEZhbHNlLAogICAgICAgICAgICAgICAgIGNvbmZpZ19maWxlOiBPcHRpb25hbFtzdHJdID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgSW5pdGlhbGl6ZSBIYWJpdGF0QW5hbHlzaXMgY2xhc3MKCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcm9vdF9mb2xkZXIgKHN0cik6IFJvb3QgZGlyZWN0b3J5IG9mIGRhdGEKICAgICAgICAgICAgb3V0X2ZvbGRlciAoc3RyLCBvcHRpb25hbCk6IE91dHB1dCBkaXJlY3RvcnkKICAgICAgICAgICAgZmVhdHVyZV9jb25maWcgKGRpY3QsIG9wdGlvbmFsKTogQ29tcGxldGUgZmVhdHVyZSBjb25maWd1cmF0aW9uIGRpY3Rpb25hcnkgdGhhdCBpbmNsdWRlczoKICAgICAgICAgICAgICAgIC0gaW1hZ2VfbmFtZXMgKGxpc3QpOiBMaXN0IG9mIGltYWdlIG5hbWVzLCBlLmcuIFsncHJlX2NvbnRyYXN0JywgJ0xBUCcsICdQVlAnXQogICAgICAgICAgICAgICAgLSBleHRyYWN0b3IgKHN0ciBvciBkaWN0KTogRmVhdHVyZSBleHRyYWN0b3IgbmFtZSBvciBjb25maWd1cmF0aW9uCiAgICAgICAgICAgICAgICAtIHBhcmFtcyAoZGljdCk6IEZlYXR1cmUgZXh0cmFjdG9yIHBhcmFtZXRlcnMsIHVzZWQgd2hlbiBleHRyYWN0b3IgaXMgYSBzdHJpbmcKICAgICAgICAgICAgICAgIC0gcHJlcHJvY2Vzc2luZyAoZGljdCk6IEZlYXR1cmUgcHJlcHJvY2Vzc2luZyBwYXJhbWV0ZXJzCiAgICAgICAgICAgIHN1cGVydm94ZWxfY2x1c3RlcmluZ19tZXRob2QgKHN0ciwgb3B0aW9uYWwpOiBTdXBlcnZveGVsIGNsdXN0ZXJpbmcgbWV0aG9kLCBkZWZhdWx0IGlzIGttZWFucwogICAgICAgICAgICBoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kIChzdHIsIG9wdGlvbmFsKTogSGFiaXRhdCBjbHVzdGVyaW5nIG1ldGhvZCwgZGVmYXVsdCBpcyBrbWVhbnMKICAgICAgICAgICAgbl9jbHVzdGVyc19zdXBlcnZveGVsIChpbnQsIG9wdGlvbmFsKTogTnVtYmVyIG9mIHN1cGVydm94ZWwgY2x1c3RlcnMsIGRlZmF1bHQgaXMgNTAKICAgICAgICAgICAgbl9jbHVzdGVyc19oYWJpdGF0c19tYXggKGludCwgb3B0aW9uYWwpOiBNYXhpbXVtIG51bWJlciBvZiBoYWJpdGF0IGNsdXN0ZXJzLCBkZWZhdWx0IGlzIDEwCiAgICAgICAgICAgIG5fY2x1c3RlcnNfaGFiaXRhdHNfbWluIChpbnQsIG9wdGlvbmFsKTogTWluaW11bSBudW1iZXIgb2YgaGFiaXRhdCBjbHVzdGVycywgZGVmYXVsdCBpcyAyCiAgICAgICAgICAgIGhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kIChzdHIsIG9wdGlvbmFsKTogTWV0aG9kIGZvciBzZWxlY3RpbmcgbnVtYmVyIG9mIGhhYml0YXQgY2x1c3RlcnMKICAgICAgICAgICAgYmVzdF9uX2NsdXN0ZXJzIChpbnQsIG9wdGlvbmFsKTogRGlyZWN0bHkgc3BlY2lmeSB0aGUgYmVzdCBudW1iZXIgb2YgY2x1c3RlcnMKICAgICAgICAgICAgbl9wcm9jZXNzZXMgKGludCwgb3B0aW9uYWwpOiBOdW1iZXIgb2YgcGFyYWxsZWwgcHJvY2Vzc2VzLCBkZWZhdWx0IGlzIDEKICAgICAgICAgICAgcmFuZG9tX3N0YXRlIChpbnQsIG9wdGlvbmFsKTogUmFuZG9tIHNlZWQsIGRlZmF1bHQgaXMgNDIKICAgICAgICAgICAgdmVyYm9zZSAoYm9vbCwgb3B0aW9uYWwpOiBXaGV0aGVyIHRvIG91dHB1dCBkZXRhaWxlZCBpbmZvcm1hdGlvbiwgZGVmYXVsdCBpcyBUcnVlCiAgICAgICAgICAgIGltYWdlc19kaXIgKHN0ciwgb3B0aW9uYWwpOiBJbWFnZSBkaXJlY3RvcnkgbmFtZSwgZGVmYXVsdCBpcyBpbWFnZXMKICAgICAgICAgICAgbWFza3NfZGlyIChzdHIsIG9wdGlvbmFsKTogTWFzayBkaXJlY3RvcnkgbmFtZSwgZGVmYXVsdCBpcyBtYXNrcwogICAgICAgICAgICBwbG90X2N1cnZlcyAoYm9vbCwgb3B0aW9uYWwpOiBXaGV0aGVyIHRvIHBsb3QgZXZhbHVhdGlvbiBjdXJ2ZXMsIGRlZmF1bHQgaXMgVHJ1ZQogICAgICAgICAgICBwcm9ncmVzc19jYWxsYmFjayAoY2FsbGFibGUsIG9wdGlvbmFsKTogUHJvZ3Jlc3MgY2FsbGJhY2sgZnVuY3Rpb24KICAgICAgICAgICAgc2F2ZV9pbnRlcm1lZGlhdGVfcmVzdWx0cyAoYm9vbCwgb3B0aW9uYWwpOiBXaGV0aGVyIHRvIHNhdmUgaW50ZXJtZWRpYXRlIHJlc3VsdHMsIGRlZmF1bHQgaXMgRmFsc2UKICAgICAgICAgICAgY29uZmlnX2ZpbGUgKHN0ciwgb3B0aW9uYWwpOiBQYXRoIHRvIHRoZSBvcmlnaW5hbCBjb25maWd1cmF0aW9uIGZpbGUKICAgICAgICAiIiIKICAgICAgICAjIEJhc2ljIHBhcmFtZXRlcnMKICAgICAgICBzZWxmLmRhdGFfZGlyID0gb3MucGF0aC5hYnNwYXRoKHJvb3RfZm9sZGVyKQogICAgICAgIHNlbGYub3V0X2RpciA9IG9zLnBhdGguYWJzcGF0aChvdXRfZm9sZGVyIG9yIG9zLnBhdGguam9pbihzZWxmLmRhdGFfZGlyLCAiaGFiaXRhdHNfb3V0cHV0IikpCiAgICAgICAgc2VsZi5jb25maWdfZmlsZSA9IGNvbmZpZ19maWxlICAjIOS/neWtmOWOn+Wni+mFjee9ruaWh+S7tui3r+W+hAoKICAgICAgICAjIEluaXRpYWxpemUgbG9nZ2VyCiAgICAgICAgc2VsZi5sb2dnZXIgPSBnZXRfbG9nZ2VyKHNlbGYub3V0X2RpciwgIkhhYml0YXRBbmFseXNpcyIpCgogICAgICAgICMgQ2x1c3RlcmluZyBwYXJhbWV0ZXJzCiAgICAgICAgc2VsZi5zdXBlcnZveGVsX21ldGhvZCA9IHN1cGVydm94ZWxfY2x1c3RlcmluZ19tZXRob2QKICAgICAgICBzZWxmLmhhYml0YXRfbWV0aG9kID0gaGFiaXRhdF9jbHVzdGVyaW5nX21ldGhvZAogICAgICAgIHNlbGYubl9jbHVzdGVyc19zdXBlcnZveGVsID0gbl9jbHVzdGVyc19zdXBlcnZveGVsCiAgICAgICAgc2VsZi5uX2NsdXN0ZXJzX2hhYml0YXRzX21heCA9IG5fY2x1c3RlcnNfaGFiaXRhdHNfbWF4CiAgICAgICAgc2VsZi5uX2NsdXN0ZXJzX2hhYml0YXRzX21pbiA9IG5fY2x1c3RlcnNfaGFiaXRhdHNfbWluCgogICAgICAgIHNlbGYudmVyYm9zZSA9IHZlcmJvc2UKCiAgICAgICAgIyBHZXQgdmFsaWRhdGlvbiBtZXRob2RzIHN1cHBvcnRlZCBieSB0aGUgY2x1c3RlcmluZyBtZXRob2QgdXNpbmcgY2x1c3Rlcl92YWxpZGF0aW9uX21ldGhvZHMgbW9kdWxlCiAgICAgICAgdmFsaWRhdGlvbl9pbmZvID0gZ2V0X3ZhbGlkYXRpb25fbWV0aG9kcyhoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kKQogICAgICAgIHZhbGlkX3NlbGVjdGlvbl9tZXRob2RzID0gbGlzdCh2YWxpZGF0aW9uX2luZm9bJ21ldGhvZHMnXS5rZXlzKCkpCiAgICAgICAgZGVmYXVsdF9tZXRob2RzID0gZ2V0X2RlZmF1bHRfbWV0aG9kcyhoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kKQoKICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJWYWxpZGF0aW9uIG1ldGhvZHMgc3VwcG9ydGVkIGJ5IGNsdXN0ZXJpbmcgbWV0aG9kICd7aGFiaXRhdF9jbHVzdGVyaW5nX21ldGhvZH0nOiB7JywgJy5qb2luKHZhbGlkX3NlbGVjdGlvbl9tZXRob2RzKX0iKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiRGVmYXVsdCB2YWxpZGF0aW9uIG1ldGhvZHM6IHsnLCAnLmpvaW4oZGVmYXVsdF9tZXRob2RzKX0iKQoKICAgICAgICAjIENoZWNrIHZhbGlkaXR5IG9mIGhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kIHBhcmFtZXRlcgogICAgICAgIGlmIGhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kIGlzIE5vbmU6CiAgICAgICAgICAgICMgVXNlIGRlZmF1bHQgbWV0aG9kcwogICAgICAgICAgICBzZWxmLmhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kID0gZGVmYXVsdF9tZXRob2RzCiAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJObyBjbHVzdGVyaW5nIGV2YWx1YXRpb24gbWV0aG9kIHNwZWNpZmllZCwgdXNpbmcgZGVmYXVsdCBtZXRob2RzOiB7JywgJy5qb2luKGRlZmF1bHRfbWV0aG9kcyl9IikKICAgICAgICBlbGlmIGlzaW5zdGFuY2UoaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QsIHN0cik6CiAgICAgICAgICAgICMgQ2hlY2sgaWYgc2luZ2xlIG1ldGhvZCBpcyB2YWxpZAogICAgICAgICAgICBpZiBpc192YWxpZF9tZXRob2RfZm9yX2FsZ29yaXRobShoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kLCBoYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZC5sb3dlcigpKToKICAgICAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSBoYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZC5sb3dlcigpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIElmIHNwZWNpZmllZCBtZXRob2QgaXMgaW52YWxpZCBmb3IgY3VycmVudCBjbHVzdGVyaW5nIGFsZ29yaXRobSwgdXNlIGRlZmF1bHQgbWV0aG9kcwogICAgICAgICAgICAgICAgb3JpZ2luYWxfbWV0aG9kID0gaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QKICAgICAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSBkZWZhdWx0X21ldGhvZHMKICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiVmFsaWRhdGlvbiBtZXRob2QgJ3tvcmlnaW5hbF9tZXRob2R9JyBpcyBpbnZhbGlkIGZvciBjbHVzdGVyaW5nIG1ldGhvZCAne2hhYml0YXRfY2x1c3RlcmluZ19tZXRob2R9JyIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkF2YWlsYWJsZSB2YWxpZGF0aW9uIG1ldGhvZHM6IHsnLCAnLmpvaW4odmFsaWRfc2VsZWN0aW9uX21ldGhvZHMpfSIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlVzaW5nIGRlZmF1bHQgbWV0aG9kczogeycsICcuam9pbihkZWZhdWx0X21ldGhvZHMpfSIpCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGhhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kLCBsaXN0KToKICAgICAgICAgICAgIyBDaGVjayBpZiBtdWx0aXBsZSBtZXRob2RzIGFyZSB2YWxpZAogICAgICAgICAgICB2YWxpZF9tZXRob2RzID0gW10KICAgICAgICAgICAgaW52YWxpZF9tZXRob2RzID0gW10KCiAgICAgICAgICAgIGZvciBtZXRob2QgaW4gaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2Q6CiAgICAgICAgICAgICAgICBpZiBpc192YWxpZF9tZXRob2RfZm9yX2FsZ29yaXRobShoYWJpdGF0X2NsdXN0ZXJpbmdfbWV0aG9kLCBtZXRob2QubG93ZXIoKSk6CiAgICAgICAgICAgICAgICAgICAgdmFsaWRfbWV0aG9kcy5hcHBlbmQobWV0aG9kLmxvd2VyKCkpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGludmFsaWRfbWV0aG9kcy5hcHBlbmQobWV0aG9kKQoKICAgICAgICAgICAgaWYgdmFsaWRfbWV0aG9kczoKICAgICAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSB2YWxpZF9tZXRob2RzCiAgICAgICAgICAgICAgICBpZiBpbnZhbGlkX21ldGhvZHMgYW5kIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiVGhlIGZvbGxvd2luZyB2YWxpZGF0aW9uIG1ldGhvZHMgYXJlIGludmFsaWQgZm9yIGNsdXN0ZXJpbmcgbWV0aG9kICd7aGFiaXRhdF9jbHVzdGVyaW5nX21ldGhvZH0nOiB7JywgJy5qb2luKGludmFsaWRfbWV0aG9kcyl9IikKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiT25seSB1c2luZyB2YWxpZCBtZXRob2RzOiB7JywgJy5qb2luKHZhbGlkX21ldGhvZHMpfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIElmIG5vIHZhbGlkIG1ldGhvZHMsIHVzZSBkZWZhdWx0IG1ldGhvZHMKICAgICAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSBkZWZhdWx0X21ldGhvZHMKICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiQWxsIHNwZWNpZmllZCB2YWxpZGF0aW9uIG1ldGhvZHMgYXJlIGludmFsaWQgZm9yIGNsdXN0ZXJpbmcgbWV0aG9kICd7aGFiaXRhdF9jbHVzdGVyaW5nX21ldGhvZH0nIikKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQXZhaWxhYmxlIHZhbGlkYXRpb24gbWV0aG9kczogeycsICcuam9pbih2YWxpZF9zZWxlY3Rpb25fbWV0aG9kcyl9IikKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVXNpbmcgZGVmYXVsdCBtZXRob2RzOiB7JywgJy5qb2luKGRlZmF1bHRfbWV0aG9kcyl9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIFBhcmFtZXRlciB0eXBlIGVycm9yLCB1c2UgZGVmYXVsdCBtZXRob2RzCiAgICAgICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QgPSBkZWZhdWx0X21ldGhvZHMKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiQ2x1c3RlcmluZyBldmFsdWF0aW9uIG1ldGhvZCBwYXJhbWV0ZXIgdHlwZSBlcnJvciwgc2hvdWxkIGJlIHN0cmluZyBvciBsaXN0IikKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJVc2luZyBkZWZhdWx0IG1ldGhvZHM6IHsnLCAnLmpvaW4oZGVmYXVsdF9tZXRob2RzKX0iKQoKCiAgICAgICAgIyBQYXJhbWV0ZXJzCiAgICAgICAgc2VsZi5iZXN0X25fY2x1c3RlcnMgPSBiZXN0X25fY2x1c3RlcnMKICAgICAgICBzZWxmLnJhbmRvbV9zdGF0ZSA9IHJhbmRvbV9zdGF0ZQogICAgICAgIHNlbGYudmVyYm9zZSA9IHZlcmJvc2UKICAgICAgICBzZWxmLmltYWdlc19kaXIgPSBpbWFnZXNfZGlyCiAgICAgICAgc2VsZi5tYXNrc19kaXIgPSBtYXNrc19kaXIKICAgICAgICBzZWxmLnBsb3RfY3VydmVzID0gcGxvdF9jdXJ2ZXMKICAgICAgICBzZWxmLm5fcHJvY2Vzc2VzID0gbl9wcm9jZXNzZXMKICAgICAgICBzZWxmLnByb2dyZXNzX2NhbGxiYWNrID0gcHJvZ3Jlc3NfY2FsbGJhY2sKICAgICAgICBzZWxmLnNhdmVfaW50ZXJtZWRpYXRlX3Jlc3VsdHMgPSBzYXZlX2ludGVybWVkaWF0ZV9yZXN1bHRzCgogICAgICAgICMgSW5pdGlhbGl6ZSBmZWF0dXJlIGNvbmZpZ3VyYXRpb24gZGljdGlvbmFyeQogICAgICAgIHNlbGYuZmVhdHVyZV9jb25maWcgPSBmZWF0dXJlX2NvbmZpZyBvciB7fQoKICAgICAgICAjIOajgOafpWZlYXR1cmVfY29uZmln5qC85byPCiAgICAgICAgaWYgJ3ZveGVsX2xldmVsJyBub3QgaW4gc2VsZi5mZWF0dXJlX2NvbmZpZzoKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigidm94ZWxfbGV2ZWwgY29uZmlndXJhdGlvbiBpcyByZXF1aXJlZCIpCgogICAgICAgICMg5qOA5p+lc3VwZXJ2b3hlbF9sZXZlbOmFjee9ru+8iOWPr+mAie+8iQogICAgICAgIGlmICdzdXBlcnZveGVsX2xldmVsJyBpbiBzZWxmLmZlYXR1cmVfY29uZmlnIGFuZCBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIk5vdGU6IHN1cGVydm94ZWxfbGV2ZWwgZmVhdHVyZSBjb25maWd1cmF0aW9uIGlzIGRldGVjdGVkIGJ1dCBub3QgdXNlZCBpbiB0aGUgY3VycmVudCBpbXBsZW1lbnRhdGlvbi4iKQoKICAgICAgICAjIENyZWF0ZSBvdXRwdXQgZGlyZWN0b3J5CiAgICAgICAgb3MubWFrZWRpcnMoc2VsZi5vdXRfZGlyLCBleGlzdF9vaz1UcnVlKQoKICAgICAgICAjIEltYWdlIHBhdGhzCiAgICAgICAgc2VsZi5pbWFnZXNfcGF0aHMsIHNlbGYubWFza19wYXRocyA9IGdldF9pbWFnZV9hbmRfbWFza19wYXRocygKICAgICAgICAgICAgc2VsZi5kYXRhX2Rpciwga2V5d29yZF9vZl9yYXdfZm9sZGVyPXNlbGYuaW1hZ2VzX2RpciwKICAgICAgICAgICAga2V5d29yZF9vZl9tYXNrX2ZvbGRlcj1zZWxmLm1hc2tzX2RpcgogICAgICAgICkKCiAgICAgICAgIyDmo4Dmn6V2b3hlbF9sZXZlbOS4reaYr+WQpuaciWltYWdlX25hbWVzCiAgICAgICAgdm94ZWxfY29uZmlnID0gc2VsZi5mZWF0dXJlX2NvbmZpZ1sndm94ZWxfbGV2ZWwnXQogICAgICAgIGlmIGlzaW5zdGFuY2Uodm94ZWxfY29uZmlnLCBkaWN0KSBhbmQgJ2ltYWdlX25hbWVzJyBub3QgaW4gdm94ZWxfY29uZmlnOgogICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJJbWFnZSBuYW1lcyBub3QgcHJvdmlkZWQgaW4gdm94ZWxfbGV2ZWwgY29uZmlnLCBhdXRvbWF0aWNhbGx5IGRldGVjdGluZyBmcm9tIGRhdGEgZGlyZWN0b3J5Li4uIikKICAgICAgICAgICAgaW1hZ2VfbmFtZXMgPSBkZXRlY3RfaW1hZ2VfbmFtZXMoc2VsZi5pbWFnZXNfcGF0aHMpCiAgICAgICAgICAgIHNlbGYuZmVhdHVyZV9jb25maWdbJ3ZveGVsX2xldmVsJ11bJ2ltYWdlX25hbWVzJ10gPSBpbWFnZV9uYW1lcwogICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiRGV0ZWN0ZWQgaW1hZ2UgbmFtZXM6IHtpbWFnZV9uYW1lc30iKQoKICAgICAgICAjIEluaXRpYWxpemUgZmVhdHVyZSBleHRyYWN0b3IKICAgICAgICBzZWxmLl9pbml0X2ZlYXR1cmVfZXh0cmFjdG9yKCkKCiAgICAgICAgIyBJbml0aWFsaXplIGNsdXN0ZXJpbmcgYWxnb3JpdGhtcwogICAgICAgIHNlbGYuc3VwZXJ2b3hlbF9jbHVzdGVyaW5nID0gZ2V0X2NsdXN0ZXJpbmdfYWxnb3JpdGhtKAogICAgICAgICAgICBzZWxmLnN1cGVydm94ZWxfbWV0aG9kLAogICAgICAgICAgICBuX2NsdXN0ZXJzPXNlbGYubl9jbHVzdGVyc19zdXBlcnZveGVsLAogICAgICAgICAgICByYW5kb21fc3RhdGU9c2VsZi5yYW5kb21fc3RhdGUKICAgICAgICApCgogICAgICAgIHNlbGYuaGFiaXRhdF9jbHVzdGVyaW5nID0gZ2V0X2NsdXN0ZXJpbmdfYWxnb3JpdGhtKAogICAgICAgICAgICBzZWxmLmhhYml0YXRfbWV0aG9kLAogICAgICAgICAgICBuX2NsdXN0ZXJzPXNlbGYubl9jbHVzdGVyc19oYWJpdGF0c19tYXgsCiAgICAgICAgICAgIHJhbmRvbV9zdGF0ZT1zZWxmLnJhbmRvbV9zdGF0ZQogICAgICAgICkKCiAgICAgICAgIyBSZXN1bHRzIHN0b3JhZ2UKICAgICAgICBzZWxmLlggPSBOb25lICAjIEZlYXR1cmUgbWF0cml4CiAgICAgICAgc2VsZi5zdXBlcnZveGVsX2xhYmVscyA9IHt9ICAjIFN1cGVydm94ZWwgbGFiZWxzCiAgICAgICAgc2VsZi5oYWJpdGF0X2xhYmVscyA9IE5vbmUgICMgSGFiaXRhdCBsYWJlbHMKICAgICAgICBzZWxmLnJlc3VsdHNfZGYgPSBOb25lICAjIFJlc3VsdHMgRGF0YUZyYW1lCgogICAgICAgICMgVmFsaWRhdGUgZGF0YSBzdHJ1Y3R1cmUKICAgICAgICB2b3hlbF9jb25maWcgPSBzZWxmLmZlYXR1cmVfY29uZmlnWyd2b3hlbF9sZXZlbCddCiAgICAgICAgaWYgaXNpbnN0YW5jZSh2b3hlbF9jb25maWcsIGRpY3QpIGFuZCAnaW1hZ2VfbmFtZXMnIGluIHZveGVsX2NvbmZpZzoKICAgICAgICAgICAgY2hlY2tfZGF0YV9zdHJ1Y3R1cmUoc2VsZi5pbWFnZXNfcGF0aHMsIHNlbGYubWFza19wYXRocywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZveGVsX2NvbmZpZ1snaW1hZ2VfbmFtZXMnXSwgTm9uZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJ2b3hlbF9sZXZlbCBjb25maWd1cmF0aW9uIG11c3QgY29udGFpbiAnaW1hZ2VfbmFtZXMnIGZpZWxkIikKCiAgICBkZWYgX2luaXRfZmVhdHVyZV9leHRyYWN0b3Ioc2VsZik6CiAgICAgICAgIiIiSW5pdGlhbGl6ZSBmZWF0dXJlIGV4dHJhY3RvciBiYXNlZCBvbiBjb25maWd1cmF0aW9uIiIiCiAgICAgICAgIyDkvb/nlKjooajovr7lvI/op6PmnpDlmagKICAgICAgICBmcm9tIC5mZWF0dXJlcy5mZWF0dXJlX2V4cHJlc3Npb25fcGFyc2VyIGltcG9ydCBGZWF0dXJlRXhwcmVzc2lvblBhcnNlcgoKICAgICAgICAjIOWIm+W7uuihqOi+vuW8j+ino+aekOWZqOWunuS+iwogICAgICAgIHNlbGYuZXhwcmVzc2lvbl9wYXJzZXIgPSBGZWF0dXJlRXhwcmVzc2lvblBhcnNlcigpCgogICAgICAgICMg5o+Q5Y+Wdm94ZWxfbGV2ZWzphY3nva4KICAgICAgICB2b3hlbF9jb25maWcgPSBzZWxmLmZlYXR1cmVfY29uZmlnWyd2b3hlbF9sZXZlbCddCgogICAgICAgICMg56Gu5L+ddm94ZWxfY29uZmln5piv5a2X5YW45LiU5YyF5ZCrbWV0aG9k5a2X5q61CiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uodm94ZWxfY29uZmlnLCBkaWN0KSBvciAnbWV0aG9kJyBub3QgaW4gdm94ZWxfY29uZmlnOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJ2b3hlbF9sZXZlbCBtdXN0IGJlIGEgZGljdGlvbmFyeSB3aXRoICdtZXRob2QnIGZpZWxkIikKCiAgICAgICAgIyDop6PmnpB2b3hlbF9sZXZlbOihqOi+vuW8jwogICAgICAgIHNlbGYudm94ZWxfbWV0aG9kLCBzZWxmLnZveGVsX3BhcmFtcywgc2VsZi52b3hlbF9wcm9jZXNzaW5nX3N0ZXBzID0gc2VsZi5leHByZXNzaW9uX3BhcnNlci5wYXJzZSh2b3hlbF9jb25maWcpCgogICAgICAgICMg5qOA5p+l5piv5ZCm5o+Q5L6b5LqGc3VwZXJ2b3hlbF9sZXZlbOmFjee9rgogICAgICAgIHNlbGYuaGFzX3N1cGVydm94ZWxfY29uZmlnID0gJ3N1cGVydm94ZWxfbGV2ZWwnIGluIHNlbGYuZmVhdHVyZV9jb25maWcKICAgICAgICBpZiBzZWxmLmhhc19zdXBlcnZveGVsX2NvbmZpZzoKICAgICAgICAgICAgIyDmj5Dlj5ZzdXBlcnZveGVsX2xldmVs6YWN572uCiAgICAgICAgICAgIHN1cGVydm94ZWxfY29uZmlnID0gc2VsZi5mZWF0dXJlX2NvbmZpZ1snc3VwZXJ2b3hlbF9sZXZlbCddCgogICAgICAgICAgICAjIOehruS/nXN1cGVydm94ZWxfY29uZmln5piv5a2X5YW45LiU5YyF5ZCrbWV0aG9k5a2X5q61CiAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHN1cGVydm94ZWxfY29uZmlnLCBkaWN0KSBvciAnbWV0aG9kJyBub3QgaW4gc3VwZXJ2b3hlbF9jb25maWc6CiAgICAgICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJzdXBlcnZveGVsX2xldmVsIG11c3QgYmUgYSBkaWN0aW9uYXJ5IHdpdGggJ21ldGhvZCcgZmllbGQiKQoKICAgICAgICAgICAgIyDop6PmnpBzdXBlcnZveGVsX2xldmVs6KGo6L6+5byPCiAgICAgICAgICAgIHNlbGYuc3VwZXJ2b3hlbF9tZXRob2RfbmFtZSwgc2VsZi5zdXBlcnZveGVsX3BhcmFtcywgc2VsZi5zdXBlcnZveGVsX3Byb2Nlc3Npbmdfc3RlcHMgPSBzZWxmLmV4cHJlc3Npb25fcGFyc2VyLnBhcnNlKHN1cGVydm94ZWxfY29uZmlnKQoKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygic3VwZXJ2b3hlbF9sZXZlbCBmZWF0dXJlIGNvbmZpZ3VyYXRpb24gZGV0ZWN0ZWQgYnV0IG5vdCB1c2VkIGluIGN1cnJlbnQgaW1wbGVtZW50YXRpb24iKQoKICAgICAgICAjIOWIm+W7uui3qOWbvuWDj+eJueW+geaPkOWPluWZqOWPguaVsAogICAgICAgICMg5YeG5aSH6Leo5Zu+5YOP5Y+C5pWwCiAgICAgICAgY3Jvc3NfaW1hZ2Vfa3dhcmdzID0ge30KCiAgICAgICAgIyDmo4Dmn6V2b3hlbF9wYXJhbXPmmK/lkKbkuLrnqboKICAgICAgICBpZiBzZWxmLnZveGVsX3BhcmFtczoKICAgICAgICAgICAgIyDlpITnkIbot6jlm77lg4/lj4LmlbAKICAgICAgICAgICAgZm9yIHBhcmFtX25hbWUsIHBhcmFtX3ZhbHVlIGluIHNlbGYudm94ZWxfcGFyYW1zLml0ZW1zKCk6CiAgICAgICAgICAgICAgICAjIOS7jnZveGVsX2xldmVsLnBhcmFtc+S4reiOt+WPluWPguaVsOWAvAogICAgICAgICAgICAgICAgdm94ZWxfcGFyYW1zID0gc2VsZi5mZWF0dXJlX2NvbmZpZ1sndm94ZWxfbGV2ZWwnXS5nZXQoJ3BhcmFtcycsIHt9KQogICAgICAgICAgICAgICAgaWYgcGFyYW1fdmFsdWUgPT0gcGFyYW1fbmFtZSBhbmQgcGFyYW1fbmFtZSBpbiB2b3hlbF9wYXJhbXM6CiAgICAgICAgICAgICAgICAgICAgY3Jvc3NfaW1hZ2Vfa3dhcmdzW3BhcmFtX25hbWVdID0gdm94ZWxfcGFyYW1zW3BhcmFtX25hbWVdCiAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UocGFyYW1fdmFsdWUsIHN0cikgYW5kIHBhcmFtX3ZhbHVlIGluIHZveGVsX3BhcmFtczoKICAgICAgICAgICAgICAgICAgICBjcm9zc19pbWFnZV9rd2FyZ3NbcGFyYW1fbmFtZV0gPSB2b3hlbF9wYXJhbXNbcGFyYW1fdmFsdWVdCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMg5ZCm5YiZ55u05o6l5L2/55So5Y+C5pWw5YC8CiAgICAgICAgICAgICAgICAgICAgY3Jvc3NfaW1hZ2Vfa3dhcmdzW3BhcmFtX25hbWVdID0gcGFyYW1fdmFsdWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBzZWxmLmNyb3NzX2ltYWdlX2t3YXJncyA9IGNyb3NzX2ltYWdlX2t3YXJncwoKICAgIGRlZiBfcHJvY2Vzc19zdWJqZWN0KHNlbGYsIHN1YmplY3Q6IHN0cikgLT4gVHVwbGVbc3RyLCBwZC5EYXRhRnJhbWVdOgogICAgICAgICIiIgogICAgICAgIFByb2Nlc3MgYSBzaW5nbGUgc3ViamVjdAoKICAgICAgICBBcmdzOgogICAgICAgICAgICBzdWJqZWN0IChzdHIpOiBTdWJqZWN0IElEIHRvIHByb2Nlc3MKCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgVHVwbGVbc3RyLCBwZC5EYXRhRnJhbWVdOiBUdXBsZSBjb250YWluaW5nIHN1YmplY3QgSUQgYW5kIHByb2Nlc3NlZCBkYXRhCiAgICAgICAgIiIiCiAgICAgICAgIyBFeHRyYWN0IGZlYXR1cmVzCiAgICAgICAgXywgZmVhdHVyZV9kZiwgcmF3X2RmLCBtYXNrX2luZm8gPSBzZWxmLmV4dHJhY3Rfdm94ZWxfZmVhdHVyZXMoc3ViamVjdCkKCiAgICAgICAgIyBBcHBseSBwcmVwcm9jZXNzaW5nIGlmIGVuYWJsZWQKICAgICAgICBpZiBzZWxmLmZlYXR1cmVfY29uZmlnLmdldCgncHJlcHJvY2Vzc2luZycsIEZhbHNlKToKICAgICAgICAgICAgIyDmo4Dmn6XmmK/lkKbkvb/nlKjmlrDnmoTlpJrmlrnms5XkuLLogZTmnLrliLYKICAgICAgICAgICAgaWYgJ21ldGhvZHMnIGluIHNlbGYuZmVhdHVyZV9jb25maWdbJ3ByZXByb2Nlc3NpbmcnXToKICAgICAgICAgICAgICAgICMg5L2/55So5aSa5pa55rOV5Liy6IGUCiAgICAgICAgICAgICAgICBYX3N1YmpfID0gcHJlcHJvY2Vzc19mZWF0dXJlcygKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlX2RmLnZhbHVlcywKICAgICAgICAgICAgICAgICAgICBtZXRob2RzPXNlbGYuZmVhdHVyZV9jb25maWdbJ3ByZXByb2Nlc3NpbmcnXVsnbWV0aG9kcyddCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBmZWF0dXJlX2RmID0gcGQuRGF0YUZyYW1lKFhfc3Vial8sIGNvbHVtbnM9ZmVhdHVyZV9kZi5jb2x1bW5zKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyDkvb/nlKjljZXkuIDmlrnms5XvvIjlkJHlkI7lhbzlrrnvvIkKICAgICAgICAgICAgICAgIFhfc3Vial8gPSBwcmVwcm9jZXNzX2ZlYXR1cmVzKGZlYXR1cmVfZGYudmFsdWVzLCAqKnNlbGYuZmVhdHVyZV9jb25maWdbJ3ByZXByb2Nlc3NpbmcnXSkKICAgICAgICAgICAgICAgIGZlYXR1cmVfZGYgPSBwZC5EYXRhRnJhbWUoWF9zdWJqXywgY29sdW1ucz1mZWF0dXJlX2RmLmNvbHVtbnMpCgogICAgICAgICMgUGVyZm9ybSBzdXBlcnZveGVsIGNsdXN0ZXJpbmcgZm9yIGVhY2ggc3ViamVjdCBpbmRpdmlkdWFsbHkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuc3VwZXJ2b3hlbF9jbHVzdGVyaW5nLmZpdChmZWF0dXJlX2RmLnZhbHVlcykKICAgICAgICAgICAgc3VwZXJ2b3hlbF9sYWJlbHMgPSBzZWxmLnN1cGVydm94ZWxfY2x1c3RlcmluZy5wcmVkaWN0KGZlYXR1cmVfZGYudmFsdWVzKQogICAgICAgICAgICBzdXBlcnZveGVsX2xhYmVscyArPSAxICAjIFN0YXJ0IG51bWJlcmluZyBmcm9tIDEKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiRXJyb3I6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmIkVycm9yIHBlcmZvcm1pbmcgc3VwZXJ2b3hlbCBjbHVzdGVyaW5nIGZvciBzdWJqZWN0IHtzdWJqZWN0fSIpCgogICAgICAgICMgR2V0IGZlYXR1cmUgbmFtZXMKICAgICAgICBmZWF0dXJlX25hbWVzID0gZmVhdHVyZV9kZi5jb2x1bW5zLnRvbGlzdCgpCgogICAgICAgICMgR2V0IG9yaWdpbmFsIGZlYXR1cmUgbmFtZXMgKGltYWdlIG5hbWVzKQogICAgICAgIG9yaWdpbmFsX2ZlYXR1cmVfbmFtZXMgPSByYXdfZGYuY29sdW1ucy50b2xpc3QoKQoKICAgICAgICAjIENhbGN1bGF0ZSBhdmVyYWdlIGZlYXR1cmVzIGZvciBlYWNoIHN1cGVydm94ZWwKICAgICAgICB1bmlxdWVfbGFiZWxzID0gbnAuYXJhbmdlKDEsIHNlbGYubl9jbHVzdGVyc19zdXBlcnZveGVsICsgMSkKICAgICAgICBkYXRhX3Jvd3MgPSBbXQogICAgICAgIGZvciBpIGluIHVuaXF1ZV9sYWJlbHM6CiAgICAgICAgICAgIGluZGljZXMgPSBzdXBlcnZveGVsX2xhYmVscyA9PSBpCiAgICAgICAgICAgIGlmIG5wLmFueShpbmRpY2VzKToKICAgICAgICAgICAgICAgICMgQ2FsY3VsYXRlIGF2ZXJhZ2UgZmVhdHVyZXMgZm9yIGN1cnJlbnQgc3VwZXJ2b3hlbAogICAgICAgICAgICAgICAgbWVhbl9mZWF0dXJlcyA9IG5wLm1lYW4oZmVhdHVyZV9kZltpbmRpY2VzXSwgYXhpcz0wKQogICAgICAgICAgICAgICAgbWVhbl9vcmlnaW5hbF9mZWF0dXJlcyA9IG5wLm1lYW4ocmF3X2RmLnZhbHVlc1tpbmRpY2VzXSwgYXhpcz0wKQogICAgICAgICAgICAgICAgY291bnQgPSBucC5zdW0oaW5kaWNlcykKICAgICAgICAgICAgICAgICMgQ3JlYXRlIGRhdGEgcm93CiAgICAgICAgICAgICAgICBkYXRhX3JvdyA9IHsKICAgICAgICAgICAgICAgICAgICAiU3ViamVjdCI6IHN1YmplY3QsCiAgICAgICAgICAgICAgICAgICAgIlN1cGVydm94ZWwiOiBpLAogICAgICAgICAgICAgICAgICAgICJDb3VudCI6IGNvdW50LAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgIyBBZGQgZmVhdHVyZSBtZWFucwogICAgICAgICAgICAgICAgZm9yIGosIG5hbWUgaW4gZW51bWVyYXRlKGZlYXR1cmVfbmFtZXMpOgogICAgICAgICAgICAgICAgICAgIGRhdGFfcm93W25hbWVdID0gbWVhbl9mZWF0dXJlc1tqXQoKICAgICAgICAgICAgICAgICMgQWRkIG9yaWdpbmFsIGZlYXR1cmUgbWVhbnMKICAgICAgICAgICAgICAgIGZvciBqLCBuYW1lIGluIGVudW1lcmF0ZShvcmlnaW5hbF9mZWF0dXJlX25hbWVzKToKICAgICAgICAgICAgICAgICAgICBkYXRhX3Jvd1tmIntuYW1lfS1vcmlnaW5hbCJdID0gbWVhbl9vcmlnaW5hbF9mZWF0dXJlc1tqXQoKICAgICAgICAgICAgICAgIGRhdGFfcm93cy5hcHBlbmQoZGF0YV9yb3cpCiAgICAgICAgbWVhbl9mZWF0dXJlc19kZiA9IHBkLkRhdGFGcmFtZShkYXRhX3Jvd3MpCgogICAgICAgICMgU2F2ZSBzdXBlcnZveGVsIGltYWdlCiAgICAgICAgaWYgaXNpbnN0YW5jZShtYXNrX2luZm8sIGRpY3QpIGFuZCAnbWFza19hcnJheScgaW4gbWFza19pbmZvIGFuZCAnbWFzaycgaW4gbWFza19pbmZvOgogICAgICAgICAgICAjIENyZWF0ZSBzdXBlcnZveGVsIG1hcAogICAgICAgICAgICBzdXBlcnZveGVsX21hcCA9IG5wLnplcm9zX2xpa2UobWFza19pbmZvWydtYXNrX2FycmF5J10pCiAgICAgICAgICAgIG1hc2tfaW5kaWNlcyA9IG1hc2tfaW5mb1snbWFza19hcnJheSddID4gMAogICAgICAgICAgICBzdXBlcnZveGVsX21hcFttYXNrX2luZGljZXNdID0gc3VwZXJ2b3hlbF9sYWJlbHMKCiAgICAgICAgICAgICMgQ29udmVydCB0byBTaW1wbGVJVEsgaW1hZ2UgYW5kIHNhdmUKICAgICAgICAgICAgc3VwZXJ2b3hlbF9pbWcgPSBzaXRrLkdldEltYWdlRnJvbUFycmF5KHN1cGVydm94ZWxfbWFwKQogICAgICAgICAgICBzdXBlcnZveGVsX2ltZy5Db3B5SW5mb3JtYXRpb24obWFza19pbmZvWydtYXNrJ10pCgogICAgICAgICAgICAjIFNhdmUgYXMgbnJyZCBmaWxlCiAgICAgICAgICAgIHNpdGsuV3JpdGVJbWFnZShzdXBlcnZveGVsX2ltZywgb3MucGF0aC5qb2luKHNlbGYub3V0X2RpciwgZiJ7c3ViamVjdH1fc3VwZXJ2b3hlbC5ucnJkIikpCgogICAgICAgICAgICAjIENsZWFuIHVwIG1lbW9yeQogICAgICAgICAgICBkZWwgc3VwZXJ2b3hlbF9tYXAsIG1hc2tfaW5kaWNlcwoKICAgICAgICAjIENsZWFuIHVwIG1lbW9yeQogICAgICAgIGRlbCBmZWF0dXJlX2RmLCByYXdfZGYsIHN1cGVydm94ZWxfbGFiZWxzCgogICAgICAgIHJldHVybiBzdWJqZWN0LCBtZWFuX2ZlYXR1cmVzX2RmCgogICAgZGVmIHJ1bihzZWxmLCBzdWJqZWN0czogT3B0aW9uYWxbTGlzdFtzdHJdXSA9IE5vbmUsIHNhdmVfcmVzdWx0c19jc3Y6IGJvb2wgPSBUcnVlKSAtPiBwZC5EYXRhRnJhbWU6CiAgICAgICAgIiIiCiAgICAgICAgUnVuIHRoZSBoYWJpdGF0IGNsdXN0ZXJpbmcgcGlwZWxpbmUKCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc3ViamVjdHMgKE9wdGlvbmFsW0xpc3Rbc3RyXV0sIG9wdGlvbmFsKTogTGlzdCBvZiBzdWJqZWN0cyB0byBwcm9jZXNzLiBJZiBOb25lLCBhbGwgc3ViamVjdHMgd2lsbCBiZSBwcm9jZXNzZWQuCiAgICAgICAgICAgIHNhdmVfcmVzdWx0c19jc3YgKGJvb2wsIG9wdGlvbmFsKTogV2hldGhlciB0byBzYXZlIHJlc3VsdHMgYXMgQ1NWIGZpbGVzLiBEZWZhdWx0cyB0byBUcnVlLgoKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBwZC5EYXRhRnJhbWU6IEhhYml0YXQgY2x1c3RlcmluZyByZXN1bHRzCiAgICAgICAgIiIiCiAgICAgICAgaWYgc3ViamVjdHMgaXMgTm9uZToKICAgICAgICAgICAgc3ViamVjdHMgPSBsaXN0KHNlbGYuaW1hZ2VzX3BhdGhzLmtleXMoKSkKCiAgICAgICAgIyBFeHRyYWN0IGZlYXR1cmVzIGFuZCBwZXJmb3JtIHN1cGVydm94ZWwgY2x1c3RlcmluZyBmb3IgZWFjaCBzdWJqZWN0CiAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJFeHRyYWN0aW5nIGZlYXR1cmVzIGFuZCBwZXJmb3JtaW5nIHN1cGVydm94ZWwgY2x1c3RlcmluZy4uLiIpCgogICAgICAgICMgUmVzdWx0cyBzdG9yYWdlCiAgICAgICAgbWVhbl9mZWF0dXJlc19hbGwgPSBwZC5EYXRhRnJhbWUoKQoKICAgICAgICAjIFVzZSBtdWx0aXByb2Nlc3NpbmcgdG8gcHJvY2VzcyBzdWJqZWN0cwogICAgICAgIGlmIHNlbGYubl9wcm9jZXNzZXMgPiAxIGFuZCBsZW4oc3ViamVjdHMpID4gMToKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlVzaW5nIHtzZWxmLm5fcHJvY2Vzc2VzfSBwcm9jZXNzZXMgZm9yIHBhcmFsbGVsIHByb2Nlc3NpbmcuLi4iKQoKICAgICAgICAgICAgd2l0aCBtdWx0aXByb2Nlc3NpbmcuUG9vbChwcm9jZXNzZXM9c2VsZi5uX3Byb2Nlc3NlcykgYXMgcG9vbDoKICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJTdGFydGluZyBwYXJhbGxlbCBwcm9jZXNzaW5nIG9mIGFsbCBzdWJqZWN0cy4uLiIpCiAgICAgICAgICAgICAgICByZXN1bHRzX2l0ZXIgPSBwb29sLmltYXBfdW5vcmRlcmVkKHNlbGYuX3Byb2Nlc3Nfc3ViamVjdCwgc3ViamVjdHMpCgogICAgICAgICAgICAgICAgIyDkvb/nlKjoh6rlrprkuYnov5vluqbmnaHmmL7npLrov5vluqYKICAgICAgICAgICAgICAgIHByb2dyZXNzX2JhciA9IEN1c3RvbVRxZG0odG90YWw9bGVuKHN1YmplY3RzKSwgZGVzYz0iUHJvY2Vzc2luZyBzdWJqZWN0cyIpCiAgICAgICAgICAgICAgICBmb3Igc3ViamVjdCwgbWVhbl9mZWF0dXJlc19kZiBpbiByZXN1bHRzX2l0ZXI6CiAgICAgICAgICAgICAgICAgICAgbWVhbl9mZWF0dXJlc19hbGwgPSBwZC5jb25jYXQoW21lYW5fZmVhdHVyZXNfYWxsLCBtZWFuX2ZlYXR1cmVzX2RmXSwgaWdub3JlX2luZGV4PVRydWUpCiAgICAgICAgICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyLnVwZGF0ZSgxKQoKICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiXG5BbGwge2xlbihzdWJqZWN0cyl9IHN1YmplY3RzIGhhdmUgYmVlbiBwcm9jZXNzZWQuIFByb2NlZWRpbmcgdG8gY2x1c3RlcmluZy4uLiIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBTaW5nbGUgcHJvY2VzcyBwcm9jZXNzaW5nLCB1c2UgY3VzdG9tIHByb2dyZXNzIGJhcgogICAgICAgICAgICBwcm9ncmVzc19iYXIgPSBDdXN0b21UcWRtKHRvdGFsPWxlbihzdWJqZWN0cyksIGRlc2M9IlByb2Nlc3Npbmcgc3ViamVjdHMiKQogICAgICAgICAgICBmb3Igc3ViamVjdCBpbiBzdWJqZWN0czoKICAgICAgICAgICAgICAgIF8sIG1lYW5fZmVhdHVyZXNfZGYgPSBzZWxmLl9wcm9jZXNzX3N1YmplY3Qoc3ViamVjdCkKICAgICAgICAgICAgICAgIG1lYW5fZmVhdHVyZXNfYWxsID0gcGQuY29uY2F0KFttZWFuX2ZlYXR1cmVzX2FsbCwgbWVhbl9mZWF0dXJlc19kZl0sIGlnbm9yZV9pbmRleD1UcnVlKQogICAgICAgICAgICAgICAgcHJvZ3Jlc3NfYmFyLnVwZGF0ZSgxKQoKICAgICAgICAjIENoZWNrIGlmIHRoZXJlIGlzIGVub3VnaCBkYXRhIGZvciBjbHVzdGVyaW5nCiAgICAgICAgaWYgbGVuKG1lYW5fZmVhdHVyZXNfYWxsKSA9PSAwOgogICAgICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCJObyB2YWxpZCBmZWF0dXJlcyBmb3IgYW5hbHlzaXMiKQoKICAgICAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAgICAgIyBQcmVwYXJlIGZlYXR1cmVzIGZvciBwb3B1bGF0aW9uLWxldmVsIGNsdXN0ZXJpbmcKICAgICAgICAjIGZlYXR1cmVfbmFtZXMgPSBtZWFuX2ZlYXR1cmVzX2FsbOS4reS4jeS7pS1vcmlnaW5hbOe7k+WwvueahOWIlwogICAgICAgIGZlYXR1cmVfbmFtZXMgPSBbY29sIGZvciBjb2wgaW4gbWVhbl9mZWF0dXJlc19hbGwuY29sdW1ucyBpZiBub3QgY29sLmVuZHN3aXRoKCctb3JpZ2luYWwnKV0KICAgICAgICBmZWF0dXJlX25hbWVzID0gZmVhdHVyZV9uYW1lc1szOl0KICAgICAgICBmZWF0dXJlc19mb3JfY2x1c3RlcmluZyA9IG1lYW5fZmVhdHVyZXNfYWxsW2ZlYXR1cmVfbmFtZXNdCiAgICAgICAgc3VwZXJ2b3hlbF9maWxlX2tleXdvcmQgPSBzZWxmLmZlYXR1cmVfY29uZmlnWydzdXBlcnZveGVsX2xldmVsJ10uZ2V0KCdzdXBlcnZveGVsX2ZpbGVfa2V5d29yZCcsICcqX3N1cGVydm94ZWwubnJyZCcpCiAgICAgICAgc3VwZXJ2b3hlbF9maWxlcyA9IGdsb2Iob3MucGF0aC5qb2luKHNlbGYub3V0X2Rpciwgc3VwZXJ2b3hlbF9maWxlX2tleXdvcmQpKQogICAgICAgICMgaWYgc3ViamVjdCBpbiBzdWJqZWN0cywgdGhlbiBhZGQgdG8gc3VwZXJ2b3hlbF9maWxlX2tleXdvcmRfZGljdAogICAgICAgIHNlbGYuc3VwZXJ2b3hlbF9maWxlX2RpY3QgPSB7fQogICAgICAgIGZvciBzdWJqZWN0IGluIHN1YmplY3RzOgogICAgICAgICAgICBmb3Igc3VwZXJ2b3hlbF9maWxlIGluIHN1cGVydm94ZWxfZmlsZXM6CiAgICAgICAgICAgICAgICBpZiBzdWJqZWN0IGluIHN1cGVydm94ZWxfZmlsZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnN1cGVydm94ZWxfZmlsZV9kaWN0W3N1YmplY3RdID0gc3VwZXJ2b3hlbF9maWxlCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJObyBzdXBlcnZveGVsIGZpbGUgZm91bmQgZm9yIHN1YmplY3Qge3N1YmplY3R9IikKCiAgICAgICAgaWYgbm90IHNlbGYuc3VwZXJ2b3hlbF9maWxlX2RpY3Q6CiAgICAgICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoZiJObyBzdXBlcnZveGVsIGZpbGVzIGZvdW5kIGluIHtzZWxmLm91dF9kaXJ9IikKCiAgICAgICAgIyDmo4Dmn6XmmK/lkKbkvb/nlKhtZWFuX3ZveGVsX2ZlYXR1cmVzCiAgICAgICAgaXNfbWVhbl92b3hlbF9mZWF0dXJlcyA9ICdtZWFuX3ZveGVsX2ZlYXR1cmVzJyBpbiBzZWxmLmZlYXR1cmVfY29uZmlnWydzdXBlcnZveGVsX2xldmVsJ11bJ21ldGhvZCddCiAgICAgICAgaWYgbm90IGlzX21lYW5fdm94ZWxfZmVhdHVyZXM6CiAgICAgICAgICAgICMgVXNlIG11bHRpcHJvY2Vzc2luZyB0byBleHRyYWN0IHN1cGVydm94ZWwgZmVhdHVyZXMgZm9yIGFsbCBzdWJqZWN0cwogICAgICAgICAgICBpZiBzZWxmLm5fcHJvY2Vzc2VzID4gMSBhbmQgbGVuKHN1YmplY3RzKSA+IDE6CiAgICAgICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlVzaW5nIHtzZWxmLm5fcHJvY2Vzc2VzfSBwcm9jZXNzZXMgZm9yIHN1cGVydm94ZWwgZmVhdHVyZSBleHRyYWN0aW9uLi4uIikKCiAgICAgICAgICAgICAgICB3aXRoIG11bHRpcHJvY2Vzc2luZy5Qb29sKHByb2Nlc3Nlcz1zZWxmLm5fcHJvY2Vzc2VzKSBhcyBwb29sOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiU3RhcnRpbmcgcGFyYWxsZWwgc3VwZXJ2b3hlbCBmZWF0dXJlIGV4dHJhY3Rpb24uLi4iKQoKICAgICAgICAgICAgICAgICAgICAjIFVzZSBpbWFwX3Vub3JkZXJlZCB0byBwcm9jZXNzIHN1YmplY3RzIGluIHBhcmFsbGVsCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0c19pdGVyID0gcG9vbC5pbWFwX3Vub3JkZXJlZChzZWxmLmV4dHJhY3Rfc3VwZXJ2b3hlbF9mZWF0dXJlcywgc3ViamVjdHMpCgogICAgICAgICAgICAgICAgICAgICMgQ29sbGVjdCBmZWF0dXJlcyBmcm9tIGFsbCBzdWJqZWN0cwogICAgICAgICAgICAgICAgICAgIGZlYXR1cmVzX2Zvcl9jbHVzdGVyaW5nID0gW10KICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIgPSBDdXN0b21UcWRtKHRvdGFsPWxlbihzdWJqZWN0cyksIGRlc2M9IkV4dHJhY3Rpbmcgc3VwZXJ2b3hlbCBmZWF0dXJlcyIpCiAgICAgICAgICAgICAgICAgICAgZm9yIGZlYXR1cmVzIGluIHJlc3VsdHNfaXRlcjoKICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXNfZm9yX2NsdXN0ZXJpbmcuYXBwZW5kKGZlYXR1cmVzKQogICAgICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIudXBkYXRlKDEpCgogICAgICAgICAgICAgICAgICAgICMgY29uY2F0CiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXNfZm9yX2NsdXN0ZXJpbmcgPSBwZC5jb25jYXQoZmVhdHVyZXNfZm9yX2NsdXN0ZXJpbmcsIGlnbm9yZV9pbmRleD1UcnVlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBTaW5nbGUgcHJvY2VzcyBwcm9jZXNzaW5nCiAgICAgICAgICAgICAgICBmZWF0dXJlc19mb3JfY2x1c3RlcmluZyA9IFtdCiAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIgPSBDdXN0b21UcWRtKHRvdGFsPWxlbihzdWJqZWN0cyksIGRlc2M9IkV4dHJhY3Rpbmcgc3VwZXJ2b3hlbCBmZWF0dXJlcyIpCiAgICAgICAgICAgICAgICBmb3Igc3ViamVjdCBpbiBzdWJqZWN0czoKICAgICAgICAgICAgICAgICAgICBmZWF0dXJlcyA9IHNlbGYuZXh0cmFjdF9zdXBlcnZveGVsX2ZlYXR1cmVzKHN1YmplY3QpCiAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXNfZm9yX2NsdXN0ZXJpbmcuYXBwZW5kKGZlYXR1cmVzKQogICAgICAgICAgICAgICAgICAgIHByb2dyZXNzX2Jhci51cGRhdGUoMSkKCiAgICAgICAgICAgICAgICAjIENvbnZlcnQgdG8gbnVtcHkgYXJyYXkKICAgICAgICAgICAgICAgIGZlYXR1cmVzX2Zvcl9jbHVzdGVyaW5nID0gcGQuY29uY2F0KGZlYXR1cmVzX2Zvcl9jbHVzdGVyaW5nLCBpZ25vcmVfaW5kZXg9VHJ1ZSkKCgogICAgICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgICAjICBUT0RPOiBwZXJmb3JtIGdyb3VwIGxldmVsIGZlYXR1cmUgcHJlcHJvY2Vzc2luZywgcGVyZm9ybSBoZXJlCiAgICAgICAgIyBDdXJyZW50IG9ubHkgc3VwcG9ydCBtZWFuIGZpbGxpbmcKICAgICAgICBmZWF0dXJlc19mb3JfY2x1c3RlcmluZyA9IGZlYXR1cmVzX2Zvcl9jbHVzdGVyaW5nLmFwcGx5KGxhbWJkYSB4OiBwZC50b19udW1lcmljKHgsIGVycm9ycz0nY29lcmNlJykpCiAgICAgICAgZmVhdHVyZXNfZm9yX2NsdXN0ZXJpbmcgPSBmZWF0dXJlc19mb3JfY2x1c3RlcmluZy5hcHBseW1hcChsYW1iZGEgeDogeC5pdGVtKCkgaWYgaGFzYXR0cih4LCAnaXRlbScpIGVsc2UgeCkKICAgICAgICBmZWF0dXJlc19mb3JfY2x1c3RlcmluZyA9IGZlYXR1cmVzX2Zvcl9jbHVzdGVyaW5nLnJlcGxhY2UoW25wLmluZiwgLW5wLmluZl0sIG5wLm5hbikKICAgICAgICBmZWF0dXJlc19mb3JfY2x1c3RlcmluZyA9IGZlYXR1cmVzX2Zvcl9jbHVzdGVyaW5nLmZpbGxuYShmZWF0dXJlc19mb3JfY2x1c3RlcmluZy5tZWFuKCkpCiAgICAgICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKICAgICAgICAjIERldGVybWluZSBvcHRpbWFsIG51bWJlciBvZiBjbHVzdGVycwogICAgICAgIGlmIHNlbGYuYmVzdF9uX2NsdXN0ZXJzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjIElmIGJlc3QgbnVtYmVyIG9mIGNsdXN0ZXJzIGlzIGFscmVhZHkgc3BlY2lmaWVkLCB1c2UgaXQgZGlyZWN0bHkKICAgICAgICAgICAgb3B0aW1hbF9uX2NsdXN0ZXJzID0gc2VsZi5iZXN0X25fY2x1c3RlcnMKICAgICAgICAgICAgc2NvcmVzID0gTm9uZQogICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVXNpbmcgc3BlY2lmaWVkIGJlc3QgbnVtYmVyIG9mIGNsdXN0ZXJzOiB7b3B0aW1hbF9uX2NsdXN0ZXJzfSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBPdGhlcndpc2UgZmluZCBvcHRpbWFsIG51bWJlciBvZiBjbHVzdGVycwogICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJGaW5kaW5nIG9wdGltYWwgbnVtYmVyIG9mIGNsdXN0ZXJzLi4uIikKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgRW5zdXJlIGNsdXN0ZXIgbnVtYmVyIHJhbmdlIGlzIHJlYXNvbmFibGUKICAgICAgICAgICAgICAgIG1pbl9jbHVzdGVycyA9IG1heCgyLCBzZWxmLm5fY2x1c3RlcnNfaGFiaXRhdHNfbWluKQogICAgICAgICAgICAgICAgbWF4X2NsdXN0ZXJzID0gbWluKHNlbGYubl9jbHVzdGVyc19oYWJpdGF0c19tYXgsIGxlbihmZWF0dXJlc19mb3JfY2x1c3RlcmluZykgLSAxKQoKICAgICAgICAgICAgICAgIGlmIG1heF9jbHVzdGVycyA8PSBtaW5fY2x1c3RlcnM6CiAgICAgICAgICAgICAgICAgICAgIyBJZiByYW5nZSBpcyBpbnZhbGlkLCB1c2UgZGVmYXVsdCBtaW5pbXVtIHZhbHVlCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiSW52YWxpZCBjbHVzdGVyIG51bWJlciByYW5nZSBbe21pbl9jbHVzdGVyc30sIHttYXhfY2x1c3RlcnN9XSwgdXNpbmcgZGVmYXVsdCB2YWx1ZSIpCiAgICAgICAgICAgICAgICAgICAgb3B0aW1hbF9uX2NsdXN0ZXJzID0gbWluX2NsdXN0ZXJzCiAgICAgICAgICAgICAgICAgICAgc2NvcmVzID0gTm9uZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIFRyeSB0byBmaW5kIG9wdGltYWwgbnVtYmVyIG9mIGNsdXN0ZXJzCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBjbHVzdGVyX2Zvcl9iZXN0X24gPSBnZXRfY2x1c3RlcmluZ19hbGdvcml0aG0oc2VsZi5oYWJpdGF0X21ldGhvZCkKICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW1hbF9uX2NsdXN0ZXJzLCBzY29yZXMgPSBjbHVzdGVyX2Zvcl9iZXN0X24uZmluZF9vcHRpbWFsX2NsdXN0ZXJzKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZXNfZm9yX2NsdXN0ZXJpbmcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtaW5fY2x1c3RlcnM9bWluX2NsdXN0ZXJzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4X2NsdXN0ZXJzPW1heF9jbHVzdGVycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1ldGhvZHM9c2VsZi5oYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3dfcHJvZ3Jlc3M9VHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICApCgogICAgICAgICAgICAgICAgICAgICAgICAjIElmIHBsb3R0aW5nIGlzIG5lZWRlZCwgcGxvdCBzY29yZSBncmFwaHMKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wbG90X2N1cnZlcyBhbmQgc2NvcmVzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMg56Gu5L+d6L6T5Ye655uu5b2V5a2Y5ZyoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3MubWFrZWRpcnMoc2VsZi5vdXRfZGlyLCBleGlzdF9vaz1UcnVlKQoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIOaehOmAoOS/neWtmOi3r+W+hAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVfcGF0aCA9IG9zLnBhdGguam9pbihzZWxmLm91dF9kaXIsICdoYWJpdGF0X2NsdXN0ZXJpbmdfc2NvcmVzLnBuZycpCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMg5L2/55So5paw55qE5Y+v6KeG5YyW5Ye95pWw57uY5Zu+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGxvdF9jbHVzdGVyX3Njb3JlcygKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcmVzX2RpY3Q9c2NvcmVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbHVzdGVyX3JhbmdlPWNsdXN0ZXJfZm9yX2Jlc3Rfbi5jbHVzdGVyX3JhbmdlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXRob2RzPXNlbGYuaGFiaXRhdF9jbHVzdGVyX3NlbGVjdGlvbl9tZXRob2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsdXN0ZXJpbmdfYWxnb3JpdGhtPXNlbGYuaGFiaXRhdF9tZXRob2QsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpZ3NpemU9KDEyLCA4KSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2F2ZV9wYXRoPXNhdmVfcGF0aCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdz1GYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYi6IGa57G76K+E5YiG5Zu+5bey5L+d5a2Y6IezIHtzYXZlX3BhdGh9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIOaNleiOt+e7mOWbvui/h+eoi+S4reeahOmUmeivrwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiLnu5jliLbogZrnsbvor4TliIblm77ml7blh7rplJk6IHtzdHIoZSl9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygi57un57ut5omn6KGM5YW25LuW5rWB56iLLi4uIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICMgSWYgb3B0aW1hbCBudW1iZXIgb2YgY2x1c3RlcnMgY2Fubm90IGJlIGZvdW5kLCB1c2UgZGVmYXVsdCB2YWx1ZSBhbmQgd2FybiB1c2VyCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYudmVyYm9zZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJGYWlsZWQgdG8gZmluZCBvcHRpbWFsIG51bWJlciBvZiBjbHVzdGVyczoge3N0cihlKX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVXNpbmcgZGVmYXVsdCBudW1iZXIgb2YgY2x1c3RlcnMiKQogICAgICAgICAgICAgICAgICAgICAgICBvcHRpbWFsX25fY2x1c3RlcnMgPSBtaW4oMywgbWF4X2NsdXN0ZXJzKSAgIyBVc2UgYSByZWFzb25hYmxlIGRlZmF1bHQgdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgc2NvcmVzID0gTm9uZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAjIENhdGNoIGFsbCBleGNlcHRpb25zLCB1c2UgZGVmYXVsdCB2YWx1ZQogICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiRXhjZXB0aW9uIG9jY3VycmVkIHdoZW4gZGV0ZXJtaW5pbmcgb3B0aW1hbCBudW1iZXIgb2YgY2x1c3RlcnM6IHtzdHIoZSl9IikKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJVc2luZyBkZWZhdWx0IG51bWJlciBvZiBjbHVzdGVycyIpCiAgICAgICAgICAgICAgICBvcHRpbWFsX25fY2x1c3RlcnMgPSAzICAjIERlZmF1bHQgdG8gMyBjbHVzdGVycwogICAgICAgICAgICAgICAgc2NvcmVzID0gTm9uZQoKICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIk9wdGltYWwgbnVtYmVyIG9mIGNsdXN0ZXJzOiB7b3B0aW1hbF9uX2NsdXN0ZXJzfSIpCgogICAgICAgICMgUGVyZm9ybSBwb3B1bGF0aW9uLWxldmVsIGNsdXN0ZXJpbmcgdXNpbmcgb3B0aW1hbCBudW1iZXIgb2YgY2x1c3RlcnMKICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBlcmZvcm1pbmcgcG9wdWxhdGlvbi1sZXZlbCBjbHVzdGVyaW5nLi4uIikKCgogICAgICAgICMgUmVpbml0aWFsaXplIGNsdXN0ZXJpbmcgYWxnb3JpdGhtIHdpdGggb3B0aW1hbCBudW1iZXIgb2YgY2x1c3RlcnMKICAgICAgICBzZWxmLmhhYml0YXRfY2x1c3RlcmluZy5uX2NsdXN0ZXJzID0gb3B0aW1hbF9uX2NsdXN0ZXJzCiAgICAgICAgc2VsZi5oYWJpdGF0X2NsdXN0ZXJpbmcuZml0KGZlYXR1cmVzX2Zvcl9jbHVzdGVyaW5nKQogICAgICAgIGhhYml0YXRfbGFiZWxzID0gc2VsZi5oYWJpdGF0X2NsdXN0ZXJpbmcucHJlZGljdChmZWF0dXJlc19mb3JfY2x1c3RlcmluZykgKyAxICAjIFN0YXJ0IG51bWJlcmluZyBmcm9tIDEKCiAgICAgICAgIyBBZGQgaGFiaXRhdCBsYWJlbHMgdG8gcmVzdWx0cwogICAgICAgIG1lYW5fZmVhdHVyZXNfYWxsWydIYWJpdGF0cyddID0gaGFiaXRhdF9sYWJlbHMKCiAgICAgICAgIyBDcmVhdGUgcmVzdWx0cyBEYXRhRnJhbWUKICAgICAgICBzZWxmLnJlc3VsdHNfZGYgPSBtZWFuX2ZlYXR1cmVzX2FsbC5jb3B5KCkKCiAgICAgICAgIyBTYXZlIHJlc3VsdHMKICAgICAgICBpZiBzYXZlX3Jlc3VsdHNfY3N2OgogICAgICAgICAgICBpZiBzZWxmLnZlcmJvc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJTYXZpbmcgcmVzdWx0cy4uLiIpCgogICAgICAgICAgICAjIOehruS/neebruW9leWtmOWcqAogICAgICAgICAgICBvcy5tYWtlZGlycyhzZWxmLm91dF9kaXIsIGV4aXN0X29rPVRydWUpCgogICAgICAgICAgICAjIOWmguaenOacieWOn+Wni+mFjee9ruaWh+S7tu+8jOWImeebtOaOpeWkjeWItuWIsOi+k+WHuuebruW9lQogICAgICAgICAgICBpZiBzZWxmLmNvbmZpZ19maWxlIGFuZCBvcy5wYXRoLmV4aXN0cyhzZWxmLmNvbmZpZ19maWxlKToKICAgICAgICAgICAgICAgIGltcG9ydCBzaHV0aWwKICAgICAgICAgICAgICAgIGNvbmZpZ19vdXRfcGF0aCA9IG9zLnBhdGguam9pbihzZWxmLm91dF9kaXIsICdjb25maWcueWFtbCcpCiAgICAgICAgICAgICAgICBzaHV0aWwuY29weTIoc2VsZi5jb25maWdfZmlsZSwgY29uZmlnX291dF9wYXRoKQogICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLljp/lp4vphY3nva7mlofku7blt7LlpI3liLbliLA6IHtjb25maWdfb3V0X3BhdGh9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMg5rKh5pyJ5Y6f5aeL6YWN572u5paH5Lu25pe277yM5LuN54S25L+d5a2Y5b2T5YmN6YWN572u5Li6SlNPTgogICAgICAgICAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIuacquaPkOS+m+WOn+Wni+mFjee9ruaWh+S7tui3r+W+hO+8jOWwhuS7pUpTT07moLzlvI/kv53lrZjlvZPliY3phY3nva4iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIOWIm+W7uuWMheWQq+W9k+WJjeWIhuaekOWPguaVsOeahOmFjee9ruWtl+WFuAogICAgICAgICAgICAgICAgY29uZmlnID0gewogICAgICAgICAgICAgICAgICAgICdkYXRhX2Rpcic6IHNlbGYuZGF0YV9kaXIsCiAgICAgICAgICAgICAgICAgICAgJ291dF9mb2xkZXInOiBzZWxmLm91dF9kaXIsCiAgICAgICAgICAgICAgICAgICAgJ2ZlYXR1cmVfY29uZmlnJzogc2VsZi5mZWF0dXJlX2NvbmZpZywKICAgICAgICAgICAgICAgICAgICAnc3VwZXJ2b3hlbF9jbHVzdGVyaW5nX21ldGhvZCc6IHNlbGYuc3VwZXJ2b3hlbF9tZXRob2QsCiAgICAgICAgICAgICAgICAgICAgJ2hhYml0YXRfY2x1c3RlcmluZ19tZXRob2QnOiBzZWxmLmhhYml0YXRfbWV0aG9kLAogICAgICAgICAgICAgICAgICAgICduX2NsdXN0ZXJzX3N1cGVydm94ZWwnOiBzZWxmLm5fY2x1c3RlcnNfc3VwZXJ2b3hlbCwKICAgICAgICAgICAgICAgICAgICAnbl9jbHVzdGVyc19oYWJpdGF0c19tYXgnOiBzZWxmLm5fY2x1c3RlcnNfaGFiaXRhdHNfbWF4LAogICAgICAgICAgICAgICAgICAgICduX2NsdXN0ZXJzX2hhYml0YXRzX21pbic6IHNlbGYubl9jbHVzdGVyc19oYWJpdGF0c19taW4sCiAgICAgICAgICAgICAgICAgICAgJ2hhYml0YXRfY2x1c3Rlcl9zZWxlY3Rpb25fbWV0aG9kJzogc2VsZi5oYWJpdGF0X2NsdXN0ZXJfc2VsZWN0aW9uX21ldGhvZCwKICAgICAgICAgICAgICAgICAgICAnYmVzdF9uX2NsdXN0ZXJzJzogc2VsZi5iZXN0X25fY2x1c3RlcnMsCiAgICAgICAgICAgICAgICAgICAgJ25fcHJvY2Vzc2VzJzogc2VsZi5uX3Byb2Nlc3NlcywKICAgICAgICAgICAgICAgICAgICAncmFuZG9tX3N0YXRlJzogc2VsZi5yYW5kb21fc3RhdGUsCiAgICAgICAgICAgICAgICAgICAgJ3ZlcmJvc2UnOiBzZWxmLnZlcmJvc2UsCiAgICAgICAgICAgICAgICAgICAgJ2ltYWdlc19kaXInOiBzZWxmLmltYWdlc19kaXIsCiAgICAgICAgICAgICAgICAgICAgJ21hc2tzX2Rpcic6IHNlbGYubWFza3NfZGlyLAogICAgICAgICAgICAgICAgICAgICdwbG90X2N1cnZlcyc6IHNlbGYucGxvdF9jdXJ2ZXMsCiAgICAgICAgICAgICAgICAgICAgJ3NhdmVfaW50ZXJtZWRpYXRlX3Jlc3VsdHMnOiBzZWxmLnNhdmVfaW50ZXJtZWRpYXRlX3Jlc3VsdHMsCiAgICAgICAgICAgICAgICAgICAgJ29wdGltYWxfbl9jbHVzdGVyc19oYWJpdGF0JzogaW50KG9wdGltYWxfbl9jbHVzdGVycykKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAjIOS/neWtmOmFjee9rgogICAgICAgICAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihzZWxmLm91dF9kaXIsICdjb25maWcuanNvbicpLCAndycpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAganNvbi5kdW1wKGNvbmZpZywgZiwgaW5kZW50PTQpCgogICAgICAgICAgICAjIFNhdmUgQ1NWCiAgICAgICAgICAgIHNlbGYucmVzdWx0c19kZi50b19jc3Yob3MucGF0aC5qb2luKHNlbGYub3V0X2RpciwgJ2hhYml0YXRzLmNzdicpLCBpbmRleD1GYWxzZSkKCiAgICAgICAgICAgICMgU2F2ZSBoYWJpdGF0IGltYWdlcyBmb3IgZWFjaCBzdWJqZWN0CiAgICAgICAgICAgICMgU2V0IFN1YmplY3QgYXMgaW5kZXgKICAgICAgICAgICAgc2VsZi5yZXN1bHRzX2RmLnNldF9pbmRleCgnU3ViamVjdCcsIGlucGxhY2U9VHJ1ZSkKCiAgICAgICAgICAgICMg5L2/55So5aSa6L+b56iL5L+d5a2Y5omA5pyJ5Li75L2T55qE5qCW5oGv5Zyw5Zu+5YOPCiAgICAgICAgICAgIHdpdGggbXVsdGlwcm9jZXNzaW5nLlBvb2wocHJvY2Vzc2VzPXNlbGYubl9wcm9jZXNzZXMpIGFzIHBvb2w6CiAgICAgICAgICAgICAgICAjIOWIm+W7uuWPguaVsOWIl+ihqAogICAgICAgICAgICAgICAgYXJnc19saXN0ID0gWyhpLCBzdWJqZWN0KSBmb3IgaSwgc3ViamVjdCBpbiBlbnVtZXJhdGUoc3ViamVjdHMpXQoKICAgICAgICAgICAgICAgICMg5L2/55SoaW1hcF91bm9yZGVyZWTlubbphY3lkIjoh6rlrprkuYnov5vluqbmnaEKICAgICAgICAgICAgICAgIHByb2dyZXNzX2JhciA9IEN1c3RvbVRxZG0odG90YWw9bGVuKHN1YmplY3RzKSwgZGVzYz0iU2F2ZSBoYWJpdGF0IGltYWdlcyIpCiAgICAgICAgICAgICAgICBmb3IgXyBpbiBwb29sLmltYXBfdW5vcmRlcmVkKHNlbGYuX3NhdmVfaGFiaXRhdF9mb3Jfc3ViamVjdCwgYXJnc19saXN0KToKICAgICAgICAgICAgICAgICAgICBwcm9ncmVzc19iYXIudXBkYXRlKDEpCgogICAgICAgIHJldHVybiBzZWxmLnJlc3VsdHNfZGYKCiAgICBkZWYgX3NhdmVfaGFiaXRhdF9mb3Jfc3ViamVjdChzZWxmLCBhcmdzKToKICAgICAgICAiIiIKICAgICAgICDkv53lrZjljZXkuKrkuLvkvZPnmoTmoJbmga/lnLDlm77lg48KCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXJncyAodHVwbGUpOiDljIXlkKvkuLvkvZPntKLlvJXlkozlkI3np7DnmoTlhYPnu4QgKGksIHN1YmplY3QpCgogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDog5Li75L2T57Si5byVCiAgICAgICAgIiIiCiAgICAgICAgaSwgc3ViamVjdCA9IGFyZ3MKICAgICAgICBzdXBlcnZveGVsX3BhdGggPSBvcy5wYXRoLmpvaW4oc2VsZi5vdXRfZGlyLCBmIntzdWJqZWN0fV9zdXBlcnZveGVsLm5ycmQiKQogICAgICAgIHNhdmVfaGFiaXRhdF9pbWFnZShzdWJqZWN0LCBzZWxmLnJlc3VsdHNfZGYsIHN1cGVydm94ZWxfcGF0aCwgc2VsZi5vdXRfZGlyKQogICAgICAgIHJldHVybiBpCgogICAgZGVmIGV4dHJhY3Rfdm94ZWxfZmVhdHVyZXMoc2VsZiwgc3ViamVjdDogc3RyKSAtPiBUdXBsZVtzdHIsIHBkLkRhdGFGcmFtZSwgcGQuRGF0YUZyYW1lLCBucC5uZGFycmF5LCBkaWN0XToKICAgICAgICAiIiIKICAgICAgICBFeHRyYWN0IGZlYXR1cmVzIGZvciBhIHNpbmdsZSBzdWJqZWN0CgogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHN1YmplY3QgKHN0cik6IFN1YmplY3QgSUQKCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgVHVwbGVbc3RyLCBwZC5EYXRhRnJhbWUsIHBkLkRhdGFGcmFtZSwgbnAubmRhcnJheSwgZGljdF06IFR1cGxlIGNvbnRhaW5pbmc6CiAgICAgICAgICAgICAgICAtIHN1YmplY3QgSUQKICAgICAgICAgICAgICAgIC0gZmVhdHVyZSBkYXRhZnJhbWUKICAgICAgICAgICAgICAgIC0gb3JpZ2luYWwgaW1hZ2UgZGF0YWZyYW1lCiAgICAgICAgICAgICAgICAtIG1hc2sgYXJyYXkKICAgICAgICAgICAgICAgIC0gZGljdGlvbmFyeSB3aXRoIGltYWdlIGluZm9ybWF0aW9uCiAgICAgICAgIiIiCiAgICAgICAgZnJvbSAuZmVhdHVyZXMuZmVhdHVyZV9leHRyYWN0b3JfZmFjdG9yeSBpbXBvcnQgY3JlYXRlX2ZlYXR1cmVfZXh0cmFjdG9yCiAgICAgICAgCiAgICAgICAgIyBHZXQgaW1hZ2UgYW5kIG1hc2sgcGF0aHMKICAgICAgICBpbWdfcGF0aHMgPSBzZWxmLmltYWdlc19wYXRoc1tzdWJqZWN0XQogICAgICAgIG1hc2tfcGF0aHMgPSBzZWxmLm1hc2tfcGF0aHNbc3ViamVjdF0KCiAgICAgICAgIyDlhYjlpITnkIbljZXlm77lg48KICAgICAgICBwcm9jZXNzZWRfaW1hZ2VzID0gW10KICAgICAgICAjIOmBjeWOhuWkhOeQhuatpemqpO+8jOWkhOeQhuavj+S4quWNleWbvuWDjwogICAgICAgIGZvciBzdGVwIGluIHNlbGYudm94ZWxfcHJvY2Vzc2luZ19zdGVwczoKICAgICAgICAgICAgbWV0aG9kID0gc3RlcFsnbWV0aG9kJ10KICAgICAgICAgICAgaW1nX25hbWUgPSBzdGVwWydpbWFnZSddCiAgICAgICAgICAgIHN0ZXBfcGFyYW1zID0gc3RlcFsncGFyYW1zJ10uY29weSgpICAjIOWkjeWItuWPguaVsO+8jOmBv+WFjeS/ruaUueWOn+Wni+WPguaVsAoKICAgICAgICAgICAgIyDmo4Dmn6VzdGVwX3BhcmFtc+aYr+WQpuS4uuepugogICAgICAgICAgICBpZiBzdGVwX3BhcmFtczoKICAgICAgICAgICAgICAgICMg5aSE55CG5Y+C5pWw77yM5bCG5Y+C5pWw5ZCN5pu/5o2i5Li65a6e6ZmF5YC8CiAgICAgICAgICAgICAgICBmb3IgcGFyYW1fbmFtZSwgcGFyYW1fdmFsdWUgaW4gbGlzdChzdGVwX3BhcmFtcy5pdGVtcygpKToKICAgICAgICAgICAgICAgICAgICAjIOajgOafpXZveGVsX2xldmVsLnBhcmFtc+S4reeahOWPguaVsAogICAgICAgICAgICAgICAgICAgIHZveGVsX3BhcmFtcyA9IHNlbGYuZmVhdHVyZV9jb25maWdbJ3ZveGVsX2xldmVsJ10uZ2V0KCdwYXJhbXMnLCB7fSkKICAgICAgICAgICAgICAgICAgICBpZiBwYXJhbV92YWx1ZSA9PSBwYXJhbV9uYW1lIGFuZCBwYXJhbV9uYW1lIGluIHZveGVsX3BhcmFtczoKICAgICAgICAgICAgICAgICAgICAgICAgc3RlcF9wYXJhbXNbcGFyYW1fbmFtZV0gPSB2b3hlbF9wYXJhbXNbcGFyYW1fbmFtZV0KICAgICAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UocGFyYW1fdmFsdWUsIHN0cikgYW5kIHBhcmFtX3ZhbHVlIGluIHZveGVsX3BhcmFtczoKICAgICAgICAgICAgICAgICAgICAgICAgc3RlcF9wYXJhbXNbcGFyYW1fbmFtZV0gPSB2b3hlbF9wYXJhbXNbcGFyYW1fdmFsdWVdCgogICAgICAgICAgICAjIOaMiemcgOWIm+W7uuWNleWbvuWDj+eJueW+geaPkOWPluWZqOW5tuWkhOeQhuWbvuWDjwogICAgICAgICAgICBzdGVwX3BhcmFtcy51cGRhdGUoeydzdWJqZWN0Jzogc3ViamVjdCwgJ2ltYWdlJzogaW1nX25hbWV9KQogICAgICAgICAgICBleHRyYWN0b3IgPSBjcmVhdGVfZmVhdHVyZV9leHRyYWN0b3IobWV0aG9kLCAqKnN0ZXBfcGFyYW1zKQogICAgICAgICAgICBwcm9jZXNzZWRfZGYgPSBleHRyYWN0b3IuZXh0cmFjdF9mZWF0dXJlcyhpbWdfcGF0aHMuZ2V0KGltZ19uYW1lKSwgbWFza19wYXRocy5nZXQoaW1nX25hbWUpLCAqKnN0ZXBfcGFyYW1zKQogICAgICAgICAgICBwcm9jZXNzZWRfaW1hZ2VzLmFwcGVuZChwcm9jZXNzZWRfZGYpCgogICAgICAgICAgICAjICMg5p+l55yLbWFza+acieWkmuWwkeS4jeS4ujDnmoTlgLwKICAgICAgICAgICAgIyBtYXNrX2ltZyA9IHNpdGsuUmVhZEltYWdlKG1hc2tfcGF0aHMuZ2V0KGltZ19uYW1lKSkKICAgICAgICAgICAgIyBtYXNrX2FycmF5ID0gc2l0ay5HZXRBcnJheUZyb21JbWFnZShtYXNrX2ltZykKICAgICAgICAgICAgIyBtYXNrX25vbnplcm8gPSBucC5zdW0obWFza19hcnJheSAhPSAwKQogICAgICAgICAgICAjIHVuaXF1ZV92YWx1ZXMgPSBucC51bmlxdWUobWFza19hcnJheSkKICAgICAgICAgICAgIyBwcmludChmIntpbWdfbmFtZX0gbWFzayBoYXMge21hc2tfbm9uemVyb30gbm9uLXplcm8gdmFsdWVzLCB1bmlxdWUgdmFsdWVzOiB7dW5pcXVlX3ZhbHVlc30iKQoKICAgICAgICAjIOaMiemcgOWIm+W7uui3qOWbvuWDj+eJueW+geaPkOWPluWZqAogICAgICAgIGNyb3NzX2ltYWdlX2t3YXJncyA9IHNlbGYuY3Jvc3NfaW1hZ2Vfa3dhcmdzLmNvcHkoKQogICAgICAgIGNyb3NzX2ltYWdlX2t3YXJncy51cGRhdGUoeydzdWJqZWN0Jzogc3ViamVjdH0pCiAgICAgICAgY3Jvc3NfaW1hZ2VfZXh0cmFjdG9yID0gY3JlYXRlX2ZlYXR1cmVfZXh0cmFjdG9yKHNlbGYudm94ZWxfbWV0aG9kLCAqKmNyb3NzX2ltYWdlX2t3YXJncykKICAgICAgICBmZWF0dXJlcyA9IGNyb3NzX2ltYWdlX2V4dHJhY3Rvci5leHRyYWN0X2ZlYXR1cmVzKHByb2Nlc3NlZF9pbWFnZXMsICoqY3Jvc3NfaW1hZ2Vfa3dhcmdzKQoKICAgICAgICAjIGdldCByYXcgZGF0YSAtIOWcqOi/nuaOpeWJjemHjeWRveWQjeWIlwogICAgICAgIHJhd19kZiA9IHBkLmNvbmNhdChwcm9jZXNzZWRfaW1hZ2VzLCBheGlzPTEpCgogICAgICAgICMgU2F2ZSBtYXNrIGluZm9ybWF0aW9uIGZvciBsYXRlciBpbWFnZSByZWNvbnN0cnVjdGlvbgogICAgICAgIG1hc2sgPSBzZWxmLm1hc2tfcGF0aHNbc3ViamVjdF0KICAgICAgICBtYXNrID0gbGlzdChtYXNrLnZhbHVlcygpKVswXQogICAgICAgIG1hc2tfaW1nID0gc2l0ay5SZWFkSW1hZ2UobWFzaykKICAgICAgICBtYXNrX2FycmF5ID0gc2l0ay5HZXRBcnJheUZyb21JbWFnZShtYXNrX2ltZykKICAgICAgICBtYXNrX2luZm8gPSB7CiAgICAgICAgICAgICdtYXNrJzogbWFza19pbWcsCiAgICAgICAgICAgICdtYXNrX2FycmF5JzogbWFza19hcnJheQogICAgICAgIH0KCiAgICAgICAgIyBDbGVhbiB1cCBtZW1vcnkKICAgICAgICBkZWwgcHJvY2Vzc2VkX2ltYWdlcywgbWFza19pbWcsIG1hc2tfYXJyYXkKCiAgICAgICAgcmV0dXJuIHN1YmplY3QsIGZlYXR1cmVzLCByYXdfZGYsIG1hc2tfaW5mbwoKICAgIGRlZiBleHRyYWN0X3N1cGVydm94ZWxfZmVhdHVyZXMoc2VsZiwgc3ViamVjdDogc3RyKSAtPiBucC5uZGFycmF5OgogICAgICAgICIiIgogICAgICAgIEV4dHJhY3Qgc3VwZXJ2b3hlbC1sZXZlbCBmZWF0dXJlcyBmcm9tIHN1cGVydm94ZWwgbWFwcyBhbmQgb3JpZ2luYWwgaW1hZ2VzCgogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIG5wLm5kYXJyYXk6IFN1cGVydm94ZWwgZmVhdHVyZXMgZm9yIGNsdXN0ZXJpbmcKICAgICAgICAiIiIKICAgICAgICBmcm9tIC5mZWF0dXJlcy5mZWF0dXJlX2V4dHJhY3Rvcl9mYWN0b3J5IGltcG9ydCBjcmVhdGVfZmVhdHVyZV9leHRyYWN0b3IKCiAgICAgICAgIyBHZXQgaW1hZ2UgYW5kIG1hc2sgcGF0aHMKICAgICAgICBpbWdfcGF0aHMgPSBzZWxmLmltYWdlc19wYXRoc1tzdWJqZWN0XQogICAgICAgIG1hc2tfcGF0aCA9IHNlbGYuc3VwZXJ2b3hlbF9maWxlX2RpY3Rbc3ViamVjdF0KCiAgICAgICAgIyDojrflj5ZvdXRkaXLkuK3nmoTmiYDmnIlzdXBlcnZveGVs5paH5Lu2CiAgICAgICAgaWYgc2VsZi52ZXJib3NlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJFeHRyYWN0aW5nIHN1cGVydm94ZWwtbGV2ZWwgZmVhdHVyZXMuLi4iKQoKICAgICAgICAjIOWFiOWkhOeQhuWNleWbvuWDjwogICAgICAgIHByb2Nlc3NlZF9pbWFnZXMgPSBbXQogICAgICAgICMg6YGN5Y6G5aSE55CG5q2l6aqk77yM5aSE55CG5q+P5Liq5Y2V5Zu+5YOPCiAgICAgICAgZm9yIHN0ZXAgaW4gc2VsZi5zdXBlcnZveGVsX3Byb2Nlc3Npbmdfc3RlcHM6CiAgICAgICAgICAgIG1ldGhvZCA9IHN0ZXBbJ21ldGhvZCddCiAgICAgICAgICAgIGltZ19uYW1lID0gc3RlcFsnaW1hZ2UnXQogICAgICAgICAgICBzdGVwX3BhcmFtcyA9IHN0ZXBbJ3BhcmFtcyddLmNvcHkoKSAgIyDlpI3liLblj4LmlbDvvIzpgb/lhY3kv67mlLnljp/lp4vlj4LmlbAKCiAgICAgICAgICAgICMg5L2/55So5Y2V5Zu+5YOP54m55b6B5o+Q5Y+W5Zmo5aSE55CG5Zu+5YOPCiAgICAgICAgICAgIHN0ZXBfcGFyYW1zLnVwZGF0ZSh7J3N1YmplY3QnOiBzdWJqZWN0LCAnaW1hZ2UnOiBpbWdfbmFtZX0pCiAgICAgICAgICAgICMg5oyJ6ZyA5Yib5bu65Y2V5Zu+5YOP54m55b6B5o+Q5Y+W5ZmoCiAgICAgICAgICAgIHNpbmdsZV9pbWFnZV9leHRyYWN0b3IgPSBjcmVhdGVfZmVhdHVyZV9leHRyYWN0b3IobWV0aG9kLCAqKnN0ZXBfcGFyYW1zKQogICAgICAgICAgICBwcm9jZXNzZWRfZGYgPSBzaW5nbGVfaW1hZ2VfZXh0cmFjdG9yLmV4dHJhY3RfZmVhdHVyZXMoaW1nX3BhdGhzLmdldChpbWdfbmFtZSksIG1hc2tfcGF0aCwgKipzdGVwX3BhcmFtcykKICAgICAgICAgICAgcHJvY2Vzc2VkX2ltYWdlcy5hcHBlbmQocHJvY2Vzc2VkX2RmKQoKICAgICAgICAjIOaMiemcgOWIm+W7uui3qOWbvuWDj+eJueW+geaPkOWPluWZqAogICAgICAgIHN1cGVydm94ZWxfcGFyYW1zID0gc2VsZi5zdXBlcnZveGVsX3BhcmFtcy5jb3B5KCkKICAgICAgICBjcm9zc19pbWFnZV9leHRyYWN0b3IgPSBjcmVhdGVfZmVhdHVyZV9leHRyYWN0b3Ioc2VsZi5zdXBlcnZveGVsX21ldGhvZF9uYW1lLCAqKnN1cGVydm94ZWxfcGFyYW1zKQogICAgICAgIGZlYXR1cmVzID0gY3Jvc3NfaW1hZ2VfZXh0cmFjdG9yLmV4dHJhY3RfZmVhdHVyZXMocHJvY2Vzc2VkX2ltYWdlcywgKipzdXBlcnZveGVsX3BhcmFtcykKCiAgICAgICAgcmV0dXJuIGZlYXR1cmVzCgoKCgo=').decode())
